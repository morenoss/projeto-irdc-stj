-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  IRDC_Resultados
       log:  C:\Users\.....\Projeto\Dados\Diretorio Stata/Resultados\IRDC_RAC.log
  log type:  text
 opened on:  31 Jul 2025, 17:09:16

. 
. /*******************************************************************************
> Projeto:            Índice de Risco de Descumprimento Contratual (IRDC)
> Autor:              Moreno Souto Santiago
> Fonte dos Dados:    Painel de Informações Contábeis dos Fornecedores do STJ
> Ferramentas:        Stata 18 + Python (SMOTENC)
> Descrição:          
> Este script executa a análise preditiva do IRDC com base em dados contábeis e cadastrais
> dos fornecedores do STJ. As etapas incluem:
> 
> 1. **Importação e transformação dos dados**: consolidação dos indicadores contábeis,
>    análise descritiva inicial e preparação da base para modelagem.
> 
> 2. **Matriz de correlação inicial das variáveis contínuas**: cálculo da matriz de
>    correlação antes da imputação e criação dos índices sintéticos, permitindo acompanhar
>    a evolução das relações entre variáveis conforme os dados são atualizados ou transformados.
> 
> 3. **Winsorização das variáveis contínuas**: aplicação do corte nos percentis 1% e 99%
>    para reduzir o impacto de outliers extremos, preservando a variabilidade e robustez
>    das análises subsequentes.
> 
> 4. **Estatísticas descritivas por grupo**: geração de tabelas de estatísticas descritivas
>    (média, desvio padrão, mínimo, máximo) para empresas penalizadas e não penalizadas,
>    antes e após a winsorização, facilitando análise comparativa de perfil e identificação de padrões.
> 
> 5. **Imputação de valores faltantes**: preenchimento de dados ausentes por média ou mediana,
>    conforme o coeficiente de variação, para garantir integridade e qualidade da base.
> 
> 6. **Padronização z-score de todas as variáveis contínuas**: todas as variáveis contínuas e indicadores
>    foram transformados para escala padrão (média 0, desvio-padrão 1), conferindo maior robustez,
>    comparabilidade e estabilidade aos modelos preditivos subsequentes.
> 
> 7. **Criação dos índices sintéticos**: combinação de variáveis colineares já padronizadas
>    em índices sintéticos para reduzir dimensionalidade e multicolinearidade, facilitando a modelagem.
> 
> 8. **Matriz de correlação final dos índices sintéticos e variáveis contínuas**:
>    cálculo da matriz após a imputação, padronização e criação dos índices para validar a estrutura dos dados.
> 
> 9. **Separação das amostras em treinamento (80%) e teste (20%)**: a separação das
>    amostras é realizada obedecendo a proporção exata de empresas penalizadas e não penalizadas.
> 
> 10. **Balanceamento da amostra de treinamento**: aplicação da técnica SMOTENC em Python para lidar com
>     desbalanceamento da variável dependente (penalização pelo STJ), com codificação de
>     variáveis categóricas e posterior reintegração ao Stata.
> 
> 11. **Agrupamento de CNAEs raros**: definição do mínimo de ocorrências para manter CNAE
>     como categoria isolada (local freq_minima = 10). As categorias com menor frequência
>     foram agrupadas sob o código -1 para reduzir a sparsidade da matriz de variáveis dummies
>     e aumentar a estabilidade dos coeficientes.
> 
> 12. **Conversão e criação de variáveis dummies para variáveis categóricas**:
>     transformação de variáveis categóricas em variáveis dummy após o balanceamento.
> 
> 13. **Modelagem e avaliação preditiva**:
>     - Modelo logit completo (com todas as variáveis)
>     - Modelos logit com seleção stepwise
>     - Modelo com penalização LASSO
>     Todos os modelos são avaliados com métricas como acurácia, Kappa, NIR, teste de McNemar,
>     curvas ROC e definição do ponto de corte ideal baseado na equivalência entre
>     sensibilidade e especificidade. As métricas são aplicadas nos conjuntos de treinamento e teste.
> 
> Objetivo:
> Identificar o melhor modelo para predição da variável binária `FoiPenalizadoSTJ`,
> avaliando o poder explicativo de indicadores contábeis, porte, natureza jurídica, CNAE,
> e variáveis de histórico contratual da empresa.
> 
> Última atualização: 31/07/2025
> *******************************************************************************/
. 
. 
.    
. 
. /*******************************************************************************
> ETAPA 1 - IMPORTAÇÃO, ANÁLISE DESCRITIVA DAS VARIÁVEIS E TRANSFORMAÇÃO 
> *******************************************************************************/
. * Definindo o diretório de trabalho e importando os dados do Excel
. cd "`basedados'"
C:\Users\morenos\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata

. import excel "Dados_novo", sheet("Tabela 4") firstrow clear
(37 vars, 1,059 obs)

. 
. /*******************************************************************************
> 1.1 - Executar estatísticas descritivas para todas as variáveis
> *******************************************************************************/
. summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |      1,059    18.95554    165.3569     -65.24    4449.37
    LiqGeral |      1,059    16.66991    163.5215     -65.24    4449.37
 LiqCorAjust |      1,059    .4217162    .3469337    -3.6773          1
   SolvGeral |      1,059    21.68232    207.7772     -66.99    4449.37
    EndGeral |      1,059    .4549046    .3603665     -.0149     5.2741
-------------+---------------------------------------------------------
 CompEndivid |      1,059    .7837396    .2548589          0          1
    IndepFin |      1,059    20.68812    207.7766   -67.9885   4448.367
    ImobilPL |      1,059    .1850521    3.093927   -95.5357     9.1728
   ImobRecNC |      1,059    .2049101    .2495337     -.2471     1.4904
 PtpCapTerce |      1,059     1.27542    7.784162  -208.1876    34.7657
-------------+---------------------------------------------------------
   GiroAtivo |      1,059    1.583262    1.734124     -.0289    32.9637
      MargOp |      1,059    .7903168    10.72938    -1.4199   348.9034
     MargLiq |      1,059    .1687043    2.062448   -14.1571    60.8893
         ROI |      1,059    .1834318    1.285566    -25.837    30.4743
         ROE |      1,059    .4583256    2.625576    -3.9973    70.7696
-------------+---------------------------------------------------------
 vlrcontrato |        780    1.19e+07    2.33e+07     1171.2   1.34e+08
QtdeCNAEsS~s |      1,059    15.58735    14.29617          1         97
 IdadedeAnos |      1,059    22.58384    10.87858   .6575342   59.04658
QtePenalOu~s |      1,059    5.515581    20.56137          0        201

. 
. * Estatísticas descritivas separadas por penalização
. by FoiPenalizadoSTJ, sort: summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrga
> os

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        711    23.79115    196.3178     -65.24    4449.37
    LiqGeral |        711    20.63038     194.075     -65.24    4449.37
 LiqCorAjust |        711    .4261664    .3584656    -3.6773          1
   SolvGeral |        711    27.79716    249.1372     -66.99    4449.37
    EndGeral |        711    .4381136    .3667066     -.0149     5.2741
-------------+---------------------------------------------------------
 CompEndivid |        711    .7844131    .2662723          0          1
    IndepFin |        711    26.80295    249.1365   -67.9885   4448.367
    ImobilPL |        711    .1923691    3.662984   -95.5357     9.1728
   ImobRecNC |        711    .2172003    .2515493     -.1727     1.4904
 PtpCapTerce |        711    1.292629    8.607394  -208.1876    34.6218
-------------+---------------------------------------------------------
   GiroAtivo |        711    1.578149    1.887588     -.0289    32.9637
      MargOp |        711    .9518449    13.07853    -1.4199   348.9034
     MargLiq |        711    .1857367    2.426776   -14.1571    60.8893
         ROI |        711    .1670059    1.064927    -25.837     3.6612
         ROE |        711    .4958609    2.857416    -3.6009    70.7696
-------------+---------------------------------------------------------
 vlrcontrato |        495    1.29e+07    2.31e+07      12000   1.32e+08
QtdeCNAEsS~s |        711    16.03376     15.0676          1         97
 IdadedeAnos |        711    22.53408    11.12895   .6575342   59.04658
QtePenalOu~s |        711     4.31083    20.40403          0        201

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        348    9.075891    66.06059          0    1104.44
    LiqGeral |        348    8.578247    66.05383          0    1104.67
 LiqCorAjust |        348    .4126241    .3224006    -2.4927          1
   SolvGeral |        348     9.18908    66.29739          0    1109.62
    EndGeral |        348    .4892103    .3450338          0      4.205
-------------+---------------------------------------------------------
 CompEndivid |        348    .7823635    .2301466          0          1
    IndepFin |        348    8.194886    66.29674     -.7622   1108.622
    ImobilPL |        348    .1701029    1.316134   -23.1117     3.2065
   ImobRecNC |        348       .1798    .2437992     -.2471     1.4847
 PtpCapTerce |        348     1.24026    5.758094   -76.5962    34.7657
-------------+---------------------------------------------------------
   GiroAtivo |        348    1.593709    1.370569          0     6.6847
      MargOp |        348    .4602983    .9237973    -1.0011    14.3886
     MargLiq |        348    .1339055    .9579306    -6.3956    12.4133
         ROI |        348    .2169917      1.6483    -1.1367    30.4743
         ROE |        348    .3816371     2.07455    -3.9973    35.4538
-------------+---------------------------------------------------------
 vlrcontrato |        285    1.03e+07    2.36e+07     1171.2   1.34e+08
QtdeCNAEsS~s |        348    14.67529    12.54506          1         58
 IdadedeAnos |        348    22.68549    10.36315   3.635616   58.88493
QtePenalOu~s |        348    7.977011    20.69121          0        175


. 
. * Bloco para salvar as estatísticas descritivas originais por grupo
. tabstat LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos, ///
>     statistics(mean sd min max n) by(FoiPenalizadoSTJ)

Summary statistics: Mean, SD, Min, Max, N
Group variable: FoiPenalizadoSTJ (FoiPenalizadoSTJ)

FoiPenalizadoSTJ |  LiqCor~e  LiqGeral  LiqCor~t  SolvGe~l  EndGeral  CompEn~d  IndepFin  ImobilPL  ImobRe~C  PtpCap~e  GiroAt~o    MargOp   MargLiq       ROI       ROE  vlrcon~o  QtdeCN~s  Idaded~s  QtePen~s
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
               0 |  23.79115  20.63038  .4261664  27.79716  .4381136  .7844131  26.80295  .1923691  .2172003  1.292629  1.578149  .9518449  .1857367  .1670059  .4958609  1.29e+07  16.03376  22.53408   4.31083
                 |  196.3178   194.075  .3584656  249.1372  .3667066  .2662723  249.1365  3.662984  .2515493  8.607394  1.887588  13.07853  2.426776  1.064927  2.857416  2.31e+07   15.0676  11.12895  20.40403
                 |    -65.24    -65.24   -3.6773    -66.99    -.0149         0  -67.9885  -95.5357    -.1727 -208.1876    -.0289   -1.4199  -14.1571   -25.837   -3.6009     12000         1  .6575342         0
                 |   4449.37   4449.37         1   4449.37    5.2741         1  4448.367    9.1728    1.4904   34.6218   32.9637  348.9034   60.8893    3.6612   70.7696  1.32e+08        97  59.04658       201
                 |       711       711       711       711       711       711       711       711       711       711       711       711       711       711       711       495       711       711       711
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
               1 |  9.075891  8.578247  .4126241   9.18908  .4892103  .7823635  8.194886  .1701029     .1798   1.24026  1.593709  .4602983  .1339055  .2169917  .3816371  1.03e+07  14.67529  22.68549  7.977011
                 |  66.06059  66.05383  .3224006  66.29739  .3450338  .2301466  66.29674  1.316134  .2437992  5.758094  1.370569  .9237973  .9579306    1.6483   2.07455  2.36e+07  12.54506  10.36315  20.69121
                 |         0         0   -2.4927         0         0         0    -.7622  -23.1117    -.2471  -76.5962         0   -1.0011   -6.3956   -1.1367   -3.9973    1171.2         1  3.635616         0
                 |   1104.44   1104.67         1   1109.62     4.205         1  1108.622    3.2065    1.4847   34.7657    6.6847   14.3886   12.4133   30.4743   35.4538  1.34e+08        58  58.88493       175
                 |       348       348       348       348       348       348       348       348       348       348       348       348       348       348       348       285       348       348       348
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
           Total |  18.95554  16.66991  .4217162  21.68232  .4549046  .7837396  20.68812  .1850521  .2049101   1.27542  1.583262  .7903168  .1687043  .1834318  .4583256  1.19e+07  15.58735  22.58384  5.515581
                 |  165.3569  163.5215  .3469337  207.7772  .3603665  .2548589  207.7766  3.093927  .2495337  7.784162  1.734124  10.72938  2.062448  1.285566  2.625576  2.33e+07  14.29617  10.87858  20.56137
                 |    -65.24    -65.24   -3.6773    -66.99    -.0149         0  -67.9885  -95.5357    -.2471 -208.1876    -.0289   -1.4199  -14.1571   -25.837   -3.9973    1171.2         1  .6575342         0
                 |   4449.37   4449.37         1   4449.37    5.2741         1  4448.367    9.1728    1.4904   34.7657   32.9637  348.9034   60.8893   30.4743   70.7696  1.34e+08        97  59.04658       201
                 |      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059       780      1059      1059      1059
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

.         
. *Bloco de estatíticas das variáveis qualitativas
. 
. tabulate Porte

                  Porte |      Freq.     Percent        Cum.
------------------------+-----------------------------------
EMPRESA DE GRANDE PORTE |        133       12.56       12.56
 EMPRESA DE MÉDIO PORTE |        161       15.20       27.76
          MICROENTIDADE |        114       10.76       38.53
        PEQUENA EMPRESA |        651       61.47      100.00
------------------------+-----------------------------------
                  Total |      1,059      100.00

. tabulate NaturezaJuridica

                      NaturezaJuridica |      Freq.     Percent        Cum.
---------------------------------------+-----------------------------------
               201-1 - Empresa Pública |          5        0.47        0.47
      204-6 - Sociedade Anônima Aberta |         16        1.51        1.98
     205-4 - Sociedade Anônima Fechada |         98        9.25       11.24
 206-2 - Sociedade Empresária Limitada |        883       83.38       94.62
       213-5 - Empresário (Individual) |         26        2.46       97.07
                   214-3 - Cooperativa |          2        0.19       97.26
       215-1 - Consórcio de Sociedades |          1        0.09       97.36
    224-0 - Sociedade Simples Limitada |          2        0.19       97.54
              306-9 - Fundação Privada |          7        0.66       98.21
            399-9 - Associação Privada |         19        1.79      100.00
---------------------------------------+-----------------------------------
                                 Total |      1,059      100.00

. tabulate CNAE

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
 14.12-6-01 |          1        0.09        0.09
 16.22-6-99 |          3        0.28        0.38
 16.29-3-01 |          1        0.09        0.47
 17.42-7-99 |          3        0.28        0.76
 22.29-3-01 |          4        0.38        1.13
 26.10-8-00 |          3        0.28        1.42
 26.21-3-00 |         11        1.04        2.46
 26.32-9-00 |          1        0.09        2.55
 27.10-4-02 |          6        0.57        3.12
 27.31-7-00 |          1        0.09        3.21
 27.90-2-02 |          1        0.09        3.31
 28.24-1-01 |          5        0.47        3.78
 29.10-7-01 |          3        0.28        4.06
 31.01-2-00 |         20        1.89        5.95
 31.02-1-00 |          5        0.47        6.42
 33.12-1-02 |          1        0.09        6.52
 33.21-0-00 |          4        0.38        6.89
 41.20-4-00 |         75        7.08       13.98
 42.13-8-00 |          2        0.19       14.16
 42.21-9-03 |          7        0.66       14.83
 42.21-9-05 |          6        0.57       15.39
 42.99-5-99 |          6        0.57       15.96
 43.21-5-00 |         20        1.89       17.85
 43.22-3-02 |         11        1.04       18.89
 43.22-3-03 |          9        0.85       19.74
 43.29-1-03 |          6        0.57       20.30
 43.29-1-99 |          3        0.28       20.59
 43.30-4-05 |          2        0.19       20.77
 43.30-4-99 |          9        0.85       21.62
 45.11-1-01 |          5        0.47       22.10
 45.30-7-01 |          1        0.09       22.19
 46.18-4-99 |          2        0.19       22.38
 46.33-8-01 |          3        0.28       22.66
 46.35-4-01 |          4        0.38       23.04
 46.39-7-01 |          3        0.28       23.32
 46.42-7-02 |          1        0.09       23.42
 46.47-8-02 |          8        0.76       24.17
 46.49-4-01 |          1        0.09       24.27
 46.49-4-04 |          1        0.09       24.36
 46.49-4-08 |         15        1.42       25.78
 46.49-4-99 |          4        0.38       26.16
 46.51-6-01 |         42        3.97       30.12
 46.52-4-00 |         24        2.27       32.39
 46.61-3-00 |          2        0.19       32.58
 46.63-0-00 |          1        0.09       32.67
 46.65-6-00 |          1        0.09       32.77
 46.69-9-99 |          5        0.47       33.24
 46.81-8-01 |          1        0.09       33.33
 46.86-9-02 |          1        0.09       33.43
 46.87-7-01 |          2        0.19       33.62
 47.12-1-00 |          2        0.19       33.81
 47.29-6-99 |          9        0.85       34.66
 47.44-0-01 |          6        0.57       35.22
 47.44-0-02 |          4        0.38       35.60
 47.44-0-99 |          5        0.47       36.07
 47.51-2-01 |         54        5.10       41.17
 47.52-1-00 |          2        0.19       41.36
 47.53-9-00 |          6        0.57       41.93
 47.54-7-01 |         11        1.04       42.97
 47.59-8-99 |          1        0.09       43.06
 47.84-9-00 |          1        0.09       43.15
 47.89-0-05 |          1        0.09       43.25
 47.89-0-09 |          3        0.28       43.53
 47.89-0-99 |          4        0.38       43.91
 49.21-3-01 |          2        0.19       44.10
 52.40-1-01 |          1        0.09       44.19
 56.11-2-01 |          7        0.66       44.85
 56.20-1-01 |          1        0.09       44.95
 59.11-1-99 |          2        0.19       45.14
 61.10-8-01 |         12        1.13       46.27
 61.10-8-03 |          6        0.57       46.84
 61.20-5-01 |          7        0.66       47.50
 61.20-5-02 |          1        0.09       47.59
 61.90-6-99 |          2        0.19       47.78
 62.01-5-01 |         37        3.49       51.27
 62.02-3-00 |         17        1.61       52.88
 62.03-1-00 |         28        2.64       55.52
 62.04-0-00 |         58        5.48       61.00
 62.09-1-00 |         86        8.12       69.12
 63.11-9-00 |          3        0.28       69.41
 63.19-4-00 |          1        0.09       69.50
 63.99-2-00 |          2        0.19       69.69
 66.13-4-00 |          5        0.47       70.16
 66.21-5-02 |          7        0.66       70.82
 70.20-4-00 |         11        1.04       71.86
 71.11-1-00 |          1        0.09       71.95
 71.12-0-00 |         26        2.46       74.41
 73.11-4-00 |          3        0.28       74.69
 73.20-3-00 |          3        0.28       74.98
 74.20-0-04 |          2        0.19       75.17
 74.90-1-04 |          6        0.57       75.73
 74.90-1-99 |          4        0.38       76.11
 77.33-1-00 |         13        1.23       77.34
 77.39-0-03 |          4        0.38       77.71
 77.39-0-99 |          2        0.19       77.90
 78.10-8-00 |          6        0.57       78.47
 78.20-5-00 |          8        0.76       79.23
 78.30-2-00 |         27        2.55       81.78
 79.11-2-00 |         23        2.17       83.95
 80.11-1-01 |         23        2.17       86.12
 81.21-4-00 |         12        1.13       87.25
 81.29-0-00 |          6        0.57       87.82
 81.30-3-00 |          2        0.19       88.01
 82.11-3-00 |         16        1.51       89.52
 82.20-2-00 |         23        2.17       91.69
 82.30-0-01 |         24        2.27       93.96
 82.99-7-99 |         12        1.13       95.09
 85.31-7-00 |          3        0.28       95.37
 85.32-5-00 |          4        0.38       95.75
 85.50-3-02 |          5        0.47       96.22
 85.93-7-00 |          7        0.66       96.88
 85.99-6-04 |          5        0.47       97.36
 86.30-5-06 |          4        0.38       97.73
 86.50-0-01 |          2        0.19       97.92
 86.60-7-00 |          2        0.19       98.11
 88.00-6-00 |          6        0.57       98.68
 90.01-9-02 |          2        0.19       98.87
 93.19-1-01 |          2        0.19       99.06
 94.30-8-00 |          2        0.19       99.24
 94.99-5-00 |          6        0.57       99.81
 96.01-7-01 |          2        0.19      100.00
------------+-----------------------------------
      Total |      1,059      100.00

. 
. quietly egen cnpjs = tag(CNPJ)

. tabulate FoiPenalizadoSTJ if cnpjs == 1, missing

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        278       75.96       75.96
          1 |         88       24.04      100.00
------------+-----------------------------------
      Total |        366      100.00

. 
. 
. // Frequência com percentual
. tabulate Porte, missing

                  Porte |      Freq.     Percent        Cum.
------------------------+-----------------------------------
EMPRESA DE GRANDE PORTE |        133       12.56       12.56
 EMPRESA DE MÉDIO PORTE |        161       15.20       27.76
          MICROENTIDADE |        114       10.76       38.53
        PEQUENA EMPRESA |        651       61.47      100.00
------------------------+-----------------------------------
                  Total |      1,059      100.00

. tabulate NaturezaJuridica, missing

                      NaturezaJuridica |      Freq.     Percent        Cum.
---------------------------------------+-----------------------------------
               201-1 - Empresa Pública |          5        0.47        0.47
      204-6 - Sociedade Anônima Aberta |         16        1.51        1.98
     205-4 - Sociedade Anônima Fechada |         98        9.25       11.24
 206-2 - Sociedade Empresária Limitada |        883       83.38       94.62
       213-5 - Empresário (Individual) |         26        2.46       97.07
                   214-3 - Cooperativa |          2        0.19       97.26
       215-1 - Consórcio de Sociedades |          1        0.09       97.36
    224-0 - Sociedade Simples Limitada |          2        0.19       97.54
              306-9 - Fundação Privada |          7        0.66       98.21
            399-9 - Associação Privada |         19        1.79      100.00
---------------------------------------+-----------------------------------
                                 Total |      1,059      100.00

. tabulate CNAE, missing

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
 14.12-6-01 |          1        0.09        0.09
 16.22-6-99 |          3        0.28        0.38
 16.29-3-01 |          1        0.09        0.47
 17.42-7-99 |          3        0.28        0.76
 22.29-3-01 |          4        0.38        1.13
 26.10-8-00 |          3        0.28        1.42
 26.21-3-00 |         11        1.04        2.46
 26.32-9-00 |          1        0.09        2.55
 27.10-4-02 |          6        0.57        3.12
 27.31-7-00 |          1        0.09        3.21
 27.90-2-02 |          1        0.09        3.31
 28.24-1-01 |          5        0.47        3.78
 29.10-7-01 |          3        0.28        4.06
 31.01-2-00 |         20        1.89        5.95
 31.02-1-00 |          5        0.47        6.42
 33.12-1-02 |          1        0.09        6.52
 33.21-0-00 |          4        0.38        6.89
 41.20-4-00 |         75        7.08       13.98
 42.13-8-00 |          2        0.19       14.16
 42.21-9-03 |          7        0.66       14.83
 42.21-9-05 |          6        0.57       15.39
 42.99-5-99 |          6        0.57       15.96
 43.21-5-00 |         20        1.89       17.85
 43.22-3-02 |         11        1.04       18.89
 43.22-3-03 |          9        0.85       19.74
 43.29-1-03 |          6        0.57       20.30
 43.29-1-99 |          3        0.28       20.59
 43.30-4-05 |          2        0.19       20.77
 43.30-4-99 |          9        0.85       21.62
 45.11-1-01 |          5        0.47       22.10
 45.30-7-01 |          1        0.09       22.19
 46.18-4-99 |          2        0.19       22.38
 46.33-8-01 |          3        0.28       22.66
 46.35-4-01 |          4        0.38       23.04
 46.39-7-01 |          3        0.28       23.32
 46.42-7-02 |          1        0.09       23.42
 46.47-8-02 |          8        0.76       24.17
 46.49-4-01 |          1        0.09       24.27
 46.49-4-04 |          1        0.09       24.36
 46.49-4-08 |         15        1.42       25.78
 46.49-4-99 |          4        0.38       26.16
 46.51-6-01 |         42        3.97       30.12
 46.52-4-00 |         24        2.27       32.39
 46.61-3-00 |          2        0.19       32.58
 46.63-0-00 |          1        0.09       32.67
 46.65-6-00 |          1        0.09       32.77
 46.69-9-99 |          5        0.47       33.24
 46.81-8-01 |          1        0.09       33.33
 46.86-9-02 |          1        0.09       33.43
 46.87-7-01 |          2        0.19       33.62
 47.12-1-00 |          2        0.19       33.81
 47.29-6-99 |          9        0.85       34.66
 47.44-0-01 |          6        0.57       35.22
 47.44-0-02 |          4        0.38       35.60
 47.44-0-99 |          5        0.47       36.07
 47.51-2-01 |         54        5.10       41.17
 47.52-1-00 |          2        0.19       41.36
 47.53-9-00 |          6        0.57       41.93
 47.54-7-01 |         11        1.04       42.97
 47.59-8-99 |          1        0.09       43.06
 47.84-9-00 |          1        0.09       43.15
 47.89-0-05 |          1        0.09       43.25
 47.89-0-09 |          3        0.28       43.53
 47.89-0-99 |          4        0.38       43.91
 49.21-3-01 |          2        0.19       44.10
 52.40-1-01 |          1        0.09       44.19
 56.11-2-01 |          7        0.66       44.85
 56.20-1-01 |          1        0.09       44.95
 59.11-1-99 |          2        0.19       45.14
 61.10-8-01 |         12        1.13       46.27
 61.10-8-03 |          6        0.57       46.84
 61.20-5-01 |          7        0.66       47.50
 61.20-5-02 |          1        0.09       47.59
 61.90-6-99 |          2        0.19       47.78
 62.01-5-01 |         37        3.49       51.27
 62.02-3-00 |         17        1.61       52.88
 62.03-1-00 |         28        2.64       55.52
 62.04-0-00 |         58        5.48       61.00
 62.09-1-00 |         86        8.12       69.12
 63.11-9-00 |          3        0.28       69.41
 63.19-4-00 |          1        0.09       69.50
 63.99-2-00 |          2        0.19       69.69
 66.13-4-00 |          5        0.47       70.16
 66.21-5-02 |          7        0.66       70.82
 70.20-4-00 |         11        1.04       71.86
 71.11-1-00 |          1        0.09       71.95
 71.12-0-00 |         26        2.46       74.41
 73.11-4-00 |          3        0.28       74.69
 73.20-3-00 |          3        0.28       74.98
 74.20-0-04 |          2        0.19       75.17
 74.90-1-04 |          6        0.57       75.73
 74.90-1-99 |          4        0.38       76.11
 77.33-1-00 |         13        1.23       77.34
 77.39-0-03 |          4        0.38       77.71
 77.39-0-99 |          2        0.19       77.90
 78.10-8-00 |          6        0.57       78.47
 78.20-5-00 |          8        0.76       79.23
 78.30-2-00 |         27        2.55       81.78
 79.11-2-00 |         23        2.17       83.95
 80.11-1-01 |         23        2.17       86.12
 81.21-4-00 |         12        1.13       87.25
 81.29-0-00 |          6        0.57       87.82
 81.30-3-00 |          2        0.19       88.01
 82.11-3-00 |         16        1.51       89.52
 82.20-2-00 |         23        2.17       91.69
 82.30-0-01 |         24        2.27       93.96
 82.99-7-99 |         12        1.13       95.09
 85.31-7-00 |          3        0.28       95.37
 85.32-5-00 |          4        0.38       95.75
 85.50-3-02 |          5        0.47       96.22
 85.93-7-00 |          7        0.66       96.88
 85.99-6-04 |          5        0.47       97.36
 86.30-5-06 |          4        0.38       97.73
 86.50-0-01 |          2        0.19       97.92
 86.60-7-00 |          2        0.19       98.11
 88.00-6-00 |          6        0.57       98.68
 90.01-9-02 |          2        0.19       98.87
 93.19-1-01 |          2        0.19       99.06
 94.30-8-00 |          2        0.19       99.24
 94.99-5-00 |          6        0.57       99.81
 96.01-7-01 |          2        0.19      100.00
------------+-----------------------------------
      Total |      1,059      100.00

. 
. 
. tabulate Porte FoiPenalizadoSTJ, column

+-------------------+
| Key               |
|-------------------|
|     frequency     |
| column percentage |
+-------------------+

                      |   FoiPenalizadoSTJ
                Porte |         0          1 |     Total
----------------------+----------------------+----------
EMPRESA DE GRANDE P.. |        93         40 |       133 
                      |     13.08      11.49 |     12.56 
----------------------+----------------------+----------
EMPRESA DE MÉDIO PO.. |       106         55 |       161 
                      |     14.91      15.80 |     15.20 
----------------------+----------------------+----------
        MICROENTIDADE |        76         38 |       114 
                      |     10.69      10.92 |     10.76 
----------------------+----------------------+----------
      PEQUENA EMPRESA |       436        215 |       651 
                      |     61.32      61.78 |     61.47 
----------------------+----------------------+----------
                Total |       711        348 |     1,059 
                      |    100.00     100.00 |    100.00 

. tabulate NaturezaJuridica FoiPenalizadoSTJ, row

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   FoiPenalizadoSTJ
     NaturezaJuridica |         0          1 |     Total
----------------------+----------------------+----------
201-1 - Empresa Púb.. |         5          0 |         5 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
204-6 - Sociedade A.. |        11          5 |        16 
                      |     68.75      31.25 |    100.00 
----------------------+----------------------+----------
205-4 - Sociedade A.. |        84         14 |        98 
                      |     85.71      14.29 |    100.00 
----------------------+----------------------+----------
206-2 - Sociedade E.. |       560        323 |       883 
                      |     63.42      36.58 |    100.00 
----------------------+----------------------+----------
213-5 - Empresário .. |        23          3 |        26 
                      |     88.46      11.54 |    100.00 
----------------------+----------------------+----------
  214-3 - Cooperativa |         2          0 |         2 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
215-1 - Consórcio d.. |         1          0 |         1 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
224-0 - Sociedade S.. |         2          0 |         2 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
306-9 - Fundação Pr.. |         4          3 |         7 
                      |     57.14      42.86 |    100.00 
----------------------+----------------------+----------
399-9 - Associação .. |        19          0 |        19 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
                Total |       711        348 |     1,059 
                      |     67.14      32.86 |    100.00 

. tabulate CNAE FoiPenalizadoSTJ, cell

+-----------------+
| Key             |
|-----------------|
|    frequency    |
| cell percentage |
+-----------------+

           |   FoiPenalizadoSTJ
      CNAE |         0          1 |     Total
-----------+----------------------+----------
14.12-6-01 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
16.22-6-99 |         3          0 |         3 
           |      0.28       0.00 |      0.28 
-----------+----------------------+----------
16.29-3-01 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
17.42-7-99 |         1          2 |         3 
           |      0.09       0.19 |      0.28 
-----------+----------------------+----------
22.29-3-01 |         0          4 |         4 
           |      0.00       0.38 |      0.38 
-----------+----------------------+----------
26.10-8-00 |         0          3 |         3 
           |      0.00       0.28 |      0.28 
-----------+----------------------+----------
26.21-3-00 |        11          0 |        11 
           |      1.04       0.00 |      1.04 
-----------+----------------------+----------
26.32-9-00 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
27.10-4-02 |         6          0 |         6 
           |      0.57       0.00 |      0.57 
-----------+----------------------+----------
27.31-7-00 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
27.90-2-02 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
28.24-1-01 |         0          5 |         5 
           |      0.00       0.47 |      0.47 
-----------+----------------------+----------
29.10-7-01 |         3          0 |         3 
           |      0.28       0.00 |      0.28 
-----------+----------------------+----------
31.01-2-00 |         1         19 |        20 
           |      0.09       1.79 |      1.89 
-----------+----------------------+----------
31.02-1-00 |         5          0 |         5 
           |      0.47       0.00 |      0.47 
-----------+----------------------+----------
33.12-1-02 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
33.21-0-00 |         0          4 |         4 
           |      0.00       0.38 |      0.38 
-----------+----------------------+----------
41.20-4-00 |        50         25 |        75 
           |      4.72       2.36 |      7.08 
-----------+----------------------+----------
42.13-8-00 |         0          2 |         2 
           |      0.00       0.19 |      0.19 
-----------+----------------------+----------
42.21-9-03 |         7          0 |         7 
           |      0.66       0.00 |      0.66 
-----------+----------------------+----------
42.21-9-05 |         0          6 |         6 
           |      0.00       0.57 |      0.57 
-----------+----------------------+----------
42.99-5-99 |         6          0 |         6 
           |      0.57       0.00 |      0.57 
-----------+----------------------+----------
43.21-5-00 |        14          6 |        20 
           |      1.32       0.57 |      1.89 
-----------+----------------------+----------
43.22-3-02 |         7          4 |        11 
           |      0.66       0.38 |      1.04 
-----------+----------------------+----------
43.22-3-03 |         6          3 |         9 
           |      0.57       0.28 |      0.85 
-----------+----------------------+----------
43.29-1-03 |         0          6 |         6 
           |      0.00       0.57 |      0.57 
-----------+----------------------+----------
43.29-1-99 |         0          3 |         3 
           |      0.00       0.28 |      0.28 
-----------+----------------------+----------
43.30-4-05 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
43.30-4-99 |         9          0 |         9 
           |      0.85       0.00 |      0.85 
-----------+----------------------+----------
45.11-1-01 |         5          0 |         5 
           |      0.47       0.00 |      0.47 
-----------+----------------------+----------
45.30-7-01 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
46.18-4-99 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
46.33-8-01 |         3          0 |         3 
           |      0.28       0.00 |      0.28 
-----------+----------------------+----------
46.35-4-01 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
46.39-7-01 |         3          0 |         3 
           |      0.28       0.00 |      0.28 
-----------+----------------------+----------
46.42-7-02 |         0          1 |         1 
           |      0.00       0.09 |      0.09 
-----------+----------------------+----------
46.47-8-02 |         0          8 |         8 
           |      0.00       0.76 |      0.76 
-----------+----------------------+----------
46.49-4-01 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
46.49-4-04 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
46.49-4-08 |         0         15 |        15 
           |      0.00       1.42 |      1.42 
-----------+----------------------+----------
46.49-4-99 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
46.51-6-01 |        29         13 |        42 
           |      2.74       1.23 |      3.97 
-----------+----------------------+----------
46.52-4-00 |        16          8 |        24 
           |      1.51       0.76 |      2.27 
-----------+----------------------+----------
46.61-3-00 |         0          2 |         2 
           |      0.00       0.19 |      0.19 
-----------+----------------------+----------
46.63-0-00 |         0          1 |         1 
           |      0.00       0.09 |      0.09 
-----------+----------------------+----------
46.65-6-00 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
46.69-9-99 |         0          5 |         5 
           |      0.00       0.47 |      0.47 
-----------+----------------------+----------
46.81-8-01 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
46.86-9-02 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
46.87-7-01 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
47.12-1-00 |         0          2 |         2 
           |      0.00       0.19 |      0.19 
-----------+----------------------+----------
47.29-6-99 |         9          0 |         9 
           |      0.85       0.00 |      0.85 
-----------+----------------------+----------
47.44-0-01 |         0          6 |         6 
           |      0.00       0.57 |      0.57 
-----------+----------------------+----------
47.44-0-02 |         0          4 |         4 
           |      0.00       0.38 |      0.38 
-----------+----------------------+----------
47.44-0-99 |         0          5 |         5 
           |      0.00       0.47 |      0.47 
-----------+----------------------+----------
47.51-2-01 |        32         22 |        54 
           |      3.02       2.08 |      5.10 
-----------+----------------------+----------
47.52-1-00 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
47.53-9-00 |         6          0 |         6 
           |      0.57       0.00 |      0.57 
-----------+----------------------+----------
47.54-7-01 |         7          4 |        11 
           |      0.66       0.38 |      1.04 
-----------+----------------------+----------
47.59-8-99 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
47.84-9-00 |         0          1 |         1 
           |      0.00       0.09 |      0.09 
-----------+----------------------+----------
47.89-0-05 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
47.89-0-09 |         3          0 |         3 
           |      0.28       0.00 |      0.28 
-----------+----------------------+----------
47.89-0-99 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
49.21-3-01 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
52.40-1-01 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
56.11-2-01 |         7          0 |         7 
           |      0.66       0.00 |      0.66 
-----------+----------------------+----------
56.20-1-01 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
59.11-1-99 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
61.10-8-01 |         7          5 |        12 
           |      0.66       0.47 |      1.13 
-----------+----------------------+----------
61.10-8-03 |         3          3 |         6 
           |      0.28       0.28 |      0.57 
-----------+----------------------+----------
61.20-5-01 |         7          0 |         7 
           |      0.66       0.00 |      0.66 
-----------+----------------------+----------
61.20-5-02 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
61.90-6-99 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
62.01-5-01 |        27         10 |        37 
           |      2.55       0.94 |      3.49 
-----------+----------------------+----------
62.02-3-00 |        15          2 |        17 
           |      1.42       0.19 |      1.61 
-----------+----------------------+----------
62.03-1-00 |        20          8 |        28 
           |      1.89       0.76 |      2.64 
-----------+----------------------+----------
62.04-0-00 |        58          0 |        58 
           |      5.48       0.00 |      5.48 
-----------+----------------------+----------
62.09-1-00 |        47         39 |        86 
           |      4.44       3.68 |      8.12 
-----------+----------------------+----------
63.11-9-00 |         3          0 |         3 
           |      0.28       0.00 |      0.28 
-----------+----------------------+----------
63.19-4-00 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
63.99-2-00 |         0          2 |         2 
           |      0.00       0.19 |      0.19 
-----------+----------------------+----------
66.13-4-00 |         0          5 |         5 
           |      0.00       0.47 |      0.47 
-----------+----------------------+----------
66.21-5-02 |         0          7 |         7 
           |      0.00       0.66 |      0.66 
-----------+----------------------+----------
70.20-4-00 |        11          0 |        11 
           |      1.04       0.00 |      1.04 
-----------+----------------------+----------
71.11-1-00 |         1          0 |         1 
           |      0.09       0.00 |      0.09 
-----------+----------------------+----------
71.12-0-00 |        22          4 |        26 
           |      2.08       0.38 |      2.46 
-----------+----------------------+----------
73.11-4-00 |         0          3 |         3 
           |      0.00       0.28 |      0.28 
-----------+----------------------+----------
73.20-3-00 |         3          0 |         3 
           |      0.28       0.00 |      0.28 
-----------+----------------------+----------
74.20-0-04 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
74.90-1-04 |         1          5 |         6 
           |      0.09       0.47 |      0.57 
-----------+----------------------+----------
74.90-1-99 |         0          4 |         4 
           |      0.00       0.38 |      0.38 
-----------+----------------------+----------
77.33-1-00 |         7          6 |        13 
           |      0.66       0.57 |      1.23 
-----------+----------------------+----------
77.39-0-03 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
77.39-0-99 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
78.10-8-00 |         6          0 |         6 
           |      0.57       0.00 |      0.57 
-----------+----------------------+----------
78.20-5-00 |         8          0 |         8 
           |      0.76       0.00 |      0.76 
-----------+----------------------+----------
78.30-2-00 |        11         16 |        27 
           |      1.04       1.51 |      2.55 
-----------+----------------------+----------
79.11-2-00 |        23          0 |        23 
           |      2.17       0.00 |      2.17 
-----------+----------------------+----------
80.11-1-01 |        11         12 |        23 
           |      1.04       1.13 |      2.17 
-----------+----------------------+----------
81.21-4-00 |         4          8 |        12 
           |      0.38       0.76 |      1.13 
-----------+----------------------+----------
81.29-0-00 |         6          0 |         6 
           |      0.57       0.00 |      0.57 
-----------+----------------------+----------
81.30-3-00 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
82.11-3-00 |        16          0 |        16 
           |      1.51       0.00 |      1.51 
-----------+----------------------+----------
82.20-2-00 |        13         10 |        23 
           |      1.23       0.94 |      2.17 
-----------+----------------------+----------
82.30-0-01 |        24          0 |        24 
           |      2.27       0.00 |      2.27 
-----------+----------------------+----------
82.99-7-99 |        12          0 |        12 
           |      1.13       0.00 |      1.13 
-----------+----------------------+----------
85.31-7-00 |         3          0 |         3 
           |      0.28       0.00 |      0.28 
-----------+----------------------+----------
85.32-5-00 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
85.50-3-02 |         2          3 |         5 
           |      0.19       0.28 |      0.47 
-----------+----------------------+----------
85.93-7-00 |         0          7 |         7 
           |      0.00       0.66 |      0.66 
-----------+----------------------+----------
85.99-6-04 |         5          0 |         5 
           |      0.47       0.00 |      0.47 
-----------+----------------------+----------
86.30-5-06 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
86.50-0-01 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
86.60-7-00 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
88.00-6-00 |         6          0 |         6 
           |      0.57       0.00 |      0.57 
-----------+----------------------+----------
90.01-9-02 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
93.19-1-01 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
94.30-8-00 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
94.99-5-00 |         6          0 |         6 
           |      0.57       0.00 |      0.57 
-----------+----------------------+----------
96.01-7-01 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
     Total |       711        348 |     1,059 
           |     67.14      32.86 |    100.00 

. 
. /*******************************************************************************
> 1.1.2 Matriz de Correlação das Variáveis Contínuas (STATA + Heatmap)
> *******************************************************************************/
. 
. * 1. Defina as variáveis contínuas 
. local var_continuas LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos

. 
. * 2. Calcule a matriz de correlação em Stata
. correlate `var_continuas', means
(obs=780)

    Variable |         Mean    Std. dev.          Min          Max
-------------+----------------------------------------------------
 LiqCorrente |     11.28151     61.28682            0      1104.44
    LiqGeral |     9.142423      55.0596            0      1104.67
 LiqCorAjust |     .4014132     .3133588      -2.4927            1
   SolvGeral |     10.18351       56.918            0      1109.62
    EndGeral |     .4796026     .3165419            0        4.205
 CompEndivid |     .7776619     .2535781            0            1
    IndepFin |     9.186163     56.91749       -.7622     1108.622
    ImobilPL |     .1744862      3.59959     -95.5357       9.1728
   ImobRecNC |     .2136456     .2580113       -.2471       1.4847
 PtpCapTerce |     1.243431     8.771135    -208.1876      34.6218
   GiroAtivo |     1.586967     1.417253       -.0289      16.0742
      MargOp |     .9158049     12.49476      -1.4199     348.9034
     MargLiq |      .184405      2.37027     -14.1571      60.8893
         ROI |     .1318168     .9917547      -25.837       3.2885
         ROE |     .4433245     2.751681      -3.9973      70.7696
 vlrcontrato |     1.19e+07     2.33e+07       1171.2     1.34e+08
QtdeCNAEsS~s |     13.84231     12.68304            1           97
 IdadedeAnos |     23.69373     10.84994     .6575342     59.04657
QtePenalOu~s |     5.041026     19.68503            0          201


             | LiqCor~e LiqGeral LiqCor~t SolvGe~l EndGeral CompEn~d IndepFin ImobilPL ImobRe~C PtpCap~e GiroAt~o   MargOp  MargLiq      ROI      ROE vlrcon~o QtdeCN~s Idaded~s QtePen~s
-------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 LiqCorrente |   1.0000
    LiqGeral |   0.8984   1.0000
 LiqCorAjust |   0.2501   0.2261   1.0000
   SolvGeral |   0.8947   0.9954   0.2235   1.0000
    EndGeral |  -0.1958  -0.2037  -0.7164  -0.2160   1.0000
 CompEndivid |   0.0047   0.1132   0.1371   0.1150  -0.2415   1.0000
    IndepFin |   0.8947   0.9954   0.2235   1.0000  -0.2161   0.1149   1.0000
    ImobilPL |  -0.0030  -0.0043  -0.0080  -0.0029  -0.0432   0.0582  -0.0029   1.0000
   ImobRecNC |  -0.0884  -0.0861  -0.4749  -0.0694   0.0710  -0.1912  -0.0695   0.0712   1.0000
 PtpCapTerce |  -0.0167  -0.0194  -0.0364  -0.0209   0.0604   0.0870  -0.0209   0.9169  -0.0121   1.0000
   GiroAtivo |  -0.0398  -0.0349   0.0571  -0.0403   0.0427   0.1841  -0.0404   0.0236  -0.1476   0.0474   1.0000
      MargOp |  -0.0034  -0.0030  -0.0583  -0.0031   0.0312  -0.0590  -0.0031   0.0334   0.0879   0.0137  -0.0423   1.0000
     MargLiq |   0.0070   0.0071  -0.0260   0.0068   0.0298  -0.0445   0.0068   0.0350   0.0618   0.0194  -0.0481   0.9274   1.0000
         ROI |   0.0429   0.0346   0.2338   0.0331  -0.1714   0.0379   0.0331   0.0014  -0.0360   0.0170   0.1441   0.0019   0.2298   1.0000
         ROE |   0.0185  -0.0039  -0.1179  -0.0055   0.1137   0.0472  -0.0055  -0.0441  -0.0711  -0.0595   0.1604  -0.0025  -0.1813  -0.7647   1.0000
 vlrcontrato |  -0.0598  -0.0521  -0.0641  -0.0559   0.0895  -0.0820  -0.0560  -0.0347  -0.0801  -0.0134   0.1102  -0.0168  -0.0311  -0.0631   0.0363   1.0000
QtdeCNAEsS~s |  -0.0080  -0.0025   0.0598  -0.0029  -0.0234  -0.1594  -0.0029   0.0284  -0.0371   0.0030  -0.0695   0.0489   0.0360  -0.0417  -0.0129   0.0341   1.0000
 IdadedeAnos |  -0.0652  -0.0691  -0.2063  -0.0679   0.1316  -0.1960  -0.0680   0.0513   0.1409  -0.0083  -0.0827   0.0291   0.0260  -0.0396  -0.0163   0.3070  -0.0391   1.0000
QtePenalOu~s |   0.0004   0.0087  -0.1340   0.0068   0.0849  -0.1558   0.0068   0.0728   0.1866   0.0228  -0.0737   0.3600   0.3193  -0.0228  -0.0089  -0.0121   0.1280   0.1319   1.0000


. matrix C = r(C)

. 
. * 3. Gere o heatmap com o pacote heatplot
. 
. heatplot C, ///
>     color(RdBu) ///
>     legend(on) aspectratio(1) ///
>     xlabel(, labsize(vsmall) angle(45)) ///
>     ylabel(, labsize(vsmall)) ///
>     title("Matriz de Correlação das Variáveis Contínuas")

. 
. * 4. Salve o gráfico
. graph export "heatmap_correlacao.png", replace width(2400)
(file heatmap_correlacao.png not found)
file heatmap_correlacao.png saved as PNG format

. 
. 
. */*******************************************************************************
> 1.2 – Winsorização das variáveis contínuas (antes da imputação)
> *******************************************************************************/
. 
. * Substituir todos os valores missing (.) de vlrcontrato por 0
. replace vlrcontrato = 0 if missing(vlrcontrato)
(279 real changes made)

. 
. ssc install winsor2, replace
checking winsor2 consistency and verifying not already installed...
all files already exist and are up to date.

. local winsor_vars LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato

. 
. foreach var of local winsor_vars {
  2.     winsor2 `var', cuts(1 99) replace
  3. }

. 
. /*******************************************************************************
> 1.3 - Executar estatísticas descritivas para todas as variáveis após wisorização
> *******************************************************************************/
. summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |      1,059    10.73342    39.50825        .21     327.68
    LiqGeral |      1,059    7.666534    25.45648        .19      204.2
 LiqCorAjust |      1,059    .4306592    .2926811     -.4339      .9979
   SolvGeral |      1,059    10.06802    37.29735        .34     327.68
    EndGeral |      1,059    .4431056     .279712      .0009     1.2352
-------------+---------------------------------------------------------
 CompEndivid |      1,059    .7839054    .2543558      .0217          1
    IndepFin |      1,059     9.07415    37.29532     -.2428    326.675
    ImobilPL |      1,059    .2883165    .4354211     -.2471     2.8281
   ImobRecNC |      1,059    .2035592    .2416978          0      .9662
 PtpCapTerce |      1,059    1.480069    2.641462    -5.2517    16.7327
-------------+---------------------------------------------------------
   GiroAtivo |      1,059    1.535132    1.323401          0     6.2322
      MargOp |      1,059    .4304541     .341005      -.091     1.0834
     MargLiq |      1,059    .0995546    .3278541    -1.9267     1.0026
         ROI |      1,059    .1785404    .3350155     -.4796     2.0039
         ROE |      1,059    .3440155    .7171462    -1.3584      5.064
-------------+---------------------------------------------------------
 vlrcontrato |      1,059     8762142    2.06e+07          0   1.32e+08
QtdeCNAEsS~s |      1,059    15.58735    14.29617          1         97
 IdadedeAnos |      1,059    22.58384    10.87858   .6575342   59.04658
QtePenalOu~s |      1,059    5.515581    20.56137          0        201

. 
. * Estatísticas descritivas separadas por penalização
. by FoiPenalizadoSTJ, sort: summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrga
> os

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        711    12.90316    44.16142        .21     327.68
    LiqGeral |        711    8.926639     27.9869        .19      204.2
 LiqCorAjust |        711    .4361148    .2975651     -.4339      .9979
   SolvGeral |        711    11.86361    41.25855        .34     327.68
    EndGeral |        711    .4257158    .2793904      .0009     1.2352
-------------+---------------------------------------------------------
 CompEndivid |        711     .784599    .2657318      .0217          1
    IndepFin |        711    10.86993    41.25632     -.2428    326.675
    ImobilPL |        711    .3115198    .4567453     -.2471     2.8281
   ImobRecNC |        711    .2165141    .2468355          0      .9662
 PtpCapTerce |        711    1.463795    2.634264    -5.2517    16.7327
-------------+---------------------------------------------------------
   GiroAtivo |        711    1.507098    1.302136          0     6.2322
      MargOp |        711    .4422657    .3387496      -.091     1.0834
     MargLiq |        711     .110699    .3215239    -1.9267     1.0026
         ROI |        711    .1976205    .3611393     -.4796     2.0039
         ROE |        711    .3705592    .7326326    -1.3584      5.064
-------------+---------------------------------------------------------
 vlrcontrato |        711     8956215    2.02e+07          0   1.32e+08
QtdeCNAEsS~s |        711    16.03376     15.0676          1         97
 IdadedeAnos |        711    22.53408    11.12895   .6575342   59.04658
QtePenalOu~s |        711     4.31083    20.40403          0        201

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        348    6.300402    27.19254        .21     327.68
    LiqGeral |        348    5.092011    19.06029        .19      204.2
 LiqCorAjust |        348    .4195129    .2825334     -.4339      .9979
   SolvGeral |        348    6.399425    27.17167        .34     327.68
    EndGeral |        348    .4786348    .2773924      .0009     1.2352
-------------+---------------------------------------------------------
 CompEndivid |        348    .7824882    .2297269      .0217          1
    IndepFin |        348     5.40518    27.17002     -.2428    326.675
    ImobilPL |        348    .2409098    .3845182     -.2471     2.8281
   ImobRecNC |        348    .1770911    .2289195          0      .9662
 PtpCapTerce |        348    1.513318    2.659603    -5.2517    16.7327
-------------+---------------------------------------------------------
   GiroAtivo |        348    1.592409    1.365932          0     6.2322
      MargOp |        348    .4063218    .3447991      -.091     1.0834
     MargLiq |        348    .0767853    .3397565    -1.9267     1.0026
         ROI |        348    .1395578    .2703292     -.4796     2.0039
         ROE |        348    .2897839    .6822379    -1.3584      5.064
-------------+---------------------------------------------------------
 vlrcontrato |        348     8365633    2.15e+07          0   1.32e+08
QtdeCNAEsS~s |        348    14.67529    12.54506          1         58
 IdadedeAnos |        348    22.68549    10.36315   3.635616   58.88493
QtePenalOu~s |        348    7.977011    20.69121          0        175


. 
. * Bloco para salvar as estatísticas descritivas após a winsorização por grupo
. tabstat LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos, ///
>     statistics(mean sd min max n) by(FoiPenalizadoSTJ)

Summary statistics: Mean, SD, Min, Max, N
Group variable: FoiPenalizadoSTJ (FoiPenalizadoSTJ)

FoiPenalizadoSTJ |  LiqCor~e  LiqGeral  LiqCor~t  SolvGe~l  EndGeral  CompEn~d  IndepFin  ImobilPL  ImobRe~C  PtpCap~e  GiroAt~o    MargOp   MargLiq       ROI       ROE  vlrcon~o  QtdeCN~s  Idaded~s  QtePen~s
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
               0 |  12.90316  8.926639  .4361148  11.86361  .4257158   .784599  10.86993  .3115198  .2165141  1.463795  1.507098  .4422657   .110699  .1976205  .3705592   8956215  16.03376  22.53408   4.31083
                 |  44.16142   27.9869  .2975651  41.25855  .2793904  .2657318  41.25632  .4567453  .2468355  2.634264  1.302136  .3387496  .3215239  .3611393  .7326326  2.02e+07   15.0676  11.12895  20.40403
                 |       .21       .19    -.4339       .34     .0009     .0217    -.2428    -.2471         0   -5.2517         0     -.091   -1.9267    -.4796   -1.3584         0         1  .6575342         0
                 |    327.68     204.2     .9979    327.68    1.2352         1   326.675    2.8281     .9662   16.7327    6.2322    1.0834    1.0026    2.0039     5.064  1.32e+08        97  59.04658       201
                 |       711       711       711       711       711       711       711       711       711       711       711       711       711       711       711       711       711       711       711
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
               1 |  6.300402  5.092011  .4195129  6.399425  .4786348  .7824882   5.40518  .2409098  .1770911  1.513318  1.592409  .4063218  .0767853  .1395578  .2897839   8365633  14.67529  22.68549  7.977011
                 |  27.19254  19.06029  .2825334  27.17167  .2773924  .2297269  27.17002  .3845182  .2289195  2.659603  1.365932  .3447991  .3397565  .2703292  .6822379  2.15e+07  12.54506  10.36315  20.69121
                 |       .21       .19    -.4339       .34     .0009     .0217    -.2428    -.2471         0   -5.2517         0     -.091   -1.9267    -.4796   -1.3584         0         1  3.635616         0
                 |    327.68     204.2     .9979    327.68    1.2352         1   326.675    2.8281     .9662   16.7327    6.2322    1.0834    1.0026    2.0039     5.064  1.32e+08        58  58.88493       175
                 |       348       348       348       348       348       348       348       348       348       348       348       348       348       348       348       348       348       348       348
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
           Total |  10.73342  7.666534  .4306592  10.06802  .4431056  .7839054   9.07415  .2883165  .2035592  1.480069  1.535132  .4304541  .0995546  .1785404  .3440155   8762142  15.58735  22.58384  5.515581
                 |  39.50825  25.45648  .2926811  37.29735   .279712  .2543558  37.29532  .4354211  .2416978  2.641462  1.323401   .341005  .3278541  .3350155  .7171462  2.06e+07  14.29617  10.87858  20.56137
                 |       .21       .19    -.4339       .34     .0009     .0217    -.2428    -.2471         0   -5.2517         0     -.091   -1.9267    -.4796   -1.3584         0         1  .6575342         0
                 |    327.68     204.2     .9979    327.68    1.2352         1   326.675    2.8281     .9662   16.7327    6.2322    1.0834    1.0026    2.0039     5.064  1.32e+08        97  59.04658       201
                 |      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059      1059
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

. 
. /*******************************************************************************
> ETAPA 2 - TRANSFORMAÇÃO DE VARIÁVEIS 
> *******************************************************************************/
. 
. * Dropar CNPJ antes de exportar
. drop CNPJ

. 
. 
. /*******************************************************************************
> 2.1 - Imputação dos valores faltantes (missing) com a média ou mediana 
> *******************************************************************************/
. 
. * Lista de variáveis com dados faltantes para imputação
. local imput_vars GiroAtivo MargOp MargLiq ROI ROE RecBruta LucroBruto LucroLiquido

. 
. * Inicializar contadores
. local conta_media = 0

. local conta_mediana = 0

. 
. * Imputação adaptativa: média se CV <= 0.3, mediana se CV > 0.3
. foreach var of local imput_vars {
  2.     
.     quietly summarize `var' if `var' > 0, detail
  3.     local media = r(mean)
  4.     local desvio = r(sd)
  5.     local mediana = r(p50)
  6. 
.     * Calcular o Coeficiente de Variação (CV)
.     local cv = `desvio' / `media'
  7. 
.     * Escolher método conforme o CV
.     if `cv' <= 0.3 {
  8.         replace `var' = `media' if missing(`var') | `var' == 0
  9.         local conta_media = `conta_media' + 1
 10.         di as result "🔧 `var': imputado com MÉDIA (CV = " %4.3f `cv' ")"
 11.     }
 12.     else {
 13.         replace `var' = `mediana' if missing(`var') | `var' == 0
 14.         local conta_mediana = `conta_mediana' + 1
 15.         di as result "🔧 `var': imputado com MEDIANA (CV = " %4.3f `cv' ")"
 16.     }
 17. }
(105 real changes made)
🔧 GiroAtivo: imputado com MEDIANA (CV = 0.755)
(145 real changes made)
🔧 MargOp: imputado com MEDIANA (CV = 0.607)
(107 real changes made)
🔧 MargLiq: imputado com MEDIANA (CV = 1.170)
(87 real changes made)
🔧 ROI: imputado com MEDIANA (CV = 1.376)
(87 real changes made)
🔧 ROE: imputado com MEDIANA (CV = 1.516)
(104 real changes made)
🔧 RecBruta: imputado com MEDIANA (CV = 6.741)
(135 real changes made)
🔧 LucroBruto: imputado com MEDIANA (CV = 7.187)
(86 real changes made)
🔧 LucroLiquido: imputado com MEDIANA (CV = 7.806)

. 
. * Exibir tabela resumo
. di as text "═══════════════════════════════════════════════════════════════"
═══════════════════════════════════════════════════════════════

. di as text " Resumo da Imputação de Variáveis (Critério: CV <= 0.3 → MÉDIA)"
 Resumo da Imputação de Variáveis (Critério: CV <= 0.3 → MÉDIA)

. di as text "───────────────────────────────────────────────────────────────"
───────────────────────────────────────────────────────────────

. di " Variáveis imputadas com MÉDIA:   `conta_media'"
 Variáveis imputadas com MÉDIA:   0

. di " Variáveis imputadas com MEDIANA: `conta_mediana'"
 Variáveis imputadas com MEDIANA: 8

. di as text " Total de variáveis imputadas:    " `=`conta_media' + `conta_mediana''
 Total de variáveis imputadas:    8

. di as text "═══════════════════════════════════════════════════════════════"
═══════════════════════════════════════════════════════════════

. 
. /*******************************************************************************
> 2.2 - Criação dos Índices Sintéticos (Z-SCORE)
> *******************************************************************************/
. 
. /* (A) Liquidez_Media: combina LiqCorrente, LiqGeral, SolvGeral e IndepFin */
. foreach var in LiqCorrente LiqGeral SolvGeral IndepFin {
  2.     egen z_`var' = std(`var')
  3. }

. gen Liquidez_Media_Z = (z_LiqCorrente + z_LiqGeral + z_SolvGeral + z_IndepFin)/4

. 
. /* (B) Estrutura_Media: combina ImobilPL e PtpCapTerce  */
. foreach var in ImobilPL PtpCapTerce {
  2.     egen z_`var' = std(`var')
  3. }

. gen Estrutura_Media_Z = (z_ImobilPL + z_PtpCapTerce)/2

. 
. /* (C) Margem_Media: combina MargOp e MargLiq */
. egen z_MargOp = std(MargOp)

. egen z_MargLiq = std(MargLiq)

. gen Margem_Media_Z = (z_MargOp + z_MargLiq)/2

. 
. /* Padronize as variáveis contínuas que ficarão SEPARADAS */
. egen z_LiqCorAjust = std(LiqCorAjust)

. egen z_EndGeral = std(EndGeral)

. egen z_ImobRecNC   = std(ImobRecNC)

. egen z_CompEndivid = std(CompEndivid)

. egen z_GiroAtivo   = std(GiroAtivo)

. egen z_ROI         = std(ROI)

. egen z_ROE         = std(ROE)

. egen z_log_vlrcontrato = std(vlrcontrato)

. egen z_QtdeCNAEsSecundarios = std(QtdeCNAEsSecundarios)

. egen z_QtePenalOutrosOrgaos = std(QtePenalOutrosOrgaos)

. egen z_IdadedeAnos = std(IdadedeAnos)

. 
. 
. 
. /*******************************************************************************
> 2.2.2 - Matriz de correlação dos índices sintéticos (e outras variáveis contínuas)
> *******************************************************************************/
. 
. /* Defina as variáveis contínuas finais para correlação */
. local correl_final Liquidez_Media_Z Estrutura_Media_Z Margem_Media_Z ///
>     z_LiqCorAjust z_EndGeral z_ImobRecNC z_CompEndivid z_GiroAtivo ///
>     z_ROI z_ROE z_log_vlrcontrato z_QtdeCNAEsSecundarios z_QtePenalOutrosOrgaos z_IdadedeAnos

. 
. /* Calcule a matriz de correlação */
. correlate `correl_final', means
(obs=1,059)

    Variable |         Mean    Std. dev.          Min          Max
-------------+----------------------------------------------------
Liquidez_M~Z |     3.70e-09     .9669267    -.2676744     8.193542
Estrutura_~Z |    -1.81e-09     .8247517    -1.889076     5.320185
Margem_Med~Z |    -1.82e-09     .8076197    -4.119213     2.363331
z_LiqCorAj~t |     3.27e-10            1    -2.953929     1.938085
  z_EndGeral |    -1.22e-09            1    -1.580932     2.831822
 z_ImobRecNC |     1.81e-09            1    -.8422054     3.155348
z_CompEndi~d |    -1.98e-09            1    -2.996611     .8495762
 z_GiroAtivo |    -1.18e-09            1    -1.366008     3.721811
       z_ROI |    -4.81e-10            1     -2.01826     5.479094
       z_ROE |     1.54e-09            1    -2.427971     6.613838
z_log_vlrc~o |     5.63e-09            1    -.4256513     5.973778
z_QtdeCNAE~s |    -2.64e-09            1    -1.020367     5.694716
z_QtePenal~s |     2.60e-09            1    -.2682497     9.507364
z_IdadedeA~s |    -1.79e-09            1    -2.015549     3.351793


             | Liquid~Z Estrut~Z Margem~Z z_LiqC~t z_EndG~l z_Imob~C z_Comp~d z_Giro~o    z_ROI    z_ROE z_log_~o z_Qtde~s z_QteP~s z_Idad~s
-------------+------------------------------------------------------------------------------------------------------------------------------
Liquidez_M~Z |   1.0000
Estrutura_~Z |  -0.1482   1.0000
Margem_Med~Z |   0.2128  -0.1232   1.0000
z_LiqCorAj~t |   0.3415  -0.4876   0.3313   1.0000
  z_EndGeral |  -0.3424   0.4608  -0.4074  -0.6728   1.0000
 z_ImobRecNC |  -0.1240   0.5193  -0.0941  -0.5167   0.1074   1.0000
z_CompEndi~d |   0.1303  -0.2257   0.1309   0.1297  -0.2352  -0.1869   1.0000
 z_GiroAtivo |  -0.0850  -0.0840  -0.0917   0.0478   0.0959  -0.1549   0.1753   1.0000
       z_ROI |   0.1351  -0.1872   0.4639   0.3390  -0.2954  -0.1999   0.1974   0.3874   1.0000
       z_ROE |   0.0221  -0.1252   0.1586   0.0611   0.0561  -0.0990   0.0990   0.3599   0.7352   1.0000
z_log_vlrc~o |  -0.0745   0.0001  -0.0979  -0.0891   0.1336  -0.0511  -0.0775   0.1055  -0.0567  -0.0287   1.0000
z_QtdeCNAE~s |  -0.0045  -0.0464  -0.0014   0.0741  -0.0604  -0.0239  -0.0979  -0.0106  -0.0336  -0.0494  -0.0262   1.0000
z_QtePenal~s |  -0.0277   0.2249  -0.0376  -0.1182   0.0835   0.1362  -0.0912   0.0036  -0.0691  -0.0551  -0.0193   0.1868   1.0000
z_IdadedeA~s |  -0.1425   0.1006  -0.1894  -0.2115   0.1632   0.1669  -0.1685  -0.0192  -0.1639  -0.0576   0.2980  -0.0794   0.1119   1.0000


. matrix C = r(C)

. 
. /* Gere o heatmap (se tiver heatplot instalado) */
. heatplot C, ///
>     color(RdBu) ///
>     legend(on) aspectratio(1) ///
>     xlabel(, labsize(vsmall) angle(45)) ///
>     ylabel(, labsize(vsmall)) ///
>     title("Matriz de Correlação dos Indicadores Sintéticos e Contínuos")

. 
. graph export "heatmap_correlacao_indices.png", replace width(2400)
(file heatmap_correlacao_indices.png not found)
file heatmap_correlacao_indices.png saved as PNG format

. 
. 
. /*******************************************************************************
> ETAPA 3 - SEPARAÇÃO DOS DADOS EM CONJUNTOS DE TREINAMENTO E TESTE COM PROPORÇÕES EXATAS
> *******************************************************************************/
. * Definir uma seed para reprodutibilidade
. set seed 12345

. 
. * Gerar uma variável aleatória uniforme entre 0 e 1
. generate u = runiform()

. 
. * Ordenar aleatoriamente dentro de cada classe
. sort FoiPenalizadoSTJ u

. 
. * Gerar índices de observação dentro de cada classe
. by FoiPenalizadoSTJ: gen obs_no = _n

. by FoiPenalizadoSTJ: gen total_obs = _N

. 
. * Calcular o ponto de corte para 80% das observações
. by FoiPenalizadoSTJ: gen cutoff = ceil(0.80 * total_obs)

. 
. * Criar o indicador de treinamento
. gen train = 0

. replace train = 1 if obs_no <= cutoff
(848 real changes made)

. 
. * Verificar distribuição antes do SMOTE
. tabulate FoiPenalizadoSTJ train

FoiPenaliz |         train
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       142        569 |       711 
         1 |        69        279 |       348 
-----------+----------------------+----------
     Total |       211        848 |     1,059 

. 
. /*******************************************************************************
> ETAPA 3.1 - SALVAR OS LABELS PARA RESTAURAR DEPOIS DO SMOTE
> *******************************************************************************/
. * Criar um arquivo temporário para armazenar labels
. tempfile labels_backup

. label save using "`labels_backup'.do", replace
file C:\Users\morenos\AppData\Local\Temp\ST_10190_000001.tmp.do saved

. 
. /*******************************************************************************
> ETAPA 3.2 - EXPORTAR BASES PARA O PYTHON (TREINO PARA SMOTE, TESTE SEPARADO)
> *******************************************************************************/
. * Exportar conjunto de treino
. preserve

. keep if train == 1
(211 observations deleted)

. export delimited using "train_data.csv", replace
(file train_data.csv not found)
file train_data.csv saved

. restore

. 
. * Exportar conjunto de teste
. preserve

. keep if train == 0
(848 observations deleted)

. export delimited using "test_data.csv", replace
(file test_data.csv not found)
file test_data.csv saved

. restore

. 
. /*******************************************************************************
> ETAPA 4 - APLICAR SMOTENC NO PYTHON
> *******************************************************************************/
. python:
----------------------------------------------- python (type end to exit) ---------------------------------------------------------------------------------------------------------------------------------------------------------------------
>>> import pandas as pd
>>> import numpy as np
>>> from imblearn.over_sampling import SMOTENC
>>> import traceback  # Para melhor tratamento de erros
>>> 
>>> print("--- Iniciando Bloco Python ---")
--- Iniciando Bloco Python ---
>>> try:
...     # Carregar conjunto de treino do Stata
...     print("Carregando train_data.csv...")
...     df = pd.read_csv("train_data.csv")
...     print(f"Dados carregados: {df.shape[0]} linhas, {df.shape[1]} colunas")
...     print("Colunas originais:", df.columns.tolist())
...     print("Contagem inicial de 'FoiPenalizadoSTJ':\n", df["FoiPenalizadoSTJ"].value_counts())
... 
...     # Separar variável-alvo e explicativas
...     X = df.drop(columns=["FoiPenalizadoSTJ", "train"], errors="ignore")
...     y = df["FoiPenalizadoSTJ"]
... 
...     # Definir variáveis categóricas PELOS NOMES (mais robusto)
...     categorical_feature_names = ['Porte', 'CNAE', 'DivisaoCNAE', 'NaturezaJuridica']
... 
...     # Verificar se as colunas existem em X
...     missing_cols = [col for col in categorical_feature_names if col not in X.columns]
...     if missing_cols:
...         raise ValueError(f"As seguintes colunas categóricas não foram encontradas em X: {missing_cols}")
... 
...     # Obter os índices das colunas categóricas
...     categorical_features_indices = [X.columns.get_loc(col) for col in categorical_feature_names]
...     print(f"Índices das features categóricas: {categorical_features_indices}")
...     print("Tipos das features categóricas em X:\n", X[categorical_feature_names].dtypes)
... 
...     # Ajustar k_neighbors: deve ser menor que o número de amostras da classe minoritária
...     min_class_count = y.value_counts().min()
...     k_neighbors_val = min(5, min_class_count - 1)
...     if k_neighbors_val < 1:
...         print(f"AVISO: Classe minoritária tem apenas {min_class_count} amostras. Não é possível aplicar SMOTENC com k_neighbors >= 1.")
...         raise ValueError(f"Não é possível aplicar SMOTENC, k_neighbors ({k_neighbors_val}) seria menor que 1.")
...     else:
...         print(f"Aplicando SMOTENC com k_neighbors={k_neighbors_val}...")
...         smote_nc = SMOTENC(categorical_features=categorical_features_indices,
...                            random_state=42,
...                            k_neighbors=k_neighbors_val)
... 
...         X_resampled, y_resampled = smote_nc.fit_resample(X, y)
...         print("SMOTENC concluído.")
...         print(f"Tamanho após resample: {X_resampled.shape[0]} linhas")
...         print("Contagem de 'FoiPenalizadoSTJ' após resample:\n", pd.Series(y_resampled).value_counts())
... 
...         # Criar DataFrame balanceado a partir do resultado do SMOTENC
...         df_resampled = pd.DataFrame(X_resampled, columns=X.columns)
... 
...         # Adicionar a variável alvo e a marcação de treino
...         df_resampled["FoiPenalizadoSTJ"] = y_resampled
...         df_resampled["train"] = 1
... 
...         # Verificar se as colunas categóricas foram mantidas
...         print("Colunas no df_resampled final:", df_resampled.columns.tolist())
...         missing_cols_after = [col for col in categorical_feature_names if col not in df_resampled.columns]
...         if missing_cols_after:
...             print(f"AVISO: As colunas {missing_cols_after} NÃO estão presentes após SMOTENC!")
...         else:
...             print("Colunas categóricas presentes após SMOTENC.")
...             print("Tipos das features categóricas após SMOTENC:\n", df_resampled[categorical_feature_names].dtypes)
...             print("Primeiras linhas do df_resampled:\n", df_resampled.head())
... 
...         # 🔁 Converter variáveis categóricas e salvar mapeamentos
...         print("Convertendo variáveis categóricas do treino para códigos numéricos e salvando mapeamentos...")
... 
...         categorical_mappings = {}
... 
...         for col in categorical_feature_names:
...             df_resampled[col] = df_resampled[col].astype("category")
... 
...             # Salvar mapeamento antes de converter para códigos
...             mapping = dict(enumerate(df_resampled[col].cat.categories))
...             categorical_mappings[col] = mapping
... 
...             # Substituir coluna por códigos numéricos
...             df_resampled[col] = df_resampled[col].cat.codes
... 
...             # Exportar mapeamento para CSV
...             mapping_df = pd.DataFrame(mapping.items(), columns=[f"{col}_code", f"{col}_label"])
...             mapping_df.to_csv(f"{col}_mapping.csv", index=False, encoding="utf-8")
...             print(f"✅ Mapeamento salvo: {col}_mapping.csv")
... 
...         print("Conversão no treino concluída.")
... 
...     # Salvar dataset balanceado em CSV (codificado em UTF-8)
...     print("Salvando train_data_balanced.csv...")
...     df_resampled.to_csv("train_data_balanced.csv", index=False, encoding='utf-8')
...     print("Arquivo train_data_balanced.csv salvo com sucesso.")
... 
...     # ────────────────────────────────────────────────────────────────────────
...     # ✅ ETAPA EXTRA: Converter variáveis categóricas do conjunto de teste com os mesmos códigos do treino
...     print("Carregando test_data.csv para conversão das variáveis categóricas...")
...     df_test = pd.read_csv("test_data.csv")
...     print(f"Conjunto de teste carregado: {df_test.shape[0]} linhas")
... 
...     # Verificar se as colunas categóricas estão presentes
...     missing_test_cols = [col for col in categorical_feature_names if col not in df_test.columns]
...     if missing_test_cols:
...         raise ValueError(f"⚠️ Colunas categóricas ausentes no teste: {missing_test_cols}")
... 
...     print("Aplicando os mesmos mapeamentos do treino ao conjunto de teste...")
... 
...     for col in categorical_feature_names:
...         mapping_df = pd.read_csv(f"{col}_mapping.csv", encoding="utf-8")
...         mapping_dict = dict(zip(mapping_df[f"{col}_label"], mapping_df[f"{col}_code"]))
... 
...         # Aplicar o mapeamento manualmente
...         df_test[col] = df_test[col].map(mapping_dict)
... 
...         # Se houver valores não encontrados no mapeamento, definir como -1
...         df_test[col] = df_test[col].fillna(-1).astype(int)
... 
...         print(f"✅ Coluna '{col}' convertida com mapeamento do treino.")
... 
...     # Salvar novamente o arquivo convertido
...     df_test.to_csv("test_data.csv", index=False, encoding="utf-8")
...     print("Arquivo test_data.csv salvo com sucesso após conversão.")
... 
... except Exception as e:
...     print("--- ERRO NO BLOCO PYTHON ---")
...     print(traceback.format_exc())
...     pd.DataFrame().to_csv("train_data_balanced.csv", index=False)
...     print("Arquivo train_data_balanced.csv vazio criado devido a erro.")
... 
Carregando train_data.csv...
Dados carregados: 848 linhas, 64 colunas
Colunas originais: ['FoiPenalizadoSTJ', 'Porte', 'LiqCorrente', 'LiqGeral', 'LiqCorAjust', 'SolvGeral', 'EndGeral', 'CompEndivid', 'IndepFin', 'ImobilPL', 'ImobRecNC', 'PtpCapTerce', 'GiroAtivo', 'MargOp', 'MargLiq', 'ROI', 'ROE', 'AC', 'A
> NRP', 'Investimentos', 'Imobilizado', 'Intangivel', 'PC', 'PNC', 'PL', 'RecBruta', 'LucroBruto', 'LucroLiquido', 'QtePenalOutrosOrgaos', 'vlrcontrato', 'IdadedeAnos', 'CNAE', 'DivisaoCNAE', 'NaturezaJuridica', 'QtdeCNAEsSecundarios', 'An
> odasDemonstracões', 'cnpjs', 'z_LiqCorrente', 'z_LiqGeral', 'z_SolvGeral', 'z_IndepFin', 'Liquidez_Media_Z', 'z_ImobilPL', 'z_PtpCapTerce', 'Estrutura_Media_Z', 'z_MargOp', 'z_MargLiq', 'Margem_Media_Z', 'z_LiqCorAjust', 'z_EndGeral', 'z
> _ImobRecNC', 'z_CompEndivid', 'z_GiroAtivo', 'z_ROI', 'z_ROE', 'z_log_vlrcontrato', 'z_QtdeCNAEsSecundarios', 'z_QtePenalOutrosOrgaos', 'z_IdadedeAnos', 'u', 'obs_no', 'total_obs', 'cutoff', 'train']
Contagem inicial de 'FoiPenalizadoSTJ':
 FoiPenalizadoSTJ
0    569
1    279
Name: count, dtype: int64
Índices das features categóricas: [0, 30, 31, 32]
Tipos das features categóricas em X:
 Porte               object
CNAE                object
DivisaoCNAE          int64
NaturezaJuridica    object
dtype: object
Aplicando SMOTENC com k_neighbors=5...
SMOTENC concluído.
Tamanho após resample: 1138 linhas
Contagem de 'FoiPenalizadoSTJ' após resample:
 FoiPenalizadoSTJ
0    569
1    569
Name: count, dtype: int64
Colunas no df_resampled final: ['Porte', 'LiqCorrente', 'LiqGeral', 'LiqCorAjust', 'SolvGeral', 'EndGeral', 'CompEndivid', 'IndepFin', 'ImobilPL', 'ImobRecNC', 'PtpCapTerce', 'GiroAtivo', 'MargOp', 'MargLiq', 'ROI', 'ROE', 'AC', 'ANRP', 'I
> nvestimentos', 'Imobilizado', 'Intangivel', 'PC', 'PNC', 'PL', 'RecBruta', 'LucroBruto', 'LucroLiquido', 'QtePenalOutrosOrgaos', 'vlrcontrato', 'IdadedeAnos', 'CNAE', 'DivisaoCNAE', 'NaturezaJuridica', 'QtdeCNAEsSecundarios', 'AnodasDemo
> nstracões', 'cnpjs', 'z_LiqCorrente', 'z_LiqGeral', 'z_SolvGeral', 'z_IndepFin', 'Liquidez_Media_Z', 'z_ImobilPL', 'z_PtpCapTerce', 'Estrutura_Media_Z', 'z_MargOp', 'z_MargLiq', 'Margem_Media_Z', 'z_LiqCorAjust', 'z_EndGeral', 'z_ImobRec
> NC', 'z_CompEndivid', 'z_GiroAtivo', 'z_ROI', 'z_ROE', 'z_log_vlrcontrato', 'z_QtdeCNAEsSecundarios', 'z_QtePenalOutrosOrgaos', 'z_IdadedeAnos', 'u', 'obs_no', 'total_obs', 'cutoff', 'FoiPenalizadoSTJ', 'train']
Colunas categóricas presentes após SMOTENC.
Tipos das features categóricas após SMOTENC:
 Porte               object
CNAE                object
DivisaoCNAE          int64
NaturezaJuridica    object
dtype: object
Primeiras linhas do df_resampled:
                     Porte  LiqCorrente  ...  FoiPenalizadoSTJ  train
0  EMPRESA DE MÉDIO PORTE         2.11  ...                 0      1
1         PEQUENA EMPRESA         7.45  ...                 0      1
2         PEQUENA EMPRESA         7.95  ...                 0      1
3         PEQUENA EMPRESA         2.07  ...                 0      1
4         PEQUENA EMPRESA         2.11  ...                 0      1

[5 rows x 64 columns]
Convertendo variáveis categóricas do treino para códigos numéricos e salvando mapeamentos...
✅ Mapeamento salvo: Porte_mapping.csv
✅ Mapeamento salvo: CNAE_mapping.csv
✅ Mapeamento salvo: DivisaoCNAE_mapping.csv
✅ Mapeamento salvo: NaturezaJuridica_mapping.csv
Conversão no treino concluída.
Salvando train_data_balanced.csv...
Arquivo train_data_balanced.csv salvo com sucesso.
Carregando test_data.csv para conversão das variáveis categóricas...
Conjunto de teste carregado: 211 linhas
Aplicando os mesmos mapeamentos do treino ao conjunto de teste...
✅ Coluna 'Porte' convertida com mapeamento do treino.
✅ Coluna 'CNAE' convertida com mapeamento do treino.
✅ Coluna 'DivisaoCNAE' convertida com mapeamento do treino.
✅ Coluna 'NaturezaJuridica' convertida com mapeamento do treino.
Arquivo test_data.csv salvo com sucesso após conversão.
>>> print("--- Fim Bloco Python ---")
--- Fim Bloco Python ---
>>> end
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

. 
. 
. /*******************************************************************************
> ETAPA 5 - IMPORTAR NOVO CONJUNTO DE TREINO BALANCEADO NO STATA
> *******************************************************************************/
. clear

. * Adicionado varnames(1) e case(preserve)
. import delimited "train_data_balanced.csv", varnames(1) case(preserve) clear encoding("UTF-8")
(64 vars, 1,138 obs)

. 
. * Verificar se as variáveis existem após a importação
. describe Porte CNAE DivisaoCNAE NaturezaJuridica 

Variable      Storage   Display    Value
    name         type    format    label      Variable label
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Porte           byte    %8.0g                 
CNAE            int     %8.0g                 
DivisaoCNAE     byte    %8.0g                 
NaturezaJurid~a byte    %8.0g                 

. 
. * Restaurar labels originais corretamente
. * Certifique-se que os labels ainda são aplicáveis. SMOTE pode alterar a natureza dos dados.
. * Considere recriar labels se necessário, ou pular esta etapa se causar problemas.
. capture do "`labels_backup'.do"

. 
. if _rc != 0 {
.     di as error "⚠️ Falha ao restaurar labels. Verificar compatibilidade após SMOTE."
. }

. else {
.     di as text "✅ Labels restaurados com sucesso após SMOTE."
✅ Labels restaurados com sucesso após SMOTE.
. }

. 
. * Verificar balanceamento do conjunto de treino
. tabulate FoiPenalizadoSTJ train

FoiPenaliz |   train
    adoSTJ |         1 |     Total
-----------+-----------+----------
         0 |       569 |       569 
         1 |       569 |       569 
-----------+-----------+----------
     Total |     1,138 |     1,138 

. 
. /*******************************************************************************
> ETAPA 5.1 – IMPORTAR CONJUNTO DE TESTE E JUNTAR À BASE DE TREINO BALANCEADO
> *******************************************************************************/
. * Passo 1 – Importar o conjunto de teste separadamente e salvar como temporário
. clear

. * Adicionado case(preserve)
. import delimited "test_data.csv", varnames(1) case(preserve) encoding("UTF-8")
(64 vars, 211 obs)

. tempfile testdata

. save `testdata', replace // Adicionado replace para segurança
(file C:\Users\morenos\AppData\Local\Temp\ST_10190_000004.tmp not found)
file C:\Users\morenos\AppData\Local\Temp\ST_10190_000004.tmp saved as .dta format

. 
. * Passo 2 – Agora importar o treino balanceado
. clear

. * Adicionado varnames(1) e case(preserve)
. import delimited "train_data_balanced.csv", varnames(1) case(preserve) clear encoding("UTF-8")
(64 vars, 1,138 obs)

. 
. * Passo 3 – Restaurar os labels originais (novamente, verificar necessidade/compatibilidade)
. capture do "`labels_backup'.do"

. if _rc != 0 {
.     di as error "Falha ao restaurar labels. Verificar compatibilidade após SMOTE."
. }

. 
. * Passo 4 – Juntar com o conjunto de teste
. * Verificar se as variáveis categóricas existem antes de juntar
. describe Porte CNAE DivisaoCNAE NaturezaJuridica

Variable      Storage   Display    Value
    name         type    format    label      Variable label
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Porte           byte    %8.0g                 
CNAE            int     %8.0g                 
DivisaoCNAE     byte    %8.0g                 
NaturezaJurid~a byte    %8.0g                 

. append using `testdata'

. 
. * Passo 5 – Verificar a distribuição final por treino/teste
. tabulate FoiPenalizadoSTJ train

FoiPenaliz |         train
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       142        569 |       711 
         1 |        69        569 |       638 
-----------+----------------------+----------
     Total |       211      1,138 |     1,349 

. 
. * Verificar se as variáveis existem após o append
. describe Porte CNAE DivisaoCNAE NaturezaJuridica

Variable      Storage   Display    Value
    name         type    format    label      Variable label
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Porte           byte    %8.0g                 
CNAE            int     %8.0g                 
DivisaoCNAE     byte    %8.0g                 
NaturezaJurid~a byte    %8.0g                 

. 
. /*******************************************************************************
> ETAPA 5.1.1 – AGRUPAMENTO DE CNAEs RAROS (CATEGORIAS COM POUCA FREQUÊNCIA)
> *******************************************************************************/
. 
. * Define o mínimo de ocorrências para manter CNAE como categoria isolada
. local freq_minima = 10

. 
. * Cria um grupo especial para CNAEs com baixa frequência
. preserve

. 
. * Guardar versão original, caso queira rastrear depois
. gen CNAE_original = CNAE 

. 
. * Gerar mapa de frequência dos CNAEs
. contract CNAE

. gen CNAE_agrupado = CNAE

. replace CNAE_agrupado = -1 if _freq < `freq_minima'
(80 real changes made)

. tempfile freqmap

. save `freqmap', replace
(file C:\Users\morenos\AppData\Local\Temp\ST_10190_000006.tmp not found)
file C:\Users\morenos\AppData\Local\Temp\ST_10190_000006.tmp saved as .dta format

. 
. restore

. 
. * Aplicar o agrupamento via merge (sem 'nogen' para capturar _merge)
. merge m:1 CNAE using `freqmap', keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             1,349  (_merge==3)
    -----------------------------------------

. 
. * Substituir CNAE por CNAE_agrupado apenas onde houver correspondência
. replace CNAE = CNAE_agrupado if _merge == 3
(291 real changes made)

. drop _merge CNAE_agrupado _freq

. 
. * Verifica distribuição após o agrupamento
. tabulate CNAE

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |        296       21.94       21.94
          5 |         11        0.82       22.76
         10 |         14        1.04       23.80
         12 |         35        2.59       26.39
         16 |        106        7.86       34.25
         20 |         23        1.70       35.95
         21 |         14        1.04       36.99
         22 |         10        0.74       37.73
         23 |         18        1.33       39.07
         34 |         20        1.48       40.55
         37 |         37        2.74       43.29
         39 |         55        4.08       47.37
         40 |         34        2.52       49.89
         44 |         11        0.82       50.70
         49 |         21        1.56       52.26
         50 |         12        0.89       53.15
         51 |         13        0.96       54.11
         52 |         63        4.67       58.78
         55 |         15        1.11       59.90
         65 |         12        0.89       60.79
         70 |         45        3.34       64.12
         71 |         17        1.26       65.38
         72 |         33        2.45       67.83
         73 |         58        4.30       72.13
         74 |        111        8.23       80.36
         79 |         10        0.74       81.10
         80 |         11        0.82       81.91
         82 |         33        2.45       84.36
         88 |         17        1.26       85.62
         93 |         39        2.89       88.51
         94 |         23        1.70       90.21
         95 |         28        2.08       92.29
         96 |         17        1.26       93.55
         99 |         16        1.19       94.74
        100 |         23        1.70       96.44
        101 |         24        1.78       98.22
        102 |         12        0.89       99.11
        106 |         12        0.89      100.00
------------+-----------------------------------
      Total |      1,349      100.00

. di as text "✅ Agrupamento de CNAEs raros concluído com base na frequência mínima de `freq_minima'."
✅ Agrupamento de CNAEs raros concluído com base na frequência mínima de 10.

. 
. 
. /*******************************************************************************
> ETAPA 5.2 – CONVERTER VARIÁVEIS CATEGÓRICAS PARA INTEIROS E GERAR DUMMIES (após SMOTENC)
> *******************************************************************************/
. * Arredondar valores para garantir categorias inteiras
. * Isso pode ser necessário se o Python/SMOTE as transformou em float, mas idealmente não deveria.
. * Adicione verificações para evitar erros se a variável não existir (embora agora deva existir)
. 
. capture confirm variable Porte

. if _rc == 0 {
.     replace Porte = round(Porte)
(0 real changes made)
. } 

. else {
.     di as error "Variável Porte ainda não encontrada antes do round!"
. }

. 
. capture confirm variable CNAE

. if _rc == 0 {
.     replace CNAE = round(CNAE)
(0 real changes made)
. } 

. else {
.     di as error "Variável CNAE não encontrada antes do round!"
. }

. 
. capture confirm variable NaturezaJuridica

. if _rc == 0 {
.     replace NaturezaJuridica = round(NaturezaJuridica)
(0 real changes made)
. } 

. else {
.     di as error "Variável NaturezaJuridica não encontrada antes do round!"
. }

. 
. 
. capture confirm variable DivisaoCNAE

. if _rc == 0 {
.     replace DivisaoCNAE = round(DivisaoCNAE)
(0 real changes made)
. } 

. else {
.     di as error "Variável DivisaoCNAE não encontrada antes do round!"
. }

. 
. * Gerar variáveis dummies
. * Adicione verificações aqui também
. capture confirm variable Porte

. if _rc == 0 {
.     tabulate Porte, generate(Porte_)

      Porte |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        161       11.93       11.93
          1 |        203       15.05       26.98
          2 |        158       11.71       38.70
          3 |        827       61.30      100.00
------------+-----------------------------------
      Total |      1,349      100.00
.     drop Porte // Dropar original apenas se as dummies foram criadas
. } 

. else {
.      di as error "Não foi possível gerar dummies para Porte."
. }

. 
. capture confirm variable CNAE

. if _rc == 0 {
.     tabulate CNAE, generate(CNAE_)

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |        296       21.94       21.94
          5 |         11        0.82       22.76
         10 |         14        1.04       23.80
         12 |         35        2.59       26.39
         16 |        106        7.86       34.25
         20 |         23        1.70       35.95
         21 |         14        1.04       36.99
         22 |         10        0.74       37.73
         23 |         18        1.33       39.07
         34 |         20        1.48       40.55
         37 |         37        2.74       43.29
         39 |         55        4.08       47.37
         40 |         34        2.52       49.89
         44 |         11        0.82       50.70
         49 |         21        1.56       52.26
         50 |         12        0.89       53.15
         51 |         13        0.96       54.11
         52 |         63        4.67       58.78
         55 |         15        1.11       59.90
         65 |         12        0.89       60.79
         70 |         45        3.34       64.12
         71 |         17        1.26       65.38
         72 |         33        2.45       67.83
         73 |         58        4.30       72.13
         74 |        111        8.23       80.36
         79 |         10        0.74       81.10
         80 |         11        0.82       81.91
         82 |         33        2.45       84.36
         88 |         17        1.26       85.62
         93 |         39        2.89       88.51
         94 |         23        1.70       90.21
         95 |         28        2.08       92.29
         96 |         17        1.26       93.55
         99 |         16        1.19       94.74
        100 |         23        1.70       96.44
        101 |         24        1.78       98.22
        102 |         12        0.89       99.11
        106 |         12        0.89      100.00
------------+-----------------------------------
      Total |      1,349      100.00
.     drop CNAE
. } 

. else {
.      di as error "Não foi possível gerar dummies para CNAE."
. }

. 
. capture confirm variable DivisaoCNAE

. if _rc == 0 {
.     tabulate DivisaoCNAE, generate(DivisaoCNAE_)

DivisaoCNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |          1        0.07        0.07
          1 |          4        0.30        0.37
          2 |          3        0.22        0.59
          3 |          5        0.37        0.96
          4 |         17        1.26        2.22
          5 |          8        0.59        2.82
          6 |         14        1.04        3.85
          7 |          3        0.22        4.08
          8 |         36        2.67        6.75
          9 |          9        0.67        7.41
         10 |        102        7.56       14.97
         11 |         22        1.63       16.60
         12 |         87        6.45       23.05
         13 |          6        0.44       23.50
         14 |        178       13.19       36.69
         15 |        158       11.71       48.41
         16 |          2        0.15       48.55
         17 |          1        0.07       48.63
         18 |          8        0.59       49.22
         19 |          2        0.15       49.37
         20 |         28        2.08       51.45
         21 |        266       19.72       71.16
         22 |         11        0.82       71.98
         23 |         25        1.85       73.83
         24 |         11        0.82       74.65
         25 |         34        2.52       77.17
         26 |          8        0.59       77.76
         27 |         19        1.41       79.17
         28 |         21        1.56       80.73
         29 |         53        3.93       84.66
         30 |         23        1.70       86.36
         31 |         28        2.08       88.44
         32 |         24        1.78       90.21
         33 |         75        5.56       95.77
         34 |         29        2.15       97.92
         35 |          8        0.59       98.52
         36 |          6        0.44       98.96
         37 |          2        0.15       99.11
         38 |          2        0.15       99.26
         39 |          8        0.59       99.85
         40 |          2        0.15      100.00
------------+-----------------------------------
      Total |      1,349      100.00
.     drop DivisaoCNAE
. } 

. else {
.      di as error "Não foi possível gerar dummies para Divisão do CNAE."
. }

. 
. capture confirm variable NaturezaJuridica

. if _rc == 0 {
.     tabulate NaturezaJuridica, generate(NaturezaJuridica_)

NaturezaJur |
      idica |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |          5        0.37        0.37
          1 |         16        1.19        1.56
          2 |        102        7.56        9.12
          3 |      1,169       86.66       95.77
          4 |         26        1.93       97.70
          5 |          2        0.15       97.85
          6 |          1        0.07       97.92
          7 |          2        0.15       98.07
          8 |          7        0.52       98.59
          9 |         19        1.41      100.00
------------+-----------------------------------
      Total |      1,349      100.00
.     drop NaturezaJuridica
. } 

. else {
.      di as error "Não foi possível gerar dummies para NaturezaJuridica."
. }

. 
. 
. /*******************************************************************************
> ETAPA 6 - O CONJUNTO DE TESTE PERMANECE SEPARADO 
> *******************************************************************************/
. * O conjunto de teste ainda está salvo em "test_data.csv"
. * Ele será importado separadamente no final da análise.
. 
. /******************************************************************************
> Fornecer descrição básica da estrutura do conjunto de dados
> *******************************************************************************/
. describe

Contains data
 Observations:         1,349                  
    Variables:           153                  
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
LiqCorrente     float   %9.0g                 
LiqGeral        float   %9.0g                 
LiqCorAjust     float   %9.0g                 
SolvGeral       float   %9.0g                 
EndGeral        float   %9.0g                 
CompEndivid     float   %9.0g                 
IndepFin        float   %9.0g                 
ImobilPL        float   %9.0g                 
ImobRecNC       float   %9.0g                 
PtpCapTerce     float   %9.0g                 
GiroAtivo       float   %9.0g                 
MargOp          float   %9.0g                 
MargLiq         float   %9.0g                 
ROI             float   %9.0g                 
ROE             float   %9.0g                 
AC              double  %10.0g                
ANRP            double  %10.0g                
Investimentos   double  %10.0g                
Imobilizado     double  %10.0g                
Intangivel      double  %10.0g                
PC              double  %10.0g                
PNC             double  %10.0g                
PL              double  %10.0g                
RecBruta        double  %10.0g                
LucroBruto      double  %10.0g                
LucroLiquido    double  %10.0g                
QtePenalOutro~s int     %8.0g                 
vlrcontrato     float   %9.0g                 
IdadedeAnos     float   %9.0g                 
QtdeCNAEsSecu~s byte    %8.0g                 
AnodasDemonst~s int     %8.0g                 
cnpjs           byte    %8.0g                 
z_LiqCorrente   float   %9.0g                 
z_LiqGeral      float   %9.0g                 
z_SolvGeral     float   %9.0g                 
z_IndepFin      float   %9.0g                 
Liquidez_Medi~Z float   %9.0g                 
z_ImobilPL      float   %9.0g                 
z_PtpCapTerce   float   %9.0g                 
Estrutura_Med~Z float   %9.0g                 
z_MargOp        float   %9.0g                 
z_MargLiq       float   %9.0g                 
Margem_Media_Z  float   %9.0g                 
z_LiqCorAjust   float   %9.0g                 
z_EndGeral      float   %9.0g                 
z_ImobRecNC     float   %9.0g                 
z_CompEndivid   float   %9.0g                 
z_GiroAtivo     float   %9.0g                 
z_ROI           float   %9.0g                 
z_ROE           float   %9.0g                 
z_log_vlrcont~o float   %9.0g                 
z_QtdeCNAEsSe~s float   %9.0g                 
z_QtePenalOut~s float   %9.0g                 
z_IdadedeAnos   float   %9.0g                 
u               float   %9.0g                 
obs_no          int     %8.0g                 
total_obs       int     %8.0g                 
cutoff          int     %8.0g                 
FoiPenalizado~J byte    %8.0g                 
train           byte    %8.0g                 
Porte_1         byte    %8.0g                 Porte== 0.0000
Porte_2         byte    %8.0g                 Porte== 1.0000
Porte_3         byte    %8.0g                 Porte== 2.0000
Porte_4         byte    %8.0g                 Porte== 3.0000
CNAE_1          byte    %8.0g                 CNAE== -1.0000
CNAE_2          byte    %8.0g                 CNAE== 5.0000
CNAE_3          byte    %8.0g                 CNAE== 10.0000
CNAE_4          byte    %8.0g                 CNAE== 12.0000
CNAE_5          byte    %8.0g                 CNAE== 16.0000
CNAE_6          byte    %8.0g                 CNAE== 20.0000
CNAE_7          byte    %8.0g                 CNAE== 21.0000
CNAE_8          byte    %8.0g                 CNAE== 22.0000
CNAE_9          byte    %8.0g                 CNAE== 23.0000
CNAE_10         byte    %8.0g                 CNAE== 34.0000
CNAE_11         byte    %8.0g                 CNAE== 37.0000
CNAE_12         byte    %8.0g                 CNAE== 39.0000
CNAE_13         byte    %8.0g                 CNAE== 40.0000
CNAE_14         byte    %8.0g                 CNAE== 44.0000
CNAE_15         byte    %8.0g                 CNAE== 49.0000
CNAE_16         byte    %8.0g                 CNAE== 50.0000
CNAE_17         byte    %8.0g                 CNAE== 51.0000
CNAE_18         byte    %8.0g                 CNAE== 52.0000
CNAE_19         byte    %8.0g                 CNAE== 55.0000
CNAE_20         byte    %8.0g                 CNAE== 65.0000
CNAE_21         byte    %8.0g                 CNAE== 70.0000
CNAE_22         byte    %8.0g                 CNAE== 71.0000
CNAE_23         byte    %8.0g                 CNAE== 72.0000
CNAE_24         byte    %8.0g                 CNAE== 73.0000
CNAE_25         byte    %8.0g                 CNAE== 74.0000
CNAE_26         byte    %8.0g                 CNAE== 79.0000
CNAE_27         byte    %8.0g                 CNAE== 80.0000
CNAE_28         byte    %8.0g                 CNAE== 82.0000
CNAE_29         byte    %8.0g                 CNAE== 88.0000
CNAE_30         byte    %8.0g                 CNAE== 93.0000
CNAE_31         byte    %8.0g                 CNAE== 94.0000
CNAE_32         byte    %8.0g                 CNAE== 95.0000
CNAE_33         byte    %8.0g                 CNAE== 96.0000
CNAE_34         byte    %8.0g                 CNAE== 99.0000
CNAE_35         byte    %8.0g                 CNAE== 100.0000
CNAE_36         byte    %8.0g                 CNAE== 101.0000
CNAE_37         byte    %8.0g                 CNAE== 102.0000
CNAE_38         byte    %8.0g                 CNAE== 106.0000
DivisaoCNAE_1   byte    %8.0g                 DivisaoCNAE== 0.0000
DivisaoCNAE_2   byte    %8.0g                 DivisaoCNAE== 1.0000
DivisaoCNAE_3   byte    %8.0g                 DivisaoCNAE== 2.0000
DivisaoCNAE_4   byte    %8.0g                 DivisaoCNAE== 3.0000
DivisaoCNAE_5   byte    %8.0g                 DivisaoCNAE== 4.0000
DivisaoCNAE_6   byte    %8.0g                 DivisaoCNAE== 5.0000
DivisaoCNAE_7   byte    %8.0g                 DivisaoCNAE== 6.0000
DivisaoCNAE_8   byte    %8.0g                 DivisaoCNAE== 7.0000
DivisaoCNAE_9   byte    %8.0g                 DivisaoCNAE== 8.0000
DivisaoCNAE_10  byte    %8.0g                 DivisaoCNAE== 9.0000
DivisaoCNAE_11  byte    %8.0g                 DivisaoCNAE== 10.0000
DivisaoCNAE_12  byte    %8.0g                 DivisaoCNAE== 11.0000
DivisaoCNAE_13  byte    %8.0g                 DivisaoCNAE== 12.0000
DivisaoCNAE_14  byte    %8.0g                 DivisaoCNAE== 13.0000
DivisaoCNAE_15  byte    %8.0g                 DivisaoCNAE== 14.0000
DivisaoCNAE_16  byte    %8.0g                 DivisaoCNAE== 15.0000
DivisaoCNAE_17  byte    %8.0g                 DivisaoCNAE== 16.0000
DivisaoCNAE_18  byte    %8.0g                 DivisaoCNAE== 17.0000
DivisaoCNAE_19  byte    %8.0g                 DivisaoCNAE== 18.0000
DivisaoCNAE_20  byte    %8.0g                 DivisaoCNAE== 19.0000
DivisaoCNAE_21  byte    %8.0g                 DivisaoCNAE== 20.0000
DivisaoCNAE_22  byte    %8.0g                 DivisaoCNAE== 21.0000
DivisaoCNAE_23  byte    %8.0g                 DivisaoCNAE== 22.0000
DivisaoCNAE_24  byte    %8.0g                 DivisaoCNAE== 23.0000
DivisaoCNAE_25  byte    %8.0g                 DivisaoCNAE== 24.0000
DivisaoCNAE_26  byte    %8.0g                 DivisaoCNAE== 25.0000
DivisaoCNAE_27  byte    %8.0g                 DivisaoCNAE== 26.0000
DivisaoCNAE_28  byte    %8.0g                 DivisaoCNAE== 27.0000
DivisaoCNAE_29  byte    %8.0g                 DivisaoCNAE== 28.0000
DivisaoCNAE_30  byte    %8.0g                 DivisaoCNAE== 29.0000
DivisaoCNAE_31  byte    %8.0g                 DivisaoCNAE== 30.0000
DivisaoCNAE_32  byte    %8.0g                 DivisaoCNAE== 31.0000
DivisaoCNAE_33  byte    %8.0g                 DivisaoCNAE== 32.0000
DivisaoCNAE_34  byte    %8.0g                 DivisaoCNAE== 33.0000
DivisaoCNAE_35  byte    %8.0g                 DivisaoCNAE== 34.0000
DivisaoCNAE_36  byte    %8.0g                 DivisaoCNAE== 35.0000
DivisaoCNAE_37  byte    %8.0g                 DivisaoCNAE== 36.0000
DivisaoCNAE_38  byte    %8.0g                 DivisaoCNAE== 37.0000
DivisaoCNAE_39  byte    %8.0g                 DivisaoCNAE== 38.0000
DivisaoCNAE_40  byte    %8.0g                 DivisaoCNAE== 39.0000
DivisaoCNAE_41  byte    %8.0g                 DivisaoCNAE== 40.0000
NaturezaJurid~1 byte    %8.0g                 NaturezaJuridica== 0.0000
NaturezaJurid~2 byte    %8.0g                 NaturezaJuridica== 1.0000
NaturezaJurid~3 byte    %8.0g                 NaturezaJuridica== 2.0000
NaturezaJurid~4 byte    %8.0g                 NaturezaJuridica== 3.0000
NaturezaJurid~5 byte    %8.0g                 NaturezaJuridica== 4.0000
NaturezaJurid~6 byte    %8.0g                 NaturezaJuridica== 5.0000
NaturezaJurid~7 byte    %8.0g                 NaturezaJuridica== 6.0000
NaturezaJurid~8 byte    %8.0g                 NaturezaJuridica== 7.0000
NaturezaJurid~9 byte    %8.0g                 NaturezaJuridica== 8.0000
NaturezaJuri~10 byte    %8.0g                 NaturezaJuridica== 9.0000
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. /*******************************************************************************
> ETAPA 6 - ANÁLISE LOGIT
> 
> A variável dependente é 'FoiPenalizadoSTJ', do tipo binária.
> Ela indica se o fornecedor foi penalizado pelo STJ (1) ou não (0).
> 
> As variáveis independentes serão divididas em variáveis contábeis e variáveis de controle.
> 
> *******************************************************************************/
. 
. * 6.1 Listar todas as variáveis disponíveis
. ds
LiqCorrente   PtpCapTerce   Imobilizado   vlrcontrato   Liquidez_M~Z  z_ImobRecNC   u             Porte_4       CNAE_9        CNAE_18       CNAE_27       CNAE_36       DivisaoCN~_7  DivisaoCN~16  DivisaoCN~25  DivisaoCN~34  NaturezaJu~2
LiqGeral      GiroAtivo     Intangivel    IdadedeAnos   z_ImobilPL    z_CompEndi~d  obs_no        CNAE_1        CNAE_10       CNAE_19       CNAE_28       CNAE_37       DivisaoCN~_8  DivisaoCN~17  DivisaoCN~26  DivisaoCN~35  NaturezaJu~3
LiqCorAjust   MargOp        PC            QtdeCNAEsS~s  z_PtpCapTe~e  z_GiroAtivo   total_obs     CNAE_2        CNAE_11       CNAE_20       CNAE_29       CNAE_38       DivisaoCN~_9  DivisaoCN~18  DivisaoCN~27  DivisaoCN~36  NaturezaJu~4
SolvGeral     MargLiq       PNC           AnodasDemo~s  Estrutura_~Z  z_ROI         cutoff        CNAE_3        CNAE_12       CNAE_21       CNAE_30       DivisaoCN~_1  DivisaoCN~10  DivisaoCN~19  DivisaoCN~28  DivisaoCN~37  NaturezaJu~5
EndGeral      ROI           PL            cnpjs         z_MargOp      z_ROE         FoiPenaliz~J  CNAE_4        CNAE_13       CNAE_22       CNAE_31       DivisaoCN~_2  DivisaoCN~11  DivisaoCN~20  DivisaoCN~29  DivisaoCN~38  NaturezaJu~6
CompEndivid   ROE           RecBruta      z_LiqCorre~e  z_MargLiq     z_log_vlrc~o  train         CNAE_5        CNAE_14       CNAE_23       CNAE_32       DivisaoCN~_3  DivisaoCN~12  DivisaoCN~21  DivisaoCN~30  DivisaoCN~39  NaturezaJu~7
IndepFin      AC            LucroBruto    z_LiqGeral    Margem_Med~Z  z_QtdeCNAE~s  Porte_1       CNAE_6        CNAE_15       CNAE_24       CNAE_33       DivisaoCN~_4  DivisaoCN~13  DivisaoCN~22  DivisaoCN~31  DivisaoCN~40  NaturezaJu~8
ImobilPL      ANRP          LucroLiquido  z_SolvGeral   z_LiqCorAj~t  z_QtePenal~s  Porte_2       CNAE_7        CNAE_16       CNAE_25       CNAE_34       DivisaoCN~_5  DivisaoCN~14  DivisaoCN~23  DivisaoCN~32  DivisaoCN~41  NaturezaJu~9
ImobRecNC     Investimen~s  QtePenalOu~s  z_IndepFin    z_EndGeral    z_IdadedeA~s  Porte_3       CNAE_8        CNAE_17       CNAE_26       CNAE_35       DivisaoCN~_6  DivisaoCN~15  DivisaoCN~24  DivisaoCN~33  NaturezaJu~1  NaturezaJ~10

. 
. * Capturar todas as variáveis que começam com "Porte_"
. unab Porte_vars : Porte_*

. 
. * Capturar todas as variáveis que começam com "CNAE_"
. unab CNAE_vars : CNAE_*

. 
. * Capturar todas as variáveis que começam com "NaturezaJuridica_"
. unab Natureza_vars : NaturezaJuridica_*

. 
. * Definir variáveis contábeis (padronizadas e sintéticas)
. local var_contabeis `Porte_vars' Liquidez_Media_Z Estrutura_Media_Z Margem_Media_Z ///
>     z_LiqCorAjust z_EndGeral z_ImobRecNC z_CompEndivid z_GiroAtivo z_ROI z_ROE

. 
. * Definir variáveis de controle (padronizadas)
. local var_controle `CNAE_vars' `Natureza_vars' z_log_vlrcontrato ///
>     z_QtdeCNAEsSecundarios z_IdadedeAnos z_QtePenalOutrosOrgaos

. 
. * Executar a regressão logística no conjunto de treino
. logit FoiPenalizadoSTJ `var_contabeis' `var_controle' if train == 1

note: CNAE_2 != 0 predicts failure perfectly;
      CNAE_2 omitted and 8 obs not used.

note: CNAE_3 != 0 predicts success perfectly;
      CNAE_3 omitted and 14 obs not used.

note: CNAE_4 != 0 predicts success perfectly;
      CNAE_4 omitted and 30 obs not used.

note: CNAE_9 != 0 predicts success perfectly;
      CNAE_9 omitted and 17 obs not used.

note: CNAE_10 != 0 predicts success perfectly;
      CNAE_10 omitted and 19 obs not used.

note: CNAE_11 != 0 predicts success perfectly;
      CNAE_11 omitted and 35 obs not used.

note: CNAE_14 != 0 predicts success perfectly;
      CNAE_14 omitted and 10 obs not used.

note: CNAE_15 != 0 predicts success perfectly;
      CNAE_15 omitted and 21 obs not used.

note: CNAE_16 != 0 predicts success perfectly;
      CNAE_16 omitted and 12 obs not used.

note: CNAE_17 != 0 predicts success perfectly;
      CNAE_17 omitted and 12 obs not used.

note: CNAE_24 != 0 predicts failure perfectly;
      CNAE_24 omitted and 51 obs not used.

note: CNAE_26 != 0 predicts success perfectly;
      CNAE_26 omitted and 9 obs not used.

note: CNAE_27 != 0 predicts failure perfectly;
      CNAE_27 omitted and 8 obs not used.

note: CNAE_31 != 0 predicts failure perfectly;
      CNAE_31 omitted and 21 obs not used.

note: CNAE_34 != 0 predicts failure perfectly;
      CNAE_34 omitted and 14 obs not used.

note: CNAE_36 != 0 predicts failure perfectly;
      CNAE_36 omitted and 20 obs not used.

note: CNAE_37 != 0 predicts failure perfectly;
      CNAE_37 omitted and 8 obs not used.

note: CNAE_38 != 0 predicts success perfectly;
      CNAE_38 omitted and 11 obs not used.

note: NaturezaJuridica_6 != 0 predicts failure perfectly;
      NaturezaJuridica_6 omitted and 1 obs not used.

note: NaturezaJuridica_7 != 0 predicts failure perfectly;
      NaturezaJuridica_7 omitted and 1 obs not used.

note: NaturezaJuridica_8 != 0 predicts failure perfectly;
      NaturezaJuridica_8 omitted and 1 obs not used.

note: NaturezaJuridica_10 != 0 predicts failure perfectly;
      NaturezaJuridica_10 omitted and 15 obs not used.

note: Porte_4 omitted because of collinearity.
note: CNAE_35 omitted because of collinearity.
note: NaturezaJuridica_1 omitted because of collinearity.
note: NaturezaJuridica_9 omitted because of collinearity.
Iteration 0:  Log likelihood = -553.41474  
Iteration 1:  Log likelihood = -467.29531  
Iteration 2:  Log likelihood = -465.38585  
Iteration 3:  Log likelihood = -465.34487  
Iteration 4:  Log likelihood = -465.33841  
Iteration 5:  Log likelihood = -465.33772  
Iteration 6:  Log likelihood =  -465.3376  
Iteration 7:  Log likelihood = -465.33759  

Logistic regression                                     Number of obs =    800
                                                        LR chi2(40)   = 176.15
                                                        Prob > chi2   = 0.0000
Log likelihood = -465.33759                             Pseudo R2     = 0.1592

----------------------------------------------------------------------------------------
      FoiPenalizadoSTJ | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-----------------------+----------------------------------------------------------------
               Porte_1 |  -.2003853   .3155887    -0.63   0.525    -.8189277    .4181571
               Porte_2 |   .1550602    .260001     0.60   0.551    -.3545324    .6646529
               Porte_3 |    .069568   .3082116     0.23   0.821    -.5345156    .6736516
               Porte_4 |          0  (omitted)
      Liquidez_Media_Z |   .0321048   .0933434     0.34   0.731    -.1508448    .2150544
     Estrutura_Media_Z |  -.1603158   .1510912    -1.06   0.289    -.4564491    .1358175
        Margem_Media_Z |   .0045558    .141502     0.03   0.974     -.272783    .2818947
         z_LiqCorAjust |  -.0643144   .1562274    -0.41   0.681    -.3705144    .2418856
            z_EndGeral |   .3779024   .1654036     2.28   0.022     .0537173    .7020875
           z_ImobRecNC |  -.4098089   .1400379    -2.93   0.003    -.6842781   -.1353396
         z_CompEndivid |    .075008   .1003888     0.75   0.455    -.1217504    .2717664
           z_GiroAtivo |   .0484578   .1108691     0.44   0.662    -.1688417    .2657572
                 z_ROI |  -.0606685   .2096523    -0.29   0.772    -.4715793    .3502424
                 z_ROE |  -.2825363   .2002305    -1.41   0.158    -.6749809    .1099083
                CNAE_1 |   .3835355   .6452201     0.59   0.552    -.8810728    1.648144
                CNAE_2 |          0  (omitted)
                CNAE_3 |          0  (omitted)
                CNAE_4 |          0  (omitted)
                CNAE_5 |   1.594094   .6648756     2.40   0.017     .2909623    2.897227
                CNAE_6 |   1.012368   .7952657     1.27   0.203     -.546324     2.57106
                CNAE_7 |   1.185283   .8722405     1.36   0.174    -.5242771    2.894843
                CNAE_8 |   .5594302   .9880654     0.57   0.571    -1.377142    2.496003
                CNAE_9 |          0  (omitted)
               CNAE_10 |          0  (omitted)
               CNAE_11 |          0  (omitted)
               CNAE_12 |   1.140233   .6940059     1.64   0.100    -.2199938    2.500459
               CNAE_13 |   1.160211   .7464735     1.55   0.120    -.3028503    2.623272
               CNAE_14 |          0  (omitted)
               CNAE_15 |          0  (omitted)
               CNAE_16 |          0  (omitted)
               CNAE_17 |          0  (omitted)
               CNAE_18 |   .9556235   .7053106     1.35   0.175    -.4267598    2.338007
               CNAE_19 |   1.222621   .8905152     1.37   0.170    -.5227565    2.967999
               CNAE_20 |   12.11992   447.1804     0.03   0.978    -864.3375    888.5774
               CNAE_21 |   .6391007   .7079901     0.90   0.367    -.7485343    2.026736
               CNAE_22 |  -.6960021   1.263868    -0.55   0.582    -3.173139    1.781134
               CNAE_23 |   .5165239   .7409184     0.70   0.486    -.9356495    1.968697
               CNAE_24 |          0  (omitted)
               CNAE_25 |   1.594639   .6609987     2.41   0.016     .2991057    2.890173
               CNAE_26 |          0  (omitted)
               CNAE_27 |          0  (omitted)
               CNAE_28 |   .9260346   .7622773     1.21   0.224    -.5680015    2.420071
               CNAE_29 |   2.109279   .8980827     2.35   0.019     .3490691    3.869489
               CNAE_30 |   1.739425   .7550307     2.30   0.021     .2595922    3.219258
               CNAE_31 |          0  (omitted)
               CNAE_32 |  -.0294206   .7518154    -0.04   0.969    -1.502952    1.444111
               CNAE_33 |    2.25282   .9674388     2.33   0.020     .3566746    4.148965
               CNAE_34 |          0  (omitted)
               CNAE_35 |          0  (omitted)
               CNAE_36 |          0  (omitted)
               CNAE_37 |          0  (omitted)
               CNAE_38 |          0  (omitted)
    NaturezaJuridica_1 |          0  (omitted)
    NaturezaJuridica_2 |  -10.88306   447.1802    -0.02   0.981    -887.3402    865.5741
    NaturezaJuridica_3 |  -2.480837   1.044954    -2.37   0.018    -4.528909   -.4327647
    NaturezaJuridica_4 |  -.4845955   .9878798    -0.49   0.624    -2.420804    1.451613
    NaturezaJuridica_5 |  -2.574064   1.461903    -1.76   0.078    -5.439341    .2912128
    NaturezaJuridica_6 |          0  (omitted)
    NaturezaJuridica_7 |          0  (omitted)
    NaturezaJuridica_8 |          0  (omitted)
    NaturezaJuridica_9 |          0  (omitted)
   NaturezaJuridica_10 |          0  (omitted)
     z_log_vlrcontrato |   .2738473   .1133552     2.42   0.016     .0516752    .4960195
z_QtdeCNAEsSecundarios |  -.3207777     .09639    -3.33   0.001    -.5096986   -.1318567
         z_IdadedeAnos |  -.1549495   .1072534    -1.44   0.149    -.3651623    .0552634
z_QtePenalOutrosOrgaos |   .4305906   .0934261     4.61   0.000     .2474789    .6137024
                 _cons |  -.4873932   1.171355    -0.42   0.677    -2.783207    1.808421
----------------------------------------------------------------------------------------

. 
. * Armazenar os resultados do modelo completo
. estimates store IRDCcompleto

. 
. /*******************************************************************************
> Justificativa das Variáveis de Controle:
> 
> - **CNAE (Classificação Nacional de Atividades Econômicas)**: Diferentes setores econômicos possuem níveis distintos de regulação e riscos operacionais. Incluir o CNAE permite controlar os efeitos específicos de cada setor na probabilida
> de de penalização.
> 
> - **Natureza Jurídica**: Empresas com diferentes naturezas jurídicas têm estruturas legais e de governança distintas, o que pode influenciar a conformidade regulatória e o risco de penalidades.
> 
> - **log_vlrcontrato (Log do Valor do Contrato)**: Contratos de maior valor podem estar sujeitos a maior escrutínio e complexidade, aumentando o risco de penalidades. O logaritmo é usado para linearizar a relação.
> 
> - **QtdeCNAEsSecundarios (Quantidade de CNAEs Secundários)**: Indica o nível de diversificação das atividades da empresa. Empresas mais diversificadas podem ter estruturas mais complexas, afetando a gestão e a conformidade regulatória.
> 
> - **IdadedeAnos (Idade da Empresa em Anos)**: Empresas mais antigas podem ter processos mais estabelecidos e experiência acumulada, afetando positivamente a conformidade com normas e regulamentos.
> 
> - **QtePenalOutrosOrgaos (Quantidade de Penalidades Aplicadas por Outros Órgãos)**: Um histórico de penalidades pode indicar padrões de não conformidade, aumentando a probabilidade de novas penalizações.
> 
> Essas variáveis de controle são importantes para isolar o efeito das variáveis contábeis principais, garantindo que os resultados do modelo reflitam o impacto dos indicadores contábeis na probabilidade de penalização, independentemente d
> e outros fatores externos.
> 
> *******************************************************************************/
. 
. /*******************************************************************************
> 6.2 Regressão logística com seleção stepwise a 10% de significância no conjunto de treinamento
> *******************************************************************************/
. * 6.1 Listar todas as variáveis disponíveis
. ds
LiqCorrente   GiroAtivo     PC            AnodasDemo~s  z_MargOp      z_log_vlrc~o  Porte_1       CNAE_7        CNAE_17       CNAE_27       CNAE_37       DivisaoCN~_9  DivisaoCN~19  DivisaoCN~29  DivisaoCN~39  NaturezaJu~8
LiqGeral      MargOp        PNC           cnpjs         z_MargLiq     z_QtdeCNAE~s  Porte_2       CNAE_8        CNAE_18       CNAE_28       CNAE_38       DivisaoCN~10  DivisaoCN~20  DivisaoCN~30  DivisaoCN~40  NaturezaJu~9
LiqCorAjust   MargLiq       PL            z_LiqCorre~e  Margem_Med~Z  z_QtePenal~s  Porte_3       CNAE_9        CNAE_19       CNAE_29       DivisaoCN~_1  DivisaoCN~11  DivisaoCN~21  DivisaoCN~31  DivisaoCN~41  NaturezaJ~10
SolvGeral     ROI           RecBruta      z_LiqGeral    z_LiqCorAj~t  z_IdadedeA~s  Porte_4       CNAE_10       CNAE_20       CNAE_30       DivisaoCN~_2  DivisaoCN~12  DivisaoCN~22  DivisaoCN~32  NaturezaJu~1  _est_IRDCc~o
EndGeral      ROE           LucroBruto    z_SolvGeral   z_EndGeral    u             CNAE_1        CNAE_11       CNAE_21       CNAE_31       DivisaoCN~_3  DivisaoCN~13  DivisaoCN~23  DivisaoCN~33  NaturezaJu~2
CompEndivid   AC            LucroLiquido  z_IndepFin    z_ImobRecNC   obs_no        CNAE_2        CNAE_12       CNAE_22       CNAE_32       DivisaoCN~_4  DivisaoCN~14  DivisaoCN~24  DivisaoCN~34  NaturezaJu~3
IndepFin      ANRP          QtePenalOu~s  Liquidez_M~Z  z_CompEndi~d  total_obs     CNAE_3        CNAE_13       CNAE_23       CNAE_33       DivisaoCN~_5  DivisaoCN~15  DivisaoCN~25  DivisaoCN~35  NaturezaJu~4
ImobilPL      Investimen~s  vlrcontrato   z_ImobilPL    z_GiroAtivo   cutoff        CNAE_4        CNAE_14       CNAE_24       CNAE_34       DivisaoCN~_6  DivisaoCN~16  DivisaoCN~26  DivisaoCN~36  NaturezaJu~5
ImobRecNC     Imobilizado   IdadedeAnos   z_PtpCapTe~e  z_ROI         FoiPenaliz~J  CNAE_5        CNAE_15       CNAE_25       CNAE_35       DivisaoCN~_7  DivisaoCN~17  DivisaoCN~27  DivisaoCN~37  NaturezaJu~6
PtpCapTerce   Intangivel    QtdeCNAEsS~s  Estrutura_~Z  z_ROE         train         CNAE_6        CNAE_16       CNAE_26       CNAE_36       DivisaoCN~_8  DivisaoCN~18  DivisaoCN~28  DivisaoCN~38  NaturezaJu~7

. 
. * Capturar todas as variáveis que começam com "Porte_"
. unab Porte_vars : Porte_*

. 
. * Capturar todas as variáveis que começam com "CNAE_"
. unab CNAE_vars : CNAE_*

. 
. * Capturar todas as variáveis que começam com "NaturezaJuridica_"
. unab Natureza_vars : NaturezaJuridica_*

. 
. * Definir variáveis contábeis (padronizadas e sintéticas)
. local var_contabeis `Porte_vars' Liquidez_Media_Z Estrutura_Media_Z Margem_Media_Z ///
>     z_LiqCorAjust z_EndGeral z_ImobRecNC z_CompEndivid z_GiroAtivo z_ROI z_ROE

. 
. * Definir variáveis de controle (padronizadas)
. local var_controle `CNAE_vars' `Natureza_vars' z_log_vlrcontrato ///
>     z_QtdeCNAEsSecundarios z_IdadedeAnos z_QtePenalOutrosOrgaos

. 
. *Regressão logística com seleção stepwise a 10% 
. sw, pr(.10): logit FoiPenalizadoSTJ `var_contabeis' `var_controle' if train == 1
note: Porte_4 omitted because of estimability.
note: CNAE_2 omitted because of estimability.
note: CNAE_3 omitted because of estimability.
note: CNAE_4 omitted because of estimability.
note: CNAE_9 omitted because of estimability.
note: CNAE_10 omitted because of estimability.
note: CNAE_11 omitted because of estimability.
note: CNAE_14 omitted because of estimability.
note: CNAE_15 omitted because of estimability.
note: CNAE_16 omitted because of estimability.
note: CNAE_17 omitted because of estimability.
note: CNAE_24 omitted because of estimability.
note: CNAE_26 omitted because of estimability.
note: CNAE_27 omitted because of estimability.
note: CNAE_31 omitted because of estimability.
note: CNAE_34 omitted because of estimability.
note: CNAE_35 omitted because of estimability.
note: CNAE_36 omitted because of estimability.
note: CNAE_37 omitted because of estimability.
note: CNAE_38 omitted because of estimability.
note: NaturezaJuridica_1 omitted because of estimability.
note: NaturezaJuridica_6 omitted because of estimability.
note: NaturezaJuridica_7 omitted because of estimability.
note: NaturezaJuridica_8 omitted because of estimability.
note: NaturezaJuridica_9 omitted because of estimability.
note: NaturezaJuridica_10 omitted because of estimability.
note: 338 obs omitted because of estimability.

Wald test, begin with full model:
p = 0.9806 >= 0.1000, removing NaturezaJuridica_2
p = 0.9791 >= 0.1000, removing Margem_Media_Z
p = 0.9594 >= 0.1000, removing CNAE_32
p = 0.8217 >= 0.1000, removing Porte_3
p = 0.7502 >= 0.1000, removing z_ROI
p = 0.7531 >= 0.1000, removing NaturezaJuridica_4
p = 0.7159 >= 0.1000, removing z_GiroAtivo
p = 0.7393 >= 0.1000, removing Liquidez_Media_Z
p = 0.6911 >= 0.1000, removing z_LiqCorAjust
p = 0.5906 >= 0.1000, removing Porte_1
p = 0.5842 >= 0.1000, removing CNAE_22
p = 0.4147 >= 0.1000, removing CNAE_8
p = 0.3702 >= 0.1000, removing Porte_2
p = 0.4249 >= 0.1000, removing CNAE_23
p = 0.6131 >= 0.1000, removing CNAE_1
p = 0.4767 >= 0.1000, removing CNAE_21
p = 0.2944 >= 0.1000, removing z_CompEndivid
p = 0.2738 >= 0.1000, removing CNAE_28
p = 0.2687 >= 0.1000, removing CNAE_7
p = 0.2483 >= 0.1000, removing CNAE_19
p = 0.2601 >= 0.1000, removing CNAE_6
p = 0.2114 >= 0.1000, removing CNAE_13
p = 0.2161 >= 0.1000, removing CNAE_20
p = 0.2215 >= 0.1000, removing CNAE_18
p = 0.1125 >= 0.1000, removing Estrutura_Media_Z
p = 0.1260 >= 0.1000, removing z_IdadedeAnos

Logistic regression                                     Number of obs =    800
                                                        LR chi2(14)   = 156.00
                                                        Prob > chi2   = 0.0000
Log likelihood = -475.41601                             Pseudo R2     = 0.1409

----------------------------------------------------------------------------------------
      FoiPenalizadoSTJ | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-----------------------+----------------------------------------------------------------
z_QtdeCNAEsSecundarios |  -.2734207   .0894259    -3.06   0.002    -.4486922   -.0981492
               CNAE_29 |   1.532235   .6500483     2.36   0.018     .2581633    2.806306
     z_log_vlrcontrato |   .1656808   .0851165     1.95   0.052    -.0011446    .3325062
z_QtePenalOutrosOrgaos |   .3496835   .0851165     4.11   0.000     .1828583    .5165088
               CNAE_12 |    .588889    .328613     1.79   0.073    -.0551806    1.232959
                CNAE_5 |   .9013343   .2643797     3.41   0.001     .3831596    1.419509
               CNAE_33 |   1.607552   .7346584     2.19   0.029     .1676482    3.047456
            z_EndGeral |   .3129483   .0871594     3.59   0.000      .142119    .4837777
           z_ImobRecNC |  -.5036498    .097779    -5.15   0.000    -.6952932   -.3120064
               CNAE_30 |   1.114859   .4453523     2.50   0.012     .2419848    1.987734
    NaturezaJuridica_3 |  -1.965469   .3497953    -5.62   0.000    -2.651056   -1.279883
    NaturezaJuridica_5 |  -2.211551   1.050807    -2.10   0.035    -4.271095   -.1520064
                 z_ROE |  -.3313146   .1003373    -3.30   0.001     -.527972   -.1346572
               CNAE_25 |   .9487449   .2598343     3.65   0.000     .4394791    1.458011
                 _cons |  -.3530879   .1034867    -3.41   0.001    -.5559182   -.1502576
----------------------------------------------------------------------------------------

. 
. * Armazenar os resultados do modelo stepwise a 10%
. estimates store IRDC10

. 
. * Teste de bondade de ajuste de Hosmer-Lemeshow para o modelo stepwise a 10%
. estat gof if train == 1, group(10) table
note: obs collapsed on 10 quantiles of estimated probabilities.

Goodness-of-fit test after logistic model
Variable: FoiPenalizadoSTJ

  Table collapsed on quantiles of estimated probabilities
  +--------------------------------------------------------+
  | Group |   Prob | Obs_1 | Exp_1 | Obs_0 | Exp_0 | Total |
  |-------+--------+-------+-------+-------+-------+-------|
  |     1 | 0.1880 |    19 |  12.1 |    95 | 101.9 |   114 |
  |     2 | 0.3029 |    32 |  28.8 |    82 |  85.2 |   114 |
  |     3 | 0.3689 |    48 |  38.3 |    66 |  75.7 |   114 |
  |     4 | 0.4206 |    50 |  45.0 |    64 |  69.0 |   114 |
  |     5 | 0.4615 |    74 |  49.7 |    39 |  63.3 |   113 |
  |-------+--------+-------+-------+-------+-------+-------|
  |     6 | 0.5036 |    52 |  55.4 |    62 |  58.6 |   114 |
  |     7 | 0.5470 |    56 |  60.0 |    58 |  54.0 |   114 |
  |     8 | 0.6140 |    66 |  66.4 |    48 |  47.6 |   114 |
  |     9 | 0.7153 |    84 |  76.1 |    30 |  37.9 |   114 |
  |    10 | 0.9677 |    88 |  89.7 |    25 |  23.3 |   113 |
  +--------------------------------------------------------+

 Number of observations =  1,138
       Number of groups =     10
Hosmer–Lemeshow chi2(8) =  34.38
            Prob > chi2 = 0.0000

. 
. /*******************************************************************************
> 6.2.2 Tabela de classificação para o modelo stepwise a 10% na base de treinamento
> *******************************************************************************/
. estat class if train == 1

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |       302           171  |        473
     -     |       267           398  |        665
-----------+--------------------------+-----------
   Total   |       569           569  |       1138

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   53.08%
Specificity                     Pr( -|~D)   69.95%
Positive predictive value       Pr( D| +)   63.85%
Negative predictive value       Pr(~D| -)   59.85%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   30.05%
False - rate for true D         Pr( -| D)   46.92%
False + rate for classified +   Pr(~D| +)   36.15%
False - rate for classified -   Pr( D| -)   40.15%
--------------------------------------------------
Correctly classified                        61.51%
--------------------------------------------------

. 
. * 📌 Gerar predições na base de treinamento
. capture drop prob_pred_treino

. predict prob_pred_treino if train == 1, pr
(211 missing values generated)

. 
. * 📌 Classificação prevista
. capture drop predicted_class_treino

. gen predicted_class_treino = (prob_pred_treino >= 0.5) if train == 1
(211 missing values generated)

. 
. * 📌 Kappa na base de treinamento
. *ssc install kappaetc, replace
. kappaetc FoiPenalizadoSTJ predicted_class_treino if train == 1

Interrater agreement                             Number of subjects =    1138
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.6151    0.0144  42.63   0.000     0.5868     0.6434
Brennan and Prediger |  0.2302    0.0289   7.98   0.000     0.1736     0.2869
Cohen/Conger's Kappa |  0.2302    0.0284   8.09   0.000     0.1744     0.2860
    Scott/Fleiss' Pi |  0.2247    0.0290   7.76   0.000     0.1679     0.2815
           Gwet's AC |  0.2357    0.0291   8.11   0.000     0.1787     0.2927
Krippendorff's Alpha |  0.2251    0.0290   7.77   0.000     0.1682     0.2819
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de treinamento
. capture drop correct_classification_treino

. gen correct_classification_treino = (FoiPenalizadoSTJ == predicted_class_treino) if train == 1
(211 missing values generated)

. sum correct_classification_treino if train == 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~o |      1,138    .6151142    .4867822          0          1

. scalar prop_modelo_treino = r(mean)

. 
. * 📌 No Information Rate (NIR)
. *O NIR representa a acurácia de um modelo nulo (baseline), que classifica sempre a categoria mais frequente.
. tabulate FoiPenalizadoSTJ if train == 1, matcell(freq_treino)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        569       50.00       50.00
          1 |        569       50.00      100.00
------------+-----------------------------------
      Total |      1,138      100.00

. scalar total_treino = freq_treino[1,1] + freq_treino[2,1]

. scalar max_treino = max(freq_treino[1,1], freq_treino[2,1])

. scalar prop_nir_treino = max_treino / total_treino

. 
. * 📌 Comparação
. di "Acurácia na base de treinamento: " prop_modelo_treino
Acurácia na base de treinamento: .61511424

. di "NIR (treinamento): " prop_nir_treino
NIR (treinamento): .5

. 
. if (prop_modelo_treino > prop_nir_treino) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de treino."
✅ Modelo stepwise 10% supera o NIR na base de treino.
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de treino."
. }

. 
. * 📌 Teste de McNemar na base de treinamento
. * Criar a matriz de confusão da base de teste
. tabulate FoiPenalizadoSTJ predicted_class_treino if train == 1, matcell(mc_treino)

           | predicted_class_trein
FoiPenaliz |           o
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       398        171 |       569 
         1 |       267        302 |       569 
-----------+----------------------+----------
     Total |       665        473 |     1,138 

. 
. * Extrair os valores da matriz
. scalar tn_treino = mc_treino[1,1] // Verdadeiro Negativo

. scalar fn_treino = mc_treino[2,1] // Falso Negativo

. scalar fp_treino = mc_treino[1,2] // Falso Positivo

. scalar tp_treino = mc_treino[2,2] // Verdadeiro Positivo

. 
. * Mostrar os valores extraídos (opcional)
. di "TN: " tn_treino
TN: 398

. di "FN: " fn_treino
FN: 267

. di "FP: " fp_treino
FP: 171

. di "TP: " tp_treino
TP: 302

. 
. * Rodar o teste de McNemar com os valores numéricos
. mcci `=tn_treino' `=fn_treino' `=fp_treino' `=tp_treino'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       398         267  |        665
       Unexposed |       171         302  |        473
-----------------+------------------------+-----------
           Total |       569         569  |       1138

McNemar's chi2(1) =     21.04    Prob > chi2 = 0.0000
Exact McNemar significance probability       = 0.0000

Proportion with factor
        Cases       .5843585
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference  .0843585      .0477697   .1209473
        ratio       1.168717      1.093325   1.249308
        rel. diff.   .168717      .1029895   .2344446

        odds ratio  1.561404      1.283864   1.903111   (exact)

. 
. /*******************************************************************************
> 6.2.3 Curva ROC para o modelo stepwise a 10% na base de TREINO
> *******************************************************************************/
. lroc if train == 1

Logistic model for FoiPenalizadoSTJ

Number of observations =     1138
Area under ROC curve   =   0.6915

. graph export "lroc_IRDC10_treino.png", replace
(file lroc_IRDC10_treino.png not found)
file lroc_IRDC10_treino.png saved as PNG format

. 
. /*******************************************************************************
> 6.2.4 Tabela de classificação para o modelo stepwise a 10% na base de TESTE
> *******************************************************************************/
. estat class if train == 0

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |        29            44  |         73
     -     |        40            98  |        138
-----------+--------------------------+-----------
   Total   |        69           142  |        211

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   42.03%
Specificity                     Pr( -|~D)   69.01%
Positive predictive value       Pr( D| +)   39.73%
Negative predictive value       Pr(~D| -)   71.01%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   30.99%
False - rate for true D         Pr( -| D)   57.97%
False + rate for classified +   Pr(~D| +)   60.27%
False - rate for classified -   Pr( D| -)   28.99%
--------------------------------------------------
Correctly classified                        60.19%
--------------------------------------------------

. 
. * 📌 Gerar predições na base de teste
. capture drop prob_pred_teste

. predict prob_pred_teste if train == 0, pr
(1,138 missing values generated)

. 
. * 📌 Classificação prevista
. capture drop predicted_class_teste

. gen predicted_class_teste = (prob_pred_teste >= 0.5) if train == 0
(1,138 missing values generated)

. 
. * 📌 Kappa na base de teste
. kappaetc FoiPenalizadoSTJ predicted_class_teste if train == 0

Interrater agreement                             Number of subjects =     211
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.6019    0.0338  17.82   0.000     0.5353     0.6685
Brennan and Prediger |  0.2038    0.0676   3.02   0.003     0.0706     0.3370
Cohen/Conger's Kappa |  0.1088    0.0700   1.55   0.122    -0.0293     0.2469
    Scott/Fleiss' Pi |  0.1085    0.0701   1.55   0.123    -0.0297     0.2466
           Gwet's AC |  0.2807    0.0714   3.93   0.000     0.1399     0.4215
Krippendorff's Alpha |  0.1106    0.0701   1.58   0.116    -0.0276     0.2488
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de teste
. capture drop correct_classification_teste

. gen correct_classification_teste = (FoiPenalizadoSTJ == predicted_class_teste) if train == 0
(1,138 missing values generated)

. sum correct_classification_teste if train == 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~e |        211    .6018957    .4906713          0          1

. scalar prop_modelo_teste = r(mean)

. 
. * 📌 No Information Rate (NIR)
. tabulate FoiPenalizadoSTJ if train == 0, matcell(freq_teste)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        142       67.30       67.30
          1 |         69       32.70      100.00
------------+-----------------------------------
      Total |        211      100.00

. scalar total_teste = freq_teste[1,1] + freq_teste[2,1]

. scalar max_teste = max(freq_teste[1,1], freq_teste[2,1])

. scalar prop_nir_teste = max_teste / total_teste

. 
. 
. * 📌 Comparação
. di "Acurácia na base de teste: " prop_modelo_teste
Acurácia na base de teste: .60189573

. di "NIR (teste): " prop_nir_teste
NIR (teste): .67298578

. 
. if (prop_modelo_teste > prop_nir_teste) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de teste."
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste."
⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste.
. }

. 
. * 📌 Teste de McNemar na base de teste
. * Criar a matriz de confusão da base de teste
. tabulate FoiPenalizadoSTJ predicted_class_teste if train == 0, matcell(mc_teste)

FoiPenaliz | predicted_class_teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |        98         44 |       142 
         1 |        40         29 |        69 
-----------+----------------------+----------
     Total |       138         73 |       211 

. 
. * Extrair os valores da matriz
. scalar tn_teste = mc_teste[1,1] // Verdadeiro Negativo

. scalar fn_teste = mc_teste[2,1] // Falso Negativo

. scalar fp_teste = mc_teste[1,2] // Falso Positivo

. scalar tp_teste = mc_teste[2,2] // Verdadeiro Positivo

. 
. * Mostrar os valores extraídos (opcional)
. di "TN: " tn_teste
TN: 98

. di "FN: " fn_teste
FN: 40

. di "FP: " fp_teste
FP: 44

. di "TP: " tp_teste
TP: 29

. 
. * Rodar o teste de McNemar com os valores numéricos
. mcci `=tn_teste' `=fn_teste' `=fp_teste' `=tp_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |        98          40  |        138
       Unexposed |        44          29  |         73
-----------------+------------------------+-----------
           Total |       142          69  |        211

McNemar's chi2(1) =      0.19    Prob > chi2 = 0.6625
Exact McNemar significance probability       = 0.7436

Proportion with factor
        Cases       .6540284
        Controls    .6729858     [95% conf. interval]
                   ---------     --------------------
        difference -.0189573     -.1087927    .070878
        ratio        .971831      .8547928   1.104894
        rel. diff.  -.057971     -.3257494   .2098074

        odds ratio  .9090909      .5773427   1.427691   (exact)

. 
. /*******************************************************************************
> 6.2.5 Curva ROC para o modelo stepwise a 10% na base de TESTE
> *******************************************************************************/
. lroc if train == 0

Logistic model for FoiPenalizadoSTJ

Number of observations =      211
Area under ROC curve   =   0.5649

. graph export "lroc_IRDC10_teste.png", replace
(file lroc_IRDC10_teste.png not found)
file lroc_IRDC10_teste.png saved as PNG format

. 
. /*******************************************************************************
> 6.2.6 – Ponto de Corte Ideal (Sensibilidade ≈ Especificidade)
> *******************************************************************************/
. 
. * Reexecutar rapidamente o modelo (sem sobrescrever)
. quietly logit FoiPenalizadoSTJ `var_contabeis' `var_controle' if train == 1

. 
. * Restaurar modelo salvo
. estimates restore IRDC10
(results IRDC10 are active now)

. 
. * 📌 BASE DE TREINAMENTO
. * ------------------------------------------------------------
. * Garantir que as variáveis temporárias não existam
. capture drop prob_pred_treino

. capture drop cutoff

. capture drop sens

. capture drop spec

. capture drop difference

. capture drop abs_diff

. capture drop ordem

. 
. * Gerar predições
. predict prob_pred_treino if train == 1, pr
(211 missing values generated)

. 
. * Gerar sensitividade e especificidade para diferentes cutoffs
. lsens if train == 1, genprob(cutoff) gensens(sens) genspec(spec) nograph

. 
. * Calcular diferença entre sensibilidade e especificidade
. gen difference = sens - spec
(213 missing values generated)

. gen abs_diff = abs(difference)
(213 missing values generated)

. 
. * Obter ponto ideal (menor diferença)
. gen ordem = _n

. gsort abs_diff

. 
. * Salvar valores do melhor ponto em scalars usando summarize
. summarize cutoff if abs_diff == abs_diff[1]

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
      cutoff |          1    .4615443           .   .4615443   .4615443

. scalar cutoff_ideal_treino = r(mean)

. 
. summarize sens if abs_diff == abs_diff[1]

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        sens |          1    .6080844           .   .6080844   .6080844

. scalar sens_ideal_treino = r(mean)

. scalar cutoff_step10 = cutoff_ideal_treino

. 
. 
. summarize spec if abs_diff == abs_diff[1]

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        spec |          1    .6080843           .   .6080843   .6080843

. scalar spec_ideal_treino = r(mean)

. 
. * Mostrar o ponto ideal encontrado
. list cutoff sens spec abs_diff in 1, noobs clean

      cutoff       sens       spec   abs_diff  
    0.461544   0.608084   0.608084   5.96e-08  

. 
. * Plotar gráfico com destaque no ponto de cruzamento
. lsens if train == 1, ///
>     yline(`=sens_ideal_treino') xline(`=cutoff_ideal_treino') ///
>     scheme(s1color) ///
>     ylab(0 0.2 `=sens_ideal_treino' 0.8 1) ///
>     xlab(0 0.2 `=cutoff_ideal_treino' 0.8 1)

. 
. graph export "cutoff_ideal_IRDC10_treino.png", replace
(file cutoff_ideal_IRDC10_treino.png not found)
file cutoff_ideal_IRDC10_treino.png saved as PNG format

. 
. /*******************************************************************************
> 6.2.7 – Tabela de Classificação com Cutoff Ideal (Treinamento e Teste)
> *******************************************************************************/
. 
. * 📌 BASE DE TREINAMENTO
. * ------------------------------------------------------------
. 
. di "Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO: " cutoff_ideal_treino
Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO: .46154429

. 
. * Gerar classificação com o cutoff ideal
. capture drop predicted_class_treino

. gen predicted_class_treino = (prob_pred_treino >= cutoff_ideal_treino) if train == 1
(211 missing values generated)

. 
. * Matriz de classificação detalhada
. estat class if train == 1

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |       302           171  |        473
     -     |       267           398  |        665
-----------+--------------------------+-----------
   Total   |       569           569  |       1138

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   53.08%
Specificity                     Pr( -|~D)   69.95%
Positive predictive value       Pr( D| +)   63.85%
Negative predictive value       Pr(~D| -)   59.85%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   30.05%
False - rate for true D         Pr( -| D)   46.92%
False + rate for classified +   Pr(~D| +)   36.15%
False - rate for classified -   Pr( D| -)   40.15%
--------------------------------------------------
Correctly classified                        61.51%
--------------------------------------------------

. 
. * Kappa
. kappaetc FoiPenalizadoSTJ predicted_class_treino if train == 1

Interrater agreement                             Number of subjects =    1138
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.6081    0.0145  42.00   0.000     0.5797     0.6365
Brennan and Prediger |  0.2162    0.0290   7.47   0.000     0.1594     0.2730
Cohen/Conger's Kappa |  0.2162    0.0290   7.47   0.000     0.1594     0.2730
    Scott/Fleiss' Pi |  0.2162    0.0290   7.47   0.000     0.1594     0.2730
           Gwet's AC |  0.2162    0.0290   7.47   0.000     0.1594     0.2730
Krippendorff's Alpha |  0.2165    0.0290   7.48   0.000     0.1597     0.2733
------------------------------------------------------------------------------

. 
. * Acurácia
. capture drop correct_classification_treino

. gen correct_classification_treino = (FoiPenalizadoSTJ == predicted_class_treino) if train == 1
(211 missing values generated)

. sum correct_classification_treino if train == 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~o |      1,138    .6080844    .4883926          0          1

. scalar prop_modelo_treino = r(mean)

. 
. * No Information Rate
. tabulate FoiPenalizadoSTJ if train == 1, matcell(freq_treino)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        569       50.00       50.00
          1 |        569       50.00      100.00
------------+-----------------------------------
      Total |      1,138      100.00

. scalar total_treino = freq_treino[1,1] + freq_treino[2,1]

. scalar max_treino = max(freq_treino[1,1], freq_treino[2,1])

. scalar prop_nir_treino = max_treino / total_treino

. 
. di "Acurácia (treino): " prop_modelo_treino
Acurácia (treino): .60808436

. di "NIR (treino): " prop_nir_treino
NIR (treino): .5

. 
. if (prop_modelo_treino > prop_nir_treino) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de treino (cutoff ideal)."
✅ Modelo stepwise 10% supera o NIR na base de treino (cutoff ideal).
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de treino (cutoff ideal)."
. }

. 
. * Teste de McNemar
. tabulate FoiPenalizadoSTJ predicted_class_treino if train == 1, matcell(mc_treino)

           | predicted_class_trein
FoiPenaliz |           o
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       346        223 |       569 
         1 |       223        346 |       569 
-----------+----------------------+----------
     Total |       569        569 |     1,138 

. scalar tn_treino = mc_treino[1,1]

. scalar fn_treino = mc_treino[2,1]

. scalar fp_treino = mc_treino[1,2]

. scalar tp_treino = mc_treino[2,2]

. mcci `=tn_treino' `=fn_treino' `=fp_treino' `=tp_treino'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       346         223  |        569
       Unexposed |       223         346  |        569
-----------------+------------------------+-----------
           Total |       569         569  |       1138

McNemar's chi2(1) =      0.00    Prob > chi2 = 1.0000
Exact McNemar significance probability       = 1.0000

Proportion with factor
        Cases             .5
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference         0     -.0372512   .0372512
        ratio              1      .9298379   1.075456
        rel. diff.         0      -.072745    .072745

        odds ratio         1      .8268457   1.209416   (exact)

. 
. 
. * 📌 BASE DE TESTE
. * ------------------------------------------------------------
. 
. di "Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO (aplicado na base de TESTE): " cutoff_ideal_treino
Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO (aplicado na base de TESTE): .46154429

. 
. * Gerar classificação com o mesmo cutoff da base de teste
. capture drop predicted_class_teste

. gen predicted_class_teste = (prob_pred_teste >= cutoff_ideal_treino) if train == 0
(1,138 missing values generated)

. 
. * Matriz de classificação detalhada
. estat class if train == 0

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |        29            44  |         73
     -     |        40            98  |        138
-----------+--------------------------+-----------
   Total   |        69           142  |        211

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   42.03%
Specificity                     Pr( -|~D)   69.01%
Positive predictive value       Pr( D| +)   39.73%
Negative predictive value       Pr(~D| -)   71.01%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   30.99%
False - rate for true D         Pr( -| D)   57.97%
False + rate for classified +   Pr(~D| +)   60.27%
False - rate for classified -   Pr( D| -)   28.99%
--------------------------------------------------
Correctly classified                        60.19%
--------------------------------------------------

. 
. * Kappa
. kappaetc FoiPenalizadoSTJ predicted_class_teste if train == 0

Interrater agreement                             Number of subjects =     211
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.5640    0.0342  16.48   0.000     0.4965     0.6314
Brennan and Prediger |  0.1280    0.0684   1.87   0.063    -0.0070     0.2629
Cohen/Conger's Kappa |  0.0844    0.0676   1.25   0.213    -0.0489     0.2177
    Scott/Fleiss' Pi |  0.0739    0.0694   1.06   0.288    -0.0629     0.2106
           Gwet's AC |  0.1761    0.0724   2.43   0.016     0.0335     0.3187
Krippendorff's Alpha |  0.0760    0.0694   1.10   0.274    -0.0607     0.2128
------------------------------------------------------------------------------

. 
. * Acurácia
. capture drop correct_classification_teste

. gen correct_classification_teste = (FoiPenalizadoSTJ == predicted_class_teste) if train == 0
(1,138 missing values generated)

. sum correct_classification_teste if train == 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~e |        211     .563981    .4970688          0          1

. scalar prop_modelo_teste = r(mean)

. 
. * No Information Rate
. tabulate FoiPenalizadoSTJ if train == 0, matcell(freq_teste)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        142       67.30       67.30
          1 |         69       32.70      100.00
------------+-----------------------------------
      Total |        211      100.00

. scalar total_teste = freq_teste[1,1] + freq_teste[2,1]

. scalar max_teste = max(freq_teste[1,1], freq_teste[2,1])

. scalar prop_nir_teste = max_teste / total_teste

. 
. di "Acurácia (teste): " prop_modelo_teste
Acurácia (teste): .56398104

. di "NIR (teste): " prop_nir_teste
NIR (teste): .67298578

. 
. if (prop_modelo_teste > prop_nir_teste) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de teste (cutoff ideal do treino)."
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste (cutoff ideal do treino)."
⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste (cutoff ideal do treino).
. }

. 
. * Teste de McNemar
. tabulate FoiPenalizadoSTJ predicted_class_teste if train == 0, matcell(mc_teste)

FoiPenaliz | predicted_class_teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |        85         57 |       142 
         1 |        35         34 |        69 
-----------+----------------------+----------
     Total |       120         91 |       211 

. scalar tn_teste = mc_teste[1,1]

. scalar fn_teste = mc_teste[2,1]

. scalar fp_teste = mc_teste[1,2]

. scalar tp_teste = mc_teste[2,2]

. mcci `=tn_teste' `=fn_teste' `=fp_teste' `=tp_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |        85          35  |        120
       Unexposed |        57          34  |         91
-----------------+------------------------+-----------
           Total |       142          69  |        211

McNemar's chi2(1) =      5.26    Prob > chi2 = 0.0218
Exact McNemar significance probability       = 0.0280

Proportion with factor
        Cases       .5687204
        Controls    .6729858     [95% conf. interval]
                   ---------     --------------------
        difference -.1042654     -.1969833  -.0115475
        ratio       .8450704      .7317253   .9759729
        rel. diff. -.3188406     -.6317287  -.0059525

        odds ratio  .6140351      .3911622    .951663   (exact)

. 
. /*******************************************************************************
> 6.3 Regressão logística com seleção via LASSO (penalização L1) no conjunto de treinamento
> 
>  O LASSO (Least Absolute Shrinkage and Selection Operator) realiza seleção automática
> de variáveis e reduz o risco de overfitting (sobreajuste), especialmente útil em 
> modelos com muitas variáveis e potencial multicolinearidade.
> 
> *******************************************************************************/
. 
. * 6.1 Listar todas as variáveis disponíveis
. ds
LiqCorrente   GiroAtivo     PC            AnodasDemo~s  z_MargOp      z_log_vlrc~o  Porte_2       CNAE_8        CNAE_18       CNAE_28       CNAE_38       DivisaoCN~10  DivisaoCN~20  DivisaoCN~30  DivisaoCN~40  NaturezaJu~9  abs_diff
LiqGeral      MargOp        PNC           cnpjs         z_MargLiq     z_QtdeCNAE~s  Porte_3       CNAE_9        CNAE_19       CNAE_29       DivisaoCN~_1  DivisaoCN~11  DivisaoCN~21  DivisaoCN~31  DivisaoCN~41  NaturezaJ~10  ordem
LiqCorAjust   MargLiq       PL            z_LiqCorre~e  Margem_Med~Z  z_QtePenal~s  Porte_4       CNAE_10       CNAE_20       CNAE_30       DivisaoCN~_2  DivisaoCN~12  DivisaoCN~22  DivisaoCN~32  NaturezaJu~1  _est_IRDCc~o  predicted_~o
SolvGeral     ROI           RecBruta      z_LiqGeral    z_LiqCorAj~t  z_IdadedeA~s  CNAE_1        CNAE_11       CNAE_21       CNAE_31       DivisaoCN~_3  DivisaoCN~13  DivisaoCN~23  DivisaoCN~33  NaturezaJu~2  prob_pred_~e  correct_cl~o
EndGeral      ROE           LucroBruto    z_SolvGeral   z_EndGeral    u             CNAE_2        CNAE_12       CNAE_22       CNAE_32       DivisaoCN~_4  DivisaoCN~14  DivisaoCN~24  DivisaoCN~34  NaturezaJu~3  _est_IRDC10   predicted_~e
CompEndivid   AC            LucroLiquido  z_IndepFin    z_ImobRecNC   obs_no        CNAE_3        CNAE_13       CNAE_23       CNAE_33       DivisaoCN~_5  DivisaoCN~15  DivisaoCN~25  DivisaoCN~35  NaturezaJu~4  prob_pred_~o  correct_cl~e
IndepFin      ANRP          QtePenalOu~s  Liquidez_M~Z  z_CompEndi~d  total_obs     CNAE_4        CNAE_14       CNAE_24       CNAE_34       DivisaoCN~_6  DivisaoCN~16  DivisaoCN~26  DivisaoCN~36  NaturezaJu~5  spec
ImobilPL      Investimen~s  vlrcontrato   z_ImobilPL    z_GiroAtivo   FoiPenaliz~J  CNAE_5        CNAE_15       CNAE_25       CNAE_35       DivisaoCN~_7  DivisaoCN~17  DivisaoCN~27  DivisaoCN~37  NaturezaJu~6  sens
ImobRecNC     Imobilizado   IdadedeAnos   z_PtpCapTe~e  z_ROI         train         CNAE_6        CNAE_16       CNAE_26       CNAE_36       DivisaoCN~_8  DivisaoCN~18  DivisaoCN~28  DivisaoCN~38  NaturezaJu~7  cutoff
PtpCapTerce   Intangivel    QtdeCNAEsS~s  Estrutura_~Z  z_ROE         Porte_1       CNAE_7        CNAE_17       CNAE_27       CNAE_37       DivisaoCN~_9  DivisaoCN~19  DivisaoCN~29  DivisaoCN~39  NaturezaJu~8  difference

. 
. * Capturar todas as variáveis que começam com "Porte_"
. unab Porte_vars : Porte_*

. 
. * Capturar todas as variáveis que começam com "CNAE_"
. unab CNAE_vars : CNAE_*

. 
. * Capturar todas as variáveis que começam com "NaturezaJuridica_"
. unab Natureza_vars : NaturezaJuridica_*

. 
. * Definir variáveis contábeis (padronizadas e sintéticas)
. local var_contabeis `Porte_vars' Liquidez_Media_Z Estrutura_Media_Z Margem_Media_Z ///
>     z_LiqCorAjust z_EndGeral z_ImobRecNC z_CompEndivid z_GiroAtivo z_ROI z_ROE

. 
. * Definir variáveis de controle (padronizadas)
. local var_controle `CNAE_vars' `Natureza_vars' z_log_vlrcontrato ///
>     z_QtdeCNAEsSecundarios z_IdadedeAnos z_QtePenalOutrosOrgaos

. 
. * Consolidar todas as variáveis em uma macro
. local todas_vars `var_contabeis' `var_controle'

. 
. *Ajustar modelo LASSO na base de treinamento
. lasso logit FoiPenalizadoSTJ `todas_vars' if train == 1, selection(cv)
note: NaturezaJuridica_6 omitted because it is constant in C.V. subsamples.
note: NaturezaJuridica_7 omitted because it is constant in C.V. subsamples.
note: NaturezaJuridica_8 omitted because it is constant in C.V. subsamples.
10-fold cross-validation with 100 lambdas ...
Grid value 1:     lambda = .1312277   no. of nonzero coef. =  0
Folds: 1...5....10   CVF = 1.387541
Grid value 2:     lambda = .1195698   no. of nonzero coef. =  1
Folds: 1...5....10   CVF = 1.379544
Grid value 3:     lambda = .1089476   no. of nonzero coef. =  1
Folds: 1...5....10   CVF = 1.370288
Grid value 4:     lambda =  .099269   no. of nonzero coef. =  3
Folds: 1...5....10   CVF = 1.355484
Grid value 5:     lambda = .0904502   no. of nonzero coef. =  3
Folds: 1...5....10   CVF = 1.337238
Grid value 6:     lambda = .0824148   no. of nonzero coef. =  4
Folds: 1...5....10   CVF = 1.320585
Grid value 7:     lambda = .0750933   no. of nonzero coef. =  5
Folds: 1...5....10   CVF = 1.304023
Grid value 8:     lambda = .0684223   no. of nonzero coef. =  7
Folds: 1...5....10   CVF = 1.282685
Grid value 9:     lambda = .0623438   no. of nonzero coef. =  7
Folds: 1...5....10   CVF = 1.260713
Grid value 10:    lambda = .0568054   no. of nonzero coef. = 11
Folds: 1...5....10   CVF = 1.237917
Grid value 11:    lambda = .0517589   no. of nonzero coef. = 12
Folds: 1...5....10   CVF = 1.214622
Grid value 12:    lambda = .0471608   no. of nonzero coef. = 16
Folds: 1...5....10   CVF = 1.191878
Grid value 13:    lambda = .0429712   no. of nonzero coef. = 21
Folds: 1...5....10   CVF =  1.16736
Grid value 14:    lambda = .0391537   no. of nonzero coef. = 23
Folds: 1...5....10   CVF = 1.140063
Grid value 15:    lambda = .0356754   no. of nonzero coef. = 25
Folds: 1...5....10   CVF = 1.113445
Grid value 16:    lambda = .0325061   no. of nonzero coef. = 27
Folds: 1...5....10   CVF = 1.088342
Grid value 17:    lambda = .0296184   no. of nonzero coef. = 28
Folds: 1...5....10   CVF = 1.066078
Grid value 18:    lambda = .0269871   no. of nonzero coef. = 29
Folds: 1...5....10   CVF = 1.046549
Grid value 19:    lambda = .0245897   no. of nonzero coef. = 29
Folds: 1...5....10   CVF = 1.029549
Grid value 20:    lambda = .0224052   no. of nonzero coef. = 29
Folds: 1...5....10   CVF = 1.014737
Grid value 21:    lambda = .0204148   no. of nonzero coef. = 31
Folds: 1...5....10   CVF = 1.001856
Grid value 22:    lambda = .0186012   no. of nonzero coef. = 32
Folds: 1...5....10   CVF = .9907208
Grid value 23:    lambda = .0169487   no. of nonzero coef. = 33
Folds: 1...5....10   CVF = .9809732
Grid value 24:    lambda =  .015443   no. of nonzero coef. = 36
Folds: 1...5....10   CVF = .9725248
Grid value 25:    lambda = .0140711   no. of nonzero coef. = 39
Folds: 1...5....10   CVF = .9649478
Grid value 26:    lambda = .0128211   no. of nonzero coef. = 38
Folds: 1...5....10   CVF = .9583274
Grid value 27:    lambda = .0116821   no. of nonzero coef. = 38
Folds: 1...5....10   CVF = .9523288
Grid value 28:    lambda = .0106443   no. of nonzero coef. = 40
Folds: 1...5....10   CVF =  .947196
Grid value 29:    lambda = .0096987   no. of nonzero coef. = 43
Folds: 1...5....10   CVF = .9430073
Grid value 30:    lambda = .0088371   no. of nonzero coef. = 43
Folds: 1...5....10   CVF = .9395054
Grid value 31:    lambda =  .008052   no. of nonzero coef. = 44
Folds: 1...5....10   CVF = .9364778
Grid value 32:    lambda = .0073367   no. of nonzero coef. = 45
Folds: 1...5....10   CVF = .9337078
Grid value 33:    lambda = .0066849   no. of nonzero coef. = 46
Folds: 1...5....10   CVF = .9309923
Grid value 34:    lambda = .0060911   no. of nonzero coef. = 48
Folds: 1...5....10   CVF = .9285612
Grid value 35:    lambda = .0055499   no. of nonzero coef. = 48
Folds: 1...5....10   CVF = .9264063
Grid value 36:    lambda = .0050569   no. of nonzero coef. = 48
Folds: 1...5....10   CVF = .9246146
Grid value 37:    lambda = .0046077   no. of nonzero coef. = 49
Folds: 1...5....10   CVF = .9230701
Grid value 38:    lambda = .0041983   no. of nonzero coef. = 50
Folds: 1...5....10   CVF = .9216578
Grid value 39:    lambda = .0038254   no. of nonzero coef. = 50
Folds: 1...5....10   CVF = .9204546
Grid value 40:    lambda = .0034855   no. of nonzero coef. = 50
Folds: 1...5....10   CVF = .9193329
Grid value 41:    lambda = .0031759   no. of nonzero coef. = 50
Folds: 1...5....10   CVF = .9182567
Grid value 42:    lambda = .0028937   no. of nonzero coef. = 51
Folds: 1...5....10   CVF = .9173068
Grid value 43:    lambda = .0026367   no. of nonzero coef. = 53
Folds: 1...5....10   CVF = .9165276
Grid value 44:    lambda = .0024024   no. of nonzero coef. = 53
Folds: 1...5....10   CVF = .9159022
Grid value 45:    lambda =  .002189   no. of nonzero coef. = 54
Folds: 1...5....10   CVF = .9154001
Grid value 46:    lambda = .0019945   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9150075
Grid value 47:    lambda = .0018174   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9146909
Grid value 48:    lambda = .0016559   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9144526
Grid value 49:    lambda = .0015088   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9143149
Grid value 50:    lambda = .0013748   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9142381
Grid value 51:    lambda = .0012526   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9142005
Grid value 52:    lambda = .0011414   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9142068
Grid value 53:    lambda =   .00104   no. of nonzero coef. = 55
Folds: 1...5....10   CVF =  .914263
Grid value 54:    lambda = .0009476   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9143901
Grid value 55:    lambda = .0008634   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9145455
Grid value 56:    lambda = .0007867   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9147294
Grid value 57:    lambda = .0007168   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9149367
Grid value 58:    lambda = .0006531   no. of nonzero coef. = 56
Folds: 1...5....10   CVF = .9151655
Grid value 59:    lambda = .0005951   no. of nonzero coef. = 57
Folds: 1...5....10   CVF = .9154202
Grid value 60:    lambda = .0005422   no. of nonzero coef. = 57
Folds: 1...5....10   CVF = .9157117
... cross-validation complete ... minimum found

Lasso logit model                           No. of obs        =      1,138
                                            No. of covariates =         63
Selection: Cross-validation                 No. of CV folds   =         10

--------------------------------------------------------------------------
         |                                No. of      Out-of-
         |                               nonzero       sample      CV mean
      ID |     Description      lambda     coef.   dev. ratio     deviance
---------+----------------------------------------------------------------
       1 |    first lambda    .1312277         0      -0.0009     1.387541
      50 |   lambda before    .0013748        55       0.3405     .9142381
    * 51 | selected lambda    .0012526        55       0.3405     .9142005
      52 |    lambda after    .0011414        55       0.3405     .9142068
      60 |     last lambda    .0005422        57       0.3395     .9157117
--------------------------------------------------------------------------
* lambda selected by cross-validation.

. 
. * Salvar modelo
. estimates store IRDC_LASSO

. 
. 
. /*******************************************************************************
> 6.3.1 – Exportar Coeficientes Selecionados do Modelo LASSO (via log + conversão via Python)
> *******************************************************************************/
. 
. * Garantir que qualquer log anterior esteja fechado
. capture log close lassolog

. 
. * Abrir log no diretório atual (o mesmo de execução)
. log using "coef_lasso.txt", name(lassolog) text replace
(file C:\Users\morenos\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata\coef_lasso.txt not found)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  lassolog
       log:  C:\Users\morenos\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata\coef_lasso.txt
  log type:  text
 opened on:  31 Jul 2025, 17:09:34

. 
. * Exibir os coeficientes selecionados
. lassocoef, display(coef, postselection)

-----------------------------------
                       | IRDC_LASSO
-----------------------+-----------
               Porte_1 |  -.1998718
               Porte_2 |    .161732
               Porte_3 |   .0750556
      Liquidez_Media_Z |   .0311332
     Estrutura_Media_Z |  -.1466741
        Margem_Media_Z |   .0002438
         z_LiqCorAjust |   -.066545
            z_EndGeral |   .3685391
           z_ImobRecNC |   -.418532
         z_CompEndivid |    .079418
           z_GiroAtivo |   .0453944
                 z_ROI |  -.0599903
                 z_ROE |  -.2819734
                CNAE_1 |  -.7761239
                CNAE_2 |  -19.41626
                CNAE_3 |   19.06766
                CNAE_4 |   19.12641
                CNAE_5 |   .4412466
                CNAE_6 |  -.1395935
                CNAE_8 |  -.6024977
                CNAE_9 |   17.77768
               CNAE_10 |   18.47917
               CNAE_11 |   18.49039
               CNAE_14 |   18.71976
               CNAE_15 |   18.90927
               CNAE_16 |   18.88389
               CNAE_17 |   18.44502
               CNAE_18 |  -.1963496
               CNAE_19 |   .0636502
               CNAE_20 |   2.612778
               CNAE_21 |  -.5079672
               CNAE_22 |  -1.841828
               CNAE_23 |  -.6391353
               CNAE_24 |  -18.89076
               CNAE_25 |   .4477604
               CNAE_26 |   19.07099
               CNAE_27 |   -19.2054
               CNAE_28 |  -.2386207
               CNAE_29 |   .9577632
               CNAE_30 |   .5955041
               CNAE_31 |  -19.18762
               CNAE_32 |  -1.176223
               CNAE_33 |   1.095565
               CNAE_34 |  -18.99002
               CNAE_35 |  -1.155944
               CNAE_36 |  -18.37497
               CNAE_37 |  -18.59457
               CNAE_38 |   18.64299
    NaturezaJuridica_4 |   2.044075
    NaturezaJuridica_9 |   2.531686
   NaturezaJuridica_10 |  -15.55917
     z_log_vlrcontrato |    .272182
z_QtdeCNAEsSecundarios |  -.3190683
         z_IdadedeAnos |   -.151559
z_QtePenalOutrosOrgaos |   .4338163
                 _cons |  -1.863688
-----------------------------------
Legend:
  b - base level
  e - empty cell
  o - omitted

. 
. * Fechar o log
. log close lassolog
      name:  lassolog
       log:  C:\Users\morenos\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata\coef_lasso.txt
  log type:  text
 closed on:  31 Jul 2025, 17:09:34
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

. 
. display "✅ coef_lasso.txt exportado com sucesso."
✅ coef_lasso.txt exportado com sucesso.

. 
. 
. /*******************************************************************************
> 6.3.2 Tabela de Classificação, Acurácia, NIR e Teste de McNemar para o 
> Modelo LASSO na base de treino
> *******************************************************************************/
. 
. * 📌 Gerar predições de probabilidade na base de treinamento
. capture drop prob_pred_lasso

. predict prob_pred_lasso if train == 1, xb
(option penalized assumed; linear prediction with penalized coefficients)

. 
. * 📌 Classificação prevista com cutoff 0.5
. capture drop pred_lasso

. gen pred_lasso = (prob_pred_lasso >= 0.5) if train == 1
(211 missing values generated)

. 
. * 📌 Kappa
. kappaetc FoiPenalizadoSTJ pred_lasso if train == 1

Interrater agreement                             Number of subjects =    1138
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.7671    0.0125  61.20   0.000     0.7425     0.7917
Brennan and Prediger |  0.5343    0.0251  21.31   0.000     0.4851     0.5835
Cohen/Conger's Kappa |  0.5343    0.0241  22.17   0.000     0.4870     0.5815
    Scott/Fleiss' Pi |  0.5252    0.0255  20.61   0.000     0.4752     0.5752
           Gwet's AC |  0.5430    0.0251  21.65   0.000     0.4938     0.5922
Krippendorff's Alpha |  0.5254    0.0255  20.62   0.000     0.4754     0.5754
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de treinamento
. capture drop correct_lasso

. gen correct_lasso = (FoiPenalizadoSTJ == pred_lasso) if train == 1
(211 missing values generated)

. sum correct_lasso if train == 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_la~o |      1,138    .7671353    .4228426          0          1

. scalar acuracia = r(mean)

. 
. * 📌 No Information Rate (NIR)
. * O NIR representa a acurácia de um modelo nulo (baseline), que classifica sempre a categoria mais frequente
. tabulate FoiPenalizadoSTJ if train == 1, matcell(freq_lasso)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        569       50.00       50.00
          1 |        569       50.00      100.00
------------+-----------------------------------
      Total |      1,138      100.00

. scalar total_lasso = freq_lasso[1,1] + freq_lasso[2,1]

. scalar max_lasso = max(freq_lasso[1,1], freq_lasso[2,1])

. scalar prop_nir_lasso = max_lasso / total_lasso

. 
. * 📌 Comparação
. di "Acurácia LASSO na base de treinamento: " acuracia
Acurácia LASSO na base de treinamento: .76713533

. di "NIR (treinamento): " prop_nir_lasso
NIR (treinamento): .5

. 
. if (acuracia > prop_nir_lasso) {
.     di "✅ Modelo LASSO supera o NIR na base de treino."
✅ Modelo LASSO supera o NIR na base de treino.
. }

. else {
.     di "⚠️ Modelo LASSO NÃO supera o NIR na base de treino."
. }

. 
. * 📌 Teste de McNemar na base de treinamento
. tabulate FoiPenalizadoSTJ pred_lasso if train == 1, matcell(mc_lasso)

FoiPenaliz |      pred_lasso
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       515         54 |       569 
         1 |       211        358 |       569 
-----------+----------------------+----------
     Total |       726        412 |     1,138 

. 
. scalar tn_lasso = mc_lasso[1,1] // Verdadeiro Negativo

. scalar fn_lasso = mc_lasso[2,1] // Falso Negativo

. scalar fp_lasso = mc_lasso[1,2] // Falso Positivo

. scalar tp_lasso = mc_lasso[2,2] // Verdadeiro Positivo

. 
. * Mostrar os valores extraídos (opcional)
. di "TN: " tn_lasso
TN: 515

. di "FN: " fn_lasso
FN: 211

. di "FP: " fp_lasso
FP: 54

. di "TP: " tp_lasso
TP: 358

. 
. * Rodar o teste de McNemar com os valores numéricos
. mcci `=tn_lasso' `=fn_lasso' `=fp_lasso' `=tp_lasso'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       515         211  |        726
       Unexposed |        54         358  |        412
-----------------+------------------------+-----------
           Total |       569         569  |       1138

McNemar's chi2(1) =     93.02    Prob > chi2 = 0.0000
Exact McNemar significance probability       = 0.0000

Proportion with factor
        Cases       .6379613
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference  .1379613       .110216   .1657067
        ratio       1.275923       1.21413    1.34086
        rel. diff.  .2759227      .2282081   .3236373

        odds ratio  3.907407      2.885613   5.371578   (exact)

. 
. /*******************************************************************************
> 6.3.3 Curva ROC para o modelo LASSO na base de TREINO
> *******************************************************************************/
. capture drop prob_pred_lasso_treino

. predict prob_pred_lasso_treino if train == 1, xb
(option penalized assumed; linear prediction with penalized coefficients)

. roctab FoiPenalizadoSTJ prob_pred_lasso_treino if train == 1, graph

. graph export "ROC_LASSO_treino.png", replace
(file ROC_LASSO_treino.png not found)
file ROC_LASSO_treino.png saved as PNG format

. 
. /*******************************************************************************
> 6.3.4 Avaliação do modelo LASSO na base de TESTE
> *******************************************************************************/
. 
. * 📌 Gerar predições de probabilidade na base de teste
. capture drop prob_pred_lasso_teste

. predict prob_pred_lasso_teste if train == 0, xb
(option penalized assumed; linear prediction with penalized coefficients)

. 
. * 📌 Classificação prevista com cutoff 0.5
. capture drop pred_lasso_teste

. gen pred_lasso_teste = (prob_pred_lasso_teste >= 0.5) if train == 0
(1,138 missing values generated)

. 
. * 📌 Kappa na base de teste
. kappaetc FoiPenalizadoSTJ pred_lasso_teste if train == 0

Interrater agreement                             Number of subjects =     211
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.7062    0.0314  22.47   0.000     0.6442     0.7681
Brennan and Prediger |  0.4123    0.0629   6.56   0.000     0.2884     0.5363
Cohen/Conger's Kappa |  0.2608    0.0695   3.75   0.000     0.1237     0.3979
    Scott/Fleiss' Pi |  0.2464    0.0731   3.37   0.001     0.1023     0.3906
           Gwet's AC |  0.5184    0.0614   8.44   0.000     0.3973     0.6394
Krippendorff's Alpha |  0.2482    0.0731   3.39   0.001     0.1040     0.3924
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de teste
. capture drop correct_lasso_teste

. gen correct_lasso_teste = (FoiPenalizadoSTJ == pred_lasso_teste) if train == 0
(1,138 missing values generated)

. sum correct_lasso_teste if train == 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_la~e |        211    .7061611    .4566023          0          1

. scalar acuracia_teste = r(mean)

. 
. * 📌 No Information Rate (NIR) - TESTE
. tabulate FoiPenalizadoSTJ if train == 0, matcell(freq_teste)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        142       67.30       67.30
          1 |         69       32.70      100.00
------------+-----------------------------------
      Total |        211      100.00

. scalar total_teste = freq_teste[1,1] + freq_teste[2,1]

. scalar max_teste = max(freq_teste[1,1], freq_teste[2,1])

. scalar nir_teste = max_teste / total_teste

. 
. di "Acurácia LASSO (teste): " acuracia_teste
Acurácia LASSO (teste): .70616114

. di "NIR (teste): " nir_teste
NIR (teste): .67298578

. 
. if (acuracia_teste > nir_teste) {
.     di "✅ Modelo LASSO supera o NIR na base de teste."
✅ Modelo LASSO supera o NIR na base de teste.
. }

. else {
.     di "⚠️ Modelo LASSO NÃO supera o NIR na base de teste."
. }

. 
. * 📌 Teste de McNemar - TESTE
. tabulate FoiPenalizadoSTJ pred_lasso_teste if train == 0, matcell(mc_lasso_teste)

FoiPenaliz |   pred_lasso_teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       124         18 |       142 
         1 |        44         25 |        69 
-----------+----------------------+----------
     Total |       168         43 |       211 

. 
. scalar tn_teste = mc_lasso_teste[1,1]

. scalar fn_teste = mc_lasso_teste[2,1]

. scalar fp_teste = mc_lasso_teste[1,2]

. scalar tp_teste = mc_lasso_teste[2,2]

. 
. di "TN: " tn_teste
TN: 124

. di "FN: " fn_teste
FN: 44

. di "FP: " fp_teste
FP: 18

. di "TP: " tp_teste
TP: 25

. 
. mcci `=tn_teste' `=fn_teste' `=fp_teste' `=tp_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       124          44  |        168
       Unexposed |        18          25  |         43
-----------------+------------------------+-----------
           Total |       142          69  |        211

McNemar's chi2(1) =     10.90    Prob > chi2 = 0.0010
Exact McNemar significance probability       = 0.0013

Proportion with factor
        Cases       .7962085
        Controls    .6729858     [95% conf. interval]
                   ---------     --------------------
        difference  .1232227      .0472571   .1991884
        ratio       1.183099      1.070599   1.307419
        rel. diff.  .3768116      .2002466   .5533766

        odds ratio  2.444444      1.383846   4.494686   (exact)

. 
. /*******************************************************************************
> 6.3.5 Curva ROC para o modelo LASSO na base de TESTE
> *******************************************************************************/
. roctab FoiPenalizadoSTJ prob_pred_lasso_teste if train == 0, graph

. graph export "ROC_LASSO_teste.png", replace
(file ROC_LASSO_teste.png not found)
file ROC_LASSO_teste.png saved as PNG format

. 
. /*******************************************************************************
> 6.3.6 – Classificação com Cutoff Médio (modelo LASSO)
> *******************************************************************************/
. 
. * 📌 Definir o cutoff médio com base nos modelos completos, stepwise 5% e stepwise 10%
. scalar cutoff_medio = cutoff_step10

. di "📌 Cutoff médio dos modelos: " cutoff_medio
📌 Cutoff médio dos modelos: .46154429

. 
. * ========================================================
. * BASE DE TREINAMENTO
. * ========================================================
. 
. * 📌 Gerar classificação com cutoff médio
. capture drop predicted_class_lasso_treino

. gen predicted_class_lasso_treino = (prob_pred_lasso_treino >= cutoff_medio) if train == 1
(211 missing values generated)

. 
. * 📌 Matriz de classificação com tabulação
. tabulate FoiPenalizadoSTJ predicted_class_lasso_treino if train == 1, matcell(mc_lasso_treino)

           | predicted_class_lasso
FoiPenaliz |        _treino
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       512         57 |       569 
         1 |       206        363 |       569 
-----------+----------------------+----------
     Total |       718        420 |     1,138 

. 
. * 📌 Extrair valores
. scalar tn_lasso_medio = mc_lasso_treino[1,1]

. scalar fn_lasso_medio = mc_lasso_treino[2,1]

. scalar fp_lasso_medio = mc_lasso_treino[1,2]

. scalar tp_lasso_medio = mc_lasso_treino[2,2]

. 
. * 📌 Kappa
. kappaetc FoiPenalizadoSTJ predicted_class_lasso_treino if train == 1

Interrater agreement                             Number of subjects =    1138
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.7689    0.0125  61.50   0.000     0.7444     0.7934
Brennan and Prediger |  0.5378    0.0250  21.51   0.000     0.4887     0.5868
Cohen/Conger's Kappa |  0.5378    0.0241  22.29   0.000     0.4904     0.5851
    Scott/Fleiss' Pi |  0.5297    0.0254  20.87   0.000     0.4799     0.5795
           Gwet's AC |  0.5456    0.0250  21.81   0.000     0.4965     0.5946
Krippendorff's Alpha |  0.5299    0.0254  20.88   0.000     0.4801     0.5797
------------------------------------------------------------------------------

. 
. * 📌 Acurácia
. capture drop correct_lasso_medio

. gen correct_lasso_medio = (FoiPenalizadoSTJ == predicted_class_lasso_treino) if train == 1
(211 missing values generated)

. sum correct_lasso_medio if train == 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_l~io |      1,138    .7688928    .4217262          0          1

. scalar acuracia_lasso_medio = r(mean)

. 
. * 📌 No Information Rate (NIR)
. tabulate FoiPenalizadoSTJ if train == 1, matcell(freq_lasso_medio)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        569       50.00       50.00
          1 |        569       50.00      100.00
------------+-----------------------------------
      Total |      1,138      100.00

. scalar total_lasso_medio = freq_lasso_medio[1,1] + freq_lasso_medio[2,1]

. scalar max_lasso_medio = max(freq_lasso_medio[1,1], freq_lasso_medio[2,1])

. scalar nir_lasso_medio = max_lasso_medio / total_lasso_medio

. 
. di "Acurácia (treino, cutoff médio): " acuracia_lasso_medio
Acurácia (treino, cutoff médio): .76889279

. di "NIR (treino, cutoff médio): " nir_lasso_medio
NIR (treino, cutoff médio): .5

. 
. if (acuracia_lasso_medio > nir_lasso_medio) {
.     di "✅ Modelo LASSO (cutoff médio) supera o NIR na base de treino."
✅ Modelo LASSO (cutoff médio) supera o NIR na base de treino.
. }

. else {
.     di "⚠️ Modelo LASSO (cutoff médio) NÃO supera o NIR na base de treino."
. }

. 
. * 📌 Teste de McNemar
. mcci `=tn_lasso_medio' `=fn_lasso_medio' `=fp_lasso_medio' `=tp_lasso_medio'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       512         206  |        718
       Unexposed |        57         363  |        420
-----------------+------------------------+-----------
           Total |       569         569  |       1138

McNemar's chi2(1) =     84.41    Prob > chi2 = 0.0000
Exact McNemar significance probability       = 0.0000

Proportion with factor
        Cases       .6309315
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference  .1309315      .1031778   .1586851
        ratio       1.261863      1.200647     1.3262
        rel. diff.  .2618629      .2138694   .3098564

        odds ratio  3.614035      2.683405    4.93545   (exact)

. 
. * ========================================================
. * BASE DE TESTE
. * ========================================================
. 
. * 📌 Gerar classificação com cutoff médio
. capture drop predicted_class_lasso_teste

. gen predicted_class_lasso_teste = (prob_pred_lasso_teste >= cutoff_medio) if train == 0
(1,138 missing values generated)

. 
. * 📌 Matriz de classificação com tabulação
. tabulate FoiPenalizadoSTJ predicted_class_lasso_teste if train == 0, matcell(mc_lasso_teste)

           | predicted_class_lasso
FoiPenaliz |        _teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       124         18 |       142 
         1 |        44         25 |        69 
-----------+----------------------+----------
     Total |       168         43 |       211 

. 
. * 📌 Extrair valores
. scalar tn_lasso_medio_teste = mc_lasso_teste[1,1]

. scalar fn_lasso_medio_teste = mc_lasso_teste[2,1]

. scalar fp_lasso_medio_teste = mc_lasso_teste[1,2]

. scalar tp_lasso_medio_teste = mc_lasso_teste[2,2]

. 
. * 📌 Kappa
. kappaetc FoiPenalizadoSTJ predicted_class_lasso_teste if train == 0

Interrater agreement                             Number of subjects =     211
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.7062    0.0314  22.47   0.000     0.6442     0.7681
Brennan and Prediger |  0.4123    0.0629   6.56   0.000     0.2884     0.5363
Cohen/Conger's Kappa |  0.2608    0.0695   3.75   0.000     0.1237     0.3979
    Scott/Fleiss' Pi |  0.2464    0.0731   3.37   0.001     0.1023     0.3906
           Gwet's AC |  0.5184    0.0614   8.44   0.000     0.3973     0.6394
Krippendorff's Alpha |  0.2482    0.0731   3.39   0.001     0.1040     0.3924
------------------------------------------------------------------------------

. 
. * 📌 Acurácia
. capture drop correct_lasso_medio_teste

. gen correct_lasso_medio_teste = (FoiPenalizadoSTJ == predicted_class_lasso_teste) if train == 0
(1,138 missing values generated)

. sum correct_lasso_medio_teste if train == 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
cor~io_teste |        211    .7061611    .4566023          0          1

. scalar acuracia_lasso_medio_teste = r(mean)

. 
. * 📌 No Information Rate (NIR)
. tabulate FoiPenalizadoSTJ if train == 0, matcell(freq_lasso_medio_teste)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        142       67.30       67.30
          1 |         69       32.70      100.00
------------+-----------------------------------
      Total |        211      100.00

. scalar total_lasso_medio_teste = freq_lasso_medio_teste[1,1] + freq_lasso_medio_teste[2,1]

. scalar max_lasso_medio_teste = max(freq_lasso_medio_teste[1,1], freq_lasso_medio_teste[2,1])

. scalar nir_lasso_medio_teste = max_lasso_medio_teste / total_lasso_medio_teste

. 
. di "Acurácia (teste, cutoff médio): " acuracia_lasso_medio_teste
Acurácia (teste, cutoff médio): .70616114

. di "NIR (teste, cutoff médio): " nir_lasso_medio_teste
NIR (teste, cutoff médio): .67298578

. 
. if (acuracia_lasso_medio_teste > nir_lasso_medio_teste) {
.     di "✅ Modelo LASSO (cutoff médio) supera o NIR na base de teste."
✅ Modelo LASSO (cutoff médio) supera o NIR na base de teste.
. }

. else {
.     di "⚠️ Modelo LASSO (cutoff médio) NÃO supera o NIR na base de teste."
. }

. 
. * 📌 Teste de McNemar
. mcci `=tn_lasso_medio_teste' `=fn_lasso_medio_teste' `=fp_lasso_medio_teste' `=tp_lasso_medio_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       124          44  |        168
       Unexposed |        18          25  |         43
-----------------+------------------------+-----------
           Total |       142          69  |        211

McNemar's chi2(1) =     10.90    Prob > chi2 = 0.0010
Exact McNemar significance probability       = 0.0013

Proportion with factor
        Cases       .7962085
        Controls    .6729858     [95% conf. interval]
                   ---------     --------------------
        difference  .1232227      .0472571   .1991884
        ratio       1.183099      1.070599   1.307419
        rel. diff.  .3768116      .2002466   .5533766

        odds ratio  2.444444      1.383846   4.494686   (exact)

. 
. 
. *******************************************************************************/
. 
. 
. /*******************************************************************************
> FIM DO SCRIPT
> *******************************************************************************/
. 
. log off
no log file open
r(606);

end of do-file

r(606);

