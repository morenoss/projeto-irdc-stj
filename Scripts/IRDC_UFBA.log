----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  IRDC_Resultados
       log:  C:\Users\kkbul\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata/Resultado
> s\IRDC_UFBAAPCONT.log
  log type:  text
 opened on:  26 Jul 2025, 19:30:38

. 
. /*******************************************************************************
> Projeto:            Índice de Risco de Descumprimento Contratual (IRDC)
> Autor:              Moreno Souto Santiago
> Fonte dos Dados:    Painel de Informações Contábeis dos Fornecedores do STJ
> Ferramentas:        Stata 18 + Python (SMOTENC)
> Descrição:          
> Este script executa a análise preditiva do IRDC com base em dados contábeis e cadastrais
> dos fornecedores do STJ. As etapas incluem:
> 
> 1. **Importação e transformação dos dados**: consolidação dos indicadores contábeis,
>    análise descritiva inicial e preparação da base para modelagem.
> 
> 2. **Matriz de correlação inicial das variáveis contínuas**: cálculo da matriz de
>    correlação antes da imputação e criação dos índices sintéticos, permitindo acompanhar
>    a evolução das relações entre variáveis conforme os dados são atualizados ou transformados.
> 
> 3. **Winsorização das variáveis contínuas**: aplicação do corte nos percentis 1% e 99%
>    para reduzir o impacto de outliers extremos, preservando a variabilidade e robustez
>    das análises subsequentes.
> 
> 4. **Imputação de valores faltantes**: preenchimento de dados ausentes por média ou mediana,
>    conforme o coeficiente de variação, para garantir integridade e qualidade da base.
> 
> 5. **Criação dos índices sintéticos (Z-score)**: combinação de variáveis colineares em índices
>    sintéticos para reduzir dimensionalidade e multicolinearidade, facilitando a modelagem.
> 
> 6. **Matriz de correlação final dos índices sintéticos e variáveis contínuas**:
>    cálculo da matriz após a imputação e criação dos índices para validar a estrutura dos dados.
> 
> 7. **Estatísticas descritivas por grupo**: geração de tabelas de estatísticas descritivas
>    (média, desvio padrão, mínimo, máximo) para empresas penalizadas e não penalizadas,
>    antes e após a winsorização, facilitando análise comparativa de perfil.
> 
> 8. **Separação das amostras em treinamento (80%) e teste (20%)**: a separação das
>    amostras é realizada obedecendo a proporção exata de empresas penalizadas e não penalizadas.
> 
> 9. **Balanceamento da amostra de treinamento**: aplicação da técnica SMOTENC em Python para lidar com
>    desbalanceamento da variável dependente (penalização pelo STJ), com codificação de
>    variáveis categóricas e posterior reintegração ao Stata.
> 
> 10. **Agrupamento de CNAEs raros**: definição do mínimo de ocorrências para manter CNAE
>     como categoria isolada (local freq_minima = 10). As categorias com menor frequência
>     foram agrupadas sob o código -1 para reduzir a sparsidade da matriz de variáveis dummies
>     e aumentar a estabilidade dos coeficientes.
> 
> 11. **Conversão e criação de variáveis dummies para variáveis categóricas**:
>     transformação de variáveis categóricas em variáveis dummy após o balanceamento.
> 
> 12. **Modelagem e avaliação preditiva**:
>     - Modelo logit completo (com todas as variáveis)
>     - Modelos logit com seleção stepwise
>     - Modelo com penalização LASSO
>     Cada modelo é avaliado com métricas como acurácia, Kappa, NIR, teste de McNemar,
>     curvas ROC e definição do ponto de corte ideal baseado na equivalência entre
>     sensibilidade e especificidade. As métricas são aplicadas nos conjuntos de treinamento e teste.
> 
> Objetivo:
> Identificar o melhor modelo para predição da variável binária `FoiPenalizadoSTJ`,
> avaliando o poder explicativo de indicadores contábeis, porte, natureza jurídica, CNAE,
> e variáveis de histórico contratual da empresa.
> 
> Última atualização: 15/07/2025
> *******************************************************************************/
. 
.    
. 
. /*******************************************************************************
> ETAPA 1 - IMPORTAÇÃO, ANÁLISE DESCRITIVA DAS VARIÁVEIS E TRANSFORMAÇÃO 
> *******************************************************************************/
. * Definindo o diretório de trabalho e importando os dados do Excel
. cd "`basedados'"
C:\Users\kkbul\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata

. import excel "Dados_novo", sheet("Tabela 4") firstrow clear
(37 vars, 1,043 obs)

. 
. /*******************************************************************************
> 1.1 - Executar estatísticas descritivas para todas as variáveis
> *******************************************************************************/
. summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSe
> cundarios IdadedeAnos QtePenalOutrosOrgaos

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |      1,043    19.17385    166.6086     -65.24    4449.37
    LiqGeral |      1,043    16.85623    164.7616     -65.24    4449.37
 LiqCorAjust |      1,043    .4217767    .3478924    -3.6773          1
   SolvGeral |      1,043    21.93922    209.3532     -66.99    4449.37
    EndGeral |      1,043    1.285443    7.831921  -208.1876    34.7657
-------------+---------------------------------------------------------
 CompEndivid |      1,043    .7825249    .2557365          0          1
    IndepFin |      1,043    20.94513    209.3525   -67.9885   4448.367
    ImobilPL |      1,043    .1856697    3.117148   -95.5357     9.1728
   ImobRecNC |      1,043    .2045717    .2491494     -.2471     1.4904
 PtpCapTerce |      1,043    1.285443    7.831921  -208.1876    34.7657
-------------+---------------------------------------------------------
   GiroAtivo |      1,043    1.577482    1.729379     -.0289    32.9637
      MargOp |      1,043    .7997902    10.81105    -1.4199   348.9034
     MargLiq |      1,043    .1721872    2.077173   -14.1571    60.8893
         ROI |      1,043     .185759    1.294143    -25.837    30.4743
         ROE |      1,043     .460209    2.640144    -3.9973    70.7696
-------------+---------------------------------------------------------
 vlrcontrato |        771    1.19e+07    2.33e+07      12000   1.34e+08
QtdeCNAEsS~s |      1,043    15.52637    14.30951          1         97
 IdadedeAnos |      1,043     22.5881    10.90365   .6438356   59.03288
QtePenalOu~s |      1,043    5.395973    20.56574          0        201

. 
. * Estatísticas descritivas separadas por penalização
. by FoiPenalizadoSTJ, sort: summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI 
> ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        709    23.85152    196.5916     -65.24    4449.37
    LiqGeral |        709    20.68367    194.3463     -65.24    4449.37
 LiqCorAjust |        709    .4261989    .3589685    -3.6773          1
   SolvGeral |        709    27.86925    249.4851     -66.99    4449.37
    EndGeral |        709    1.293928    8.619504  -208.1876    34.6218
-------------+---------------------------------------------------------
 CompEndivid |        709    .7846079    .2664019          0          1
    IndepFin |        709    26.87506    249.4844   -67.9885   4448.367
    ImobilPL |        709    .1920312    3.668146   -95.5357     9.1728
   ImobRecNC |        709    .2171324    .2518957     -.1727     1.4904
 PtpCapTerce |        709    1.293928    8.619504  -208.1876    34.6218
-------------+---------------------------------------------------------
   GiroAtivo |        709    1.577439    1.889203     -.0289    32.9637
      MargOp |        709    .9533449    13.09695    -1.4199   348.9034
     MargLiq |        709    .1861615    2.430188   -14.1571    60.8893
         ROI |        709    .1673504     1.06641    -25.837     3.6612
         ROE |        709    .4970315    2.861364    -3.6009    70.7696
-------------+---------------------------------------------------------
 vlrcontrato |        493    1.28e+07    2.30e+07      12000   1.32e+08
QtdeCNAEsS~s |        709    16.04372     15.0858          1         97
 IdadedeAnos |        709    22.49518    11.12163   .6438356   59.03288
QtePenalOu~s |        709    4.299013    20.43201          0        201

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        334    9.244311    67.40297          0    1104.44
    LiqGeral |        334    8.731527    67.39665          0    1104.67
 LiqCorAjust |        334    .4123895    .3234447    -2.4927          1
   SolvGeral |        334    9.351228    67.64539          0    1109.62
    EndGeral |        334    1.267432    5.828791   -76.5962    34.7657
-------------+---------------------------------------------------------
 CompEndivid |        334    .7781033    .2317944          0          1
    IndepFin |        334    8.357327    67.64471     -.7622   1108.622
    ImobilPL |        334    .1721659    1.340381   -23.1117     3.2065
   ImobRecNC |        334    .1779084    .2414274     -.2471     1.4847
 PtpCapTerce |        334    1.267432    5.828791   -76.5962    34.7657
-------------+---------------------------------------------------------
   GiroAtivo |        334    1.577575     1.33046          0     6.2266
      MargOp |        334    .4738314    .9367527     -.8391    14.3886
     MargLiq |        334    .1425234    .9712285    -6.3956    12.4133
         ROI |        334    .2248359    1.679445    -1.1367    30.4743
         ROE |        334     .382044    2.096351    -3.9973    35.4538
-------------+---------------------------------------------------------
 vlrcontrato |        278    1.04e+07    2.38e+07   23769.99   1.34e+08
QtdeCNAEsS~s |        334    14.42814    12.45313          1         58
 IdadedeAnos |        334    22.78534    10.43942   3.621918   58.87123
QtePenalOu~s |        334    7.724551    20.68516          0        171


. 
. * Bloco para salvar as estatísticas descritivas originais por grupo
. tabstat LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecu
> ndarios IdadedeAnos QtePenalOutrosOrgaos, ///
>     statistics(mean sd min max n) by(FoiPenalizadoSTJ)

Summary statistics: Mean, SD, Min, Max, N
Group variable: FoiPenalizadoSTJ (FoiPenalizadoSTJ)

FoiPenalizadoSTJ |  LiqCor~e  LiqGeral  LiqCor~t  SolvGe~l  EndGeral  CompEn~d  IndepFin  ImobilPL  ImobRe~C  PtpCap~e  GiroAt~o    MargOp   MargLiq       ROI       ROE
-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------
               0 |  23.85152  20.68367  .4261989  27.86925  1.293928  .7846079  26.87506  .1920312  .2171324  1.293928  1.577439  .9533449  .1861615  .1673504  .4970315
                 |  196.5916  194.3463  .3589685  249.4851  8.619504  .2664019  249.4844  3.668146  .2518957  8.619504  1.889203  13.09695  2.430188   1.06641  2.861364
                 |    -65.24    -65.24   -3.6773    -66.99 -208.1876         0  -67.9885  -95.5357    -.1727 -208.1876    -.0289   -1.4199  -14.1571   -25.837   -3.6009
                 |   4449.37   4449.37         1   4449.37   34.6218         1  4448.367    9.1728    1.4904   34.6218   32.9637  348.9034   60.8893    3.6612   70.7696
                 |       709       709       709       709       709       709       709       709       709       709       709       709       709       709       709
-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------
               1 |  9.244311  8.731527  .4123895  9.351228  1.267432  .7781033  8.357327  .1721659  .1779084  1.267432  1.577575  .4738314  .1425234  .2248359   .382044
                 |  67.40297  67.39665  .3234447  67.64539  5.828791  .2317944  67.64471  1.340381  .2414274  5.828791   1.33046  .9367527  .9712285  1.679445  2.096351
                 |         0         0   -2.4927         0  -76.5962         0    -.7622  -23.1117    -.2471  -76.5962         0    -.8391   -6.3956   -1.1367   -3.9973
                 |   1104.44   1104.67         1   1109.62   34.7657         1  1108.622    3.2065    1.4847   34.7657    6.2266   14.3886   12.4133   30.4743   35.4538
                 |       334       334       334       334       334       334       334       334       334       334       334       334       334       334       334
-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------
           Total |  19.17385  16.85623  .4217767  21.93922  1.285443  .7825249  20.94513  .1856697  .2045717  1.285443  1.577482  .7997902  .1721872   .185759   .460209
                 |  166.6086  164.7616  .3478924  209.3532  7.831921  .2557365  209.3525  3.117148  .2491494  7.831921  1.729379  10.81105  2.077173  1.294143  2.640144
                 |    -65.24    -65.24   -3.6773    -66.99 -208.1876         0  -67.9885  -95.5357    -.2471 -208.1876    -.0289   -1.4199  -14.1571   -25.837   -3.9973
                 |   4449.37   4449.37         1   4449.37   34.7657         1  4448.367    9.1728    1.4904   34.7657   32.9637  348.9034   60.8893   30.4743   70.7696
                 |      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043
------------------------------------------------------------------------------------------------------------------------------------------------------------------------

FoiPenalizadoSTJ |  vlrcon~o  QtdeCN~s  Idaded~s  QtePen~s
-----------------+----------------------------------------
               0 |  1.28e+07  16.04372  22.49518  4.299013
                 |  2.30e+07   15.0858  11.12163  20.43201
                 |     12000         1  .6438356         0
                 |  1.32e+08        97  59.03288       201
                 |       493       709       709       709
-----------------+----------------------------------------
               1 |  1.04e+07  14.42814  22.78534  7.724551
                 |  2.38e+07  12.45313  10.43942  20.68516
                 |  23769.99         1  3.621918         0
                 |  1.34e+08        58  58.87123       171
                 |       278       334       334       334
-----------------+----------------------------------------
           Total |  1.19e+07  15.52637   22.5881  5.395973
                 |  2.33e+07  14.30951  10.90365  20.56574
                 |     12000         1  .6438356         0
                 |  1.34e+08        97  59.03288       201
                 |       771      1043      1043      1043
----------------------------------------------------------

.         
. *Bloco de estatíticas das variáveis qualitativas
. 
. tabulate Porte

                  Porte |      Freq.     Percent        Cum.
------------------------+-----------------------------------
EMPRESA DE GRANDE PORTE |        133       12.75       12.75
 EMPRESA DE MÉDIO PORTE |        159       15.24       28.00
          MICROENTIDADE |        112       10.74       38.73
        PEQUENA EMPRESA |        639       61.27      100.00
------------------------+-----------------------------------
                  Total |      1,043      100.00

. tabulate NaturezaJuridica

                      NaturezaJuridica |      Freq.     Percent        Cum.
---------------------------------------+-----------------------------------
               201-1 - Empresa Pública |          5        0.48        0.48
      204-6 - Sociedade Anônima Aberta |         16        1.53        2.01
     205-4 - Sociedade Anônima Fechada |         96        9.20       11.22
 206-2 - Sociedade Empresária Limitada |        870       83.41       94.63
       213-5 - Empresário (Individual) |         25        2.40       97.03
                   214-3 - Cooperativa |          2        0.19       97.22
       215-1 - Consórcio de Sociedades |          1        0.10       97.32
    224-0 - Sociedade Simples Limitada |          2        0.19       97.51
              306-9 - Fundação Privada |          7        0.67       98.18
            399-9 - Associação Privada |         19        1.82      100.00
---------------------------------------+-----------------------------------
                                 Total |      1,043      100.00

. tabulate CNAE

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
 14.12-6-01 |          1        0.10        0.10
 16.22-6-99 |          3        0.29        0.38
 16.29-3-01 |          1        0.10        0.48
 17.42-7-99 |          3        0.29        0.77
 22.29-3-01 |          4        0.38        1.15
 26.10-8-00 |          3        0.29        1.44
 26.21-3-00 |         10        0.96        2.40
 26.32-9-00 |          1        0.10        2.49
 27.10-4-02 |          6        0.58        3.07
 27.31-7-00 |          1        0.10        3.16
 27.90-2-02 |          1        0.10        3.26
 28.24-1-01 |          5        0.48        3.74
 29.10-7-01 |          3        0.29        4.03
 31.01-2-00 |         20        1.92        5.94
 31.02-1-00 |          5        0.48        6.42
 33.12-1-02 |          1        0.10        6.52
 33.21-0-00 |          4        0.38        6.90
 41.20-4-00 |         75        7.19       14.09
 42.13-8-00 |          2        0.19       14.29
 42.21-9-03 |          7        0.67       14.96
 42.21-9-05 |          6        0.58       15.53
 42.99-5-99 |          6        0.58       16.11
 43.21-5-00 |         20        1.92       18.02
 43.22-3-02 |         11        1.05       19.08
 43.22-3-03 |          9        0.86       19.94
 43.29-1-03 |          6        0.58       20.52
 43.29-1-99 |          3        0.29       20.81
 43.30-4-05 |          2        0.19       21.00
 43.30-4-99 |          9        0.86       21.86
 45.11-1-01 |          5        0.48       22.34
 45.30-7-01 |          1        0.10       22.44
 46.18-4-99 |          2        0.19       22.63
 46.33-8-01 |          3        0.29       22.91
 46.35-4-01 |          4        0.38       23.30
 46.39-7-01 |          3        0.29       23.59
 46.47-8-02 |          8        0.77       24.35
 46.49-4-01 |          1        0.10       24.45
 46.49-4-04 |          1        0.10       24.54
 46.49-4-08 |         15        1.44       25.98
 46.49-4-99 |          4        0.38       26.37
 46.51-6-01 |         42        4.03       30.39
 46.52-4-00 |         24        2.30       32.69
 46.61-3-00 |          2        0.19       32.89
 46.63-0-00 |          1        0.10       32.98
 46.65-6-00 |          1        0.10       33.08
 46.69-9-99 |          5        0.48       33.56
 46.81-8-01 |          1        0.10       33.65
 46.86-9-02 |          1        0.10       33.75
 46.87-7-01 |          2        0.19       33.94
 47.12-1-00 |          2        0.19       34.13
 47.29-6-99 |          9        0.86       35.00
 47.44-0-01 |          6        0.58       35.57
 47.44-0-99 |          5        0.48       36.05
 47.51-2-01 |         48        4.60       40.65
 47.52-1-00 |          2        0.19       40.84
 47.53-9-00 |          6        0.58       41.42
 47.54-7-01 |         11        1.05       42.47
 47.59-8-99 |          1        0.10       42.57
 47.89-0-05 |          1        0.10       42.67
 47.89-0-09 |          3        0.29       42.95
 47.89-0-99 |          4        0.38       43.34
 49.21-3-01 |          2        0.19       43.53
 52.40-1-01 |          1        0.10       43.62
 56.11-2-01 |          7        0.67       44.30
 56.20-1-01 |          1        0.10       44.39
 59.11-1-99 |          2        0.19       44.58
 61.10-8-01 |         12        1.15       45.73
 61.10-8-03 |          6        0.58       46.31
 61.20-5-01 |          7        0.67       46.98
 61.20-5-02 |          1        0.10       47.08
 61.90-6-99 |          2        0.19       47.27
 62.01-5-01 |         36        3.45       50.72
 62.02-3-00 |         15        1.44       52.16
 62.03-1-00 |         28        2.68       54.84
 62.04-0-00 |         58        5.56       60.40
 62.09-1-00 |         86        8.25       68.65
 63.11-9-00 |          3        0.29       68.94
 63.19-4-00 |          1        0.10       69.03
 63.99-2-00 |          2        0.19       69.22
 66.13-4-00 |          5        0.48       69.70
 66.21-5-02 |          7        0.67       70.37
 70.20-4-00 |         11        1.05       71.43
 71.11-1-00 |          1        0.10       71.52
 71.12-0-00 |         26        2.49       74.02
 73.11-4-00 |          3        0.29       74.30
 73.20-3-00 |          3        0.29       74.59
 74.20-0-04 |          2        0.19       74.78
 74.90-1-04 |          6        0.58       75.36
 74.90-1-99 |          4        0.38       75.74
 77.33-1-00 |         13        1.25       76.99
 77.39-0-03 |          4        0.38       77.37
 77.39-0-99 |          2        0.19       77.56
 78.10-8-00 |          6        0.58       78.14
 78.20-5-00 |          8        0.77       78.91
 78.30-2-00 |         27        2.59       81.50
 79.11-2-00 |         23        2.21       83.70
 80.11-1-01 |         23        2.21       85.91
 81.21-4-00 |         12        1.15       87.06
 81.29-0-00 |          6        0.58       87.63
 81.30-3-00 |          2        0.19       87.82
 82.11-3-00 |         16        1.53       89.36
 82.20-2-00 |         23        2.21       91.56
 82.30-0-01 |         24        2.30       93.86
 82.99-7-99 |         12        1.15       95.01
 85.31-7-00 |          3        0.29       95.30
 85.32-5-00 |          4        0.38       95.69
 85.50-3-02 |          5        0.48       96.16
 85.93-7-00 |          7        0.67       96.84
 85.99-6-04 |          5        0.48       97.32
 86.30-5-06 |          4        0.38       97.70
 86.50-0-01 |          2        0.19       97.89
 86.60-7-00 |          2        0.19       98.08
 88.00-6-00 |          6        0.58       98.66
 90.01-9-02 |          2        0.19       98.85
 93.19-1-01 |          2        0.19       99.04
 94.30-8-00 |          2        0.19       99.23
 94.99-5-00 |          6        0.58       99.81
 96.01-7-01 |          2        0.19      100.00
------------+-----------------------------------
      Total |      1,043      100.00

. 
. quietly egen cnpjs = tag(CNPJ)

. tabulate FoiPenalizadoSTJ if cnpjs == 1, missing

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        278       77.22       77.22
          1 |         82       22.78      100.00
------------+-----------------------------------
      Total |        360      100.00

. 
. 
. // Frequência com percentual
. tabulate Porte, missing

                  Porte |      Freq.     Percent        Cum.
------------------------+-----------------------------------
EMPRESA DE GRANDE PORTE |        133       12.75       12.75
 EMPRESA DE MÉDIO PORTE |        159       15.24       28.00
          MICROENTIDADE |        112       10.74       38.73
        PEQUENA EMPRESA |        639       61.27      100.00
------------------------+-----------------------------------
                  Total |      1,043      100.00

. tabulate NaturezaJuridica, missing

                      NaturezaJuridica |      Freq.     Percent        Cum.
---------------------------------------+-----------------------------------
               201-1 - Empresa Pública |          5        0.48        0.48
      204-6 - Sociedade Anônima Aberta |         16        1.53        2.01
     205-4 - Sociedade Anônima Fechada |         96        9.20       11.22
 206-2 - Sociedade Empresária Limitada |        870       83.41       94.63
       213-5 - Empresário (Individual) |         25        2.40       97.03
                   214-3 - Cooperativa |          2        0.19       97.22
       215-1 - Consórcio de Sociedades |          1        0.10       97.32
    224-0 - Sociedade Simples Limitada |          2        0.19       97.51
              306-9 - Fundação Privada |          7        0.67       98.18
            399-9 - Associação Privada |         19        1.82      100.00
---------------------------------------+-----------------------------------
                                 Total |      1,043      100.00

. tabulate CNAE, missing

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
 14.12-6-01 |          1        0.10        0.10
 16.22-6-99 |          3        0.29        0.38
 16.29-3-01 |          1        0.10        0.48
 17.42-7-99 |          3        0.29        0.77
 22.29-3-01 |          4        0.38        1.15
 26.10-8-00 |          3        0.29        1.44
 26.21-3-00 |         10        0.96        2.40
 26.32-9-00 |          1        0.10        2.49
 27.10-4-02 |          6        0.58        3.07
 27.31-7-00 |          1        0.10        3.16
 27.90-2-02 |          1        0.10        3.26
 28.24-1-01 |          5        0.48        3.74
 29.10-7-01 |          3        0.29        4.03
 31.01-2-00 |         20        1.92        5.94
 31.02-1-00 |          5        0.48        6.42
 33.12-1-02 |          1        0.10        6.52
 33.21-0-00 |          4        0.38        6.90
 41.20-4-00 |         75        7.19       14.09
 42.13-8-00 |          2        0.19       14.29
 42.21-9-03 |          7        0.67       14.96
 42.21-9-05 |          6        0.58       15.53
 42.99-5-99 |          6        0.58       16.11
 43.21-5-00 |         20        1.92       18.02
 43.22-3-02 |         11        1.05       19.08
 43.22-3-03 |          9        0.86       19.94
 43.29-1-03 |          6        0.58       20.52
 43.29-1-99 |          3        0.29       20.81
 43.30-4-05 |          2        0.19       21.00
 43.30-4-99 |          9        0.86       21.86
 45.11-1-01 |          5        0.48       22.34
 45.30-7-01 |          1        0.10       22.44
 46.18-4-99 |          2        0.19       22.63
 46.33-8-01 |          3        0.29       22.91
 46.35-4-01 |          4        0.38       23.30
 46.39-7-01 |          3        0.29       23.59
 46.47-8-02 |          8        0.77       24.35
 46.49-4-01 |          1        0.10       24.45
 46.49-4-04 |          1        0.10       24.54
 46.49-4-08 |         15        1.44       25.98
 46.49-4-99 |          4        0.38       26.37
 46.51-6-01 |         42        4.03       30.39
 46.52-4-00 |         24        2.30       32.69
 46.61-3-00 |          2        0.19       32.89
 46.63-0-00 |          1        0.10       32.98
 46.65-6-00 |          1        0.10       33.08
 46.69-9-99 |          5        0.48       33.56
 46.81-8-01 |          1        0.10       33.65
 46.86-9-02 |          1        0.10       33.75
 46.87-7-01 |          2        0.19       33.94
 47.12-1-00 |          2        0.19       34.13
 47.29-6-99 |          9        0.86       35.00
 47.44-0-01 |          6        0.58       35.57
 47.44-0-99 |          5        0.48       36.05
 47.51-2-01 |         48        4.60       40.65
 47.52-1-00 |          2        0.19       40.84
 47.53-9-00 |          6        0.58       41.42
 47.54-7-01 |         11        1.05       42.47
 47.59-8-99 |          1        0.10       42.57
 47.89-0-05 |          1        0.10       42.67
 47.89-0-09 |          3        0.29       42.95
 47.89-0-99 |          4        0.38       43.34
 49.21-3-01 |          2        0.19       43.53
 52.40-1-01 |          1        0.10       43.62
 56.11-2-01 |          7        0.67       44.30
 56.20-1-01 |          1        0.10       44.39
 59.11-1-99 |          2        0.19       44.58
 61.10-8-01 |         12        1.15       45.73
 61.10-8-03 |          6        0.58       46.31
 61.20-5-01 |          7        0.67       46.98
 61.20-5-02 |          1        0.10       47.08
 61.90-6-99 |          2        0.19       47.27
 62.01-5-01 |         36        3.45       50.72
 62.02-3-00 |         15        1.44       52.16
 62.03-1-00 |         28        2.68       54.84
 62.04-0-00 |         58        5.56       60.40
 62.09-1-00 |         86        8.25       68.65
 63.11-9-00 |          3        0.29       68.94
 63.19-4-00 |          1        0.10       69.03
 63.99-2-00 |          2        0.19       69.22
 66.13-4-00 |          5        0.48       69.70
 66.21-5-02 |          7        0.67       70.37
 70.20-4-00 |         11        1.05       71.43
 71.11-1-00 |          1        0.10       71.52
 71.12-0-00 |         26        2.49       74.02
 73.11-4-00 |          3        0.29       74.30
 73.20-3-00 |          3        0.29       74.59
 74.20-0-04 |          2        0.19       74.78
 74.90-1-04 |          6        0.58       75.36
 74.90-1-99 |          4        0.38       75.74
 77.33-1-00 |         13        1.25       76.99
 77.39-0-03 |          4        0.38       77.37
 77.39-0-99 |          2        0.19       77.56
 78.10-8-00 |          6        0.58       78.14
 78.20-5-00 |          8        0.77       78.91
 78.30-2-00 |         27        2.59       81.50
 79.11-2-00 |         23        2.21       83.70
 80.11-1-01 |         23        2.21       85.91
 81.21-4-00 |         12        1.15       87.06
 81.29-0-00 |          6        0.58       87.63
 81.30-3-00 |          2        0.19       87.82
 82.11-3-00 |         16        1.53       89.36
 82.20-2-00 |         23        2.21       91.56
 82.30-0-01 |         24        2.30       93.86
 82.99-7-99 |         12        1.15       95.01
 85.31-7-00 |          3        0.29       95.30
 85.32-5-00 |          4        0.38       95.69
 85.50-3-02 |          5        0.48       96.16
 85.93-7-00 |          7        0.67       96.84
 85.99-6-04 |          5        0.48       97.32
 86.30-5-06 |          4        0.38       97.70
 86.50-0-01 |          2        0.19       97.89
 86.60-7-00 |          2        0.19       98.08
 88.00-6-00 |          6        0.58       98.66
 90.01-9-02 |          2        0.19       98.85
 93.19-1-01 |          2        0.19       99.04
 94.30-8-00 |          2        0.19       99.23
 94.99-5-00 |          6        0.58       99.81
 96.01-7-01 |          2        0.19      100.00
------------+-----------------------------------
      Total |      1,043      100.00

. 
. 
. tabulate Porte FoiPenalizadoSTJ, column

+-------------------+
| Key               |
|-------------------|
|     frequency     |
| column percentage |
+-------------------+

                      |   FoiPenalizadoSTJ
                Porte |         0          1 |     Total
----------------------+----------------------+----------
EMPRESA DE GRANDE P.. |        93         40 |       133 
                      |     13.12      11.98 |     12.75 
----------------------+----------------------+----------
EMPRESA DE MÉDIO PO.. |       104         55 |       159 
                      |     14.67      16.47 |     15.24 
----------------------+----------------------+----------
        MICROENTIDADE |        76         36 |       112 
                      |     10.72      10.78 |     10.74 
----------------------+----------------------+----------
      PEQUENA EMPRESA |       436        203 |       639 
                      |     61.50      60.78 |     61.27 
----------------------+----------------------+----------
                Total |       709        334 |     1,043 
                      |    100.00     100.00 |    100.00 

. tabulate NaturezaJuridica FoiPenalizadoSTJ, row

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   FoiPenalizadoSTJ
     NaturezaJuridica |         0          1 |     Total
----------------------+----------------------+----------
201-1 - Empresa Púb.. |         5          0 |         5 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
204-6 - Sociedade A.. |        11          5 |        16 
                      |     68.75      31.25 |    100.00 
----------------------+----------------------+----------
205-4 - Sociedade A.. |        82         14 |        96 
                      |     85.42      14.58 |    100.00 
----------------------+----------------------+----------
206-2 - Sociedade E.. |       560        310 |       870 
                      |     64.37      35.63 |    100.00 
----------------------+----------------------+----------
213-5 - Empresário .. |        23          2 |        25 
                      |     92.00       8.00 |    100.00 
----------------------+----------------------+----------
  214-3 - Cooperativa |         2          0 |         2 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
215-1 - Consórcio d.. |         1          0 |         1 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
224-0 - Sociedade S.. |         2          0 |         2 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
306-9 - Fundação Pr.. |         4          3 |         7 
                      |     57.14      42.86 |    100.00 
----------------------+----------------------+----------
399-9 - Associação .. |        19          0 |        19 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
                Total |       709        334 |     1,043 
                      |     67.98      32.02 |    100.00 

. tabulate CNAE FoiPenalizadoSTJ, cell

+-----------------+
| Key             |
|-----------------|
|    frequency    |
| cell percentage |
+-----------------+

           |   FoiPenalizadoSTJ
      CNAE |         0          1 |     Total
-----------+----------------------+----------
14.12-6-01 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
16.22-6-99 |         3          0 |         3 
           |      0.29       0.00 |      0.29 
-----------+----------------------+----------
16.29-3-01 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
17.42-7-99 |         1          2 |         3 
           |      0.10       0.19 |      0.29 
-----------+----------------------+----------
22.29-3-01 |         0          4 |         4 
           |      0.00       0.38 |      0.38 
-----------+----------------------+----------
26.10-8-00 |         0          3 |         3 
           |      0.00       0.29 |      0.29 
-----------+----------------------+----------
26.21-3-00 |        10          0 |        10 
           |      0.96       0.00 |      0.96 
-----------+----------------------+----------
26.32-9-00 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
27.10-4-02 |         6          0 |         6 
           |      0.58       0.00 |      0.58 
-----------+----------------------+----------
27.31-7-00 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
27.90-2-02 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
28.24-1-01 |         0          5 |         5 
           |      0.00       0.48 |      0.48 
-----------+----------------------+----------
29.10-7-01 |         3          0 |         3 
           |      0.29       0.00 |      0.29 
-----------+----------------------+----------
31.01-2-00 |         1         19 |        20 
           |      0.10       1.82 |      1.92 
-----------+----------------------+----------
31.02-1-00 |         5          0 |         5 
           |      0.48       0.00 |      0.48 
-----------+----------------------+----------
33.12-1-02 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
33.21-0-00 |         0          4 |         4 
           |      0.00       0.38 |      0.38 
-----------+----------------------+----------
41.20-4-00 |        50         25 |        75 
           |      4.79       2.40 |      7.19 
-----------+----------------------+----------
42.13-8-00 |         0          2 |         2 
           |      0.00       0.19 |      0.19 
-----------+----------------------+----------
42.21-9-03 |         7          0 |         7 
           |      0.67       0.00 |      0.67 
-----------+----------------------+----------
42.21-9-05 |         0          6 |         6 
           |      0.00       0.58 |      0.58 
-----------+----------------------+----------
42.99-5-99 |         6          0 |         6 
           |      0.58       0.00 |      0.58 
-----------+----------------------+----------
43.21-5-00 |        14          6 |        20 
           |      1.34       0.58 |      1.92 
-----------+----------------------+----------
43.22-3-02 |         7          4 |        11 
           |      0.67       0.38 |      1.05 
-----------+----------------------+----------
43.22-3-03 |         6          3 |         9 
           |      0.58       0.29 |      0.86 
-----------+----------------------+----------
43.29-1-03 |         0          6 |         6 
           |      0.00       0.58 |      0.58 
-----------+----------------------+----------
43.29-1-99 |         0          3 |         3 
           |      0.00       0.29 |      0.29 
-----------+----------------------+----------
43.30-4-05 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
43.30-4-99 |         9          0 |         9 
           |      0.86       0.00 |      0.86 
-----------+----------------------+----------
45.11-1-01 |         5          0 |         5 
           |      0.48       0.00 |      0.48 
-----------+----------------------+----------
45.30-7-01 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
46.18-4-99 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
46.33-8-01 |         3          0 |         3 
           |      0.29       0.00 |      0.29 
-----------+----------------------+----------
46.35-4-01 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
46.39-7-01 |         3          0 |         3 
           |      0.29       0.00 |      0.29 
-----------+----------------------+----------
46.47-8-02 |         0          8 |         8 
           |      0.00       0.77 |      0.77 
-----------+----------------------+----------
46.49-4-01 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
46.49-4-04 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
46.49-4-08 |         0         15 |        15 
           |      0.00       1.44 |      1.44 
-----------+----------------------+----------
46.49-4-99 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
46.51-6-01 |        29         13 |        42 
           |      2.78       1.25 |      4.03 
-----------+----------------------+----------
46.52-4-00 |        16          8 |        24 
           |      1.53       0.77 |      2.30 
-----------+----------------------+----------
46.61-3-00 |         0          2 |         2 
           |      0.00       0.19 |      0.19 
-----------+----------------------+----------
46.63-0-00 |         0          1 |         1 
           |      0.00       0.10 |      0.10 
-----------+----------------------+----------
46.65-6-00 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
46.69-9-99 |         0          5 |         5 
           |      0.00       0.48 |      0.48 
-----------+----------------------+----------
46.81-8-01 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
46.86-9-02 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
46.87-7-01 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
47.12-1-00 |         0          2 |         2 
           |      0.00       0.19 |      0.19 
-----------+----------------------+----------
47.29-6-99 |         9          0 |         9 
           |      0.86       0.00 |      0.86 
-----------+----------------------+----------
47.44-0-01 |         0          6 |         6 
           |      0.00       0.58 |      0.58 
-----------+----------------------+----------
47.44-0-99 |         0          5 |         5 
           |      0.00       0.48 |      0.48 
-----------+----------------------+----------
47.51-2-01 |        32         16 |        48 
           |      3.07       1.53 |      4.60 
-----------+----------------------+----------
47.52-1-00 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
47.53-9-00 |         6          0 |         6 
           |      0.58       0.00 |      0.58 
-----------+----------------------+----------
47.54-7-01 |         7          4 |        11 
           |      0.67       0.38 |      1.05 
-----------+----------------------+----------
47.59-8-99 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
47.89-0-05 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
47.89-0-09 |         3          0 |         3 
           |      0.29       0.00 |      0.29 
-----------+----------------------+----------
47.89-0-99 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
49.21-3-01 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
52.40-1-01 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
56.11-2-01 |         7          0 |         7 
           |      0.67       0.00 |      0.67 
-----------+----------------------+----------
56.20-1-01 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
59.11-1-99 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
61.10-8-01 |         7          5 |        12 
           |      0.67       0.48 |      1.15 
-----------+----------------------+----------
61.10-8-03 |         3          3 |         6 
           |      0.29       0.29 |      0.58 
-----------+----------------------+----------
61.20-5-01 |         7          0 |         7 
           |      0.67       0.00 |      0.67 
-----------+----------------------+----------
61.20-5-02 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
61.90-6-99 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
62.01-5-01 |        26         10 |        36 
           |      2.49       0.96 |      3.45 
-----------+----------------------+----------
62.02-3-00 |        15          0 |        15 
           |      1.44       0.00 |      1.44 
-----------+----------------------+----------
62.03-1-00 |        20          8 |        28 
           |      1.92       0.77 |      2.68 
-----------+----------------------+----------
62.04-0-00 |        58          0 |        58 
           |      5.56       0.00 |      5.56 
-----------+----------------------+----------
62.09-1-00 |        47         39 |        86 
           |      4.51       3.74 |      8.25 
-----------+----------------------+----------
63.11-9-00 |         3          0 |         3 
           |      0.29       0.00 |      0.29 
-----------+----------------------+----------
63.19-4-00 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
63.99-2-00 |         0          2 |         2 
           |      0.00       0.19 |      0.19 
-----------+----------------------+----------
66.13-4-00 |         0          5 |         5 
           |      0.00       0.48 |      0.48 
-----------+----------------------+----------
66.21-5-02 |         0          7 |         7 
           |      0.00       0.67 |      0.67 
-----------+----------------------+----------
70.20-4-00 |        11          0 |        11 
           |      1.05       0.00 |      1.05 
-----------+----------------------+----------
71.11-1-00 |         1          0 |         1 
           |      0.10       0.00 |      0.10 
-----------+----------------------+----------
71.12-0-00 |        22          4 |        26 
           |      2.11       0.38 |      2.49 
-----------+----------------------+----------
73.11-4-00 |         0          3 |         3 
           |      0.00       0.29 |      0.29 
-----------+----------------------+----------
73.20-3-00 |         3          0 |         3 
           |      0.29       0.00 |      0.29 
-----------+----------------------+----------
74.20-0-04 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
74.90-1-04 |         1          5 |         6 
           |      0.10       0.48 |      0.58 
-----------+----------------------+----------
74.90-1-99 |         0          4 |         4 
           |      0.00       0.38 |      0.38 
-----------+----------------------+----------
77.33-1-00 |         7          6 |        13 
           |      0.67       0.58 |      1.25 
-----------+----------------------+----------
77.39-0-03 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
77.39-0-99 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
78.10-8-00 |         6          0 |         6 
           |      0.58       0.00 |      0.58 
-----------+----------------------+----------
78.20-5-00 |         8          0 |         8 
           |      0.77       0.00 |      0.77 
-----------+----------------------+----------
78.30-2-00 |        11         16 |        27 
           |      1.05       1.53 |      2.59 
-----------+----------------------+----------
79.11-2-00 |        23          0 |        23 
           |      2.21       0.00 |      2.21 
-----------+----------------------+----------
80.11-1-01 |        11         12 |        23 
           |      1.05       1.15 |      2.21 
-----------+----------------------+----------
81.21-4-00 |         4          8 |        12 
           |      0.38       0.77 |      1.15 
-----------+----------------------+----------
81.29-0-00 |         6          0 |         6 
           |      0.58       0.00 |      0.58 
-----------+----------------------+----------
81.30-3-00 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
82.11-3-00 |        16          0 |        16 
           |      1.53       0.00 |      1.53 
-----------+----------------------+----------
82.20-2-00 |        13         10 |        23 
           |      1.25       0.96 |      2.21 
-----------+----------------------+----------
82.30-0-01 |        24          0 |        24 
           |      2.30       0.00 |      2.30 
-----------+----------------------+----------
82.99-7-99 |        12          0 |        12 
           |      1.15       0.00 |      1.15 
-----------+----------------------+----------
85.31-7-00 |         3          0 |         3 
           |      0.29       0.00 |      0.29 
-----------+----------------------+----------
85.32-5-00 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
85.50-3-02 |         2          3 |         5 
           |      0.19       0.29 |      0.48 
-----------+----------------------+----------
85.93-7-00 |         0          7 |         7 
           |      0.00       0.67 |      0.67 
-----------+----------------------+----------
85.99-6-04 |         5          0 |         5 
           |      0.48       0.00 |      0.48 
-----------+----------------------+----------
86.30-5-06 |         4          0 |         4 
           |      0.38       0.00 |      0.38 
-----------+----------------------+----------
86.50-0-01 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
86.60-7-00 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
88.00-6-00 |         6          0 |         6 
           |      0.58       0.00 |      0.58 
-----------+----------------------+----------
90.01-9-02 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
93.19-1-01 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
94.30-8-00 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
94.99-5-00 |         6          0 |         6 
           |      0.58       0.00 |      0.58 
-----------+----------------------+----------
96.01-7-01 |         2          0 |         2 
           |      0.19       0.00 |      0.19 
-----------+----------------------+----------
     Total |       709        334 |     1,043 
           |     67.98      32.02 |    100.00 

. 
. /*******************************************************************************
> 1.1.2 Matriz de Correlação das Variáveis Contínuas (STATA + Heatmap)
> *******************************************************************************/
. 
. * 1. Defina as variáveis contínuas 
. local var_continuas LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato Q
> tdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos

. 
. * 2. Calcule a matriz de correlação em Stata
. correlate `var_continuas', means
(obs=771)

    Variable |         Mean    Std. dev.          Min          Max
-------------+----------------------------------------------------
 LiqCorrente |     11.34602     61.62887            0      1104.44
    LiqGeral |     9.186511     55.36508            0      1104.67
 LiqCorAjust |     .4019707     .3138378      -2.4927            1
   SolvGeral |     10.23475     57.23463            0      1109.62
    EndGeral |     1.258522     8.809461    -208.1876      34.6218
 CompEndivid |     .7779113     .2544419            0            1
    IndepFin |     9.237449     57.23411       -.7622     1108.622
    ImobilPL |     .1742551     3.620113     -95.5357       9.1728
   ImobRecNC |     .2121664     .2575229       -.2471       1.4847
 PtpCapTerce |     1.258522     8.809461    -208.1876      34.6218
   GiroAtivo |     1.593768     1.421136       -.0289      16.0742
      MargOp |     .9241728      12.5672      -1.4199     348.9034
     MargLiq |     .1878087     2.382947     -14.1571      60.8893
         ROI |     .1331925     .9969528      -25.837       3.2885
         ROE |      .442292     2.761754      -3.9973      70.7696
 vlrcontrato |     1.19e+07     2.33e+07        12000     1.34e+08
QtdeCNAEsS~s |     13.80674     12.70148            1           97
 IdadedeAnos |     23.66408     10.87023     .6438356     59.03288
QtePenalOu~s |     5.045396     19.79681            0          201


             | LiqCor~e LiqGeral LiqCor~t SolvGe~l EndGeral CompEn~d IndepFin ImobilPL ImobRe~C PtpCap~e GiroAt~o   MargOp  MargLiq      ROI      ROE vlrcon~o QtdeCN~s
-------------+---------------------------------------------------------------------------------------------------------------------------------------------------------
 LiqCorrente |   1.0000
    LiqGeral |   0.8983   1.0000
 LiqCorAjust |   0.2496   0.2253   1.0000
   SolvGeral |   0.8946   0.9954   0.2227   1.0000
    EndGeral |  -0.0169  -0.0196  -0.0387  -0.0211   1.0000
 CompEndivid |   0.0039   0.1126   0.1357   0.1145   0.0879   1.0000
    IndepFin |   0.8946   0.9954   0.2228   1.0000  -0.0211   0.1143   1.0000
    ImobilPL |  -0.0030  -0.0043  -0.0083  -0.0029   0.9176   0.0587  -0.0029   1.0000
   ImobRecNC |  -0.0875  -0.0852  -0.4717  -0.0684  -0.0065  -0.1924  -0.0684   0.0730   1.0000
 PtpCapTerce |  -0.0169  -0.0196  -0.0387  -0.0211   1.0000   0.0879  -0.0211   0.9176  -0.0065   1.0000
   GiroAtivo |  -0.0402  -0.0352   0.0570  -0.0407   0.0464   0.1829  -0.0408   0.0235  -0.1458   0.0464   1.0000
      MargOp |  -0.0035  -0.0031  -0.0590  -0.0032   0.0135  -0.0593  -0.0032   0.0334   0.0894   0.0135  -0.0428   1.0000
     MargLiq |   0.0065   0.0067  -0.0282   0.0063   0.0183  -0.0453   0.0063   0.0348   0.0657   0.0183  -0.0493   0.9276   1.0000
         ROI |   0.0424   0.0340   0.2325   0.0325   0.0161   0.0371   0.0325   0.0013  -0.0330   0.0161   0.1436   0.0017   0.2291   1.0000
         ROE |   0.0186  -0.0039  -0.1164  -0.0055  -0.0563   0.0464  -0.0055  -0.0432  -0.0780  -0.0563   0.1622  -0.0023  -0.1808  -0.7660   1.0000
 vlrcontrato |  -0.0597  -0.0519  -0.0639  -0.0559  -0.0140  -0.0845  -0.0559  -0.0351  -0.0796  -0.0140   0.1053  -0.0170  -0.0317  -0.0637   0.0373   1.0000
QtdeCNAEsS~s |  -0.0070  -0.0013   0.0636  -0.0017   0.0042  -0.1578  -0.0018   0.0289  -0.0425   0.0042  -0.0652   0.0495   0.0382  -0.0394  -0.0140   0.0385   1.0000
 IdadedeAnos |  -0.0640  -0.0677  -0.2033  -0.0666  -0.0083  -0.1925  -0.0666   0.0513   0.1386  -0.0083  -0.0819   0.0294   0.0274  -0.0379  -0.0162   0.3105  -0.0434
QtePenalOu~s |   0.0002   0.0085  -0.1351   0.0066   0.0225  -0.1570   0.0066   0.0728   0.1892   0.0225  -0.0745   0.3601   0.3191  -0.0232  -0.0088  -0.0125   0.1302

             | Idaded~s QtePen~s
-------------+------------------
 IdadedeAnos |   1.0000
QtePenalOu~s |   0.1335   1.0000


. matrix C = r(C)

. 
. * 3. Gere o heatmap com o pacote heatplot
. 
. heatplot C, ///
>     color(RdBu) ///
>     legend(on) aspectratio(1) ///
>     xlabel(, labsize(vsmall) angle(45)) ///
>     ylabel(, labsize(vsmall)) ///
>     title("Matriz de Correlação das Variáveis Contínuas")

. 
. * 4. Salve o gráfico
. graph export "heatmap_correlacao.png", replace width(2400)
(file heatmap_correlacao.png not found)
file heatmap_correlacao.png saved as PNG format

. 
. 
. */*******************************************************************************
> 1.2 – Winsorização das variáveis contínuas (antes da imputação)
> *******************************************************************************/
. 
. ssc install winsor2, replace
checking winsor2 consistency and verifying not already installed...
all files already exist and are up to date.

. local winsor_vars LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato

. 
. foreach var of local winsor_vars {
  2.     winsor2 `var', cuts(1 99) replace
  3. }

. 
. /*******************************************************************************
> 1.3 - Executar estatísticas descritivas para todas as variáveis após wisorização
> *******************************************************************************/
. summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSe
> cundarios IdadedeAnos QtePenalOutrosOrgaos

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |      1,043     10.8256    39.78872        .21     327.68
    LiqGeral |      1,043    7.714746     25.6251        .19      204.2
 LiqCorAjust |      1,043    .4308569    .2929047     -.4339      .9979
   SolvGeral |      1,043    10.14675    37.56172        .34     327.68
    EndGeral |      1,043    1.498043    2.623075    -4.1192    16.7327
-------------+---------------------------------------------------------
 CompEndivid |      1,043    .7826933    .2552281      .0217          1
    IndepFin |      1,043    9.152995    37.55966     -.2428    326.675
    ImobilPL |      1,043     .290273    .4366479     -.1759     2.8281
   ImobRecNC |      1,043    .2031115    .2409047          0       .952
 PtpCapTerce |      1,043    1.498043    2.623075    -4.1192    16.7327
-------------+---------------------------------------------------------
   GiroAtivo |      1,043    1.528994    1.311048          0     6.2266
      MargOp |      1,043    .4336818    .3406366     -.0693     1.0834
     MargLiq |      1,043    .1019767    .3243324    -1.9267     1.0026
         ROI |      1,043    .1808547    .3332982     -.4072     2.0039
         ROE |      1,043    .3400332    .6569672    -1.1287     4.4129
-------------+---------------------------------------------------------
 vlrcontrato |        771    1.19e+07    2.32e+07      32820   1.32e+08
QtdeCNAEsS~s |      1,043    15.52637    14.30951          1         97
 IdadedeAnos |      1,043     22.5881    10.90365   .6438356   59.03288
QtePenalOu~s |      1,043    5.395973    20.56574          0        201

. 
. * Estatísticas descritivas separadas por penalização
. by FoiPenalizadoSTJ, sort: summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI 
> ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        709    12.93282    44.22021        .21     327.68
    LiqGeral |        709    8.946911    28.02379        .19      204.2
 LiqCorAjust |        709    .4361753    .2979798     -.4339      .9979
   SolvGeral |        709    11.89076     41.3136        .34     327.68
    EndGeral |        709    1.471966    2.622786    -4.1192    16.7327
-------------+---------------------------------------------------------
 CompEndivid |        709    .7847944      .26586      .0217          1
    IndepFin |        709     10.8971    41.31137     -.2428    326.675
    ImobilPL |        709    .3119197    .4569043     -.1759     2.8281
   ImobRecNC |        709    .2163642    .2469337          0       .952
 PtpCapTerce |        709    1.471966    2.622786    -4.1192    16.7327
-------------+---------------------------------------------------------
   GiroAtivo |        709    1.506109    1.302121          0     6.2266
      MargOp |        709    .4425118    .3386633     -.0693     1.0834
     MargLiq |        709    .1109121    .3219514    -1.9267     1.0026
         ROI |        709    .1987354    .3603414     -.4072     2.0039
         ROE |        709    .3653255     .685232    -1.1287     4.4129
-------------+---------------------------------------------------------
 vlrcontrato |        493    1.28e+07    2.30e+07      32820   1.32e+08
QtdeCNAEsS~s |        709    16.04372     15.0858          1         97
 IdadedeAnos |        709    22.49518    11.12163   .6438356   59.03288
QtePenalOu~s |        709    4.299013    20.43201          0        201

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        334    6.352485    27.69203        .21     327.68
    LiqGeral |        334    5.099162    19.36281        .19      204.2
 LiqCorAjust |        334    .4195671    .2819341     -.4339      .9979
   SolvGeral |        334    6.444641    27.67145        .34     327.68
    EndGeral |        334    1.553399    2.626765    -4.1192    16.7327
-------------+---------------------------------------------------------
 CompEndivid |        334    .7782332    .2313626      .0217          1
    IndepFin |        334    5.450687    27.66977     -.2428    326.675
    ImobilPL |        334    .2443222    .3868271     -.1759     2.8281
   ImobRecNC |        334    .1749793    .2253628          0       .952
 PtpCapTerce |        334    1.553399    2.626765    -4.1192    16.7327
-------------+---------------------------------------------------------
   GiroAtivo |        334    1.577575     1.33046          0     6.2266
      MargOp |        334    .4149377     .344548     -.0693     1.0834
     MargLiq |        334     .083009    .3290109    -1.9267     1.0026
         ROI |        334    .1428985    .2634637     -.4072     2.0039
         ROE |        334    .2863437    .5899066    -1.1287     4.4129
-------------+---------------------------------------------------------
 vlrcontrato |        278    1.03e+07    2.36e+07      32820   1.32e+08
QtdeCNAEsS~s |        334    14.42814    12.45313          1         58
 IdadedeAnos |        334    22.78534    10.43942   3.621918   58.87123
QtePenalOu~s |        334    7.724551    20.68516          0        171


. 
. * Bloco para salvar as estatísticas descritivas após a winsorização por grupo
. tabstat LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecu
> ndarios IdadedeAnos QtePenalOutrosOrgaos, ///
>     statistics(mean sd min max n) by(FoiPenalizadoSTJ)

Summary statistics: Mean, SD, Min, Max, N
Group variable: FoiPenalizadoSTJ (FoiPenalizadoSTJ)

FoiPenalizadoSTJ |  LiqCor~e  LiqGeral  LiqCor~t  SolvGe~l  EndGeral  CompEn~d  IndepFin  ImobilPL  ImobRe~C  PtpCap~e  GiroAt~o    MargOp   MargLiq       ROI       ROE
-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------
               0 |  12.93282  8.946911  .4361753  11.89076  1.471966  .7847944   10.8971  .3119197  .2163642  1.471966  1.506109  .4425118  .1109121  .1987354  .3653255
                 |  44.22021  28.02379  .2979798   41.3136  2.622786    .26586  41.31137  .4569043  .2469337  2.622786  1.302121  .3386633  .3219514  .3603414   .685232
                 |       .21       .19    -.4339       .34   -4.1192     .0217    -.2428    -.1759         0   -4.1192         0    -.0693   -1.9267    -.4072   -1.1287
                 |    327.68     204.2     .9979    327.68   16.7327         1   326.675    2.8281      .952   16.7327    6.2266    1.0834    1.0026    2.0039    4.4129
                 |       709       709       709       709       709       709       709       709       709       709       709       709       709       709       709
-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------
               1 |  6.352485  5.099162  .4195671  6.444641  1.553399  .7782332  5.450687  .2443222  .1749793  1.553399  1.577575  .4149377   .083009  .1428985  .2863437
                 |  27.69203  19.36281  .2819341  27.67145  2.626765  .2313626  27.66977  .3868271  .2253628  2.626765   1.33046   .344548  .3290109  .2634637  .5899066
                 |       .21       .19    -.4339       .34   -4.1192     .0217    -.2428    -.1759         0   -4.1192         0    -.0693   -1.9267    -.4072   -1.1287
                 |    327.68     204.2     .9979    327.68   16.7327         1   326.675    2.8281      .952   16.7327    6.2266    1.0834    1.0026    2.0039    4.4129
                 |       334       334       334       334       334       334       334       334       334       334       334       334       334       334       334
-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------
           Total |   10.8256  7.714746  .4308569  10.14675  1.498043  .7826933  9.152995   .290273  .2031115  1.498043  1.528994  .4336818  .1019767  .1808547  .3400332
                 |  39.78872   25.6251  .2929047  37.56172  2.623075  .2552281  37.55966  .4366479  .2409047  2.623075  1.311048  .3406366  .3243324  .3332982  .6569672
                 |       .21       .19    -.4339       .34   -4.1192     .0217    -.2428    -.1759         0   -4.1192         0    -.0693   -1.9267    -.4072   -1.1287
                 |    327.68     204.2     .9979    327.68   16.7327         1   326.675    2.8281      .952   16.7327    6.2266    1.0834    1.0026    2.0039    4.4129
                 |      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043      1043
------------------------------------------------------------------------------------------------------------------------------------------------------------------------

FoiPenalizadoSTJ |  vlrcon~o  QtdeCN~s  Idaded~s  QtePen~s
-----------------+----------------------------------------
               0 |  1.28e+07  16.04372  22.49518  4.299013
                 |  2.30e+07   15.0858  11.12163  20.43201
                 |     32820         1  .6438356         0
                 |  1.32e+08        97  59.03288       201
                 |       493       709       709       709
-----------------+----------------------------------------
               1 |  1.03e+07  14.42814  22.78534  7.724551
                 |  2.36e+07  12.45313  10.43942  20.68516
                 |     32820         1  3.621918         0
                 |  1.32e+08        58  58.87123       171
                 |       278       334       334       334
-----------------+----------------------------------------
           Total |  1.19e+07  15.52637   22.5881  5.395973
                 |  2.32e+07  14.30951  10.90365  20.56574
                 |     32820         1  .6438356         0
                 |  1.32e+08        97  59.03288       201
                 |       771      1043      1043      1043
----------------------------------------------------------

. 
. /*******************************************************************************
> ETAPA 2 - TRANSFORMAÇÃO DE VARIÁVEIS 
> *******************************************************************************/
. * NÃO gerar dummies ainda — manter Porte, CNAE e NaturezaJuridica para o SMOTENC
. 
. * Ajuste log do valor dos contratos
. replace vlrcontrato = 1 if vlrcontrato == 0 | vlrcontrato == .
(272 real changes made)

. gen log_vlrcontrato = log(vlrcontrato)

. 
. * Dropar CNPJ antes de exportar
. drop CNPJ

. 
. 
. /*******************************************************************************
> 2.1 - Imputação dos valores faltantes (missing) com a média ou mediana 
> *******************************************************************************/
. 
. * Lista de variáveis com dados faltantes para imputação
. local imput_vars GiroAtivo MargOp MargLiq ROI ROE RecBruta LucroBruto LucroLiquido

. 
. * Inicializar contadores
. local conta_media = 0

. local conta_mediana = 0

. 
. * Imputação adaptativa: média se CV <= 0.3, mediana se CV > 0.3
. foreach var of local imput_vars {
  2.     
.     quietly summarize `var' if `var' > 0, detail
  3.     local media = r(mean)
  4.     local desvio = r(sd)
  5.     local mediana = r(p50)
  6. 
.     * Calcular o Coeficiente de Variação (CV)
.     local cv = `desvio' / `media'
  7. 
.     * Escolher método conforme o CV
.     if `cv' <= 0.3 {
  8.         replace `var' = `media' if missing(`var') | `var' == 0
  9.         local conta_media = `conta_media' + 1
 10.         di as result "🔧 `var': imputado com MÉDIA (CV = " %4.3f `cv' ")"
 11.     }
 12.     else {
 13.         replace `var' = `mediana' if missing(`var') | `var' == 0
 14.         local conta_mediana = `conta_mediana' + 1
 15.         di as result "🔧 `var': imputado com MEDIANA (CV = " %4.3f `cv' ")"
 16.     }
 17. }
(104 real changes made)
🔧 GiroAtivo: imputado com MEDIANA (CV = 0.750)
(144 real changes made)
🔧 MargOp: imputado com MEDIANA (CV = 0.604)
(106 real changes made)
🔧 MargLiq: imputado com MEDIANA (CV = 1.167)
(86 real changes made)
🔧 ROI: imputado com MEDIANA (CV = 1.382)
(86 real changes made)
🔧 ROE: imputado com MEDIANA (CV = 1.424)
(103 real changes made)
🔧 RecBruta: imputado com MEDIANA (CV = 6.691)
(134 real changes made)
🔧 LucroBruto: imputado com MEDIANA (CV = 7.145)
(85 real changes made)
🔧 LucroLiquido: imputado com MEDIANA (CV = 7.764)

. 
. * Exibir tabela resumo
. di as text "═══════════════════════════════════════════════════════════════"
═══════════════════════════════════════════════════════════════

. di as text " Resumo da Imputação de Variáveis (Critério: CV <= 0.3 → MÉDIA)"
 Resumo da Imputação de Variáveis (Critério: CV <= 0.3 → MÉDIA)

. di as text "───────────────────────────────────────────────────────────────"
───────────────────────────────────────────────────────────────

. di " Variáveis imputadas com MÉDIA:   `conta_media'"
 Variáveis imputadas com MÉDIA:   0

. di " Variáveis imputadas com MEDIANA: `conta_mediana'"
 Variáveis imputadas com MEDIANA: 8

. di as text " Total de variáveis imputadas:    " `=`conta_media' + `conta_mediana''
 Total de variáveis imputadas:    8

. di as text "═══════════════════════════════════════════════════════════════"
═══════════════════════════════════════════════════════════════

. 
. /*******************************************************************************
> 2.2 - Criação dos Índices Sintéticos (Z-SCORE)
> *******************************************************************************/
. 
. /* (A) Liquidez: combina LiqCorrente, LiqGeral, SolvGeral e IndepFin */
. foreach var in LiqCorrente LiqGeral SolvGeral IndepFin {
  2.     egen z_`var' = std(`var')
  3. }

. gen Liquidez_Media_Z = (z_LiqCorrente + z_LiqGeral + z_SolvGeral + z_IndepFin)/4

. 
. /* (B) Estrutura: combina ImobilPL, PtpCapTerce e EndGeral */
. foreach var in ImobilPL PtpCapTerce EndGeral {
  2.     egen z_`var' = std(`var')
  3. }

. gen Estrutura_Media_Z = (z_ImobilPL + z_PtpCapTerce + EndGeral)/2

. 
. /* (C) Margem: combina MargOp e MargLiq */
. egen z_MargOp = std(MargOp)

. egen z_MargLiq = std(MargLiq)

. gen Margem_Media_Z = (z_MargOp + z_MargLiq)/2

. 
. /*******************************************************************************
> 2.2.1 - Matriz de correção dos índices sintéticos (e outras variáveis contínuas) 
> *******************************************************************************/
. 
. /* Defina as variáveis contínuas finais para correlação */
. local correl_final Liquidez_Media_Z Estrutura_Media_Z Margem_Media_Z ROI ROE CompEndivid GiroAtivo log_vlrcontrato QtdeCNAEsSecundarios QtePenalOutrosOrgaos

. 
. /* Calcule a matriz de correlação */
. correlate `correl_final', means
(obs=1,043)

    Variable |         Mean    Std. dev.          Min          Max
-------------+----------------------------------------------------
Liquidez_M~Z |    -1.86e-09     .9669045    -.2679217     8.134639
Estrutura_~Z |     .7490214     2.043631    -3.664145     13.69427
Margem_Med~Z |    -2.18e-09     .8029176    -4.134047     2.373264
         ROI |     .1913842     .3294091       -.4072       2.0039
         ROE |     .3622134     .6496054      -1.1287       4.4129
 CompEndivid |     .7826933     .2552281        .0217            1
   GiroAtivo |     1.668402     1.211515        .0004       6.2266
log_vlrcon~o |      10.8801     6.667194            0     18.69629
QtdeCNAEsS~s |     15.52637     14.30951            1           97
QtePenalOu~s |     5.395973     20.56574            0          201


             | Liquid~Z Estrut~Z Margem~Z      ROI      ROE CompEn~d GiroAt~o log_vl~o QtdeCN~s QtePen~s
-------------+------------------------------------------------------------------------------------------
Liquidez_M~Z |   1.0000
Estrutura_~Z |  -0.1456   1.0000
Margem_Med~Z |   0.2118  -0.1589   1.0000
         ROI |   0.1336  -0.1670   0.4526   1.0000
         ROE |   0.0234  -0.0485   0.1954   0.7851   1.0000
 CompEndivid |   0.1309  -0.1336   0.1336   0.1987   0.1088   1.0000
   GiroAtivo |  -0.0852  -0.0238  -0.0952   0.4000   0.3941   0.1694   1.0000
log_vlrcon~o |  -0.0979   0.0810  -0.0962  -0.1072  -0.0563  -0.0263   0.0431   1.0000
QtdeCNAEsS~s |  -0.0029  -0.0652   0.0110  -0.0310  -0.0538  -0.1003  -0.0087  -0.1865   1.0000
QtePenalOu~s |  -0.0267   0.1163  -0.0337  -0.0689  -0.0574  -0.0970  -0.0052  -0.0126   0.1876   1.0000


. matrix C = r(C)

. 
. /* Gere o heatmap (se tiver heatplot instalado) */
. heatplot C, ///
>     color(RdBu) ///
>     legend(on) aspectratio(1) ///
>     xlabel(, labsize(vsmall) angle(45)) ///
>     ylabel(, labsize(vsmall)) ///
>     title("Matriz de Correlação dos Indicadores Sintéticos e Contínuos")

. 
. graph export "heatmap_correlacao_indices.png", replace width(2400)
(file heatmap_correlacao_indices.png not found)
file heatmap_correlacao_indices.png saved as PNG format

. 
. 
. /*******************************************************************************
> ETAPA 3 - SEPARAÇÃO DOS DADOS EM CONJUNTOS DE TREINAMENTO E TESTE COM PROPORÇÕES EXATAS
> *******************************************************************************/
. * Definir uma seed para reprodutibilidade
. set seed 12345

. 
. * Gerar uma variável aleatória uniforme entre 0 e 1
. generate u = runiform()

. 
. * Ordenar aleatoriamente dentro de cada classe
. sort FoiPenalizadoSTJ u

. 
. * Gerar índices de observação dentro de cada classe
. by FoiPenalizadoSTJ: gen obs_no = _n

. by FoiPenalizadoSTJ: gen total_obs = _N

. 
. * Calcular o ponto de corte para 80% das observações
. by FoiPenalizadoSTJ: gen cutoff = ceil(0.80 * total_obs)

. 
. * Criar o indicador de treinamento
. gen train = 0

. replace train = 1 if obs_no <= cutoff
(836 real changes made)

. 
. * Verificar distribuição antes do SMOTE
. tabulate FoiPenalizadoSTJ train

FoiPenaliz |         train
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       141        568 |       709 
         1 |        66        268 |       334 
-----------+----------------------+----------
     Total |       207        836 |     1,043 

. 
. /*******************************************************************************
> ETAPA 3.1 - SALVAR OS LABELS PARA RESTAURAR DEPOIS DO SMOTE
> *******************************************************************************/
. * Criar um arquivo temporário para armazenar labels
. tempfile labels_backup

. label save using "`labels_backup'.do", replace
(file C:\Users\kkbul\AppData\Local\Temp\ST_2d10_000001.tmp.do not found)
file C:\Users\kkbul\AppData\Local\Temp\ST_2d10_000001.tmp.do saved

. 
. /*******************************************************************************
> ETAPA 3.2 - EXPORTAR BASES PARA O PYTHON (TREINO PARA SMOTE, TESTE SEPARADO)
> *******************************************************************************/
. * Exportar conjunto de treino
. preserve

. keep if train == 1
(207 observations deleted)

. export delimited using "train_data.csv", replace
(file train_data.csv not found)
file train_data.csv saved

. restore

. 
. * Exportar conjunto de teste
. preserve

. keep if train == 0
(836 observations deleted)

. export delimited using "test_data.csv", replace
(file test_data.csv not found)
file test_data.csv saved

. restore

. 
. /*******************************************************************************
> ETAPA 4 - APLICAR SMOTENC NO PYTHON
> *******************************************************************************/
. python:
----------------------------------------------- python (type end to exit) --------------------------------------------------------------------------------------------------
>>> import pandas as pd
>>> import numpy as np
>>> from imblearn.over_sampling import SMOTENC
>>> import traceback  # Para melhor tratamento de erros
>>> 
>>> print("--- Iniciando Bloco Python ---")
--- Iniciando Bloco Python ---
>>> try:
...     # Carregar conjunto de treino do Stata
...     print("Carregando train_data.csv...")
...     df = pd.read_csv("train_data.csv")
...     print(f"Dados carregados: {df.shape[0]} linhas, {df.shape[1]} colunas")
...     print("Colunas originais:", df.columns.tolist())
...     print("Contagem inicial de 'FoiPenalizadoSTJ':\n", df["FoiPenalizadoSTJ"].value_counts())
... 
...     # Separar variável-alvo e explicativas
...     X = df.drop(columns=["FoiPenalizadoSTJ", "train"], errors="ignore")
...     y = df["FoiPenalizadoSTJ"]
... 
...     # Definir variáveis categóricas PELOS NOMES (mais robusto)
...     categorical_feature_names = ['Porte', 'CNAE', 'DivisaoCNAE', 'NaturezaJuridica']
... 
...     # Verificar se as colunas existem em X
...     missing_cols = [col for col in categorical_feature_names if col not in X.columns]
...     if missing_cols:
...         raise ValueError(f"As seguintes colunas categóricas não foram encontradas em X: {missing_cols}")
... 
...     # Obter os índices das colunas categóricas
...     categorical_features_indices = [X.columns.get_loc(col) for col in categorical_feature_names]
...     print(f"Índices das features categóricas: {categorical_features_indices}")
...     print("Tipos das features categóricas em X:\n", X[categorical_feature_names].dtypes)
... 
...     # Ajustar k_neighbors: deve ser menor que o número de amostras da classe minoritária
...     min_class_count = y.value_counts().min()
...     k_neighbors_val = min(5, min_class_count - 1)
...     if k_neighbors_val < 1:
...         print(f"AVISO: Classe minoritária tem apenas {min_class_count} amostras. Não é possível aplicar SMOTENC com k_neighbors >= 1.")
...         raise ValueError(f"Não é possível aplicar SMOTENC, k_neighbors ({k_neighbors_val}) seria menor que 1.")
...     else:
...         print(f"Aplicando SMOTENC com k_neighbors={k_neighbors_val}...")
...         smote_nc = SMOTENC(categorical_features=categorical_features_indices,
...                            random_state=42,
...                            k_neighbors=k_neighbors_val)
... 
...         X_resampled, y_resampled = smote_nc.fit_resample(X, y)
...         print("SMOTENC concluído.")
...         print(f"Tamanho após resample: {X_resampled.shape[0]} linhas")
...         print("Contagem de 'FoiPenalizadoSTJ' após resample:\n", pd.Series(y_resampled).value_counts())
... 
...         # Criar DataFrame balanceado a partir do resultado do SMOTENC
...         df_resampled = pd.DataFrame(X_resampled, columns=X.columns)
... 
...         # Adicionar a variável alvo e a marcação de treino
...         df_resampled["FoiPenalizadoSTJ"] = y_resampled
...         df_resampled["train"] = 1
... 
...         # Verificar se as colunas categóricas foram mantidas
...         print("Colunas no df_resampled final:", df_resampled.columns.tolist())
...         missing_cols_after = [col for col in categorical_feature_names if col not in df_resampled.columns]
...         if missing_cols_after:
...             print(f"AVISO: As colunas {missing_cols_after} NÃO estão presentes após SMOTENC!")
...         else:
...             print("Colunas categóricas presentes após SMOTENC.")
...             print("Tipos das features categóricas após SMOTENC:\n", df_resampled[categorical_feature_names].dtypes)
...             print("Primeiras linhas do df_resampled:\n", df_resampled.head())
... 
...         # 🔁 Converter variáveis categóricas e salvar mapeamentos
...         print("Convertendo variáveis categóricas do treino para códigos numéricos e salvando mapeamentos...")
... 
...         categorical_mappings = {}
... 
...         for col in categorical_feature_names:
...             df_resampled[col] = df_resampled[col].astype("category")
... 
...             # Salvar mapeamento antes de converter para códigos
...             mapping = dict(enumerate(df_resampled[col].cat.categories))
...             categorical_mappings[col] = mapping
... 
...             # Substituir coluna por códigos numéricos
...             df_resampled[col] = df_resampled[col].cat.codes
... 
...             # Exportar mapeamento para CSV
...             mapping_df = pd.DataFrame(mapping.items(), columns=[f"{col}_code", f"{col}_label"])
...             mapping_df.to_csv(f"{col}_mapping.csv", index=False, encoding="utf-8")
...             print(f"✅ Mapeamento salvo: {col}_mapping.csv")
... 
...         print("Conversão no treino concluída.")
... 
...     # Salvar dataset balanceado em CSV (codificado em UTF-8)
...     print("Salvando train_data_balanced.csv...")
...     df_resampled.to_csv("train_data_balanced.csv", index=False, encoding='utf-8')
...     print("Arquivo train_data_balanced.csv salvo com sucesso.")
... 
...     # ────────────────────────────────────────────────────────────────────────
...     # ✅ ETAPA EXTRA: Converter variáveis categóricas do conjunto de teste com os mesmos códigos do treino
...     print("Carregando test_data.csv para conversão das variáveis categóricas...")
...     df_test = pd.read_csv("test_data.csv")
...     print(f"Conjunto de teste carregado: {df_test.shape[0]} linhas")
... 
...     # Verificar se as colunas categóricas estão presentes
...     missing_test_cols = [col for col in categorical_feature_names if col not in df_test.columns]
...     if missing_test_cols:
...         raise ValueError(f"⚠️ Colunas categóricas ausentes no teste: {missing_test_cols}")
... 
...     print("Aplicando os mesmos mapeamentos do treino ao conjunto de teste...")
... 
...     for col in categorical_feature_names:
...         mapping_df = pd.read_csv(f"{col}_mapping.csv", encoding="utf-8")
...         mapping_dict = dict(zip(mapping_df[f"{col}_label"], mapping_df[f"{col}_code"]))
... 
...         # Aplicar o mapeamento manualmente
...         df_test[col] = df_test[col].map(mapping_dict)
... 
...         # Se houver valores não encontrados no mapeamento, definir como -1
...         df_test[col] = df_test[col].fillna(-1).astype(int)
... 
...         print(f"✅ Coluna '{col}' convertida com mapeamento do treino.")
... 
...     # Salvar novamente o arquivo convertido
...     df_test.to_csv("test_data.csv", index=False, encoding="utf-8")
...     print("Arquivo test_data.csv salvo com sucesso após conversão.")
... 
... except Exception as e:
...     print("--- ERRO NO BLOCO PYTHON ---")
...     print(traceback.format_exc())
...     pd.DataFrame().to_csv("train_data_balanced.csv", index=False)
...     print("Arquivo train_data_balanced.csv vazio criado devido a erro.")
... 
Carregando train_data.csv...
Dados carregados: 836 linhas, 55 colunas
Colunas originais: ['FoiPenalizadoSTJ', 'Porte', 'LiqCorrente', 'LiqGeral', 'LiqCorAjust', 'SolvGeral', 'EndGeral', 'CompEndivid', 'IndepFin', 'ImobilPL', 'ImobRecNC', 'Ptp
> CapTerce', 'GiroAtivo', 'MargOp', 'MargLiq', 'ROI', 'ROE', 'AC', 'ANRP', 'Investimentos', 'Imobilizado', 'Intangivel', 'PC', 'PNC', 'PL', 'RecBruta', 'LucroBruto', 'Lucro
> Liquido', 'QtePenalOutrosOrgaos', 'vlrcontrato', 'IdadedeAnos', 'CNAE', 'DivisaoCNAE', 'NaturezaJuridica', 'QtdeCNAEsSecundarios', 'AnodasDemonstracões', 'cnpjs', 'log_vl
> rcontrato', 'z_LiqCorrente', 'z_LiqGeral', 'z_SolvGeral', 'z_IndepFin', 'Liquidez_Media_Z', 'z_ImobilPL', 'z_PtpCapTerce', 'z_EndGeral', 'Estrutura_Media_Z', 'z_MargOp', 
> 'z_MargLiq', 'Margem_Media_Z', 'u', 'obs_no', 'total_obs', 'cutoff', 'train']
Contagem inicial de 'FoiPenalizadoSTJ':
 FoiPenalizadoSTJ
0    568
1    268
Name: count, dtype: int64
Índices das features categóricas: [0, 30, 31, 32]
Tipos das features categóricas em X:
 Porte               object
CNAE                object
DivisaoCNAE          int64
NaturezaJuridica    object
dtype: object
Aplicando SMOTENC com k_neighbors=5...
SMOTENC concluído.
Tamanho após resample: 1136 linhas
Contagem de 'FoiPenalizadoSTJ' após resample:
 FoiPenalizadoSTJ
0    568
1    568
Name: count, dtype: int64
Colunas no df_resampled final: ['Porte', 'LiqCorrente', 'LiqGeral', 'LiqCorAjust', 'SolvGeral', 'EndGeral', 'CompEndivid', 'IndepFin', 'ImobilPL', 'ImobRecNC', 'PtpCapTerce
> ', 'GiroAtivo', 'MargOp', 'MargLiq', 'ROI', 'ROE', 'AC', 'ANRP', 'Investimentos', 'Imobilizado', 'Intangivel', 'PC', 'PNC', 'PL', 'RecBruta', 'LucroBruto', 'LucroLiquido'
> , 'QtePenalOutrosOrgaos', 'vlrcontrato', 'IdadedeAnos', 'CNAE', 'DivisaoCNAE', 'NaturezaJuridica', 'QtdeCNAEsSecundarios', 'AnodasDemonstracões', 'cnpjs', 'log_vlrcontrat
> o', 'z_LiqCorrente', 'z_LiqGeral', 'z_SolvGeral', 'z_IndepFin', 'Liquidez_Media_Z', 'z_ImobilPL', 'z_PtpCapTerce', 'z_EndGeral', 'Estrutura_Media_Z', 'z_MargOp', 'z_MargL
> iq', 'Margem_Media_Z', 'u', 'obs_no', 'total_obs', 'cutoff', 'FoiPenalizadoSTJ', 'train']
Colunas categóricas presentes após SMOTENC.
Tipos das features categóricas após SMOTENC:
 Porte               object
CNAE                object
DivisaoCNAE          int64
NaturezaJuridica    object
dtype: object
Primeiras linhas do df_resampled:
              Porte  LiqCorrente  LiqGeral  ...  cutoff  FoiPenalizadoSTJ  train
0  PEQUENA EMPRESA         3.83      3.62  ...     568                 0      1
1    MICROENTIDADE        71.67     22.21  ...     568                 0      1
2  PEQUENA EMPRESA         4.68      4.68  ...     568                 0      1
3  PEQUENA EMPRESA        26.73     26.73  ...     568                 0      1
4  PEQUENA EMPRESA         2.55      2.42  ...     568                 0      1

[5 rows x 55 columns]
Convertendo variáveis categóricas do treino para códigos numéricos e salvando mapeamentos...
✅ Mapeamento salvo: Porte_mapping.csv
✅ Mapeamento salvo: CNAE_mapping.csv
✅ Mapeamento salvo: DivisaoCNAE_mapping.csv
✅ Mapeamento salvo: NaturezaJuridica_mapping.csv
Conversão no treino concluída.
Salvando train_data_balanced.csv...
Arquivo train_data_balanced.csv salvo com sucesso.
Carregando test_data.csv para conversão das variáveis categóricas...
Conjunto de teste carregado: 207 linhas
Aplicando os mesmos mapeamentos do treino ao conjunto de teste...
✅ Coluna 'Porte' convertida com mapeamento do treino.
✅ Coluna 'CNAE' convertida com mapeamento do treino.
✅ Coluna 'DivisaoCNAE' convertida com mapeamento do treino.
✅ Coluna 'NaturezaJuridica' convertida com mapeamento do treino.
Arquivo test_data.csv salvo com sucesso após conversão.
>>> print("--- Fim Bloco Python ---")
--- Fim Bloco Python ---
>>> end
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

. 
. 
. /*******************************************************************************
> ETAPA 5 - IMPORTAR NOVO CONJUNTO DE TREINO BALANCEADO NO STATA
> *******************************************************************************/
. clear

. * Adicionado varnames(1) e case(preserve)
. import delimited "train_data_balanced.csv", varnames(1) case(preserve) clear encoding("UTF-8")
(55 vars, 1,136 obs)

. 
. * Verificar se as variáveis existem após a importação
. describe Porte CNAE DivisaoCNAE NaturezaJuridica 

Variable      Storage   Display    Value
    name         type    format    label      Variable label
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Porte           byte    %8.0g                 
CNAE            int     %8.0g                 
DivisaoCNAE     byte    %8.0g                 
NaturezaJurid~a byte    %8.0g                 

. 
. * Restaurar labels originais corretamente
. * Certifique-se que os labels ainda são aplicáveis. SMOTE pode alterar a natureza dos dados.
. * Considere recriar labels se necessário, ou pular esta etapa se causar problemas.
. capture do "`labels_backup'.do"

. 
. if _rc != 0 {
.     di as error "⚠️ Falha ao restaurar labels. Verificar compatibilidade após SMOTE."
. }

. else {
.     di as text "✅ Labels restaurados com sucesso após SMOTE."
✅ Labels restaurados com sucesso após SMOTE.
. }

. 
. * Verificar balanceamento do conjunto de treino
. tabulate FoiPenalizadoSTJ train

FoiPenaliz |   train
    adoSTJ |         1 |     Total
-----------+-----------+----------
         0 |       568 |       568 
         1 |       568 |       568 
-----------+-----------+----------
     Total |     1,136 |     1,136 

. 
. /*******************************************************************************
> ETAPA 5.1 – IMPORTAR CONJUNTO DE TESTE E JUNTAR À BASE DE TREINO BALANCEADO
> *******************************************************************************/
. * Passo 1 – Importar o conjunto de teste separadamente e salvar como temporário
. clear

. * Adicionado case(preserve)
. import delimited "test_data.csv", varnames(1) case(preserve) encoding("UTF-8")
(55 vars, 207 obs)

. tempfile testdata

. save `testdata', replace // Adicionado replace para segurança
(file C:\Users\kkbul\AppData\Local\Temp\ST_2d10_000004.tmp not found)
file C:\Users\kkbul\AppData\Local\Temp\ST_2d10_000004.tmp saved as .dta format

. 
. * Passo 2 – Agora importar o treino balanceado
. clear

. * Adicionado varnames(1) e case(preserve)
. import delimited "train_data_balanced.csv", varnames(1) case(preserve) clear encoding("UTF-8")
(55 vars, 1,136 obs)

. 
. * Passo 3 – Restaurar os labels originais (novamente, verificar necessidade/compatibilidade)
. capture do "`labels_backup'.do"

. if _rc != 0 {
.     di as error "Falha ao restaurar labels. Verificar compatibilidade após SMOTE."
. }

. 
. * Passo 4 – Juntar com o conjunto de teste
. * Verificar se as variáveis categóricas existem antes de juntar
. describe Porte CNAE DivisaoCNAE NaturezaJuridica

Variable      Storage   Display    Value
    name         type    format    label      Variable label
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Porte           byte    %8.0g                 
CNAE            int     %8.0g                 
DivisaoCNAE     byte    %8.0g                 
NaturezaJurid~a byte    %8.0g                 

. append using `testdata'

. 
. * Passo 5 – Verificar a distribuição final por treino/teste
. tabulate FoiPenalizadoSTJ train

FoiPenaliz |         train
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       141        568 |       709 
         1 |        66        568 |       634 
-----------+----------------------+----------
     Total |       207      1,136 |     1,343 

. 
. * Verificar se as variáveis existem após o append
. describe Porte CNAE DivisaoCNAE NaturezaJuridica

Variable      Storage   Display    Value
    name         type    format    label      Variable label
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Porte           byte    %8.0g                 
CNAE            int     %8.0g                 
DivisaoCNAE     byte    %8.0g                 
NaturezaJurid~a byte    %8.0g                 

. 
. /*******************************************************************************
> ETAPA 5.1.1 – AGRUPAMENTO DE CNAEs RAROS (CATEGORIAS COM POUCA FREQUÊNCIA)
> *******************************************************************************/
. 
. * Define o mínimo de ocorrências para manter CNAE como categoria isolada
. local freq_minima = 10

. 
. * Cria um grupo especial para CNAEs com baixa frequência
. preserve

. 
. * Guardar versão original, caso queira rastrear depois
. gen CNAE_original = CNAE 

. 
. * Gerar mapa de frequência dos CNAEs
. contract CNAE

. gen CNAE_agrupado = CNAE

. replace CNAE_agrupado = -1 if _freq < `freq_minima'
(81 real changes made)

. tempfile freqmap

. save `freqmap', replace
(file C:\Users\kkbul\AppData\Local\Temp\ST_2d10_000006.tmp not found)
file C:\Users\kkbul\AppData\Local\Temp\ST_2d10_000006.tmp saved as .dta format

. 
. restore

. 
. * Aplicar o agrupamento via merge (sem 'nogen' para capturar _merge)
. merge m:1 CNAE using `freqmap', keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             1,343  (_merge==3)
    -----------------------------------------

. 
. * Substituir CNAE por CNAE_agrupado apenas onde houver correspondência
. replace CNAE = CNAE_agrupado if _merge == 3
(302 real changes made)

. drop _merge CNAE_agrupado _freq

. 
. * Verifica distribuição após o agrupamento
. tabulate CNAE

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |        305       22.71       22.71
          6 |         10        0.74       23.45
         10 |         12        0.89       24.35
         12 |         35        2.61       26.95
         16 |         99        7.37       34.33
         21 |         20        1.49       35.82
         22 |         18        1.34       37.16
         23 |         12        0.89       38.05
         24 |         16        1.19       39.24
         33 |         17        1.27       40.51
         36 |         28        2.08       42.59
         38 |         54        4.02       46.61
         39 |         39        2.90       49.52
         49 |         16        1.19       50.71
         51 |         60        4.47       55.17
         54 |         11        0.82       55.99
         63 |         12        0.89       56.89
         68 |         43        3.20       60.09
         69 |         15        1.12       61.21
         70 |         35        2.61       63.81
         71 |         58        4.32       68.13
         72 |        132        9.83       77.96
         77 |         18        1.34       79.30
         78 |         11        0.82       80.12
         80 |         32        2.38       82.50
         86 |         22        1.64       84.14
         91 |         44        3.28       87.42
         92 |         23        1.71       89.13
         93 |         29        2.16       91.29
         94 |         19        1.41       92.70
         97 |         16        1.19       93.89
         98 |         29        2.16       96.05
         99 |         24        1.79       97.84
        100 |         12        0.89       98.73
        104 |         17        1.27      100.00
------------+-----------------------------------
      Total |      1,343      100.00

. di as text "✅ Agrupamento de CNAEs raros concluído com base na frequência mínima de `freq_minima'."
✅ Agrupamento de CNAEs raros concluído com base na frequência mínima de 10.

. 
. 
. /*******************************************************************************
> ETAPA 5.2 – CONVERTER VARIÁVEIS CATEGÓRICAS PARA INTEIROS E GERAR DUMMIES (após SMOTENC)
> *******************************************************************************/
. * Arredondar valores para garantir categorias inteiras
. * Isso pode ser necessário se o Python/SMOTE as transformou em float, mas idealmente não deveria.
. * Adicione verificações para evitar erros se a variável não existir (embora agora deva existir)
. 
. capture confirm variable Porte

. if _rc == 0 {
.     replace Porte = round(Porte)
(0 real changes made)
. } 

. else {
.     di as error "Variável Porte ainda não encontrada antes do round!"
. }

. 
. capture confirm variable CNAE

. if _rc == 0 {
.     replace CNAE = round(CNAE)
(0 real changes made)
. } 

. else {
.     di as error "Variável CNAE não encontrada antes do round!"
. }

. 
. capture confirm variable NaturezaJuridica

. if _rc == 0 {
.     replace NaturezaJuridica = round(NaturezaJuridica)
(0 real changes made)
. } 

. else {
.     di as error "Variável NaturezaJuridica não encontrada antes do round!"
. }

. 
. 
. capture confirm variable DivisaoCNAE

. if _rc == 0 {
.     replace DivisaoCNAE = round(DivisaoCNAE)
(0 real changes made)
. } 

. else {
.     di as error "Variável DivisaoCNAE não encontrada antes do round!"
. }

. 
. * Gerar variáveis dummies
. * Adicione verificações aqui também
. capture confirm variable Porte

. if _rc == 0 {
.     tabulate Porte, generate(Porte_)

      Porte |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        171       12.73       12.73
          1 |        204       15.19       27.92
          2 |        138       10.28       38.20
          3 |        830       61.80      100.00
------------+-----------------------------------
      Total |      1,343      100.00
.     drop Porte // Dropar original apenas se as dummies foram criadas
. } 

. else {
.      di as error "Não foi possível gerar dummies para Porte."
. }

. 
. capture confirm variable CNAE

. if _rc == 0 {
.     tabulate CNAE, generate(CNAE_)

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |        305       22.71       22.71
          6 |         10        0.74       23.45
         10 |         12        0.89       24.35
         12 |         35        2.61       26.95
         16 |         99        7.37       34.33
         21 |         20        1.49       35.82
         22 |         18        1.34       37.16
         23 |         12        0.89       38.05
         24 |         16        1.19       39.24
         33 |         17        1.27       40.51
         36 |         28        2.08       42.59
         38 |         54        4.02       46.61
         39 |         39        2.90       49.52
         49 |         16        1.19       50.71
         51 |         60        4.47       55.17
         54 |         11        0.82       55.99
         63 |         12        0.89       56.89
         68 |         43        3.20       60.09
         69 |         15        1.12       61.21
         70 |         35        2.61       63.81
         71 |         58        4.32       68.13
         72 |        132        9.83       77.96
         77 |         18        1.34       79.30
         78 |         11        0.82       80.12
         80 |         32        2.38       82.50
         86 |         22        1.64       84.14
         91 |         44        3.28       87.42
         92 |         23        1.71       89.13
         93 |         29        2.16       91.29
         94 |         19        1.41       92.70
         97 |         16        1.19       93.89
         98 |         29        2.16       96.05
         99 |         24        1.79       97.84
        100 |         12        0.89       98.73
        104 |         17        1.27      100.00
------------+-----------------------------------
      Total |      1,343      100.00
.     drop CNAE
. } 

. else {
.      di as error "Não foi possível gerar dummies para CNAE."
. }

. 
. capture confirm variable DivisaoCNAE

. if _rc == 0 {
.     tabulate DivisaoCNAE, generate(DivisaoCNAE_)

DivisaoCNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |          1        0.07        0.07
          1 |          4        0.30        0.37
          2 |          3        0.22        0.60
          3 |          6        0.45        1.04
          4 |         15        1.12        2.16
          5 |          8        0.60        2.76
          6 |         12        0.89        3.65
          7 |          3        0.22        3.87
          8 |         38        2.83        6.70
          9 |          5        0.37        7.07
         10 |         98        7.30       14.37
         11 |         23        1.71       16.08
         12 |         79        5.88       21.97
         13 |          6        0.45       22.41
         14 |        176       13.10       35.52
         15 |        131        9.75       45.27
         16 |          2        0.15       45.42
         17 |          1        0.07       45.50
         18 |          8        0.60       46.09
         19 |          2        0.15       46.24
         20 |         29        2.16       48.40
         21 |        281       20.92       69.32
         22 |          6        0.45       69.77
         23 |         24        1.79       71.56
         24 |         11        0.82       72.38
         25 |         35        2.61       74.98
         26 |          6        0.45       75.43
         27 |         20        1.49       76.92
         28 |         29        2.16       79.08
         29 |         54        4.02       83.10
         30 |         23        1.71       84.81
         31 |         30        2.23       87.04
         32 |         30        2.23       89.28
         33 |         81        6.03       95.31
         34 |         35        2.61       97.92
         35 |          8        0.60       98.51
         36 |          6        0.45       98.96
         37 |          2        0.15       99.11
         38 |          2        0.15       99.26
         39 |          8        0.60       99.85
         40 |          2        0.15      100.00
------------+-----------------------------------
      Total |      1,343      100.00
.     drop DivisaoCNAE
. } 

. else {
.      di as error "Não foi possível gerar dummies para Divisão do CNAE."
. }

. 
. capture confirm variable NaturezaJuridica

. if _rc == 0 {
.     tabulate NaturezaJuridica, generate(NaturezaJuridica_)

NaturezaJur |
      idica |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |          1        0.07        0.07
          0 |          5        0.37        0.45
          1 |         16        1.19        1.64
          2 |        107        7.97        9.61
          3 |      1,159       86.30       95.90
          4 |         25        1.86       97.77
          5 |          2        0.15       97.92
          6 |          2        0.15       98.06
          7 |          7        0.52       98.59
          8 |         19        1.41      100.00
------------+-----------------------------------
      Total |      1,343      100.00
.     drop NaturezaJuridica
. } 

. else {
.      di as error "Não foi possível gerar dummies para NaturezaJuridica."
. }

. 
. 
. /*******************************************************************************
> ETAPA 6 - O CONJUNTO DE TESTE PERMANECE SEPARADO 
> *******************************************************************************/
. * O conjunto de teste ainda está salvo em "test_data.csv"
. * Ele será importado separadamente no final da análise.
. 
. /******************************************************************************
> Fornecer descrição básica da estrutura do conjunto de dados
> *******************************************************************************/
. describe

Contains data
 Observations:         1,343                  
    Variables:           141                  
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
LiqCorrente     float   %9.0g                 
LiqGeral        float   %9.0g                 
LiqCorAjust     float   %9.0g                 
SolvGeral       float   %9.0g                 
EndGeral        float   %9.0g                 
CompEndivid     float   %9.0g                 
IndepFin        float   %9.0g                 
ImobilPL        float   %9.0g                 
ImobRecNC       float   %9.0g                 
PtpCapTerce     float   %9.0g                 
GiroAtivo       float   %9.0g                 
MargOp          float   %9.0g                 
MargLiq         float   %9.0g                 
ROI             float   %9.0g                 
ROE             float   %9.0g                 
AC              double  %10.0g                
ANRP            double  %10.0g                
Investimentos   double  %10.0g                
Imobilizado     double  %10.0g                
Intangivel      double  %10.0g                
PC              double  %10.0g                
PNC             double  %10.0g                
PL              double  %10.0g                
RecBruta        double  %10.0g                
LucroBruto      double  %10.0g                
LucroLiquido    double  %10.0g                
QtePenalOutro~s int     %8.0g                 
vlrcontrato     float   %9.0g                 
IdadedeAnos     float   %9.0g                 
QtdeCNAEsSecu~s byte    %8.0g                 
AnodasDemonst~s int     %8.0g                 
cnpjs           byte    %8.0g                 
log_vlrcontrato float   %9.0g                 
z_LiqCorrente   float   %9.0g                 
z_LiqGeral      float   %9.0g                 
z_SolvGeral     float   %9.0g                 
z_IndepFin      float   %9.0g                 
Liquidez_Medi~Z float   %9.0g                 
z_ImobilPL      float   %9.0g                 
z_PtpCapTerce   float   %9.0g                 
z_EndGeral      float   %9.0g                 
Estrutura_Med~Z float   %9.0g                 
z_MargOp        float   %9.0g                 
z_MargLiq       float   %9.0g                 
Margem_Media_Z  float   %9.0g                 
u               float   %9.0g                 
obs_no          int     %8.0g                 
total_obs       int     %8.0g                 
cutoff          int     %8.0g                 
FoiPenalizado~J byte    %8.0g                 
train           byte    %8.0g                 
Porte_1         byte    %8.0g                 Porte== 0.0000
Porte_2         byte    %8.0g                 Porte== 1.0000
Porte_3         byte    %8.0g                 Porte== 2.0000
Porte_4         byte    %8.0g                 Porte== 3.0000
CNAE_1          byte    %8.0g                 CNAE== -1.0000
CNAE_2          byte    %8.0g                 CNAE== 6.0000
CNAE_3          byte    %8.0g                 CNAE== 10.0000
CNAE_4          byte    %8.0g                 CNAE== 12.0000
CNAE_5          byte    %8.0g                 CNAE== 16.0000
CNAE_6          byte    %8.0g                 CNAE== 21.0000
CNAE_7          byte    %8.0g                 CNAE== 22.0000
CNAE_8          byte    %8.0g                 CNAE== 23.0000
CNAE_9          byte    %8.0g                 CNAE== 24.0000
CNAE_10         byte    %8.0g                 CNAE== 33.0000
CNAE_11         byte    %8.0g                 CNAE== 36.0000
CNAE_12         byte    %8.0g                 CNAE== 38.0000
CNAE_13         byte    %8.0g                 CNAE== 39.0000
CNAE_14         byte    %8.0g                 CNAE== 49.0000
CNAE_15         byte    %8.0g                 CNAE== 51.0000
CNAE_16         byte    %8.0g                 CNAE== 54.0000
CNAE_17         byte    %8.0g                 CNAE== 63.0000
CNAE_18         byte    %8.0g                 CNAE== 68.0000
CNAE_19         byte    %8.0g                 CNAE== 69.0000
CNAE_20         byte    %8.0g                 CNAE== 70.0000
CNAE_21         byte    %8.0g                 CNAE== 71.0000
CNAE_22         byte    %8.0g                 CNAE== 72.0000
CNAE_23         byte    %8.0g                 CNAE== 77.0000
CNAE_24         byte    %8.0g                 CNAE== 78.0000
CNAE_25         byte    %8.0g                 CNAE== 80.0000
CNAE_26         byte    %8.0g                 CNAE== 86.0000
CNAE_27         byte    %8.0g                 CNAE== 91.0000
CNAE_28         byte    %8.0g                 CNAE== 92.0000
CNAE_29         byte    %8.0g                 CNAE== 93.0000
CNAE_30         byte    %8.0g                 CNAE== 94.0000
CNAE_31         byte    %8.0g                 CNAE== 97.0000
CNAE_32         byte    %8.0g                 CNAE== 98.0000
CNAE_33         byte    %8.0g                 CNAE== 99.0000
CNAE_34         byte    %8.0g                 CNAE== 100.0000
CNAE_35         byte    %8.0g                 CNAE== 104.0000
DivisaoCNAE_1   byte    %8.0g                 DivisaoCNAE== 0.0000
DivisaoCNAE_2   byte    %8.0g                 DivisaoCNAE== 1.0000
DivisaoCNAE_3   byte    %8.0g                 DivisaoCNAE== 2.0000
DivisaoCNAE_4   byte    %8.0g                 DivisaoCNAE== 3.0000
DivisaoCNAE_5   byte    %8.0g                 DivisaoCNAE== 4.0000
DivisaoCNAE_6   byte    %8.0g                 DivisaoCNAE== 5.0000
DivisaoCNAE_7   byte    %8.0g                 DivisaoCNAE== 6.0000
DivisaoCNAE_8   byte    %8.0g                 DivisaoCNAE== 7.0000
DivisaoCNAE_9   byte    %8.0g                 DivisaoCNAE== 8.0000
DivisaoCNAE_10  byte    %8.0g                 DivisaoCNAE== 9.0000
DivisaoCNAE_11  byte    %8.0g                 DivisaoCNAE== 10.0000
DivisaoCNAE_12  byte    %8.0g                 DivisaoCNAE== 11.0000
DivisaoCNAE_13  byte    %8.0g                 DivisaoCNAE== 12.0000
DivisaoCNAE_14  byte    %8.0g                 DivisaoCNAE== 13.0000
DivisaoCNAE_15  byte    %8.0g                 DivisaoCNAE== 14.0000
DivisaoCNAE_16  byte    %8.0g                 DivisaoCNAE== 15.0000
DivisaoCNAE_17  byte    %8.0g                 DivisaoCNAE== 16.0000
DivisaoCNAE_18  byte    %8.0g                 DivisaoCNAE== 17.0000
DivisaoCNAE_19  byte    %8.0g                 DivisaoCNAE== 18.0000
DivisaoCNAE_20  byte    %8.0g                 DivisaoCNAE== 19.0000
DivisaoCNAE_21  byte    %8.0g                 DivisaoCNAE== 20.0000
DivisaoCNAE_22  byte    %8.0g                 DivisaoCNAE== 21.0000
DivisaoCNAE_23  byte    %8.0g                 DivisaoCNAE== 22.0000
DivisaoCNAE_24  byte    %8.0g                 DivisaoCNAE== 23.0000
DivisaoCNAE_25  byte    %8.0g                 DivisaoCNAE== 24.0000
DivisaoCNAE_26  byte    %8.0g                 DivisaoCNAE== 25.0000
DivisaoCNAE_27  byte    %8.0g                 DivisaoCNAE== 26.0000
DivisaoCNAE_28  byte    %8.0g                 DivisaoCNAE== 27.0000
DivisaoCNAE_29  byte    %8.0g                 DivisaoCNAE== 28.0000
DivisaoCNAE_30  byte    %8.0g                 DivisaoCNAE== 29.0000
DivisaoCNAE_31  byte    %8.0g                 DivisaoCNAE== 30.0000
DivisaoCNAE_32  byte    %8.0g                 DivisaoCNAE== 31.0000
DivisaoCNAE_33  byte    %8.0g                 DivisaoCNAE== 32.0000
DivisaoCNAE_34  byte    %8.0g                 DivisaoCNAE== 33.0000
DivisaoCNAE_35  byte    %8.0g                 DivisaoCNAE== 34.0000
DivisaoCNAE_36  byte    %8.0g                 DivisaoCNAE== 35.0000
DivisaoCNAE_37  byte    %8.0g                 DivisaoCNAE== 36.0000
DivisaoCNAE_38  byte    %8.0g                 DivisaoCNAE== 37.0000
DivisaoCNAE_39  byte    %8.0g                 DivisaoCNAE== 38.0000
DivisaoCNAE_40  byte    %8.0g                 DivisaoCNAE== 39.0000
DivisaoCNAE_41  byte    %8.0g                 DivisaoCNAE== 40.0000
NaturezaJurid~1 byte    %8.0g                 NaturezaJuridica== -1.0000
NaturezaJurid~2 byte    %8.0g                 NaturezaJuridica== 0.0000
NaturezaJurid~3 byte    %8.0g                 NaturezaJuridica== 1.0000
NaturezaJurid~4 byte    %8.0g                 NaturezaJuridica== 2.0000
NaturezaJurid~5 byte    %8.0g                 NaturezaJuridica== 3.0000
NaturezaJurid~6 byte    %8.0g                 NaturezaJuridica== 4.0000
NaturezaJurid~7 byte    %8.0g                 NaturezaJuridica== 5.0000
NaturezaJurid~8 byte    %8.0g                 NaturezaJuridica== 6.0000
NaturezaJurid~9 byte    %8.0g                 NaturezaJuridica== 7.0000
NaturezaJuri~10 byte    %8.0g                 NaturezaJuridica== 8.0000
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. /*******************************************************************************
> ETAPA 6 - ANÁLISE LOGIT
> 
> A variável dependente é 'FoiPenalizadoSTJ', do tipo binária.
> Ela indica se o fornecedor foi penalizado pelo STJ (1) ou não (0).
> 
> As variáveis independentes serão divididas em variáveis contábeis e variáveis de controle.
> 
> *******************************************************************************/
. * 6.1 Listar todas as variáveis disponíveis
. ds
LiqCorrente   MargLiq       LucroBruto    z_IndepFin    cutoff        CNAE_6        CNAE_18       CNAE_30       DivisaoCN~_7  DivisaoCN~19  DivisaoCN~31  NaturezaJu~2
LiqGeral      ROI           LucroLiquido  Liquidez_M~Z  FoiPenaliz~J  CNAE_7        CNAE_19       CNAE_31       DivisaoCN~_8  DivisaoCN~20  DivisaoCN~32  NaturezaJu~3
LiqCorAjust   ROE           QtePenalOu~s  z_ImobilPL    train         CNAE_8        CNAE_20       CNAE_32       DivisaoCN~_9  DivisaoCN~21  DivisaoCN~33  NaturezaJu~4
SolvGeral     AC            vlrcontrato   z_PtpCapTe~e  Porte_1       CNAE_9        CNAE_21       CNAE_33       DivisaoCN~10  DivisaoCN~22  DivisaoCN~34  NaturezaJu~5
EndGeral      ANRP          IdadedeAnos   z_EndGeral    Porte_2       CNAE_10       CNAE_22       CNAE_34       DivisaoCN~11  DivisaoCN~23  DivisaoCN~35  NaturezaJu~6
CompEndivid   Investimen~s  QtdeCNAEsS~s  Estrutura_~Z  Porte_3       CNAE_11       CNAE_23       CNAE_35       DivisaoCN~12  DivisaoCN~24  DivisaoCN~36  NaturezaJu~7
IndepFin      Imobilizado   AnodasDemo~s  z_MargOp      Porte_4       CNAE_12       CNAE_24       DivisaoCN~_1  DivisaoCN~13  DivisaoCN~25  DivisaoCN~37  NaturezaJu~8
ImobilPL      Intangivel    cnpjs         z_MargLiq     CNAE_1        CNAE_13       CNAE_25       DivisaoCN~_2  DivisaoCN~14  DivisaoCN~26  DivisaoCN~38  NaturezaJu~9
ImobRecNC     PC            log_vlrcon~o  Margem_Med~Z  CNAE_2        CNAE_14       CNAE_26       DivisaoCN~_3  DivisaoCN~15  DivisaoCN~27  DivisaoCN~39  NaturezaJ~10
PtpCapTerce   PNC           z_LiqCorre~e  u             CNAE_3        CNAE_15       CNAE_27       DivisaoCN~_4  DivisaoCN~16  DivisaoCN~28  DivisaoCN~40
GiroAtivo     PL            z_LiqGeral    obs_no        CNAE_4        CNAE_16       CNAE_28       DivisaoCN~_5  DivisaoCN~17  DivisaoCN~29  DivisaoCN~41
MargOp        RecBruta      z_SolvGeral   total_obs     CNAE_5        CNAE_17       CNAE_29       DivisaoCN~_6  DivisaoCN~18  DivisaoCN~30  NaturezaJu~1

. 
. * Capturar todas as variáveis que começam com "Porte_"
. unab Porte_vars : Porte_*

. 
. * Capturar todas as variáveis que começam com "CNAE_"
. unab CNAE_vars : CNAE_*

. 
. * Capturar todas as variáveis que começam com "NaturezaJuridica_"
. unab Natureza_vars : NaturezaJuridica_*

. 
. * Definir variáveis contábeis e de controle corretamente
. *ANTES DA COMBINAÇÃO DE VARIÁVEISlocal var_contabeis `Porte_vars' LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce 
> GiroAtivo MargOp MargLiq ROI ROE
. local var_contabeis `Porte_vars' Liquidez_Media_Z Estrutura_Media_Z Margem_Media_Z ROI ROE CompEndivid ImobRecNC GiroAtivo

. 
. local var_controle `CNAE_vars' `Natureza_vars' log_vlrcon~o  QtdeCNAEsS~s IdadedeAnos QtePenalOu~s

. 
. 
. * Executar a regressão logística
. logit FoiPenalizadoSTJ `var_contabeis' `var_controle' if train == 1

note: CNAE_2 != 0 predicts failure perfectly;
      CNAE_2 omitted and 9 obs not used.

note: CNAE_3 != 0 predicts success perfectly;
      CNAE_3 omitted and 11 obs not used.

note: CNAE_9 != 0 predicts success perfectly;
      CNAE_9 omitted and 16 obs not used.

note: CNAE_10 != 0 predicts success perfectly;
      CNAE_10 omitted and 17 obs not used.

note: CNAE_11 != 0 predicts success perfectly;
      CNAE_11 omitted and 24 obs not used.

note: CNAE_14 != 0 predicts success perfectly;
      CNAE_14 omitted and 14 obs not used.

note: CNAE_19 != 0 predicts failure perfectly;
      CNAE_19 omitted and 10 obs not used.

note: CNAE_21 != 0 predicts failure perfectly;
      CNAE_21 omitted and 51 obs not used.

note: CNAE_23 != 0 predicts success perfectly;
      CNAE_23 omitted and 18 obs not used.

note: CNAE_24 != 0 predicts failure perfectly;
      CNAE_24 omitted and 9 obs not used.

note: CNAE_28 != 0 predicts failure perfectly;
      CNAE_28 omitted and 16 obs not used.

note: CNAE_31 != 0 predicts failure perfectly;
      CNAE_31 omitted and 12 obs not used.

note: CNAE_33 != 0 predicts failure perfectly;
      CNAE_33 omitted and 19 obs not used.

note: CNAE_34 != 0 predicts failure perfectly;
      CNAE_34 omitted and 6 obs not used.

note: CNAE_35 != 0 predicts success perfectly;
      CNAE_35 omitted and 16 obs not used.

note: NaturezaJuridica_7 != 0 predicts failure perfectly;
      NaturezaJuridica_7 omitted and 2 obs not used.

note: NaturezaJuridica_8 != 0 predicts failure perfectly;
      NaturezaJuridica_8 omitted and 2 obs not used.

note: NaturezaJuridica_10 != 0 predicts failure perfectly;
      NaturezaJuridica_10 omitted and 16 obs not used.

note: Porte_4 omitted because of collinearity.
note: CNAE_32 omitted because of collinearity.
note: NaturezaJuridica_1 omitted because of collinearity.
note: NaturezaJuridica_2 omitted because of collinearity.
note: NaturezaJuridica_9 omitted because of collinearity.
Iteration 0:  Log likelihood = -600.90499  
Iteration 1:  Log likelihood =  -500.1336  
Iteration 2:  Log likelihood = -498.22887  
Iteration 3:  Log likelihood = -498.15129  
Iteration 4:  Log likelihood = -498.14514  
Iteration 5:  Log likelihood = -498.14459  
Iteration 6:  Log likelihood = -498.14448  
Iteration 7:  Log likelihood = -498.14447  

Logistic regression                                     Number of obs =    868
                                                        LR chi2(38)   = 205.52
                                                        Prob > chi2   = 0.0000
Log likelihood = -498.14447                             Pseudo R2     = 0.1710

--------------------------------------------------------------------------------------
    FoiPenalizadoSTJ | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
---------------------+----------------------------------------------------------------
             Porte_1 |  -.3012827   .2939414    -1.02   0.305    -.8773972    .2748318
             Porte_2 |    .220133   .2565687     0.86   0.391    -.2827323    .7229983
             Porte_3 |  -.0715171    .309698    -0.23   0.817     -.678514    .5354797
             Porte_4 |          0  (omitted)
    Liquidez_Media_Z |  -.1076086   .1013934    -1.06   0.289    -.3063361    .0911188
   Estrutura_Media_Z |   -.022327   .0413308    -0.54   0.589     -.103334    .0586799
      Margem_Media_Z |  -.1893807   .1289006    -1.47   0.142    -.4420211    .0632598
                 ROI |  -.9953282   .5330054    -1.87   0.062        -2.04    .0493432
                 ROE |    .340614   .2187105     1.56   0.119    -.0880507    .7692787
         CompEndivid |  -.3706149    .352032    -1.05   0.292    -1.060585    .3193551
           ImobRecNC |  -1.066102   .3891875    -2.74   0.006    -1.828895   -.3033083
           GiroAtivo |   .0422984   .0848628     0.50   0.618    -.1240296    .2086264
              CNAE_1 |   -.524512   .4903845    -1.07   0.285    -1.485648     .436624
              CNAE_2 |          0  (omitted)
              CNAE_3 |          0  (omitted)
              CNAE_4 |   3.645738   1.121107     3.25   0.001     1.448408    5.843069
              CNAE_5 |   .2603919   .5254224     0.50   0.620    -.7694172    1.290201
              CNAE_6 |  -.7806344   .7351897    -1.06   0.288     -2.22158    .6603109
              CNAE_7 |    .828742   .7007569     1.18   0.237    -.5447163      2.2022
              CNAE_8 |  -.3735915   .7768209    -0.48   0.631    -1.896133     1.14895
              CNAE_9 |          0  (omitted)
             CNAE_10 |          0  (omitted)
             CNAE_11 |          0  (omitted)
             CNAE_12 |  -.3325238   .5507202    -0.60   0.546    -1.411916     .746868
             CNAE_13 |   .1186628   .5913878     0.20   0.841    -1.040436    1.277762
             CNAE_14 |          0  (omitted)
             CNAE_15 |  -.3590109   .5490193    -0.65   0.513    -1.435069    .7170472
             CNAE_16 |  -.5588896   1.066936    -0.52   0.600    -2.650045    1.532266
             CNAE_17 |   9.816027   460.9967     0.02   0.983     -893.721     913.353
             CNAE_18 |  -.5103356    .579816    -0.88   0.379    -1.646754     .626083
             CNAE_19 |          0  (omitted)
             CNAE_20 |  -.2740305      .5956    -0.46   0.645    -1.441385     .893324
             CNAE_21 |          0  (omitted)
             CNAE_22 |    .952464   .5012424     1.90   0.057    -.0299531    1.934881
             CNAE_23 |          0  (omitted)
             CNAE_24 |          0  (omitted)
             CNAE_25 |  -.4762696   .6356462    -0.75   0.454    -1.722113     .769574
             CNAE_26 |   .8100758   .6909359     1.17   0.241    -.5441336    2.164285
             CNAE_27 |   1.191096   .6270846     1.90   0.058    -.0379673    2.420159
             CNAE_28 |          0  (omitted)
             CNAE_29 |   .0717208   .6304247     0.11   0.909    -1.163889     1.30733
             CNAE_30 |   .8583271   .8274291     1.04   0.300    -.7634042    2.480058
             CNAE_31 |          0  (omitted)
             CNAE_32 |          0  (omitted)
             CNAE_33 |          0  (omitted)
             CNAE_34 |          0  (omitted)
             CNAE_35 |          0  (omitted)
  NaturezaJuridica_1 |          0  (omitted)
  NaturezaJuridica_2 |          0  (omitted)
  NaturezaJuridica_3 |     -9.769   460.9972    -0.02   0.983    -913.3069    893.7689
  NaturezaJuridica_4 |   -2.14558   1.262468    -1.70   0.089    -4.619972    .3288126
  NaturezaJuridica_5 |    -.22952   1.217484    -0.19   0.850    -2.615746    2.156706
  NaturezaJuridica_6 |  -2.077765    1.43948    -1.44   0.149    -4.899094    .7435635
  NaturezaJuridica_7 |          0  (omitted)
  NaturezaJuridica_8 |          0  (omitted)
  NaturezaJuridica_9 |          0  (omitted)
 NaturezaJuridica_10 |          0  (omitted)
     log_vlrcontrato |   .0585038   .0142978     4.09   0.000     .0304807    .0865269
QtdeCNAEsSecundarios |  -.0126476   .0066843    -1.89   0.058    -.0257486    .0004534
         IdadedeAnos |   -.038114   .0098772    -3.86   0.000    -.0574729   -.0187551
QtePenalOutrosOrgaos |   .0178569   .0040673     4.39   0.000      .009885    .0258287
               _cons |   1.212244   1.410875     0.86   0.390    -1.553021    3.977508
--------------------------------------------------------------------------------------

. 
. * Armazenar os resultados do modelo completo
. estimates store IRDCcompleto

. 
. /*******************************************************************************
> Justificativa das Variáveis de Controle:
> 
> - **CNAE (Classificação Nacional de Atividades Econômicas)**: Diferentes setores econômicos possuem níveis distintos de regulação e riscos operacionais. Incluir o CNAE pe
> rmite controlar os efeitos específicos de cada setor na probabilidade de penalização.
> 
> - **Natureza Jurídica**: Empresas com diferentes naturezas jurídicas têm estruturas legais e de governança distintas, o que pode influenciar a conformidade regulatória e 
> o risco de penalidades.
> 
> - **log_vlrcontrato (Log do Valor do Contrato)**: Contratos de maior valor podem estar sujeitos a maior escrutínio e complexidade, aumentando o risco de penalidades. O lo
> garitmo é usado para linearizar a relação.
> 
> - **QtdeCNAEsSecundarios (Quantidade de CNAEs Secundários)**: Indica o nível de diversificação das atividades da empresa. Empresas mais diversificadas podem ter estrutura
> s mais complexas, afetando a gestão e a conformidade regulatória.
> 
> - **IdadedeAnos (Idade da Empresa em Anos)**: Empresas mais antigas podem ter processos mais estabelecidos e experiência acumulada, afetando positivamente a conformidade 
> com normas e regulamentos.
> 
> - **QtePenalOutrosOrgaos (Quantidade de Penalidades Aplicadas por Outros Órgãos)**: Um histórico de penalidades pode indicar padrões de não conformidade, aumentando a pro
> babilidade de novas penalizações.
> 
> Essas variáveis de controle são importantes para isolar o efeito das variáveis contábeis principais, garantindo que os resultados do modelo reflitam o impacto dos indicad
> ores contábeis na probabilidade de penalização, independentemente de outros fatores externos.
> 
> *******************************************************************************/
. 
. /*******************************************************************************
> 6.2 Regressão logística com seleção stepwise a 10% de significância no conjunto de treinamento
> *******************************************************************************/
. * Capturar todas as variáveis que começam com "Porte_"
. unab Porte_vars : Porte_*

. 
. * Capturar todas as variáveis que começam com "CNAE_"
. unab CNAE_vars : CNAE_*

. 
. * Capturar todas as variáveis que começam com "NaturezaJuridica_"
. unab Natureza_vars : NaturezaJuridica_*

. 
. * Definir variáveis contábeis e de controle corretamente
. local var_contabeis `Porte_vars' Liquidez_Media_Z Estrutura_Media_Z Margem_Media_Z ROI ROE CompEndivid ImobRecNC GiroAtivo

. local var_controle `CNAE_vars' `Natureza_vars' log_vlrcon~o  QtdeCNAEsS~s IdadedeAnos QtePenalOu~s

. 
. *Regressão logística com seleção stepwise a 10% 
. sw, pr(.10): logit FoiPenalizadoSTJ `var_contabeis' `var_controle' if train == 1
note: Porte_4 omitted because of estimability.
note: CNAE_2 omitted because of estimability.
note: CNAE_3 omitted because of estimability.
note: CNAE_9 omitted because of estimability.
note: CNAE_10 omitted because of estimability.
note: CNAE_11 omitted because of estimability.
note: CNAE_14 omitted because of estimability.
note: CNAE_19 omitted because of estimability.
note: CNAE_21 omitted because of estimability.
note: CNAE_23 omitted because of estimability.
note: CNAE_24 omitted because of estimability.
note: CNAE_28 omitted because of estimability.
note: CNAE_31 omitted because of estimability.
note: CNAE_32 omitted because of estimability.
note: CNAE_33 omitted because of estimability.
note: CNAE_34 omitted because of estimability.
note: CNAE_35 omitted because of estimability.
note: o.NaturezaJuridica_1 omitted because of estimability.
note: NaturezaJuridica_2 omitted because of estimability.
note: NaturezaJuridica_7 omitted because of estimability.
note: NaturezaJuridica_8 omitted because of estimability.
note: NaturezaJuridica_9 omitted because of estimability.
note: NaturezaJuridica_10 omitted because of estimability.
note: 268 obs omitted because of estimability.

Wald test, begin with full model:
p = 0.9831 >= 0.1000, removing NaturezaJuridica_3
p = 0.9239 >= 0.1000, removing CNAE_17
p = 0.9259 >= 0.1000, removing CNAE_29
p = 0.8764 >= 0.1000, removing CNAE_13
p = 0.8091 >= 0.1000, removing NaturezaJuridica_5
p = 0.8137 >= 0.1000, removing Porte_3
p = 0.6521 >= 0.1000, removing CNAE_5
p = 0.6318 >= 0.1000, removing GiroAtivo
p = 0.6006 >= 0.1000, removing Estrutura_Media_Z
p = 0.4215 >= 0.1000, removing CNAE_16
p = 0.3704 >= 0.1000, removing CNAE_8
p = 0.3868 >= 0.1000, removing CNAE_20
p = 0.3015 >= 0.1000, removing Porte_2
p = 0.3222 >= 0.1000, removing CNAE_12
p = 0.2962 >= 0.1000, removing CNAE_15
p = 0.3195 >= 0.1000, removing CNAE_18
p = 0.3448 >= 0.1000, removing CNAE_25
p = 0.2868 >= 0.1000, removing CNAE_6
p = 0.2845 >= 0.1000, removing Liquidez_Media_Z
p = 0.1611 >= 0.1000, removing CompEndivid
p = 0.1733 >= 0.1000, removing QtdeCNAEsSecundarios
p = 0.1580 >= 0.1000, removing CNAE_30
p = 0.1168 >= 0.1000, removing ROE
p = 0.3225 >= 0.1000, removing ROI

Logistic regression                                     Number of obs =    868
                                                        LR chi2(14)   = 185.15
                                                        Prob > chi2   = 0.0000
Log likelihood = -508.32852                             Pseudo R2     = 0.1541

--------------------------------------------------------------------------------------
    FoiPenalizadoSTJ | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
---------------------+----------------------------------------------------------------
             Porte_1 |  -.4372418    .264192    -1.66   0.098    -.9550486     .080565
         IdadedeAnos |  -.0298188   .0087646    -3.40   0.001    -.0469971   -.0126405
  NaturezaJuridica_6 |   -2.03641   .7667043    -2.66   0.008    -3.539123   -.5336975
             CNAE_26 |   .9943831   .5120296     1.94   0.052    -.0091765    1.997943
             CNAE_27 |   1.231955   .4362901     2.82   0.005     .3768423    2.087068
      Margem_Media_Z |  -.3575344   .1004489    -3.56   0.000    -.5544105   -.1606582
             CNAE_22 |   1.061959    .246144     4.31   0.000     .5795258    1.544393
              CNAE_7 |   .9406552   .5465329     1.72   0.085    -.1305296     2.01184
     log_vlrcontrato |   .0660146   .0130937     5.04   0.000     .0403514    .0916778
           ImobRecNC |  -.9121573   .3474655    -2.63   0.009    -1.593177   -.2311374
QtePenalOutrosOrgaos |   .0176376   .0038263     4.61   0.000     .0101383     .025137
              CNAE_1 |  -.4359783   .1909645    -2.28   0.022    -.8102618   -.0616947
              CNAE_4 |   3.795361    1.03524     3.67   0.000     1.766327    5.824395
  NaturezaJuridica_4 |  -1.853727    .319831    -5.80   0.000    -2.480585    -1.22687
               _cons |   .1258534   .2379139     0.53   0.597    -.3404493    .5921561
--------------------------------------------------------------------------------------

. 
. * Armazenar os resultados do modelo stepwise a 10%
. estimates store IRDC10

. 
. * Teste de bondade de ajuste de Hosmer-Lemeshow para o modelo stepwise a 10%
. estat gof if train == 1, group(10) table
note: obs collapsed on 10 quantiles of estimated probabilities.

Goodness-of-fit test after logistic model
Variable: FoiPenalizadoSTJ

  Table collapsed on quantiles of estimated probabilities
  +--------------------------------------------------------+
  | Group |   Prob | Obs_1 | Exp_1 | Obs_0 | Exp_0 | Total |
  |-------+--------+-------+-------+-------+-------+-------|
  |     1 | 0.2015 |    15 |  15.2 |    99 |  98.8 |   114 |
  |     2 | 0.3291 |    22 |  30.6 |    92 |  83.4 |   114 |
  |     3 | 0.4291 |    40 |  43.7 |    73 |  69.3 |   113 |
  |     4 | 0.4835 |    51 |  52.2 |    63 |  61.8 |   114 |
  |     5 | 0.5421 |    46 |  58.1 |    67 |  54.9 |   113 |
  |-------+--------+-------+-------+-------+-------+-------|
  |     6 | 0.5815 |    74 |  64.1 |    40 |  49.9 |   114 |
  |     7 | 0.6299 |    69 |  69.2 |    45 |  44.8 |   114 |
  |     8 | 0.6801 |    76 |  73.8 |    37 |  39.2 |   113 |
  |     9 | 0.7616 |    88 |  81.3 |    26 |  32.7 |   114 |
  |    10 | 0.9886 |    87 |  97.9 |    26 |  15.1 |   113 |
  +--------------------------------------------------------+

 Number of observations =  1,136
       Number of groups =     10
Hosmer–Lemeshow chi2(8) =  23.78
            Prob > chi2 = 0.0025

. 
. /*******************************************************************************
> 6.2.2 Tabela de classificação para o modelo stepwise a 10% na base de treinamento
> *******************************************************************************/
. estat class if train == 1

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |       432           219  |        651
     -     |       136           349  |        485
-----------+--------------------------+-----------
   Total   |       568           568  |       1136

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   76.06%
Specificity                     Pr( -|~D)   61.44%
Positive predictive value       Pr( D| +)   66.36%
Negative predictive value       Pr(~D| -)   71.96%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   38.56%
False - rate for true D         Pr( -| D)   23.94%
False + rate for classified +   Pr(~D| +)   33.64%
False - rate for classified -   Pr( D| -)   28.04%
--------------------------------------------------
Correctly classified                        68.75%
--------------------------------------------------

. 
. * 📌 Gerar predições na base de treinamento
. capture drop prob_pred_treino

. predict prob_pred_treino if train == 1, pr
(207 missing values generated)

. 
. * 📌 Classificação prevista
. capture drop predicted_class_treino

. gen predicted_class_treino = (prob_pred_treino >= 0.5) if train == 1
(207 missing values generated)

. 
. * 📌 Kappa na base de treinamento
. *ssc install kappaetc, replace
. kappaetc FoiPenalizadoSTJ predicted_class_treino if train == 1

Interrater agreement                             Number of subjects =    1136
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.6875    0.0138  49.97   0.000     0.6605     0.7145
Brennan and Prediger |  0.3750    0.0275  13.63   0.000     0.3210     0.4290
Cohen/Conger's Kappa |  0.3750    0.0272  13.78   0.000     0.3216     0.4284
    Scott/Fleiss' Pi |  0.3716    0.0276  13.45   0.000     0.3175     0.4258
           Gwet's AC |  0.3783    0.0276  13.71   0.000     0.3242     0.4325
Krippendorff's Alpha |  0.3719    0.0276  13.46   0.000     0.3177     0.4261
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de treinamento
. capture drop correct_classification_treino

. gen correct_classification_treino = (FoiPenalizadoSTJ == predicted_class_treino) if train == 1
(207 missing values generated)

. sum correct_classification_treino if train == 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~o |      1,136       .6875    .4637166          0          1

. scalar prop_modelo_treino = r(mean)

. 
. * 📌 No Information Rate (NIR)
. *O NIR representa a acurácia de um modelo nulo (baseline), que classifica sempre a categoria mais frequente.
. tabulate FoiPenalizadoSTJ if train == 1, matcell(freq_treino)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        568       50.00       50.00
          1 |        568       50.00      100.00
------------+-----------------------------------
      Total |      1,136      100.00

. scalar total_treino = freq_treino[1,1] + freq_treino[2,1]

. scalar max_treino = max(freq_treino[1,1], freq_treino[2,1])

. scalar prop_nir_treino = max_treino / total_treino

. 
. * 📌 Comparação
. di "Acurácia na base de treinamento: " prop_modelo_treino
Acurácia na base de treinamento: .6875

. di "NIR (treinamento): " prop_nir_treino
NIR (treinamento): .5

. 
. if (prop_modelo_treino > prop_nir_treino) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de treino."
✅ Modelo stepwise 10% supera o NIR na base de treino.
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de treino."
. }

. 
. * 📌 Teste de McNemar na base de treinamento
. * Criar a matriz de confusão da base de teste
. tabulate FoiPenalizadoSTJ predicted_class_treino if train == 1, matcell(mc_treino)

           | predicted_class_trein
FoiPenaliz |           o
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       349        219 |       568 
         1 |       136        432 |       568 
-----------+----------------------+----------
     Total |       485        651 |     1,136 

. 
. * Extrair os valores da matriz
. scalar tn_treino = mc_treino[1,1] // Verdadeiro Negativo

. scalar fn_treino = mc_treino[2,1] // Falso Negativo

. scalar fp_treino = mc_treino[1,2] // Falso Positivo

. scalar tp_treino = mc_treino[2,2] // Verdadeiro Positivo

. 
. * Mostrar os valores extraídos (opcional)
. di "TN: " tn_treino
TN: 349

. di "FN: " fn_treino
FN: 136

. di "FP: " fp_treino
FP: 219

. di "TP: " tp_treino
TP: 432

. 
. * Rodar o teste de McNemar com os valores numéricos
. mcci `=tn_treino' `=fn_treino' `=fp_treino' `=tp_treino'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       349         136  |        485
       Unexposed |       219         432  |        651
-----------------+------------------------+-----------
           Total |       568         568  |       1136

McNemar's chi2(1) =     19.41    Prob > chi2 = 0.0000
Exact McNemar significance probability       = 0.0000

Proportion with factor
        Cases       .4269366
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference -.0730634     -.1061723  -.0399544
        ratio       .8538732      .7958607   .9161145
        rel. diff. -.1461268     -.2157301  -.0765234

        odds ratio  .6210046      .4976372   .7726822   (exact)

. 
. /*******************************************************************************
> 6.2.3 Curva ROC para o modelo stepwise a 10% na base de TREINO
> *******************************************************************************/
. lroc if train == 1

Logistic model for FoiPenalizadoSTJ

Number of observations =     1136
Area under ROC curve   =   0.7475

. graph export "lroc_IRDC10_treino.png", replace
(file lroc_IRDC10_treino.png not found)
file lroc_IRDC10_treino.png saved as PNG format

. 
. /*******************************************************************************
> 6.2.4 Tabela de classificação para o modelo stepwise a 10% na base de TESTE
> *******************************************************************************/
. estat class if train == 0

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |        39            63  |        102
     -     |        27            78  |        105
-----------+--------------------------+-----------
   Total   |        66           141  |        207

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   59.09%
Specificity                     Pr( -|~D)   55.32%
Positive predictive value       Pr( D| +)   38.24%
Negative predictive value       Pr(~D| -)   74.29%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   44.68%
False - rate for true D         Pr( -| D)   40.91%
False + rate for classified +   Pr(~D| +)   61.76%
False - rate for classified -   Pr( D| -)   25.71%
--------------------------------------------------
Correctly classified                        56.52%
--------------------------------------------------

. 
. * 📌 Gerar predições na base de teste
. capture drop prob_pred_teste

. predict prob_pred_teste if train == 0, pr
(1,136 missing values generated)

. 
. * 📌 Classificação prevista
. capture drop predicted_class_teste

. gen predicted_class_teste = (prob_pred_teste >= 0.5) if train == 0
(1,136 missing values generated)

. 
. * 📌 Kappa na base de teste
. kappaetc FoiPenalizadoSTJ predicted_class_teste if train == 0

Interrater agreement                             Number of subjects =     207
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.5652    0.0345  16.36   0.000     0.4971     0.6333
Brennan and Prediger |  0.1304    0.0691   1.89   0.060    -0.0058     0.2666
Cohen/Conger's Kappa |  0.1258    0.0648   1.94   0.054    -0.0020     0.2537
    Scott/Fleiss' Pi |  0.0984    0.0698   1.41   0.160    -0.0391     0.2360
           Gwet's AC |  0.1602    0.0718   2.23   0.027     0.0186     0.3019
Krippendorff's Alpha |  0.1006    0.0698   1.44   0.151    -0.0369     0.2382
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de teste
. capture drop correct_classification_teste

. gen correct_classification_teste = (FoiPenalizadoSTJ == predicted_class_teste) if train == 0
(1,136 missing values generated)

. sum correct_classification_teste if train == 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~e |        207    .5652174    .4969302          0          1

. scalar prop_modelo_teste = r(mean)

. 
. * 📌 No Information Rate (NIR)
. tabulate FoiPenalizadoSTJ if train == 0, matcell(freq_teste)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        141       68.12       68.12
          1 |         66       31.88      100.00
------------+-----------------------------------
      Total |        207      100.00

. scalar total_teste = freq_teste[1,1] + freq_teste[2,1]

. scalar max_teste = max(freq_teste[1,1], freq_teste[2,1])

. scalar prop_nir_teste = max_teste / total_teste

. 
. 
. * 📌 Comparação
. di "Acurácia na base de teste: " prop_modelo_teste
Acurácia na base de teste: .56521739

. di "NIR (teste): " prop_nir_teste
NIR (teste): .68115942

. 
. if (prop_modelo_teste > prop_nir_teste) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de teste."
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste."
⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste.
. }

. 
. * 📌 Teste de McNemar na base de teste
. * Criar a matriz de confusão da base de teste
. tabulate FoiPenalizadoSTJ predicted_class_teste if train == 0, matcell(mc_teste)

FoiPenaliz | predicted_class_teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |        78         63 |       141 
         1 |        27         39 |        66 
-----------+----------------------+----------
     Total |       105        102 |       207 

. 
. * Extrair os valores da matriz
. scalar tn_teste = mc_teste[1,1] // Verdadeiro Negativo

. scalar fn_teste = mc_teste[2,1] // Falso Negativo

. scalar fp_teste = mc_teste[1,2] // Falso Positivo

. scalar tp_teste = mc_teste[2,2] // Verdadeiro Positivo

. 
. * Mostrar os valores extraídos (opcional)
. di "TN: " tn_teste
TN: 78

. di "FN: " fn_teste
FN: 27

. di "FP: " fp_teste
FP: 63

. di "TP: " tp_teste
TP: 39

. 
. * Rodar o teste de McNemar com os valores numéricos
. mcci `=tn_teste' `=fn_teste' `=fp_teste' `=tp_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |        78          27  |        105
       Unexposed |        63          39  |        102
-----------------+------------------------+-----------
           Total |       141          66  |        207

McNemar's chi2(1) =     14.40    Prob > chi2 = 0.0001
Exact McNemar significance probability       = 0.0002

Proportion with factor
        Cases       .5072464
        Controls    .6811594     [95% conf. interval]
                   ---------     --------------------
        difference  -.173913     -.2653887  -.0824374
        ratio       .7446809      .6391512   .8676344
        rel. diff. -.5454545     -.8956847  -.1952244

        odds ratio  .4285714       .262438   .6827119   (exact)

. 
. /*******************************************************************************
> 6.2.5 Curva ROC para o modelo stepwise a 10% na base de TESTE
> *******************************************************************************/
. lroc if train == 0

Logistic model for FoiPenalizadoSTJ

Number of observations =      207
Area under ROC curve   =   0.6352

. graph export "lroc_IRDC10_teste.png", replace
(file lroc_IRDC10_teste.png not found)
file lroc_IRDC10_teste.png saved as PNG format

. 
. /*******************************************************************************
> 6.2.6 – Ponto de Corte Ideal (Sensibilidade ≈ Especificidade)
> *******************************************************************************/
. 
. * Reexecutar rapidamente o modelo (sem sobrescrever)
. quietly logit FoiPenalizadoSTJ `var_contabeis' `var_controle' if train == 1

. 
. * Restaurar modelo salvo
. estimates restore IRDC10
(results IRDC10 are active now)

. 
. * 📌 BASE DE TREINAMENTO
. * ------------------------------------------------------------
. * Garantir que as variáveis temporárias não existam
. capture drop prob_pred_treino

. capture drop cutoff

. capture drop sens

. capture drop spec

. capture drop difference

. capture drop abs_diff

. capture drop ordem

. 
. * Gerar predições
. predict prob_pred_treino if train == 1, pr
(207 missing values generated)

. 
. * Gerar sensitividade e especificidade para diferentes cutoffs
. lsens if train == 1, genprob(cutoff) gensens(sens) genspec(spec) nograph

. 
. * Calcular diferença entre sensibilidade e especificidade
. gen difference = sens - spec
(208 missing values generated)

. gen abs_diff = abs(difference)
(208 missing values generated)

. 
. * Obter ponto ideal (menor diferença)
. gen ordem = _n

. gsort abs_diff

. 
. * Salvar valores do melhor ponto em scalars usando summarize
. summarize cutoff if abs_diff == abs_diff[1]

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
      cutoff |          1    .5421547           .   .5421547   .5421547

. scalar cutoff_ideal_treino = r(mean)

. 
. summarize sens if abs_diff == abs_diff[1]

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        sens |          1     .693662           .    .693662    .693662

. scalar sens_ideal_treino = r(mean)

. scalar cutoff_step10 = cutoff_ideal_treino

. 
. 
. summarize spec if abs_diff == abs_diff[1]

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        spec |          1    .6936619           .   .6936619   .6936619

. scalar spec_ideal_treino = r(mean)

. 
. * Mostrar o ponto ideal encontrado
. list cutoff sens spec abs_diff in 1, noobs clean

      cutoff       sens       spec   abs_diff  
    0.542155   0.693662   0.693662   5.96e-08  

. 
. * Plotar gráfico com destaque no ponto de cruzamento
. lsens if train == 1, ///
>     yline(`=sens_ideal_treino') xline(`=cutoff_ideal_treino') ///
>     scheme(s1color) ///
>     ylab(0 0.2 `=sens_ideal_treino' 0.8 1) ///
>     xlab(0 0.2 `=cutoff_ideal_treino' 0.8 1)

. 
. graph export "cutoff_ideal_IRDC10_treino.png", replace
(file cutoff_ideal_IRDC10_treino.png not found)
file cutoff_ideal_IRDC10_treino.png saved as PNG format

. 
. /*******************************************************************************
> 6.2.7 – Tabela de Classificação com Cutoff Ideal (Treinamento e Teste)
> *******************************************************************************/
. 
. * 📌 BASE DE TREINAMENTO
. * ------------------------------------------------------------
. 
. di "Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO: " cutoff_ideal_treino
Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO: .54215475

. 
. * Gerar classificação com o cutoff ideal
. capture drop predicted_class_treino

. gen predicted_class_treino = (prob_pred_treino >= cutoff_ideal_treino) if train == 1
(207 missing values generated)

. 
. * Matriz de classificação detalhada
. estat class if train == 1

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |       432           219  |        651
     -     |       136           349  |        485
-----------+--------------------------+-----------
   Total   |       568           568  |       1136

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   76.06%
Specificity                     Pr( -|~D)   61.44%
Positive predictive value       Pr( D| +)   66.36%
Negative predictive value       Pr(~D| -)   71.96%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   38.56%
False - rate for true D         Pr( -| D)   23.94%
False + rate for classified +   Pr(~D| +)   33.64%
False - rate for classified -   Pr( D| -)   28.04%
--------------------------------------------------
Correctly classified                        68.75%
--------------------------------------------------

. 
. * Kappa
. kappaetc FoiPenalizadoSTJ predicted_class_treino if train == 1

Interrater agreement                             Number of subjects =    1136
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.6928    0.0137  50.59   0.000     0.6659     0.7196
Brennan and Prediger |  0.3856    0.0274  14.08   0.000     0.3318     0.4393
Cohen/Conger's Kappa |  0.3856    0.0274  14.08   0.000     0.3318     0.4393
    Scott/Fleiss' Pi |  0.3856    0.0274  14.08   0.000     0.3318     0.4393
           Gwet's AC |  0.3856    0.0274  14.08   0.000     0.3318     0.4393
Krippendorff's Alpha |  0.3858    0.0274  14.09   0.000     0.3321     0.4396
------------------------------------------------------------------------------

. 
. * Acurácia
. capture drop correct_classification_treino

. gen correct_classification_treino = (FoiPenalizadoSTJ == predicted_class_treino) if train == 1
(207 missing values generated)

. sum correct_classification_treino if train == 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~o |      1,136    .6927817    .4615439          0          1

. scalar prop_modelo_treino = r(mean)

. 
. * No Information Rate
. tabulate FoiPenalizadoSTJ if train == 1, matcell(freq_treino)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        568       50.00       50.00
          1 |        568       50.00      100.00
------------+-----------------------------------
      Total |      1,136      100.00

. scalar total_treino = freq_treino[1,1] + freq_treino[2,1]

. scalar max_treino = max(freq_treino[1,1], freq_treino[2,1])

. scalar prop_nir_treino = max_treino / total_treino

. 
. di "Acurácia (treino): " prop_modelo_treino
Acurácia (treino): .69278169

. di "NIR (treino): " prop_nir_treino
NIR (treino): .5

. 
. if (prop_modelo_treino > prop_nir_treino) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de treino (cutoff ideal)."
✅ Modelo stepwise 10% supera o NIR na base de treino (cutoff ideal).
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de treino (cutoff ideal)."
. }

. 
. * Teste de McNemar
. tabulate FoiPenalizadoSTJ predicted_class_treino if train == 1, matcell(mc_treino)

           | predicted_class_trein
FoiPenaliz |           o
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       394        174 |       568 
         1 |       175        393 |       568 
-----------+----------------------+----------
     Total |       569        567 |     1,136 

. scalar tn_treino = mc_treino[1,1]

. scalar fn_treino = mc_treino[2,1]

. scalar fp_treino = mc_treino[1,2]

. scalar tp_treino = mc_treino[2,2]

. mcci `=tn_treino' `=fn_treino' `=fp_treino' `=tp_treino'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       394         175  |        569
       Unexposed |       174         393  |        567
-----------------+------------------------+-----------
           Total |       568         568  |       1136

McNemar's chi2(1) =      0.00    Prob > chi2 = 0.9573
Exact McNemar significance probability       = 1.0000

Proportion with factor
        Cases       .5008803
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference  .0008803     -.0322316   .0339922
        ratio       1.001761      .9392744   1.068404
        rel. diff.  .0017606      -.062646   .0661671

        odds ratio  1.005747      .8106891   1.247781   (exact)

. 
. 
. * 📌 BASE DE TESTE
. * ------------------------------------------------------------
. 
. di "Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO (aplicado na base de TESTE): " cutoff_ideal_treino
Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO (aplicado na base de TESTE): .54215475

. 
. * Gerar classificação com o mesmo cutoff da base de teste
. capture drop predicted_class_teste

. gen predicted_class_teste = (prob_pred_teste >= cutoff_ideal_treino) if train == 0
(1,136 missing values generated)

. 
. * Matriz de classificação detalhada
. estat class if train == 0

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |        39            63  |        102
     -     |        27            78  |        105
-----------+--------------------------+-----------
   Total   |        66           141  |        207

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   59.09%
Specificity                     Pr( -|~D)   55.32%
Positive predictive value       Pr( D| +)   38.24%
Negative predictive value       Pr(~D| -)   74.29%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   44.68%
False - rate for true D         Pr( -| D)   40.91%
False + rate for classified +   Pr(~D| +)   61.76%
False - rate for classified -   Pr( D| -)   25.71%
--------------------------------------------------
Correctly classified                        56.52%
--------------------------------------------------

. 
. * Kappa
. kappaetc FoiPenalizadoSTJ predicted_class_teste if train == 0

Interrater agreement                             Number of subjects =     207
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.6039    0.0341  17.72   0.000     0.5367     0.6710
Brennan and Prediger |  0.2077    0.0682   3.05   0.003     0.0734     0.3421
Cohen/Conger's Kappa |  0.1497    0.0689   2.17   0.031     0.0138     0.2855
    Scott/Fleiss' Pi |  0.1427    0.0703   2.03   0.043     0.0042     0.2812
           Gwet's AC |  0.2636    0.0716   3.68   0.000     0.1225     0.4046
Krippendorff's Alpha |  0.1448    0.0703   2.06   0.041     0.0063     0.2833
------------------------------------------------------------------------------

. 
. * Acurácia
. capture drop correct_classification_teste

. gen correct_classification_teste = (FoiPenalizadoSTJ == predicted_class_teste) if train == 0
(1,136 missing values generated)

. sum correct_classification_teste if train == 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~e |        207    .6038647    .4902788          0          1

. scalar prop_modelo_teste = r(mean)

. 
. * No Information Rate
. tabulate FoiPenalizadoSTJ if train == 0, matcell(freq_teste)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        141       68.12       68.12
          1 |         66       31.88      100.00
------------+-----------------------------------
      Total |        207      100.00

. scalar total_teste = freq_teste[1,1] + freq_teste[2,1]

. scalar max_teste = max(freq_teste[1,1], freq_teste[2,1])

. scalar prop_nir_teste = max_teste / total_teste

. 
. di "Acurácia (teste): " prop_modelo_teste
Acurácia (teste): .60386473

. di "NIR (teste): " prop_nir_teste
NIR (teste): .68115942

. 
. if (prop_modelo_teste > prop_nir_teste) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de teste (cutoff ideal do treino)."
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste (cutoff ideal do treino)."
⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste (cutoff ideal do treino).
. }

. 
. * Teste de McNemar
. tabulate FoiPenalizadoSTJ predicted_class_teste if train == 0, matcell(mc_teste)

FoiPenaliz | predicted_class_teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |        91         50 |       141 
         1 |        32         34 |        66 
-----------+----------------------+----------
     Total |       123         84 |       207 

. scalar tn_teste = mc_teste[1,1]

. scalar fn_teste = mc_teste[2,1]

. scalar fp_teste = mc_teste[1,2]

. scalar tp_teste = mc_teste[2,2]

. mcci `=tn_teste' `=fn_teste' `=fp_teste' `=tp_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |        91          32  |        123
       Unexposed |        50          34  |         84
-----------------+------------------------+-----------
           Total |       141          66  |        207

McNemar's chi2(1) =      3.95    Prob > chi2 = 0.0468
Exact McNemar significance probability       = 0.0598

Proportion with factor
        Cases       .5942029
        Controls    .6811594     [95% conf. interval]
                   ---------     --------------------
        difference -.0869565     -.1767054   .0027924
        ratio       .8723404      .7623531    .998196
        rel. diff. -.2727273     -.5761016    .030647

        odds ratio       .64      .3973596    1.01733   (exact)

. 
. /*******************************************************************************
> 6.3 Regressão logística com seleção via LASSO (penalização L1) no conjunto de treinamento
> 
>  O LASSO (Least Absolute Shrinkage and Selection Operator) realiza seleção automática
> de variáveis e reduz o risco de overfitting (sobreajuste), especialmente útil em 
> modelos com muitas variáveis e potencial multicolinearidade.
> 
> *******************************************************************************/
. 
. * Capturar todas as variáveis que começam com "Porte_"
. unab Porte_vars : Porte_*

. 
. * Capturar todas as variáveis que começam com "CNAE_"
. unab CNAE_vars : CNAE_*

. 
. * Capturar todas as variáveis que começam com "DivisaoCNAE_"
. unab DivisaoCNAE_vars : DivisaoCNAE_*

. 
. * Capturar todas as variáveis que começam com "NaturezaJuridica_"
. unab Natureza_vars : NaturezaJuridica_*

. 
. * Definir variáveis contábeis e de controle corretamente
. local var_contabeis `Porte_vars' Liquidez_Media_Z Estrutura_Media_Z Margem_Media_Z ROI ROE CompEndivid ImobRecNC GiroAtivo

. local var_controle `CNAE_vars' `Natureza_vars' log_vlrcon~o  QtdeCNAEsS~s IdadedeAnos QtePenalOu~s

. 
. *local var_controle `DivisaoCNAE_vars' `Natureza_vars' log_vlrcon~o  QtdeCNAEsS~s IdadedeAnos QtePenalOu~s
. 
. * Consolidar todas as variáveis em uma macro
. local todas_vars `var_contabeis' `var_controle'

. 
. *Ajustar modelo LASSO na base de treinamento
. lasso logit FoiPenalizadoSTJ `todas_vars' if train == 1, selection(cv)
note: NaturezaJuridica_1 omitted because it is constant.
10-fold cross-validation with 100 lambdas ...
Grid value 1:     lambda = .1208598   no. of nonzero coef. =  0
Folds: 1...5....10   CVF = 1.386422
Grid value 2:     lambda = .1101229   no. of nonzero coef. =  1
Folds: 1...5....10   CVF = 1.378057
Grid value 3:     lambda = .1003399   no. of nonzero coef. =  2
Folds: 1...5....10   CVF = 1.365132
Grid value 4:     lambda =  .091426   no. of nonzero coef. =  3
Folds: 1...5....10   CVF = 1.348079
Grid value 5:     lambda = .0833039   no. of nonzero coef. =  3
Folds: 1...5....10   CVF = 1.331882
Grid value 6:     lambda = .0759035   no. of nonzero coef. =  4
Folds: 1...5....10   CVF = 1.317547
Grid value 7:     lambda = .0691604   no. of nonzero coef. =  6
Folds: 1...5....10   CVF = 1.302108
Grid value 8:     lambda = .0630164   no. of nonzero coef. =  8
Folds: 1...5....10   CVF = 1.282341
Grid value 9:     lambda = .0574182   no. of nonzero coef. =  8
Folds: 1...5....10   CVF = 1.261889
Grid value 10:    lambda = .0523173   no. of nonzero coef. = 12
Folds: 1...5....10   CVF = 1.241823
Grid value 11:    lambda = .0476696   no. of nonzero coef. = 16
Folds: 1...5....10   CVF =    1.219
Grid value 12:    lambda = .0434347   no. of nonzero coef. = 17
Folds: 1...5....10   CVF = 1.194399
Grid value 13:    lambda = .0395761   no. of nonzero coef. = 22
Folds: 1...5....10   CVF = 1.170164
Grid value 14:    lambda = .0360603   no. of nonzero coef. = 23
Folds: 1...5....10   CVF = 1.147415
Grid value 15:    lambda = .0328568   no. of nonzero coef. = 23
Folds: 1...5....10   CVF = 1.126001
Grid value 16:    lambda = .0299379   no. of nonzero coef. = 24
Folds: 1...5....10   CVF =  1.10665
Grid value 17:    lambda = .0272783   no. of nonzero coef. = 24
Folds: 1...5....10   CVF = 1.089308
Grid value 18:    lambda =  .024855   no. of nonzero coef. = 25
Folds: 1...5....10   CVF = 1.074186
Grid value 19:    lambda = .0226469   no. of nonzero coef. = 28
Folds: 1...5....10   CVF = 1.061057
Grid value 20:    lambda =  .020635   no. of nonzero coef. = 32
Folds: 1...5....10   CVF = 1.049254
Grid value 21:    lambda = .0188019   no. of nonzero coef. = 32
Folds: 1...5....10   CVF = 1.038119
Grid value 22:    lambda = .0171316   no. of nonzero coef. = 34
Folds: 1...5....10   CVF = 1.027965
Grid value 23:    lambda = .0156096   no. of nonzero coef. = 37
Folds: 1...5....10   CVF = 1.018852
Grid value 24:    lambda = .0142229   no. of nonzero coef. = 37
Folds: 1...5....10   CVF = 1.010879
Grid value 25:    lambda = .0129594   no. of nonzero coef. = 37
Folds: 1...5....10   CVF = 1.003654
Grid value 26:    lambda = .0118081   no. of nonzero coef. = 41
Folds: 1...5....10   CVF =  .996675
Grid value 27:    lambda = .0107591   no. of nonzero coef. = 42
Folds: 1...5....10   CVF = .9903532
Grid value 28:    lambda = .0098033   no. of nonzero coef. = 43
Folds: 1...5....10   CVF = .9847742
Grid value 29:    lambda = .0089324   no. of nonzero coef. = 44
Folds: 1...5....10   CVF = .9798582
Grid value 30:    lambda = .0081389   no. of nonzero coef. = 44
Folds: 1...5....10   CVF = .9756016
Grid value 31:    lambda = .0074158   no. of nonzero coef. = 46
Folds: 1...5....10   CVF = .9718088
Grid value 32:    lambda =  .006757   no. of nonzero coef. = 46
Folds: 1...5....10   CVF = .9685028
Grid value 33:    lambda = .0061568   no. of nonzero coef. = 46
Folds: 1...5....10   CVF = .9657647
Grid value 34:    lambda = .0056098   no. of nonzero coef. = 48
Folds: 1...5....10   CVF = .9634574
Grid value 35:    lambda = .0051115   no. of nonzero coef. = 48
Folds: 1...5....10   CVF = .9615421
Grid value 36:    lambda = .0046574   no. of nonzero coef. = 51
Folds: 1...5....10   CVF = .9599061
Grid value 37:    lambda = .0042436   no. of nonzero coef. = 51
Folds: 1...5....10   CVF = .9585502
Grid value 38:    lambda = .0038666   no. of nonzero coef. = 51
Folds: 1...5....10   CVF = .9573902
Grid value 39:    lambda = .0035231   no. of nonzero coef. = 51
Folds: 1...5....10   CVF = .9562783
Grid value 40:    lambda = .0032101   no. of nonzero coef. = 51
Folds: 1...5....10   CVF = .9552986
Grid value 41:    lambda =  .002925   no. of nonzero coef. = 51
Folds: 1...5....10   CVF = .9545181
Grid value 42:    lambda = .0026651   no. of nonzero coef. = 51
Folds: 1...5....10   CVF =  .953843
Grid value 43:    lambda = .0024284   no. of nonzero coef. = 51
Folds: 1...5....10   CVF = .9533571
Grid value 44:    lambda = .0022126   no. of nonzero coef. = 52
Folds: 1...5....10   CVF = .9530452
Grid value 45:    lambda = .0020161   no. of nonzero coef. = 53
Folds: 1...5....10   CVF = .9528457
Grid value 46:    lambda =  .001837   no. of nonzero coef. = 53
Folds: 1...5....10   CVF = .9527495
Grid value 47:    lambda = .0016738   no. of nonzero coef. = 54
Folds: 1...5....10   CVF = .9527282
Grid value 48:    lambda = .0015251   no. of nonzero coef. = 54
Folds: 1...5....10   CVF = .9527741
Grid value 49:    lambda = .0013896   no. of nonzero coef. = 54
Folds: 1...5....10   CVF = .9528874
Grid value 50:    lambda = .0012661   no. of nonzero coef. = 54
Folds: 1...5....10   CVF = .9530302
Grid value 51:    lambda = .0011537   no. of nonzero coef. = 54
Folds: 1...5....10   CVF = .9532007
Grid value 52:    lambda = .0010512   no. of nonzero coef. = 54
Folds: 1...5....10   CVF = .9533981
Grid value 53:    lambda = .0009578   no. of nonzero coef. = 54
Folds: 1...5....10   CVF = .9536212
Grid value 54:    lambda = .0008727   no. of nonzero coef. = 54
Folds: 1...5....10   CVF =  .953863
Grid value 55:    lambda = .0007952   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9541193
Grid value 56:    lambda = .0007245   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .9543893
... cross-validation complete ... minimum found

Lasso logit model                           No. of obs        =      1,136
                                            No. of covariates =         60
Selection: Cross-validation                 No. of CV folds   =         10

--------------------------------------------------------------------------
         |                                No. of      Out-of-
         |                               nonzero       sample      CV mean
      ID |     Description      lambda     coef.   dev. ratio     deviance
---------+----------------------------------------------------------------
       1 |    first lambda    .1208598         0      -0.0001     1.386422
      46 |   lambda before     .001837        53       0.3127     .9527495
    * 47 | selected lambda    .0016738        54       0.3128     .9527282
      48 |    lambda after    .0015251        54       0.3127     .9527741
      56 |     last lambda    .0007245        55       0.3116     .9543893
--------------------------------------------------------------------------
* lambda selected by cross-validation.

. 
. * Salvar modelo
. estimates store IRDC_LASSO

. 
. 
. /*******************************************************************************
> 6.3.1 – Exportar Coeficientes Selecionados do Modelo LASSO (via log + conversão via Python)
> *******************************************************************************/
. 
. * Garantir que qualquer log anterior esteja fechado
. capture log close lassolog

. 
. * Abrir log no diretório atual (o mesmo de execução)
. log using "coef_lasso.txt", name(lassolog) text replace
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  lassolog
       log:  C:\Users\kkbul\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata\coef_lass
> o.txt
  log type:  text
 opened on:  26 Jul 2025, 19:31:02

. 
. * Exibir os coeficientes selecionados
. lassocoef, display(coef, postselection)

---------------------------------
                     | IRDC_LASSO
---------------------+-----------
             Porte_1 |  -.3028087
             Porte_2 |   .2175597
             Porte_3 |  -.0732556
    Liquidez_Media_Z |     -.1069
   Estrutura_Media_Z |  -.0224971
      Margem_Media_Z |  -.1893771
                 ROI |  -.9964137
                 ROE |   .3408284
         CompEndivid |  -.3694553
           ImobRecNC |  -1.066618
           GiroAtivo |   .0420225
              CNAE_1 |  -.5243295
              CNAE_2 |  -18.65118
              CNAE_3 |   18.22967
              CNAE_4 |   3.645649
              CNAE_5 |   .2584098
              CNAE_6 |  -.7811646
              CNAE_7 |   .8267954
              CNAE_8 |  -.3749861
              CNAE_9 |   17.34275
             CNAE_10 |     17.385
             CNAE_11 |   17.61076
             CNAE_12 |  -.3327661
             CNAE_13 |    .116261
             CNAE_14 |   18.24133
             CNAE_15 |  -.3605345
             CNAE_16 |  -.5548082
             CNAE_17 |   2.183378
             CNAE_18 |  -.5118089
             CNAE_19 |  -17.05691
             CNAE_20 |  -.2752271
             CNAE_21 |  -17.77721
             CNAE_22 |   .9497991
             CNAE_23 |     17.806
             CNAE_24 |  -18.55454
             CNAE_25 |  -.4780625
             CNAE_26 |   .8071935
             CNAE_27 |   1.188479
             CNAE_28 |  -18.23843
             CNAE_29 |   .0715375
             CNAE_30 |   .8581294
             CNAE_31 |  -18.03153
             CNAE_33 |  -17.91764
             CNAE_34 |  -18.23986
             CNAE_35 |   17.28002
  NaturezaJuridica_5 |   1.906793
  NaturezaJuridica_7 |  -14.97708
  NaturezaJuridica_8 |  -15.72935
  NaturezaJuridica_9 |   2.136814
 NaturezaJuridica_10 |  -15.06866
     log_vlrcontrato |   .0585056
QtdeCNAEsSecundarios |  -.0126396
         IdadedeAnos |   -.038139
QtePenalOutrosOrgaos |   .0178316
               _cons |  -.9217606
---------------------------------
Legend:
  b - base level
  e - empty cell
  o - omitted

. 
. * Fechar o log
. log close lassolog
      name:  lassolog
       log:  C:\Users\kkbul\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata\coef_lass
> o.txt
  log type:  text
 closed on:  26 Jul 2025, 19:31:02
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

. 
. display "✅ coef_lasso.txt exportado com sucesso."
✅ coef_lasso.txt exportado com sucesso.

. 
. 
. /*******************************************************************************
> 6.3.2 Tabela de Classificação, Acurácia, NIR e Teste de McNemar para o 
> Modelo LASSO na base de treino
> *******************************************************************************/
. 
. * 📌 Gerar predições de probabilidade na base de treinamento
. capture drop prob_pred_lasso

. predict prob_pred_lasso if train == 1, xb
(option penalized assumed; linear prediction with penalized coefficients)

. 
. * 📌 Classificação prevista com cutoff 0.5
. capture drop pred_lasso

. gen pred_lasso = (prob_pred_lasso >= 0.5) if train == 1
(207 missing values generated)

. 
. * 📌 Kappa
. kappaetc FoiPenalizadoSTJ pred_lasso if train == 1

Interrater agreement                             Number of subjects =    1136
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.7694    0.0125  61.53   0.000     0.7448     0.7939
Brennan and Prediger |  0.5387    0.0250  21.54   0.000     0.4897     0.5878
Cohen/Conger's Kappa |  0.5387    0.0241  22.34   0.000     0.4914     0.5861
    Scott/Fleiss' Pi |  0.5305    0.0254  20.90   0.000     0.4807     0.5804
           Gwet's AC |  0.5466    0.0250  21.85   0.000     0.4976     0.5957
Krippendorff's Alpha |  0.5308    0.0254  20.91   0.000     0.4809     0.5806
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de treinamento
. capture drop correct_lasso

. gen correct_lasso = (FoiPenalizadoSTJ == pred_lasso) if train == 1
(207 missing values generated)

. sum correct_lasso if train == 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_la~o |      1,136    .7693662     .421424          0          1

. scalar acuracia = r(mean)

. 
. * 📌 No Information Rate (NIR)
. * O NIR representa a acurácia de um modelo nulo (baseline), que classifica sempre a categoria mais frequente
. tabulate FoiPenalizadoSTJ if train == 1, matcell(freq_lasso)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        568       50.00       50.00
          1 |        568       50.00      100.00
------------+-----------------------------------
      Total |      1,136      100.00

. scalar total_lasso = freq_lasso[1,1] + freq_lasso[2,1]

. scalar max_lasso = max(freq_lasso[1,1], freq_lasso[2,1])

. scalar prop_nir_lasso = max_lasso / total_lasso

. 
. * 📌 Comparação
. di "Acurácia LASSO na base de treinamento: " acuracia
Acurácia LASSO na base de treinamento: .7693662

. di "NIR (treinamento): " prop_nir_lasso
NIR (treinamento): .5

. 
. if (acuracia > prop_nir_lasso) {
.     di "✅ Modelo LASSO supera o NIR na base de treino."
✅ Modelo LASSO supera o NIR na base de treino.
. }

. else {
.     di "⚠️ Modelo LASSO NÃO supera o NIR na base de treino."
. }

. 
. * 📌 Teste de McNemar na base de treinamento
. tabulate FoiPenalizadoSTJ pred_lasso if train == 1, matcell(mc_lasso)

FoiPenaliz |      pred_lasso
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       512         56 |       568 
         1 |       206        362 |       568 
-----------+----------------------+----------
     Total |       718        418 |     1,136 

. 
. scalar tn_lasso = mc_lasso[1,1] // Verdadeiro Negativo

. scalar fn_lasso = mc_lasso[2,1] // Falso Negativo

. scalar fp_lasso = mc_lasso[1,2] // Falso Positivo

. scalar tp_lasso = mc_lasso[2,2] // Verdadeiro Positivo

. 
. * Mostrar os valores extraídos (opcional)
. di "TN: " tn_lasso
TN: 512

. di "FN: " fn_lasso
FN: 206

. di "FP: " fp_lasso
FP: 56

. di "TP: " tp_lasso
TP: 362

. 
. * Rodar o teste de McNemar com os valores numéricos
. mcci `=tn_lasso' `=fn_lasso' `=fp_lasso' `=tp_lasso'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       512         206  |        718
       Unexposed |        56         362  |        418
-----------------+------------------------+-----------
           Total |       568         568  |       1136

McNemar's chi2(1) =     85.88    Prob > chi2 = 0.0000
Exact McNemar significance probability       = 0.0000

Proportion with factor
        Cases       .6320423
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference  .1320423      .1043115    .159773
        ratio       1.264085      1.202822   1.328467
        rel. diff.  .2640845      .2161703   .3119987

        odds ratio  3.678571      2.725795   5.035564   (exact)

. 
. /*******************************************************************************
> 6.3.3 Curva ROC para o modelo LASSO na base de TREINO
> *******************************************************************************/
. capture drop prob_pred_lasso_treino

. predict prob_pred_lasso_treino if train == 1, xb
(option penalized assumed; linear prediction with penalized coefficients)

. roctab FoiPenalizadoSTJ prob_pred_lasso_treino if train == 1, graph

. graph export "ROC_LASSO_treino.png", replace
(file ROC_LASSO_treino.png not found)
file ROC_LASSO_treino.png saved as PNG format

. 
. /*******************************************************************************
> 6.3.4 Avaliação do modelo LASSO na base de TESTE
> *******************************************************************************/
. 
. * 📌 Gerar predições de probabilidade na base de teste
. capture drop prob_pred_lasso_teste

. predict prob_pred_lasso_teste if train == 0, xb
(option penalized assumed; linear prediction with penalized coefficients)

. 
. * 📌 Classificação prevista com cutoff 0.5
. capture drop pred_lasso_teste

. gen pred_lasso_teste = (prob_pred_lasso_teste >= 0.5) if train == 0
(1,136 missing values generated)

. 
. * 📌 Kappa na base de teste
. kappaetc FoiPenalizadoSTJ pred_lasso_teste if train == 0

Interrater agreement                             Number of subjects =     207
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.7246    0.0311  23.28   0.000     0.6633     0.7860
Brennan and Prediger |  0.4493    0.0622   7.22   0.000     0.3266     0.5720
Cohen/Conger's Kappa |  0.3074    0.0708   4.34   0.000     0.1679     0.4470
    Scott/Fleiss' Pi |  0.2984    0.0733   4.07   0.000     0.1539     0.4428
           Gwet's AC |  0.5468    0.0602   9.08   0.000     0.4280     0.6655
Krippendorff's Alpha |  0.3001    0.0733   4.09   0.000     0.1556     0.4445
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de teste
. capture drop correct_lasso_teste

. gen correct_lasso_teste = (FoiPenalizadoSTJ == pred_lasso_teste) if train == 0
(1,136 missing values generated)

. sum correct_lasso_teste if train == 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_la~e |        207    .7246377    .4477796          0          1

. scalar acuracia_teste = r(mean)

. 
. * 📌 No Information Rate (NIR) - TESTE
. tabulate FoiPenalizadoSTJ if train == 0, matcell(freq_teste)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        141       68.12       68.12
          1 |         66       31.88      100.00
------------+-----------------------------------
      Total |        207      100.00

. scalar total_teste = freq_teste[1,1] + freq_teste[2,1]

. scalar max_teste = max(freq_teste[1,1], freq_teste[2,1])

. scalar nir_teste = max_teste / total_teste

. 
. di "Acurácia LASSO (teste): " acuracia_teste
Acurácia LASSO (teste): .72463768

. di "NIR (teste): " nir_teste
NIR (teste): .68115942

. 
. if (acuracia_teste > nir_teste) {
.     di "✅ Modelo LASSO supera o NIR na base de teste."
✅ Modelo LASSO supera o NIR na base de teste.
. }

. else {
.     di "⚠️ Modelo LASSO NÃO supera o NIR na base de teste."
. }

. 
. * 📌 Teste de McNemar - TESTE
. tabulate FoiPenalizadoSTJ pred_lasso_teste if train == 0, matcell(mc_lasso_teste)

FoiPenaliz |   pred_lasso_teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       123         18 |       141 
         1 |        39         27 |        66 
-----------+----------------------+----------
     Total |       162         45 |       207 

. 
. scalar tn_teste = mc_lasso_teste[1,1]

. scalar fn_teste = mc_lasso_teste[2,1]

. scalar fp_teste = mc_lasso_teste[1,2]

. scalar tp_teste = mc_lasso_teste[2,2]

. 
. di "TN: " tn_teste
TN: 123

. di "FN: " fn_teste
FN: 39

. di "FP: " fp_teste
FP: 18

. di "TP: " tp_teste
TP: 27

. 
. mcci `=tn_teste' `=fn_teste' `=fp_teste' `=tp_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       123          39  |        162
       Unexposed |        18          27  |         45
-----------------+------------------------+-----------
           Total |       141          66  |        207

McNemar's chi2(1) =      7.74    Prob > chi2 = 0.0054
Exact McNemar significance probability       = 0.0075

Proportion with factor
        Cases       .7826087
        Controls    .6811594     [95% conf. interval]
                   ---------     --------------------
        difference  .1014493       .026482   .1764166
        ratio       1.148936      1.041777   1.267117
        rel. diff.  .3181818      .1330522   .5033114

        odds ratio  2.166667      1.210287   4.023861   (exact)

. 
. /*******************************************************************************
> 6.3.5 Curva ROC para o modelo LASSO na base de TESTE
> *******************************************************************************/
. roctab FoiPenalizadoSTJ prob_pred_lasso_teste if train == 0, graph

. graph export "ROC_LASSO_teste.png", replace
(file ROC_LASSO_teste.png not found)
file ROC_LASSO_teste.png saved as PNG format

. 
. /*******************************************************************************
> 6.3.6 – Classificação com Cutoff Médio (modelo LASSO)
> *******************************************************************************/
. 
. * 📌 Definir o cutoff médio com base nos modelos completos, stepwise 5% e stepwise 10%
. scalar cutoff_medio = cutoff_step10

. di "📌 Cutoff médio dos modelos: " cutoff_medio
📌 Cutoff médio dos modelos: .54215475

. 
. * ========================================================
. * BASE DE TREINAMENTO
. * ========================================================
. 
. * 📌 Gerar classificação com cutoff médio
. capture drop predicted_class_lasso_treino

. gen predicted_class_lasso_treino = (prob_pred_lasso_treino >= cutoff_medio) if train == 1
(207 missing values generated)

. 
. * 📌 Matriz de classificação com tabulação
. tabulate FoiPenalizadoSTJ predicted_class_lasso_treino if train == 1, matcell(mc_lasso_treino)

           | predicted_class_lasso
FoiPenaliz |        _treino
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       513         55 |       568 
         1 |       217        351 |       568 
-----------+----------------------+----------
     Total |       730        406 |     1,136 

. 
. * 📌 Extrair valores
. scalar tn_lasso_medio = mc_lasso_treino[1,1]

. scalar fn_lasso_medio = mc_lasso_treino[2,1]

. scalar fp_lasso_medio = mc_lasso_treino[1,2]

. scalar tp_lasso_medio = mc_lasso_treino[2,2]

. 
. * 📌 Kappa
. kappaetc FoiPenalizadoSTJ predicted_class_lasso_treino if train == 1

Interrater agreement                             Number of subjects =    1136
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.7606    0.0127  60.04   0.000     0.7357     0.7854
Brennan and Prediger |  0.5211    0.0253  20.57   0.000     0.4714     0.5708
Cohen/Conger's Kappa |  0.5211    0.0243  21.46   0.000     0.4735     0.5688
    Scott/Fleiss' Pi |  0.5112    0.0258  19.83   0.000     0.4606     0.5618
           Gwet's AC |  0.5307    0.0254  20.93   0.000     0.4809     0.5804
Krippendorff's Alpha |  0.5114    0.0258  19.84   0.000     0.4608     0.5620
------------------------------------------------------------------------------

. 
. * 📌 Acurácia
. capture drop correct_lasso_medio

. gen correct_lasso_medio = (FoiPenalizadoSTJ == predicted_class_lasso_treino) if train == 1
(207 missing values generated)

. sum correct_lasso_medio if train == 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_l~io |      1,136    .7605634    .4269276          0          1

. scalar acuracia_lasso_medio = r(mean)

. 
. * 📌 No Information Rate (NIR)
. tabulate FoiPenalizadoSTJ if train == 1, matcell(freq_lasso_medio)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        568       50.00       50.00
          1 |        568       50.00      100.00
------------+-----------------------------------
      Total |      1,136      100.00

. scalar total_lasso_medio = freq_lasso_medio[1,1] + freq_lasso_medio[2,1]

. scalar max_lasso_medio = max(freq_lasso_medio[1,1], freq_lasso_medio[2,1])

. scalar nir_lasso_medio = max_lasso_medio / total_lasso_medio

. 
. di "Acurácia (treino, cutoff médio): " acuracia_lasso_medio
Acurácia (treino, cutoff médio): .76056338

. di "NIR (treino, cutoff médio): " nir_lasso_medio
NIR (treino, cutoff médio): .5

. 
. if (acuracia_lasso_medio > nir_lasso_medio) {
.     di "✅ Modelo LASSO (cutoff médio) supera o NIR na base de treino."
✅ Modelo LASSO (cutoff médio) supera o NIR na base de treino.
. }

. else {
.     di "⚠️ Modelo LASSO (cutoff médio) NÃO supera o NIR na base de treino."
. }

. 
. * 📌 Teste de McNemar
. mcci `=tn_lasso_medio' `=fn_lasso_medio' `=fp_lasso_medio' `=tp_lasso_medio'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       513         217  |        730
       Unexposed |        55         351  |        406
-----------------+------------------------+-----------
           Total |       568         568  |       1136

McNemar's chi2(1) =     96.49    Prob > chi2 = 0.0000
Exact McNemar significance probability       = 0.0000

Proportion with factor
        Cases       .6426056
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference  .1426056      .1145058   .1707054
        ratio       1.285211      1.222287   1.351375
        rel. diff.  .2852113      .2370971   .3333254

        odds ratio  3.945455      2.922867    5.40556   (exact)

. 
. * ========================================================
. * BASE DE TESTE
. * ========================================================
. 
. * 📌 Gerar classificação com cutoff médio
. capture drop predicted_class_lasso_teste

. gen predicted_class_lasso_teste = (prob_pred_lasso_teste >= cutoff_medio) if train == 0
(1,136 missing values generated)

. 
. * 📌 Matriz de classificação com tabulação
. tabulate FoiPenalizadoSTJ predicted_class_lasso_teste if train == 0, matcell(mc_lasso_teste)

           | predicted_class_lasso
FoiPenaliz |        _teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       125         16 |       141 
         1 |        39         27 |        66 
-----------+----------------------+----------
     Total |       164         43 |       207 

. 
. * 📌 Extrair valores
. scalar tn_lasso_medio_teste = mc_lasso_teste[1,1]

. scalar fn_lasso_medio_teste = mc_lasso_teste[2,1]

. scalar fp_lasso_medio_teste = mc_lasso_teste[1,2]

. scalar tp_lasso_medio_teste = mc_lasso_teste[2,2]

. 
. * 📌 Kappa
. kappaetc FoiPenalizadoSTJ predicted_class_lasso_teste if train == 0

Interrater agreement                             Number of subjects =     207
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.7343    0.0308  23.86   0.000     0.6736     0.7950
Brennan and Prediger |  0.4686    0.0616   7.61   0.000     0.3473     0.5899
Cohen/Conger's Kappa |  0.3258    0.0704   4.63   0.000     0.1871     0.4646
    Scott/Fleiss' Pi |  0.3151    0.0734   4.29   0.000     0.1703     0.4599
           Gwet's AC |  0.5659    0.0590   9.60   0.000     0.4496     0.6822
Krippendorff's Alpha |  0.3167    0.0734   4.31   0.000     0.1720     0.4615
------------------------------------------------------------------------------

. 
. * 📌 Acurácia
. capture drop correct_lasso_medio_teste

. gen correct_lasso_medio_teste = (FoiPenalizadoSTJ == predicted_class_lasso_teste) if train == 0
(1,136 missing values generated)

. sum correct_lasso_medio_teste if train == 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
cor~io_teste |        207    .7342995    .4427763          0          1

. scalar acuracia_lasso_medio_teste = r(mean)

. 
. * 📌 No Information Rate (NIR)
. tabulate FoiPenalizadoSTJ if train == 0, matcell(freq_lasso_medio_teste)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        141       68.12       68.12
          1 |         66       31.88      100.00
------------+-----------------------------------
      Total |        207      100.00

. scalar total_lasso_medio_teste = freq_lasso_medio_teste[1,1] + freq_lasso_medio_teste[2,1]

. scalar max_lasso_medio_teste = max(freq_lasso_medio_teste[1,1], freq_lasso_medio_teste[2,1])

. scalar nir_lasso_medio_teste = max_lasso_medio_teste / total_lasso_medio_teste

. 
. di "Acurácia (teste, cutoff médio): " acuracia_lasso_medio_teste
Acurácia (teste, cutoff médio): .73429952

. di "NIR (teste, cutoff médio): " nir_lasso_medio_teste
NIR (teste, cutoff médio): .68115942

. 
. if (acuracia_lasso_medio_teste > nir_lasso_medio_teste) {
.     di "✅ Modelo LASSO (cutoff médio) supera o NIR na base de teste."
✅ Modelo LASSO (cutoff médio) supera o NIR na base de teste.
. }

. else {
.     di "⚠️ Modelo LASSO (cutoff médio) NÃO supera o NIR na base de teste."
. }

. 
. * 📌 Teste de McNemar
. mcci `=tn_lasso_medio_teste' `=fn_lasso_medio_teste' `=fp_lasso_medio_teste' `=tp_lasso_medio_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       125          39  |        164
       Unexposed |        16          27  |         43
-----------------+------------------------+-----------
           Total |       141          66  |        207

McNemar's chi2(1) =      9.62    Prob > chi2 = 0.0019
Exact McNemar significance probability       = 0.0027

Proportion with factor
        Cases       .7922705
        Controls    .6811594     [95% conf. interval]
                   ---------     --------------------
        difference  .1111111      .0377112    .184511
        ratio       1.163121       1.05709   1.279787
        rel. diff.  .3484848      .1707192   .5262505

        odds ratio    2.4375      1.331097   4.672161   (exact)

. 
. 
. *******************************************************************************/
. 
. 
. /*******************************************************************************
> FIM DO SCRIPT
> *******************************************************************************/
. 
. log off
no log file open
r(606);

end of do-file

r(606);

