-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  IRDC_Resultados
       log:  C...\Projeto\Dados\Diretorio Stata\Resultados\IRDC_UFBAAPCONT.log
  log type:  text
 opened on:   2 Jul 2025, 14:57:35

. 
. /*******************************************************************************
> Projeto:            Índice de Risco de Descumprimento Contratual (IRDC)
> Autor:              Moreno Souto Santiago
> Fonte dos Dados:    Painel de Informações Contábeis dos Fornecedores do STJ
> Ferramentas:        Stata 18 + Python (SMOTENC)
> Descrição:          
> Este script executa a análise preditiva do IRDC com base em dados contábeis e cadastrais
> dos fornecedores do STJ. As etapas incluem:
> 
> 1. **Importação e transformação dos dados**: consolidação dos indicadores contábeis,
>    análise descritiva inicial e preparação da base para modelagem.
> 
> 2. **Winsorização das variáveis contínuas**: aplicação do corte nos percentis 1% e 99%
>    para reduzir o impacto de outliers extremos, preservando a variabilidade e robustez
>    das análises subsequentes.
> 
> 3. **Imputação de valores faltantes**: preenchimento de dados ausentes por média ou mediana,
>    conforme o coeficiente de variação, para garantir integridade e qualidade da base.
> 
> 4. **Estatísticas descritivas por grupo**: geração de tabelas de estatísticas descritivas
>    (média, desvio padrão, mínimo, máximo) para empresas penalizadas e não penalizadas,
>    antes e após a winsorização, facilitando análise comparativa de perfil.
>    
> 5. **Separação das amostras em treinamento (80%) e teste (20%)**: a separação das
>    amostras é realizada obedecendo a proporção exata de empresas penalizadas e não penalizadas.
> 
> 6. **Balanceamento da amostra de treinamento**: aplicação da técnica SMOTENC em Python para lidar com
>    desbalanceamento da variável dependente (penalização pelo STJ), com codificação de
>    variáveis categóricas e posterior reintegração ao Stata.
> 
> 7. **Agrupamento de CNAEs raros**: definição do mínimo de ocorrências para manter CNAE
>    como categoria isolada (local freq_minima = 10). As categorias com menor frequência
>    foram agrupadas sob o código -1 para reduzir a sparsidade da matriz de variáveis dummies
>    e aumentar a estabilidade dos coeficientes.
>  
> 8. **Modelagem e avaliação preditiva**:
>    - Modelo logit completo (com todas as variáveis)
>    - Modelos logit com seleção stepwise (a 5% e 10%)
>    - Modelo com penalização LASSO
>    Cada modelo é avaliado com métricas como acurácia, Kappa, NIR, teste de McNemar,
>    curvas ROC e definição do ponto de corte ideal baseado na equivalência entre
>    sensibilidade e especificidade. As métricas são aplicadas nos conjuntos de treinamento e teste.
> 
> Objetivo:
> Identificar o melhor modelo para predição da variável binária `FoiPenalizadoSTJ`,
> avaliando o poder explicativo de indicadores contábeis, porte, natureza jurídica, CNAE,
> e variáveis de histórico contratual da empresa.
> 
> Última atualização: 12/06/2025
> *******************************************************************************/
.    
. 
. /*******************************************************************************
> ETAPA 1 - IMPORTAÇÃO, ANÁLISE DESCRITIVA DAS VARIÁVEIS E TRANSFORMAÇÃO 
> *******************************************************************************/
. * Definindo o diretório de trabalho e importando os dados do Excel
. cd "`basedados'"
C:\Users\morenos\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata

. import excel "Dados_novo.xlsx", sheet("Tabela 4") firstrow clear
(37 vars, 931 obs)

. 
. /*******************************************************************************
> 1.1 - Executar estatísticas descritivas para todas as variáveis
> *******************************************************************************/
. summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        931    20.27115    175.2277     -65.24    4449.37
    LiqGeral |        931    17.79793    173.2711     -65.24    4449.37
 LiqCorAjust |        931    .4205884    .3556316    -3.6773          1
   SolvGeral |        931    23.42267    220.6801     -66.99    4449.37
    EndGeral |        931    1.119794    8.035152  -208.1876    34.6218
-------------+---------------------------------------------------------
 CompEndivid |        931    .7853853    .2551754          0          1
    IndepFin |        931    22.42819    220.6795   -67.9885   4448.367
    ImobilPL |        931    .1717159    3.294931   -95.5357     9.1728
   ImobRecNC |        931    .2082625     .252257     -.2471     1.4904
 PtpCapTerce |        931    1.119794    8.035152  -208.1876    34.6218
-------------+---------------------------------------------------------
   GiroAtivo |        931    1.567206    1.750998     -.0289    32.9637
      MargOp |        931    .8386915    11.44148    -1.4199   348.9034
     MargLiq |        931    .1716029    2.190555   -14.1571    60.8893
         ROI |        931    .1539564    .9351267    -25.837     3.6612
         ROE |        931    .4404016    2.541514    -3.9973    70.7696
-------------+---------------------------------------------------------
 vlrcontrato |        336    1.23e+07    2.52e+07   23769.99   1.34e+08
QtdeCNAEsS~s |        931    15.39527    14.31003          1         97
 IdadedeAnos |        931    22.64656    10.94995   .5041096   58.89315
QtePenalOu~s |        931    5.508056    20.42007          0        201

. 
. * Estatísticas descritivas separadas por penalização
. by FoiPenalizadoSTJ, sort: summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrga
> os

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        651    24.62353    203.8325     -65.24    4449.37
    LiqGeral |        651    21.23358    201.4794     -65.24    4449.37
 LiqCorAjust |        651    .4243464    .3639081    -3.6773          1
   SolvGeral |        651    29.01237    259.2962     -66.99    4449.37
    EndGeral |        651    1.153004    8.787333  -208.1876    34.6218
-------------+---------------------------------------------------------
 CompEndivid |        651    .7866369    .2649721          0          1
    IndepFin |        651    28.01713    259.2956   -67.9885   4448.367
    ImobilPL |        651    .1798339    3.824482   -95.5357     9.1728
   ImobRecNC |        651    .2199992    .2526778     -.1727     1.4904
 PtpCapTerce |        651    1.153004    8.787333  -208.1876    34.6218
-------------+---------------------------------------------------------
   GiroAtivo |        651    1.542487    1.900782     -.0289    32.9637
      MargOp |        651    .9889069    13.66699    -1.4199   348.9034
     MargLiq |        651    .1907648    2.535471   -14.1571    60.8893
         ROI |        651    .1614748    1.104968    -25.837     3.6612
         ROE |        651     .507284    2.980461    -3.6009    70.7696
-------------+---------------------------------------------------------
 vlrcontrato |        206    1.06e+07    2.08e+07      73284   8.19e+07
QtdeCNAEsS~s |        651    16.07834    15.09799          1         97
 IdadedeAnos |        651    22.42379    11.07274   .5041096   58.89315
QtePenalOu~s |        651    4.102919    19.68491          0        201

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        280    10.15186    73.52903          0    1104.44
    LiqGeral |        280    9.810036    73.55928          0    1104.67
 LiqCorAjust |        280    .4118511    .3360704    -2.4927          1
   SolvGeral |        280    10.42664    73.82675          0    1109.62
    EndGeral |        280    1.042582    5.941962   -76.5962    20.4292
-------------+---------------------------------------------------------
 CompEndivid |        280    .7824754    .2312228          0          1
    IndepFin |        280    9.433916     73.8259     -.7622   1108.622
    ImobilPL |        280    .1528414    1.453138   -23.1117     3.2065
   ImobRecNC |        280    .1809746    .2495955     -.2471     1.4847
 PtpCapTerce |        280    1.042582    5.941962   -76.5962    20.4292
-------------+---------------------------------------------------------
   GiroAtivo |        280    1.624678    1.340864          0     6.2266
      MargOp |        280    .4894407    1.008674     -.1079    14.3886
     MargLiq |        280    .1270514     1.00757    -6.3956    12.4133
         ROI |        280    .1364761    .2644234    -1.1367     1.6018
         ROE |        280       .2849    .8948627    -3.9973    11.2697
-------------+---------------------------------------------------------
 vlrcontrato |        130    1.49e+07    3.07e+07   23769.99   1.34e+08
QtdeCNAEsS~s |        280    13.80714    12.16163          1         58
 IdadedeAnos |        280    23.16451    10.66048   3.482192   58.73151
QtePenalOu~s |        280       8.775      21.722          0        166


. 
. * Bloco para salvar as estatísticas descritivas originais por grupo
. tabstat LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos, ///
>     statistics(mean sd min max n) by(FoiPenalizadoSTJ)

Summary statistics: Mean, SD, Min, Max, N
Group variable: FoiPenalizadoSTJ (FoiPenalizadoSTJ)

FoiPenalizadoSTJ |  LiqCor~e  LiqGeral  LiqCor~t  SolvGe~l  EndGeral  CompEn~d  IndepFin  ImobilPL  ImobRe~C  PtpCap~e  GiroAt~o    MargOp   MargLiq       ROI       ROE  vlrcon~o  QtdeCN~s  Idaded~s  QtePen~s
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
               0 |  24.62353  21.23358  .4243464  29.01237  1.153004  .7866369  28.01713  .1798339  .2199992  1.153004  1.542487  .9889069  .1907648  .1614748   .507284  1.06e+07  16.07834  22.42379  4.102919
                 |  203.8325  201.4794  .3639081  259.2962  8.787333  .2649721  259.2956  3.824482  .2526778  8.787333  1.900782  13.66699  2.535471  1.104968  2.980461  2.08e+07  15.09799  11.07274  19.68491
                 |    -65.24    -65.24   -3.6773    -66.99 -208.1876         0  -67.9885  -95.5357    -.1727 -208.1876    -.0289   -1.4199  -14.1571   -25.837   -3.6009     73284         1  .5041096         0
                 |   4449.37   4449.37         1   4449.37   34.6218         1  4448.367    9.1728    1.4904   34.6218   32.9637  348.9034   60.8893    3.6612   70.7696  8.19e+07        97  58.89315       201
                 |       651       651       651       651       651       651       651       651       651       651       651       651       651       651       651       206       651       651       651
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
               1 |  10.15186  9.810036  .4118511  10.42664  1.042582  .7824754  9.433916  .1528414  .1809746  1.042582  1.624678  .4894407  .1270514  .1364761     .2849  1.49e+07  13.80714  23.16451     8.775
                 |  73.52903  73.55928  .3360704  73.82675  5.941962  .2312228   73.8259  1.453138  .2495955  5.941962  1.340864  1.008674   1.00757  .2644234  .8948627  3.07e+07  12.16163  10.66048    21.722
                 |         0         0   -2.4927         0  -76.5962         0    -.7622  -23.1117    -.2471  -76.5962         0    -.1079   -6.3956   -1.1367   -3.9973  23769.99         1  3.482192         0
                 |   1104.44   1104.67         1   1109.62   20.4292         1  1108.622    3.2065    1.4847   20.4292    6.2266   14.3886   12.4133    1.6018   11.2697  1.34e+08        58  58.73151       166
                 |       280       280       280       280       280       280       280       280       280       280       280       280       280       280       280       130       280       280       280
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
           Total |  20.27115  17.79793  .4205884  23.42267  1.119794  .7853853  22.42819  .1717159  .2082625  1.119794  1.567206  .8386915  .1716029  .1539564  .4404016  1.23e+07  15.39527  22.64656  5.508056
                 |  175.2277  173.2711  .3556316  220.6801  8.035152  .2551754  220.6795  3.294931   .252257  8.035152  1.750998  11.44148  2.190555  .9351267  2.541514  2.52e+07  14.31003  10.94995  20.42007
                 |    -65.24    -65.24   -3.6773    -66.99 -208.1876         0  -67.9885  -95.5357    -.2471 -208.1876    -.0289   -1.4199  -14.1571   -25.837   -3.9973  23769.99         1  .5041096         0
                 |   4449.37   4449.37         1   4449.37   34.6218         1  4448.367    9.1728    1.4904   34.6218   32.9637  348.9034   60.8893    3.6612   70.7696  1.34e+08        97  58.89315       201
                 |       931       931       931       931       931       931       931       931       931       931       931       931       931       931       931       336       931       931       931
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

.         
. *Bloco de estatíticas das variáveis qualitativas
. 
. tabulate Porte

                  Porte |      Freq.     Percent        Cum.
------------------------+-----------------------------------
EMPRESA DE GRANDE PORTE |        109       11.71       11.71
 EMPRESA DE MÉDIO PORTE |        143       15.36       27.07
          MICROENTIDADE |        102       10.96       38.02
        PEQUENA EMPRESA |        577       61.98      100.00
------------------------+-----------------------------------
                  Total |        931      100.00

. tabulate NaturezaJuridica

                      NaturezaJuridica |      Freq.     Percent        Cum.
---------------------------------------+-----------------------------------
               201-1 - Empresa Pública |          5        0.54        0.54
      204-6 - Sociedade Anônima Aberta |         13        1.40        1.93
     205-4 - Sociedade Anônima Fechada |         90        9.67       11.60
 206-2 - Sociedade Empresária Limitada |        772       82.92       94.52
       213-5 - Empresário (Individual) |         23        2.47       96.99
                   214-3 - Cooperativa |          2        0.21       97.21
       215-1 - Consórcio de Sociedades |          1        0.11       97.31
    224-0 - Sociedade Simples Limitada |          1        0.11       97.42
              306-9 - Fundação Privada |          6        0.64       98.07
            399-9 - Associação Privada |         18        1.93      100.00
---------------------------------------+-----------------------------------
                                 Total |        931      100.00

. tabulate CNAE

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
 14.12-6-01 |          1        0.11        0.11
 16.22-6-99 |          2        0.21        0.32
 16.29-3-01 |          1        0.11        0.43
 17.42-7-99 |          2        0.21        0.64
 22.29-3-01 |          4        0.43        1.07
 26.21-3-00 |         10        1.07        2.15
 26.32-9-00 |          1        0.11        2.26
 27.10-4-02 |          5        0.54        2.79
 27.31-7-00 |          1        0.11        2.90
 27.90-2-02 |          1        0.11        3.01
 29.10-7-01 |          3        0.32        3.33
 31.01-2-00 |         19        2.04        5.37
 31.02-1-00 |          5        0.54        5.91
 33.12-1-02 |          1        0.11        6.02
 33.21-0-00 |          4        0.43        6.44
 41.20-4-00 |         59        6.34       12.78
 42.21-9-03 |          6        0.64       13.43
 42.21-9-05 |          6        0.64       14.07
 42.99-5-99 |          6        0.64       14.72
 43.21-5-00 |         19        2.04       16.76
 43.22-3-02 |         11        1.18       17.94
 43.22-3-03 |          6        0.64       18.58
 43.29-1-03 |          6        0.64       19.23
 43.29-1-99 |          3        0.32       19.55
 43.30-4-05 |          2        0.21       19.76
 43.30-4-99 |          8        0.86       20.62
 45.11-1-01 |          5        0.54       21.16
 45.30-7-01 |          1        0.11       21.27
 46.18-4-99 |          2        0.21       21.48
 46.33-8-01 |          2        0.21       21.70
 46.35-4-01 |          4        0.43       22.13
 46.39-7-01 |          3        0.32       22.45
 46.47-8-02 |          8        0.86       23.31
 46.49-4-01 |          1        0.11       23.42
 46.49-4-04 |          1        0.11       23.52
 46.49-4-08 |         10        1.07       24.60
 46.49-4-99 |          4        0.43       25.03
 46.51-6-01 |         38        4.08       29.11
 46.52-4-00 |         22        2.36       31.47
 46.61-3-00 |          2        0.21       31.69
 46.63-0-00 |          1        0.11       31.79
 46.65-6-00 |          1        0.11       31.90
 46.69-9-99 |          5        0.54       32.44
 46.81-8-01 |          1        0.11       32.55
 46.86-9-02 |          1        0.11       32.65
 46.87-7-01 |          2        0.21       32.87
 47.12-1-00 |          2        0.21       33.08
 47.29-6-99 |          8        0.86       33.94
 47.44-0-01 |          6        0.64       34.59
 47.44-0-99 |          5        0.54       35.12
 47.51-2-01 |         46        4.94       40.06
 47.52-1-00 |          2        0.21       40.28
 47.53-9-00 |          4        0.43       40.71
 47.54-7-01 |          9        0.97       41.68
 47.59-8-99 |          1        0.11       41.78
 47.89-0-05 |          1        0.11       41.89
 47.89-0-09 |          3        0.32       42.21
 47.89-0-99 |          4        0.43       42.64
 49.21-3-01 |          2        0.21       42.86
 52.40-1-01 |          1        0.11       42.96
 56.11-2-01 |          7        0.75       43.72
 56.20-1-01 |          1        0.11       43.82
 59.11-1-99 |          2        0.21       44.04
 61.10-8-01 |         11        1.18       45.22
 61.10-8-03 |          6        0.64       45.86
 61.20-5-01 |          6        0.64       46.51
 61.20-5-02 |          1        0.11       46.62
 61.90-6-99 |          2        0.21       46.83
 62.01-5-01 |         31        3.33       50.16
 62.02-3-00 |         15        1.61       51.77
 62.03-1-00 |         25        2.69       54.46
 62.04-0-00 |         51        5.48       59.94
 62.09-1-00 |         73        7.84       67.78
 63.11-9-00 |          3        0.32       68.10
 63.19-4-00 |          1        0.11       68.21
 63.99-2-00 |          2        0.21       68.42
 66.13-4-00 |          5        0.54       68.96
 66.21-5-02 |          6        0.64       69.60
 70.20-4-00 |          9        0.97       70.57
 71.11-1-00 |          1        0.11       70.68
 71.12-0-00 |         25        2.69       73.36
 73.11-4-00 |          3        0.32       73.68
 73.20-3-00 |          3        0.32       74.01
 74.20-0-04 |          2        0.21       74.22
 74.90-1-04 |          6        0.64       74.87
 74.90-1-99 |          4        0.43       75.30
 77.33-1-00 |          9        0.97       76.26
 77.39-0-03 |          4        0.43       76.69
 77.39-0-99 |          2        0.21       76.91
 78.10-8-00 |          6        0.64       77.55
 78.20-5-00 |          8        0.86       78.41
 78.30-2-00 |         25        2.69       81.10
 79.11-2-00 |         20        2.15       83.24
 80.11-1-01 |         20        2.15       85.39
 81.21-4-00 |         12        1.29       86.68
 81.29-0-00 |          6        0.64       87.33
 81.30-3-00 |          2        0.21       87.54
 82.11-3-00 |         15        1.61       89.15
 82.20-2-00 |         21        2.26       91.41
 82.30-0-01 |         20        2.15       93.56
 82.99-7-99 |         11        1.18       94.74
 85.31-7-00 |          2        0.21       94.95
 85.32-5-00 |          3        0.32       95.27
 85.50-3-02 |          5        0.54       95.81
 85.93-7-00 |          6        0.64       96.46
 85.99-6-04 |          5        0.54       96.99
 86.30-5-06 |          4        0.43       97.42
 86.50-0-01 |          2        0.21       97.64
 86.60-7-00 |          2        0.21       97.85
 88.00-6-00 |          6        0.64       98.50
 90.01-9-02 |          2        0.21       98.71
 93.19-1-01 |          2        0.21       98.93
 94.30-8-00 |          2        0.21       99.14
 94.99-5-00 |          6        0.64       99.79
 96.01-7-01 |          2        0.21      100.00
------------+-----------------------------------
      Total |        931      100.00

. 
. quietly egen cnpjs = tag(CNPJ)

. tabulate FoiPenalizadoSTJ if cnpjs == 1, missing

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        273       79.36       79.36
          1 |         71       20.64      100.00
------------+-----------------------------------
      Total |        344      100.00

. 
. 
. // Frequência com percentual
. tabulate Porte, missing

                  Porte |      Freq.     Percent        Cum.
------------------------+-----------------------------------
EMPRESA DE GRANDE PORTE |        109       11.71       11.71
 EMPRESA DE MÉDIO PORTE |        143       15.36       27.07
          MICROENTIDADE |        102       10.96       38.02
        PEQUENA EMPRESA |        577       61.98      100.00
------------------------+-----------------------------------
                  Total |        931      100.00

. tabulate NaturezaJuridica, missing

                      NaturezaJuridica |      Freq.     Percent        Cum.
---------------------------------------+-----------------------------------
               201-1 - Empresa Pública |          5        0.54        0.54
      204-6 - Sociedade Anônima Aberta |         13        1.40        1.93
     205-4 - Sociedade Anônima Fechada |         90        9.67       11.60
 206-2 - Sociedade Empresária Limitada |        772       82.92       94.52
       213-5 - Empresário (Individual) |         23        2.47       96.99
                   214-3 - Cooperativa |          2        0.21       97.21
       215-1 - Consórcio de Sociedades |          1        0.11       97.31
    224-0 - Sociedade Simples Limitada |          1        0.11       97.42
              306-9 - Fundação Privada |          6        0.64       98.07
            399-9 - Associação Privada |         18        1.93      100.00
---------------------------------------+-----------------------------------
                                 Total |        931      100.00

. tabulate CNAE, missing

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
 14.12-6-01 |          1        0.11        0.11
 16.22-6-99 |          2        0.21        0.32
 16.29-3-01 |          1        0.11        0.43
 17.42-7-99 |          2        0.21        0.64
 22.29-3-01 |          4        0.43        1.07
 26.21-3-00 |         10        1.07        2.15
 26.32-9-00 |          1        0.11        2.26
 27.10-4-02 |          5        0.54        2.79
 27.31-7-00 |          1        0.11        2.90
 27.90-2-02 |          1        0.11        3.01
 29.10-7-01 |          3        0.32        3.33
 31.01-2-00 |         19        2.04        5.37
 31.02-1-00 |          5        0.54        5.91
 33.12-1-02 |          1        0.11        6.02
 33.21-0-00 |          4        0.43        6.44
 41.20-4-00 |         59        6.34       12.78
 42.21-9-03 |          6        0.64       13.43
 42.21-9-05 |          6        0.64       14.07
 42.99-5-99 |          6        0.64       14.72
 43.21-5-00 |         19        2.04       16.76
 43.22-3-02 |         11        1.18       17.94
 43.22-3-03 |          6        0.64       18.58
 43.29-1-03 |          6        0.64       19.23
 43.29-1-99 |          3        0.32       19.55
 43.30-4-05 |          2        0.21       19.76
 43.30-4-99 |          8        0.86       20.62
 45.11-1-01 |          5        0.54       21.16
 45.30-7-01 |          1        0.11       21.27
 46.18-4-99 |          2        0.21       21.48
 46.33-8-01 |          2        0.21       21.70
 46.35-4-01 |          4        0.43       22.13
 46.39-7-01 |          3        0.32       22.45
 46.47-8-02 |          8        0.86       23.31
 46.49-4-01 |          1        0.11       23.42
 46.49-4-04 |          1        0.11       23.52
 46.49-4-08 |         10        1.07       24.60
 46.49-4-99 |          4        0.43       25.03
 46.51-6-01 |         38        4.08       29.11
 46.52-4-00 |         22        2.36       31.47
 46.61-3-00 |          2        0.21       31.69
 46.63-0-00 |          1        0.11       31.79
 46.65-6-00 |          1        0.11       31.90
 46.69-9-99 |          5        0.54       32.44
 46.81-8-01 |          1        0.11       32.55
 46.86-9-02 |          1        0.11       32.65
 46.87-7-01 |          2        0.21       32.87
 47.12-1-00 |          2        0.21       33.08
 47.29-6-99 |          8        0.86       33.94
 47.44-0-01 |          6        0.64       34.59
 47.44-0-99 |          5        0.54       35.12
 47.51-2-01 |         46        4.94       40.06
 47.52-1-00 |          2        0.21       40.28
 47.53-9-00 |          4        0.43       40.71
 47.54-7-01 |          9        0.97       41.68
 47.59-8-99 |          1        0.11       41.78
 47.89-0-05 |          1        0.11       41.89
 47.89-0-09 |          3        0.32       42.21
 47.89-0-99 |          4        0.43       42.64
 49.21-3-01 |          2        0.21       42.86
 52.40-1-01 |          1        0.11       42.96
 56.11-2-01 |          7        0.75       43.72
 56.20-1-01 |          1        0.11       43.82
 59.11-1-99 |          2        0.21       44.04
 61.10-8-01 |         11        1.18       45.22
 61.10-8-03 |          6        0.64       45.86
 61.20-5-01 |          6        0.64       46.51
 61.20-5-02 |          1        0.11       46.62
 61.90-6-99 |          2        0.21       46.83
 62.01-5-01 |         31        3.33       50.16
 62.02-3-00 |         15        1.61       51.77
 62.03-1-00 |         25        2.69       54.46
 62.04-0-00 |         51        5.48       59.94
 62.09-1-00 |         73        7.84       67.78
 63.11-9-00 |          3        0.32       68.10
 63.19-4-00 |          1        0.11       68.21
 63.99-2-00 |          2        0.21       68.42
 66.13-4-00 |          5        0.54       68.96
 66.21-5-02 |          6        0.64       69.60
 70.20-4-00 |          9        0.97       70.57
 71.11-1-00 |          1        0.11       70.68
 71.12-0-00 |         25        2.69       73.36
 73.11-4-00 |          3        0.32       73.68
 73.20-3-00 |          3        0.32       74.01
 74.20-0-04 |          2        0.21       74.22
 74.90-1-04 |          6        0.64       74.87
 74.90-1-99 |          4        0.43       75.30
 77.33-1-00 |          9        0.97       76.26
 77.39-0-03 |          4        0.43       76.69
 77.39-0-99 |          2        0.21       76.91
 78.10-8-00 |          6        0.64       77.55
 78.20-5-00 |          8        0.86       78.41
 78.30-2-00 |         25        2.69       81.10
 79.11-2-00 |         20        2.15       83.24
 80.11-1-01 |         20        2.15       85.39
 81.21-4-00 |         12        1.29       86.68
 81.29-0-00 |          6        0.64       87.33
 81.30-3-00 |          2        0.21       87.54
 82.11-3-00 |         15        1.61       89.15
 82.20-2-00 |         21        2.26       91.41
 82.30-0-01 |         20        2.15       93.56
 82.99-7-99 |         11        1.18       94.74
 85.31-7-00 |          2        0.21       94.95
 85.32-5-00 |          3        0.32       95.27
 85.50-3-02 |          5        0.54       95.81
 85.93-7-00 |          6        0.64       96.46
 85.99-6-04 |          5        0.54       96.99
 86.30-5-06 |          4        0.43       97.42
 86.50-0-01 |          2        0.21       97.64
 86.60-7-00 |          2        0.21       97.85
 88.00-6-00 |          6        0.64       98.50
 90.01-9-02 |          2        0.21       98.71
 93.19-1-01 |          2        0.21       98.93
 94.30-8-00 |          2        0.21       99.14
 94.99-5-00 |          6        0.64       99.79
 96.01-7-01 |          2        0.21      100.00
------------+-----------------------------------
      Total |        931      100.00

. 
. 
. tabulate Porte FoiPenalizadoSTJ, column

+-------------------+
| Key               |
|-------------------|
|     frequency     |
| column percentage |
+-------------------+

                      |   FoiPenalizadoSTJ
                Porte |         0          1 |     Total
----------------------+----------------------+----------
EMPRESA DE GRANDE P.. |        82         27 |       109 
                      |     12.60       9.64 |     11.71 
----------------------+----------------------+----------
EMPRESA DE MÉDIO PO.. |        92         51 |       143 
                      |     14.13      18.21 |     15.36 
----------------------+----------------------+----------
        MICROENTIDADE |        75         27 |       102 
                      |     11.52       9.64 |     10.96 
----------------------+----------------------+----------
      PEQUENA EMPRESA |       402        175 |       577 
                      |     61.75      62.50 |     61.98 
----------------------+----------------------+----------
                Total |       651        280 |       931 
                      |    100.00     100.00 |    100.00 

. tabulate NaturezaJuridica FoiPenalizadoSTJ, row

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   FoiPenalizadoSTJ
     NaturezaJuridica |         0          1 |     Total
----------------------+----------------------+----------
201-1 - Empresa Púb.. |         5          0 |         5 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
204-6 - Sociedade A.. |         8          5 |        13 
                      |     61.54      38.46 |    100.00 
----------------------+----------------------+----------
205-4 - Sociedade A.. |        79         11 |        90 
                      |     87.78      12.22 |    100.00 
----------------------+----------------------+----------
206-2 - Sociedade E.. |       513        259 |       772 
                      |     66.45      33.55 |    100.00 
----------------------+----------------------+----------
213-5 - Empresário .. |        21          2 |        23 
                      |     91.30       8.70 |    100.00 
----------------------+----------------------+----------
  214-3 - Cooperativa |         2          0 |         2 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
215-1 - Consórcio d.. |         1          0 |         1 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
224-0 - Sociedade S.. |         1          0 |         1 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
306-9 - Fundação Pr.. |         3          3 |         6 
                      |     50.00      50.00 |    100.00 
----------------------+----------------------+----------
399-9 - Associação .. |        18          0 |        18 
                      |    100.00       0.00 |    100.00 
----------------------+----------------------+----------
                Total |       651        280 |       931 
                      |     69.92      30.08 |    100.00 

. tabulate CNAE FoiPenalizadoSTJ, cell

+-----------------+
| Key             |
|-----------------|
|    frequency    |
| cell percentage |
+-----------------+

           |   FoiPenalizadoSTJ
      CNAE |         0          1 |     Total
-----------+----------------------+----------
14.12-6-01 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
16.22-6-99 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
16.29-3-01 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
17.42-7-99 |         0          2 |         2 
           |      0.00       0.21 |      0.21 
-----------+----------------------+----------
22.29-3-01 |         0          4 |         4 
           |      0.00       0.43 |      0.43 
-----------+----------------------+----------
26.21-3-00 |        10          0 |        10 
           |      1.07       0.00 |      1.07 
-----------+----------------------+----------
26.32-9-00 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
27.10-4-02 |         5          0 |         5 
           |      0.54       0.00 |      0.54 
-----------+----------------------+----------
27.31-7-00 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
27.90-2-02 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
29.10-7-01 |         3          0 |         3 
           |      0.32       0.00 |      0.32 
-----------+----------------------+----------
31.01-2-00 |         1         18 |        19 
           |      0.11       1.93 |      2.04 
-----------+----------------------+----------
31.02-1-00 |         5          0 |         5 
           |      0.54       0.00 |      0.54 
-----------+----------------------+----------
33.12-1-02 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
33.21-0-00 |         0          4 |         4 
           |      0.00       0.43 |      0.43 
-----------+----------------------+----------
41.20-4-00 |        45         14 |        59 
           |      4.83       1.50 |      6.34 
-----------+----------------------+----------
42.21-9-03 |         6          0 |         6 
           |      0.64       0.00 |      0.64 
-----------+----------------------+----------
42.21-9-05 |         0          6 |         6 
           |      0.00       0.64 |      0.64 
-----------+----------------------+----------
42.99-5-99 |         6          0 |         6 
           |      0.64       0.00 |      0.64 
-----------+----------------------+----------
43.21-5-00 |        13          6 |        19 
           |      1.40       0.64 |      2.04 
-----------+----------------------+----------
43.22-3-02 |         7          4 |        11 
           |      0.75       0.43 |      1.18 
-----------+----------------------+----------
43.22-3-03 |         6          0 |         6 
           |      0.64       0.00 |      0.64 
-----------+----------------------+----------
43.29-1-03 |         0          6 |         6 
           |      0.00       0.64 |      0.64 
-----------+----------------------+----------
43.29-1-99 |         0          3 |         3 
           |      0.00       0.32 |      0.32 
-----------+----------------------+----------
43.30-4-05 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
43.30-4-99 |         8          0 |         8 
           |      0.86       0.00 |      0.86 
-----------+----------------------+----------
45.11-1-01 |         5          0 |         5 
           |      0.54       0.00 |      0.54 
-----------+----------------------+----------
45.30-7-01 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
46.18-4-99 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
46.33-8-01 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
46.35-4-01 |         4          0 |         4 
           |      0.43       0.00 |      0.43 
-----------+----------------------+----------
46.39-7-01 |         3          0 |         3 
           |      0.32       0.00 |      0.32 
-----------+----------------------+----------
46.47-8-02 |         0          8 |         8 
           |      0.00       0.86 |      0.86 
-----------+----------------------+----------
46.49-4-01 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
46.49-4-04 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
46.49-4-08 |         0         10 |        10 
           |      0.00       1.07 |      1.07 
-----------+----------------------+----------
46.49-4-99 |         4          0 |         4 
           |      0.43       0.00 |      0.43 
-----------+----------------------+----------
46.51-6-01 |        25         13 |        38 
           |      2.69       1.40 |      4.08 
-----------+----------------------+----------
46.52-4-00 |        15          7 |        22 
           |      1.61       0.75 |      2.36 
-----------+----------------------+----------
46.61-3-00 |         0          2 |         2 
           |      0.00       0.21 |      0.21 
-----------+----------------------+----------
46.63-0-00 |         0          1 |         1 
           |      0.00       0.11 |      0.11 
-----------+----------------------+----------
46.65-6-00 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
46.69-9-99 |         0          5 |         5 
           |      0.00       0.54 |      0.54 
-----------+----------------------+----------
46.81-8-01 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
46.86-9-02 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
46.87-7-01 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
47.12-1-00 |         0          2 |         2 
           |      0.00       0.21 |      0.21 
-----------+----------------------+----------
47.29-6-99 |         8          0 |         8 
           |      0.86       0.00 |      0.86 
-----------+----------------------+----------
47.44-0-01 |         0          6 |         6 
           |      0.00       0.64 |      0.64 
-----------+----------------------+----------
47.44-0-99 |         0          5 |         5 
           |      0.00       0.54 |      0.54 
-----------+----------------------+----------
47.51-2-01 |        30         16 |        46 
           |      3.22       1.72 |      4.94 
-----------+----------------------+----------
47.52-1-00 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
47.53-9-00 |         4          0 |         4 
           |      0.43       0.00 |      0.43 
-----------+----------------------+----------
47.54-7-01 |         7          2 |         9 
           |      0.75       0.21 |      0.97 
-----------+----------------------+----------
47.59-8-99 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
47.89-0-05 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
47.89-0-09 |         3          0 |         3 
           |      0.32       0.00 |      0.32 
-----------+----------------------+----------
47.89-0-99 |         4          0 |         4 
           |      0.43       0.00 |      0.43 
-----------+----------------------+----------
49.21-3-01 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
52.40-1-01 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
56.11-2-01 |         7          0 |         7 
           |      0.75       0.00 |      0.75 
-----------+----------------------+----------
56.20-1-01 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
59.11-1-99 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
61.10-8-01 |         6          5 |        11 
           |      0.64       0.54 |      1.18 
-----------+----------------------+----------
61.10-8-03 |         3          3 |         6 
           |      0.32       0.32 |      0.64 
-----------+----------------------+----------
61.20-5-01 |         6          0 |         6 
           |      0.64       0.00 |      0.64 
-----------+----------------------+----------
61.20-5-02 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
61.90-6-99 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
62.01-5-01 |        24          7 |        31 
           |      2.58       0.75 |      3.33 
-----------+----------------------+----------
62.02-3-00 |        15          0 |        15 
           |      1.61       0.00 |      1.61 
-----------+----------------------+----------
62.03-1-00 |        17          8 |        25 
           |      1.83       0.86 |      2.69 
-----------+----------------------+----------
62.04-0-00 |        51          0 |        51 
           |      5.48       0.00 |      5.48 
-----------+----------------------+----------
62.09-1-00 |        44         29 |        73 
           |      4.73       3.11 |      7.84 
-----------+----------------------+----------
63.11-9-00 |         3          0 |         3 
           |      0.32       0.00 |      0.32 
-----------+----------------------+----------
63.19-4-00 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
63.99-2-00 |         0          2 |         2 
           |      0.00       0.21 |      0.21 
-----------+----------------------+----------
66.13-4-00 |         0          5 |         5 
           |      0.00       0.54 |      0.54 
-----------+----------------------+----------
66.21-5-02 |         0          6 |         6 
           |      0.00       0.64 |      0.64 
-----------+----------------------+----------
70.20-4-00 |         9          0 |         9 
           |      0.97       0.00 |      0.97 
-----------+----------------------+----------
71.11-1-00 |         1          0 |         1 
           |      0.11       0.00 |      0.11 
-----------+----------------------+----------
71.12-0-00 |        21          4 |        25 
           |      2.26       0.43 |      2.69 
-----------+----------------------+----------
73.11-4-00 |         0          3 |         3 
           |      0.00       0.32 |      0.32 
-----------+----------------------+----------
73.20-3-00 |         3          0 |         3 
           |      0.32       0.00 |      0.32 
-----------+----------------------+----------
74.20-0-04 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
74.90-1-04 |         1          5 |         6 
           |      0.11       0.54 |      0.64 
-----------+----------------------+----------
74.90-1-99 |         0          4 |         4 
           |      0.00       0.43 |      0.43 
-----------+----------------------+----------
77.33-1-00 |         6          3 |         9 
           |      0.64       0.32 |      0.97 
-----------+----------------------+----------
77.39-0-03 |         4          0 |         4 
           |      0.43       0.00 |      0.43 
-----------+----------------------+----------
77.39-0-99 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
78.10-8-00 |         6          0 |         6 
           |      0.64       0.00 |      0.64 
-----------+----------------------+----------
78.20-5-00 |         8          0 |         8 
           |      0.86       0.00 |      0.86 
-----------+----------------------+----------
78.30-2-00 |        10         15 |        25 
           |      1.07       1.61 |      2.69 
-----------+----------------------+----------
79.11-2-00 |        20          0 |        20 
           |      2.15       0.00 |      2.15 
-----------+----------------------+----------
80.11-1-01 |         9         11 |        20 
           |      0.97       1.18 |      2.15 
-----------+----------------------+----------
81.21-4-00 |         4          8 |        12 
           |      0.43       0.86 |      1.29 
-----------+----------------------+----------
81.29-0-00 |         6          0 |         6 
           |      0.64       0.00 |      0.64 
-----------+----------------------+----------
81.30-3-00 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
82.11-3-00 |        15          0 |        15 
           |      1.61       0.00 |      1.61 
-----------+----------------------+----------
82.20-2-00 |        12          9 |        21 
           |      1.29       0.97 |      2.26 
-----------+----------------------+----------
82.30-0-01 |        20          0 |        20 
           |      2.15       0.00 |      2.15 
-----------+----------------------+----------
82.99-7-99 |        11          0 |        11 
           |      1.18       0.00 |      1.18 
-----------+----------------------+----------
85.31-7-00 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
85.32-5-00 |         3          0 |         3 
           |      0.32       0.00 |      0.32 
-----------+----------------------+----------
85.50-3-02 |         2          3 |         5 
           |      0.21       0.32 |      0.54 
-----------+----------------------+----------
85.93-7-00 |         0          6 |         6 
           |      0.00       0.64 |      0.64 
-----------+----------------------+----------
85.99-6-04 |         5          0 |         5 
           |      0.54       0.00 |      0.54 
-----------+----------------------+----------
86.30-5-06 |         4          0 |         4 
           |      0.43       0.00 |      0.43 
-----------+----------------------+----------
86.50-0-01 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
86.60-7-00 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
88.00-6-00 |         6          0 |         6 
           |      0.64       0.00 |      0.64 
-----------+----------------------+----------
90.01-9-02 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
93.19-1-01 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
94.30-8-00 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
94.99-5-00 |         6          0 |         6 
           |      0.64       0.00 |      0.64 
-----------+----------------------+----------
96.01-7-01 |         2          0 |         2 
           |      0.21       0.00 |      0.21 
-----------+----------------------+----------
     Total |       651        280 |       931 
           |     69.92      30.08 |    100.00 

. 
. 
. */*******************************************************************************
> 1.2 – Winsorização das variáveis contínuas (antes da imputação)
> *******************************************************************************/
. 
. ssc install winsor2, replace
checking winsor2 consistency and verifying not already installed...
all files already exist and are up to date.

. local winsor_vars LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato

. 
. foreach var of local winsor_vars {
  2.     winsor2 `var', cuts(1 99) replace
  3. }

. 
. /*******************************************************************************
> 1.3 - Executar estatísticas descritivas para todas as variáveis após wisorização
> *******************************************************************************/
. summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        931     11.2109     40.6634        .21     327.68
    LiqGeral |        931    7.981676    26.20506        .19      204.2
 LiqCorAjust |        931    .4298598    .2977401      -.518      .9979
   SolvGeral |        931    10.50537    38.22939        .34     327.68
    EndGeral |        931    1.372216    2.328307    -5.2517    13.0224
-------------+---------------------------------------------------------
 CompEndivid |        931    .7855506    .2546734      .0217          1
    IndepFin |        931    9.511547    38.22731     -.2514    326.675
    ImobilPL |        931    .2888404    .4358922     -.2471     2.8281
   ImobRecNC |        931    .2067792     .243615          0      .9662
 PtpCapTerce |        931    1.372216    2.328307    -5.2517    13.0224
-------------+---------------------------------------------------------
   GiroAtivo |        931    1.517332    1.306511          0     6.0238
      MargOp |        931    .4308339    .3388786     -.0351          1
     MargLiq |        931    .0973164    .3363066    -1.9653     1.0026
         ROI |        931     .178735     .325961     -.3632     1.9876
         ROE |        931    .3388057    .6602208    -1.1287     4.4129
-------------+---------------------------------------------------------
 vlrcontrato |        336    1.23e+07    2.52e+07      32820   1.34e+08
QtdeCNAEsS~s |        931    15.39527    14.31003          1         97
 IdadedeAnos |        931    22.64656    10.94995   .5041096   58.89315
QtePenalOu~s |        931    5.508056    20.42007          0        201

. 
. * Estatísticas descritivas separadas por penalização
. by FoiPenalizadoSTJ, sort: summarize LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrga
> os

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        651    13.15008    44.33276        .21     327.68
    LiqGeral |        651    9.058894    28.07785        .19      204.2
 LiqCorAjust |        651    .4344398     .300393      -.518      .9979
   SolvGeral |        651    12.03048    41.15147        .34     327.68
    EndGeral |        651    1.362274    2.294265    -5.2517    13.0224
-------------+---------------------------------------------------------
 CompEndivid |        651    .7868066     .264475      .0217          1
    IndepFin |        651    11.03625    41.14937     -.2514    326.675
    ImobilPL |        651    .3109705    .4539883     -.2471     2.8281
   ImobRecNC |        651    .2192498    .2475562          0      .9662
 PtpCapTerce |        651    1.362274    2.294265    -5.2517    13.0224
-------------+---------------------------------------------------------
   GiroAtivo |        651    1.471473    1.290879          0     6.0238
      MargOp |        651    .4372518    .3378751     -.0351          1
     MargLiq |        651    .1084555    .3322532    -1.9653     1.0026
         ROI |        651    .1949458    .3524576     -.3632     1.9876
         ROE |        651    .3634088    .6923151    -1.1287     4.4129
-------------+---------------------------------------------------------
 vlrcontrato |        206    1.06e+07    2.08e+07      73284   8.19e+07
QtdeCNAEsS~s |        651    16.07834    15.09799          1         97
 IdadedeAnos |        651    22.42379    11.07274   .5041096   58.89315
QtePenalOu~s |        651    4.102919    19.68491          0        201

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> FoiPenalizadoSTJ = 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 LiqCorrente |        280    6.702321    30.06092        .21     327.68
    LiqGeral |        280    5.477143    21.05516        .19      204.2
 LiqCorAjust |        280    .4192114    .2917316      -.518      .9979
   SolvGeral |        280      6.9595    30.13764        .34     327.68
    EndGeral |        280    1.395331    2.409623    -5.2517    13.0224
-------------+---------------------------------------------------------
 CompEndivid |        280    .7826304     .230703      .0217          1
    IndepFin |        280    5.966618    30.13568     -.2514    326.675
    ImobilPL |        280    .2373879    .3864801     -.2471     2.8281
   ImobRecNC |        280     .177785    .2320442          0      .9662
 PtpCapTerce |        280    1.395331    2.409623    -5.2517    13.0224
-------------+---------------------------------------------------------
   GiroAtivo |        280    1.623954    1.338422          0     6.0238
      MargOp |        280    .4159125      .34134     -.0351          1
     MargLiq |        280    .0714182    .3447585    -1.9653     1.0026
         ROI |        280     .141045    .2504266     -.3632     1.6018
         ROE |        280    .2816036      .57587    -1.1287     4.4129
-------------+---------------------------------------------------------
 vlrcontrato |        130    1.49e+07    3.07e+07      32820   1.34e+08
QtdeCNAEsS~s |        280    13.80714    12.16163          1         58
 IdadedeAnos |        280    23.16451    10.66048   3.482192   58.73151
QtePenalOu~s |        280       8.775      21.722          0        166


. 
. * Bloco para salvar as estatísticas descritivas após a winsorização por grupo
. tabstat LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE vlrcontrato QtdeCNAEsSecundarios IdadedeAnos QtePenalOutrosOrgaos, ///
>     statistics(mean sd min max n) by(FoiPenalizadoSTJ)

Summary statistics: Mean, SD, Min, Max, N
Group variable: FoiPenalizadoSTJ (FoiPenalizadoSTJ)

FoiPenalizadoSTJ |  LiqCor~e  LiqGeral  LiqCor~t  SolvGe~l  EndGeral  CompEn~d  IndepFin  ImobilPL  ImobRe~C  PtpCap~e  GiroAt~o    MargOp   MargLiq       ROI       ROE  vlrcon~o  QtdeCN~s  Idaded~s  QtePen~s
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
               0 |  13.15008  9.058894  .4344398  12.03048  1.362274  .7868066  11.03625  .3109705  .2192498  1.362274  1.471473  .4372518  .1084555  .1949458  .3634088  1.06e+07  16.07834  22.42379  4.102919
                 |  44.33276  28.07785   .300393  41.15147  2.294265   .264475  41.14937  .4539883  .2475562  2.294265  1.290879  .3378751  .3322532  .3524576  .6923151  2.08e+07  15.09799  11.07274  19.68491
                 |       .21       .19     -.518       .34   -5.2517     .0217    -.2514    -.2471         0   -5.2517         0    -.0351   -1.9653    -.3632   -1.1287     73284         1  .5041096         0
                 |    327.68     204.2     .9979    327.68   13.0224         1   326.675    2.8281     .9662   13.0224    6.0238         1    1.0026    1.9876    4.4129  8.19e+07        97  58.89315       201
                 |       651       651       651       651       651       651       651       651       651       651       651       651       651       651       651       206       651       651       651
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
               1 |  6.702321  5.477143  .4192114    6.9595  1.395331  .7826304  5.966618  .2373879   .177785  1.395331  1.623954  .4159125  .0714182   .141045  .2816036  1.49e+07  13.80714  23.16451     8.775
                 |  30.06092  21.05516  .2917316  30.13764  2.409623   .230703  30.13568  .3864801  .2320442  2.409623  1.338422    .34134  .3447585  .2504266    .57587  3.07e+07  12.16163  10.66048    21.722
                 |       .21       .19     -.518       .34   -5.2517     .0217    -.2514    -.2471         0   -5.2517         0    -.0351   -1.9653    -.3632   -1.1287     32820         1  3.482192         0
                 |    327.68     204.2     .9979    327.68   13.0224         1   326.675    2.8281     .9662   13.0224    6.0238         1    1.0026    1.6018    4.4129  1.34e+08        58  58.73151       166
                 |       280       280       280       280       280       280       280       280       280       280       280       280       280       280       280       130       280       280       280
-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
           Total |   11.2109  7.981676  .4298598  10.50537  1.372216  .7855506  9.511547  .2888404  .2067792  1.372216  1.517332  .4308339  .0973164   .178735  .3388057  1.23e+07  15.39527  22.64656  5.508056
                 |   40.6634  26.20506  .2977401  38.22939  2.328307  .2546734  38.22731  .4358922   .243615  2.328307  1.306511  .3388786  .3363066   .325961  .6602208  2.52e+07  14.31003  10.94995  20.42007
                 |       .21       .19     -.518       .34   -5.2517     .0217    -.2514    -.2471         0   -5.2517         0    -.0351   -1.9653    -.3632   -1.1287     32820         1  .5041096         0
                 |    327.68     204.2     .9979    327.68   13.0224         1   326.675    2.8281     .9662   13.0224    6.0238         1    1.0026    1.9876    4.4129  1.34e+08        97  58.89315       201
                 |       931       931       931       931       931       931       931       931       931       931       931       931       931       931       931       336       931       931       931
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

. 
. /*******************************************************************************
> 1.4 - Transformação de variáveis 
> *******************************************************************************/
. * NÃO gerar dummies ainda — manter Porte, CNAE e NaturezaJuridica para o SMOTENC
. 
. * Ajuste apenas valores de variáveis contínuas
. replace vlrcontrato = 1 if vlrcontrato == 0 | vlrcontrato == .
(595 real changes made)

. gen log_vlrcontrato = log(vlrcontrato)

. 
. * Dropar CNPJ antes de exportar
. drop CNPJ

. 
. 
. /*******************************************************************************
> ETAPA 2 - IMPUTAÇÃO DOS VALORES FALTANTES (MISSING) COM MÉDIA OU MEDIANA
> *******************************************************************************/
. 
. * Lista de variáveis com dados faltantes para imputação
. local imput_vars GiroAtivo MargOp MargLiq ROI ROE RecBruta LucroBruto LucroLiquido

. 
. * Inicializar contadores
. local conta_media = 0

. local conta_mediana = 0

. 
. * Imputação adaptativa: média se CV <= 0.3, mediana se CV > 0.3
. foreach var of local imput_vars {
  2.     
.     quietly summarize `var' if `var' > 0, detail
  3.     local media = r(mean)
  4.     local desvio = r(sd)
  5.     local mediana = r(p50)
  6. 
.     * Calcular o Coeficiente de Variação (CV)
.     local cv = `desvio' / `media'
  7. 
.     * Escolher método conforme o CV
.     if `cv' <= 0.3 {
  8.         replace `var' = `media' if missing(`var') | `var' == 0
  9.         local conta_media = `conta_media' + 1
 10.         di as result "🔧 `var': imputado com MÉDIA (CV = " %4.3f `cv' ")"
 11.     }
 12.     else {
 13.         replace `var' = `mediana' if missing(`var') | `var' == 0
 14.         local conta_mediana = `conta_mediana' + 1
 15.         di as result "🔧 `var': imputado com MEDIANA (CV = " %4.3f `cv' ")"
 16.     }
 17. }
(98 real changes made)
🔧 GiroAtivo: imputado com MEDIANA (CV = 0.747)
(137 real changes made)
🔧 MargOp: imputado com MEDIANA (CV = 0.597)
(100 real changes made)
🔧 MargLiq: imputado com MEDIANA (CV = 1.172)
(80 real changes made)
🔧 ROI: imputado com MEDIANA (CV = 1.366)
(80 real changes made)
🔧 ROE: imputado com MEDIANA (CV = 1.442)
(97 real changes made)
🔧 RecBruta: imputado com MEDIANA (CV = 6.666)
(127 real changes made)
🔧 LucroBruto: imputado com MEDIANA (CV = 7.204)
(79 real changes made)
🔧 LucroLiquido: imputado com MEDIANA (CV = 7.812)

. 
. * Exibir tabela resumo
. di as text "═══════════════════════════════════════════════════════════════"
═══════════════════════════════════════════════════════════════

. di as text " Resumo da Imputação de Variáveis (Critério: CV <= 0.3 → MÉDIA)"
 Resumo da Imputação de Variáveis (Critério: CV <= 0.3 → MÉDIA)

. di as text "───────────────────────────────────────────────────────────────"
───────────────────────────────────────────────────────────────

. di " Variáveis imputadas com MÉDIA:   `conta_media'"
 Variáveis imputadas com MÉDIA:   0

. di " Variáveis imputadas com MEDIANA: `conta_mediana'"
 Variáveis imputadas com MEDIANA: 8

. di as text " Total de variáveis imputadas:    " `=`conta_media' + `conta_mediana''
 Total de variáveis imputadas:    8

. di as text "═══════════════════════════════════════════════════════════════"
═══════════════════════════════════════════════════════════════

. 
. 
. /*******************************************************************************
> ETAPA 3 - SEPARAÇÃO DOS DADOS EM CONJUNTOS DE TREINAMENTO E TESTE COM PROPORÇÕES EXATAS
> *******************************************************************************/
. * Definir uma seed para reprodutibilidade
. set seed 12345

. 
. * Gerar uma variável aleatória uniforme entre 0 e 1
. generate u = runiform()

. 
. * Ordenar aleatoriamente dentro de cada classe
. sort FoiPenalizadoSTJ u

. 
. * Gerar índices de observação dentro de cada classe
. by FoiPenalizadoSTJ: gen obs_no = _n

. by FoiPenalizadoSTJ: gen total_obs = _N

. 
. * Calcular o ponto de corte para 80% das observações
. by FoiPenalizadoSTJ: gen cutoff = ceil(0.80 * total_obs)

. 
. * Criar o indicador de treinamento
. gen train = 0

. replace train = 1 if obs_no <= cutoff
(745 real changes made)

. 
. * Verificar distribuição antes do SMOTE
. tabulate FoiPenalizadoSTJ train

FoiPenaliz |         train
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       130        521 |       651 
         1 |        56        224 |       280 
-----------+----------------------+----------
     Total |       186        745 |       931 

. 
. /*******************************************************************************
> ETAPA 3.1 - SALVAR OS LABELS PARA RESTAURAR DEPOIS DO SMOTE
> *******************************************************************************/
. * Criar um arquivo temporário para armazenar labels
. tempfile labels_backup

. label save using "`labels_backup'.do", replace
file C:\Users\morenos\AppData\Local\Temp\ST_3564_000001.tmp.do saved

. 
. /*******************************************************************************
> ETAPA 3.2 - EXPORTAR BASES PARA O PYTHON (TREINO PARA SMOTE, TESTE SEPARADO)
> *******************************************************************************/
. * Exportar conjunto de treino
. preserve

. keep if train == 1
(186 observations deleted)

. export delimited using "train_data.csv", replace
file train_data.csv saved

. restore

. 
. * Exportar conjunto de teste
. preserve

. keep if train == 0
(745 observations deleted)

. export delimited using "test_data.csv", replace
file test_data.csv saved

. restore

. 
. /*******************************************************************************
> ETAPA 4 - APLICAR SMOTENC NO PYTHON
> *******************************************************************************/
. python:
----------------------------------------------- python (type end to exit) ---------------------------------------------------------------------------------------------------------------------------------------------------------------------
>>> import pandas as pd
>>> import numpy as np
>>> from imblearn.over_sampling import SMOTENC
>>> import traceback  # Para melhor tratamento de erros
>>> 
>>> print("--- Iniciando Bloco Python ---")
--- Iniciando Bloco Python ---
>>> try:
...     # Carregar conjunto de treino do Stata
...     print("Carregando train_data.csv...")
...     df = pd.read_csv("train_data.csv")
...     print(f"Dados carregados: {df.shape[0]} linhas, {df.shape[1]} colunas")
...     print("Colunas originais:", df.columns.tolist())
...     print("Contagem inicial de 'FoiPenalizadoSTJ':\n", df["FoiPenalizadoSTJ"].value_counts())
... 
...     # Separar variável-alvo e explicativas
...     X = df.drop(columns=["FoiPenalizadoSTJ", "train"], errors="ignore")
...     y = df["FoiPenalizadoSTJ"]
... 
...     # Definir variáveis categóricas PELOS NOMES (mais robusto)
...     categorical_feature_names = ['Porte', 'CNAE', 'DivisaoCNAE', 'NaturezaJuridica']
... 
...     # Verificar se as colunas existem em X
...     missing_cols = [col for col in categorical_feature_names if col not in X.columns]
...     if missing_cols:
...         raise ValueError(f"As seguintes colunas categóricas não foram encontradas em X: {missing_cols}")
... 
...     # Obter os índices das colunas categóricas
...     categorical_features_indices = [X.columns.get_loc(col) for col in categorical_feature_names]
...     print(f"Índices das features categóricas: {categorical_features_indices}")
...     print("Tipos das features categóricas em X:\n", X[categorical_feature_names].dtypes)
... 
...     # Ajustar k_neighbors: deve ser menor que o número de amostras da classe minoritária
...     min_class_count = y.value_counts().min()
...     k_neighbors_val = min(5, min_class_count - 1)
...     if k_neighbors_val < 1:
...         print(f"AVISO: Classe minoritária tem apenas {min_class_count} amostras. Não é possível aplicar SMOTENC com k_neighbors >= 1.")
...         raise ValueError(f"Não é possível aplicar SMOTENC, k_neighbors ({k_neighbors_val}) seria menor que 1.")
...     else:
...         print(f"Aplicando SMOTENC com k_neighbors={k_neighbors_val}...")
...         smote_nc = SMOTENC(categorical_features=categorical_features_indices,
...                            random_state=42,
...                            k_neighbors=k_neighbors_val)
... 
...         X_resampled, y_resampled = smote_nc.fit_resample(X, y)
...         print("SMOTENC concluído.")
...         print(f"Tamanho após resample: {X_resampled.shape[0]} linhas")
...         print("Contagem de 'FoiPenalizadoSTJ' após resample:\n", pd.Series(y_resampled).value_counts())
... 
...         # Criar DataFrame balanceado a partir do resultado do SMOTENC
...         df_resampled = pd.DataFrame(X_resampled, columns=X.columns)
... 
...         # Adicionar a variável alvo e a marcação de treino
...         df_resampled["FoiPenalizadoSTJ"] = y_resampled
...         df_resampled["train"] = 1
... 
...         # Verificar se as colunas categóricas foram mantidas
...         print("Colunas no df_resampled final:", df_resampled.columns.tolist())
...         missing_cols_after = [col for col in categorical_feature_names if col not in df_resampled.columns]
...         if missing_cols_after:
...             print(f"AVISO: As colunas {missing_cols_after} NÃO estão presentes após SMOTENC!")
...         else:
...             print("Colunas categóricas presentes após SMOTENC.")
...             print("Tipos das features categóricas após SMOTENC:\n", df_resampled[categorical_feature_names].dtypes)
...             print("Primeiras linhas do df_resampled:\n", df_resampled.head())
... 
...         # 🔁 Converter variáveis categóricas e salvar mapeamentos
...         print("Convertendo variáveis categóricas do treino para códigos numéricos e salvando mapeamentos...")
... 
...         categorical_mappings = {}
... 
...         for col in categorical_feature_names:
...             df_resampled[col] = df_resampled[col].astype("category")
... 
...             # Salvar mapeamento antes de converter para códigos
...             mapping = dict(enumerate(df_resampled[col].cat.categories))
...             categorical_mappings[col] = mapping
... 
...             # Substituir coluna por códigos numéricos
...             df_resampled[col] = df_resampled[col].cat.codes
... 
...             # Exportar mapeamento para CSV
...             mapping_df = pd.DataFrame(mapping.items(), columns=[f"{col}_code", f"{col}_label"])
...             mapping_df.to_csv(f"{col}_mapping.csv", index=False, encoding="utf-8")
...             print(f"✅ Mapeamento salvo: {col}_mapping.csv")
... 
...         print("Conversão no treino concluída.")
... 
...     # Salvar dataset balanceado em CSV (codificado em UTF-8)
...     print("Salvando train_data_balanced.csv...")
...     df_resampled.to_csv("train_data_balanced.csv", index=False, encoding='utf-8')
...     print("Arquivo train_data_balanced.csv salvo com sucesso.")
... 
...     # ────────────────────────────────────────────────────────────────────────
...     # ✅ ETAPA EXTRA: Converter variáveis categóricas do conjunto de teste com os mesmos códigos do treino
...     print("Carregando test_data.csv para conversão das variáveis categóricas...")
...     df_test = pd.read_csv("test_data.csv")
...     print(f"Conjunto de teste carregado: {df_test.shape[0]} linhas")
... 
...     # Verificar se as colunas categóricas estão presentes
...     missing_test_cols = [col for col in categorical_feature_names if col not in df_test.columns]
...     if missing_test_cols:
...         raise ValueError(f"⚠️ Colunas categóricas ausentes no teste: {missing_test_cols}")
... 
...     print("Aplicando os mesmos mapeamentos do treino ao conjunto de teste...")
... 
...     for col in categorical_feature_names:
...         mapping_df = pd.read_csv(f"{col}_mapping.csv", encoding="utf-8")
...         mapping_dict = dict(zip(mapping_df[f"{col}_label"], mapping_df[f"{col}_code"]))
... 
...         # Aplicar o mapeamento manualmente
...         df_test[col] = df_test[col].map(mapping_dict)
... 
...         # Se houver valores não encontrados no mapeamento, definir como -1
...         df_test[col] = df_test[col].fillna(-1).astype(int)
... 
...         print(f"✅ Coluna '{col}' convertida com mapeamento do treino.")
... 
...     # Salvar novamente o arquivo convertido
...     df_test.to_csv("test_data.csv", index=False, encoding="utf-8")
...     print("Arquivo test_data.csv salvo com sucesso após conversão.")
... 
... except Exception as e:
...     print("--- ERRO NO BLOCO PYTHON ---")
...     print(traceback.format_exc())
...     pd.DataFrame().to_csv("train_data_balanced.csv", index=False)
...     print("Arquivo train_data_balanced.csv vazio criado devido a erro.")
... 
Carregando train_data.csv...
Dados carregados: 745 linhas, 43 colunas
Colunas originais: ['FoiPenalizadoSTJ', 'Porte', 'LiqCorrente', 'LiqGeral', 'LiqCorAjust', 'SolvGeral', 'EndGeral', 'CompEndivid', 'IndepFin', 'ImobilPL', 'ImobRecNC', 'PtpCapTerce', 'GiroAtivo', 'MargOp', 'MargLiq', 'ROI', 'ROE', 'AC', 'A
> NRP', 'Investimentos', 'Imobilizado', 'Intangivel', 'PC', 'PNC', 'PL', 'RecBruta', 'LucroBruto', 'LucroLiquido', 'QtePenalOutrosOrgaos', 'vlrcontrato', 'IdadedeAnos', 'CNAE', 'DivisaoCNAE', 'NaturezaJuridica', 'QtdeCNAEsSecundarios', 'An
> odasDemonstracões', 'cnpjs', 'log_vlrcontrato', 'u', 'obs_no', 'total_obs', 'cutoff', 'train']
Contagem inicial de 'FoiPenalizadoSTJ':
 FoiPenalizadoSTJ
0    521
1    224
Name: count, dtype: int64
Índices das features categóricas: [0, 30, 31, 32]
Tipos das features categóricas em X:
 Porte               object
CNAE                object
DivisaoCNAE          int64
NaturezaJuridica    object
dtype: object
Aplicando SMOTENC com k_neighbors=5...
SMOTENC concluído.
Tamanho após resample: 1042 linhas
Contagem de 'FoiPenalizadoSTJ' após resample:
 FoiPenalizadoSTJ
0    521
1    521
Name: count, dtype: int64
Colunas no df_resampled final: ['Porte', 'LiqCorrente', 'LiqGeral', 'LiqCorAjust', 'SolvGeral', 'EndGeral', 'CompEndivid', 'IndepFin', 'ImobilPL', 'ImobRecNC', 'PtpCapTerce', 'GiroAtivo', 'MargOp', 'MargLiq', 'ROI', 'ROE', 'AC', 'ANRP', 'I
> nvestimentos', 'Imobilizado', 'Intangivel', 'PC', 'PNC', 'PL', 'RecBruta', 'LucroBruto', 'LucroLiquido', 'QtePenalOutrosOrgaos', 'vlrcontrato', 'IdadedeAnos', 'CNAE', 'DivisaoCNAE', 'NaturezaJuridica', 'QtdeCNAEsSecundarios', 'AnodasDemo
> nstracões', 'cnpjs', 'log_vlrcontrato', 'u', 'obs_no', 'total_obs', 'cutoff', 'FoiPenalizadoSTJ', 'train']
Colunas categóricas presentes após SMOTENC.
Tipos das features categóricas após SMOTENC:
 Porte               object
CNAE                object
DivisaoCNAE          int64
NaturezaJuridica    object
dtype: object
Primeiras linhas do df_resampled:
                      Porte  LiqCorrente  ...  FoiPenalizadoSTJ  train
0          PEQUENA EMPRESA         2.08  ...                 0      1
1  EMPRESA DE GRANDE PORTE         1.47  ...                 0      1
2          PEQUENA EMPRESA         3.55  ...                 0      1
3          PEQUENA EMPRESA         3.41  ...                 0      1
4  EMPRESA DE GRANDE PORTE         0.97  ...                 0      1

[5 rows x 43 columns]
Convertendo variáveis categóricas do treino para códigos numéricos e salvando mapeamentos...
✅ Mapeamento salvo: Porte_mapping.csv
✅ Mapeamento salvo: CNAE_mapping.csv
✅ Mapeamento salvo: DivisaoCNAE_mapping.csv
✅ Mapeamento salvo: NaturezaJuridica_mapping.csv
Conversão no treino concluída.
Salvando train_data_balanced.csv...
Arquivo train_data_balanced.csv salvo com sucesso.
Carregando test_data.csv para conversão das variáveis categóricas...
Conjunto de teste carregado: 186 linhas
Aplicando os mesmos mapeamentos do treino ao conjunto de teste...
✅ Coluna 'Porte' convertida com mapeamento do treino.
✅ Coluna 'CNAE' convertida com mapeamento do treino.
✅ Coluna 'DivisaoCNAE' convertida com mapeamento do treino.
✅ Coluna 'NaturezaJuridica' convertida com mapeamento do treino.
Arquivo test_data.csv salvo com sucesso após conversão.
>>> print("--- Fim Bloco Python ---")
--- Fim Bloco Python ---
>>> end
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

. 
. 
. /*******************************************************************************
> ETAPA 5 - IMPORTAR NOVO CONJUNTO DE TREINO BALANCEADO NO STATA
> *******************************************************************************/
. clear

. * Adicionado varnames(1) e case(preserve)
. import delimited "train_data_balanced.csv", varnames(1) case(preserve) clear encoding("UTF-8")
(43 vars, 1,042 obs)

. 
. * Verificar se as variáveis existem após a importação
. describe Porte CNAE DivisaoCNAE NaturezaJuridica 

Variable      Storage   Display    Value
    name         type    format    label      Variable label
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Porte           byte    %8.0g                 
CNAE            int     %8.0g                 
DivisaoCNAE     byte    %8.0g                 
NaturezaJurid~a byte    %8.0g                 

. 
. * Restaurar labels originais corretamente
. * Certifique-se que os labels ainda são aplicáveis. SMOTE pode alterar a natureza dos dados.
. * Considere recriar labels se necessário, ou pular esta etapa se causar problemas.
. capture do "`labels_backup'.do"

. 
. if _rc != 0 {
.     di as error "⚠️ Falha ao restaurar labels. Verificar compatibilidade após SMOTE."
. }

. else {
.     di as text "✅ Labels restaurados com sucesso após SMOTE."
✅ Labels restaurados com sucesso após SMOTE.
. }

. 
. * Verificar balanceamento do conjunto de treino
. tabulate FoiPenalizadoSTJ train

FoiPenaliz |   train
    adoSTJ |         1 |     Total
-----------+-----------+----------
         0 |       521 |       521 
         1 |       521 |       521 
-----------+-----------+----------
     Total |     1,042 |     1,042 

. 
. /*******************************************************************************
> ETAPA 5.1 – IMPORTAR CONJUNTO DE TESTE E JUNTAR À BASE DE TREINO BALANCEADO
> *******************************************************************************/
. * Passo 1 – Importar o conjunto de teste separadamente e salvar como temporário
. clear

. * Adicionado case(preserve)
. import delimited "test_data.csv", varnames(1) case(preserve) encoding("UTF-8")
(43 vars, 186 obs)

. tempfile testdata

. save `testdata', replace // Adicionado replace para segurança
(file C:\Users\morenos\AppData\Local\Temp\ST_3564_000004.tmp not found)
file C:\Users\morenos\AppData\Local\Temp\ST_3564_000004.tmp saved as .dta format

. 
. * Passo 2 – Agora importar o treino balanceado
. clear

. * Adicionado varnames(1) e case(preserve)
. import delimited "train_data_balanced.csv", varnames(1) case(preserve) clear encoding("UTF-8")
(43 vars, 1,042 obs)

. 
. * Passo 3 – Restaurar os labels originais (novamente, verificar necessidade/compatibilidade)
. capture do "`labels_backup'.do"

. if _rc != 0 {
.     di as error "Falha ao restaurar labels. Verificar compatibilidade após SMOTE."
. }

. 
. * Passo 4 – Juntar com o conjunto de teste
. * Verificar se as variáveis categóricas existem antes de juntar
. describe Porte CNAE DivisaoCNAE NaturezaJuridica

Variable      Storage   Display    Value
    name         type    format    label      Variable label
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Porte           byte    %8.0g                 
CNAE            int     %8.0g                 
DivisaoCNAE     byte    %8.0g                 
NaturezaJurid~a byte    %8.0g                 

. append using `testdata'

. 
. * Passo 5 – Verificar a distribuição final por treino/teste
. tabulate FoiPenalizadoSTJ train

FoiPenaliz |         train
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       130        521 |       651 
         1 |        56        521 |       577 
-----------+----------------------+----------
     Total |       186      1,042 |     1,228 

. 
. * Verificar se as variáveis existem após o append
. describe Porte CNAE DivisaoCNAE NaturezaJuridica

Variable      Storage   Display    Value
    name         type    format    label      Variable label
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Porte           byte    %8.0g                 
CNAE            int     %8.0g                 
DivisaoCNAE     byte    %8.0g                 
NaturezaJurid~a byte    %8.0g                 

. 
. /*******************************************************************************
> ETAPA 5.1.1 – AGRUPAMENTO DE CNAEs RAROS (CATEGORIAS COM POUCA FREQUÊNCIA)
> *******************************************************************************/
. 
. * Define o mínimo de ocorrências para manter CNAE como categoria isolada
. local freq_minima = 10

. 
. * Cria um grupo especial para CNAEs com baixa frequência
. preserve

. 
. * Guardar versão original, caso queira rastrear depois
. gen CNAE_original = CNAE 

. 
. * Gerar mapa de frequência dos CNAEs
. contract CNAE

. gen CNAE_agrupado = CNAE

. replace CNAE_agrupado = -1 if _freq < `freq_minima'
(71 real changes made)

. tempfile freqmap

. save `freqmap', replace
(file C:\Users\morenos\AppData\Local\Temp\ST_3564_000006.tmp not found)
file C:\Users\morenos\AppData\Local\Temp\ST_3564_000006.tmp saved as .dta format

. 
. restore

. 
. * Aplicar o agrupamento via merge (sem 'nogen' para capturar _merge)
. merge m:1 CNAE using `freqmap', keep(master match)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             1,228  (_merge==3)
    -----------------------------------------

. 
. * Substituir CNAE por CNAE_agrupado apenas onde houver correspondência
. replace CNAE = CNAE_agrupado if _merge == 3
(257 real changes made)

. drop _merge CNAE_agrupado _freq

. 
. * Verifica distribuição após o agrupamento
. tabulate CNAE

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |        265       21.58       21.58
          3 |         10        0.81       22.39
          7 |         45        3.66       26.06
         10 |         10        0.81       26.87
         11 |         70        5.70       32.57
         13 |         15        1.22       33.79
         15 |         27        2.20       35.99
         16 |         20        1.63       37.62
         18 |         18        1.47       39.09
         28 |         11        0.90       39.98
         30 |         22        1.79       41.78
         32 |         54        4.40       46.17
         33 |         28        2.28       48.45
         42 |         19        1.55       50.00
         43 |         23        1.87       51.87
         44 |         66        5.37       57.25
         47 |         12        0.98       58.22
         57 |         11        0.90       59.12
         62 |         33        2.69       61.81
         63 |         15        1.22       63.03
         64 |         29        2.36       65.39
         65 |         51        4.15       69.54
         66 |         90        7.33       76.87
         70 |         15        1.22       78.09
         71 |         10        0.81       78.91
         73 |         27        2.20       81.11
         77 |         12        0.98       82.08
         78 |         16        1.30       83.39
         79 |         10        0.81       84.20
         84 |         32        2.61       86.81
         85 |         20        1.63       88.44
         86 |         27        2.20       90.64
         87 |         33        2.69       93.32
         90 |         15        1.22       94.54
         91 |         26        2.12       96.66
         92 |         20        1.63       98.29
         93 |         11        0.90       99.19
         97 |         10        0.81      100.00
------------+-----------------------------------
      Total |      1,228      100.00

. di as text "✅ Agrupamento de CNAEs raros concluído com base na frequência mínima de `freq_minima'."
✅ Agrupamento de CNAEs raros concluído com base na frequência mínima de 10.

. 
. 
. /*******************************************************************************
> ETAPA 5.2 – CONVERTER VARIÁVEIS CATEGÓRICAS PARA INTEIROS E GERAR DUMMIES (após SMOTENC)
> *******************************************************************************/
. * Arredondar valores para garantir categorias inteiras
. * Isso pode ser necessário se o Python/SMOTE as transformou em float, mas idealmente não deveria.
. * Adicione verificações para evitar erros se a variável não existir (embora agora deva existir)
. 
. capture confirm variable Porte

. if _rc == 0 {
.     replace Porte = round(Porte)
(0 real changes made)
. } 

. else {
.     di as error "Variável Porte ainda não encontrada antes do round!"
. }

. 
. capture confirm variable CNAE

. if _rc == 0 {
.     replace CNAE = round(CNAE)
(0 real changes made)
. } 

. else {
.     di as error "Variável CNAE não encontrada antes do round!"
. }

. 
. capture confirm variable NaturezaJuridica

. if _rc == 0 {
.     replace NaturezaJuridica = round(NaturezaJuridica)
(0 real changes made)
. } 

. else {
.     di as error "Variável NaturezaJuridica não encontrada antes do round!"
. }

. 
. 
. capture confirm variable DivisaoCNAE

. if _rc == 0 {
.     replace DivisaoCNAE = round(DivisaoCNAE)
(0 real changes made)
. } 

. else {
.     di as error "Variável DivisaoCNAE não encontrada antes do round!"
. }

. 
. * Gerar variáveis dummies
. * Adicione verificações aqui também
. capture confirm variable Porte

. if _rc == 0 {
.     tabulate Porte, generate(Porte_)

      Porte |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        130       10.59       10.59
          1 |        191       15.55       26.14
          2 |        141       11.48       37.62
          3 |        766       62.38      100.00
------------+-----------------------------------
      Total |      1,228      100.00
.     drop Porte // Dropar original apenas se as dummies foram criadas
. } 

. else {
.      di as error "Não foi possível gerar dummies para Porte."
. }

. 
. capture confirm variable CNAE

. if _rc == 0 {
.     tabulate CNAE, generate(CNAE_)

       CNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |        265       21.58       21.58
          3 |         10        0.81       22.39
          7 |         45        3.66       26.06
         10 |         10        0.81       26.87
         11 |         70        5.70       32.57
         13 |         15        1.22       33.79
         15 |         27        2.20       35.99
         16 |         20        1.63       37.62
         18 |         18        1.47       39.09
         28 |         11        0.90       39.98
         30 |         22        1.79       41.78
         32 |         54        4.40       46.17
         33 |         28        2.28       48.45
         42 |         19        1.55       50.00
         43 |         23        1.87       51.87
         44 |         66        5.37       57.25
         47 |         12        0.98       58.22
         57 |         11        0.90       59.12
         62 |         33        2.69       61.81
         63 |         15        1.22       63.03
         64 |         29        2.36       65.39
         65 |         51        4.15       69.54
         66 |         90        7.33       76.87
         70 |         15        1.22       78.09
         71 |         10        0.81       78.91
         73 |         27        2.20       81.11
         77 |         12        0.98       82.08
         78 |         16        1.30       83.39
         79 |         10        0.81       84.20
         84 |         32        2.61       86.81
         85 |         20        1.63       88.44
         86 |         27        2.20       90.64
         87 |         33        2.69       93.32
         90 |         15        1.22       94.54
         91 |         26        2.12       96.66
         92 |         20        1.63       98.29
         93 |         11        0.90       99.19
         97 |         10        0.81      100.00
------------+-----------------------------------
      Total |      1,228      100.00
.     drop CNAE
. } 

. else {
.      di as error "Não foi possível gerar dummies para CNAE."
. }

. 
. capture confirm variable DivisaoCNAE

. if _rc == 0 {
.     tabulate DivisaoCNAE, generate(DivisaoCNAE_)

DivisaoCNAE |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |          2        0.16        0.16
          0 |          1        0.08        0.24
          1 |          3        0.24        0.49
          2 |          6        0.49        0.98
          3 |         11        0.90        1.87
          4 |          7        0.57        2.44
          5 |          3        0.24        2.69
          6 |         44        3.58        6.27
          7 |         11        0.90        7.17
          8 |         71        5.78       12.95
          9 |         24        1.95       14.90
         10 |         86        7.00       21.91
         11 |          6        0.49       22.39
         12 |        165       13.44       35.83
         13 |        151       12.30       48.13
         14 |          2        0.16       48.29
         15 |          1        0.08       48.37
         16 |          8        0.65       49.02
         17 |          2        0.16       49.19
         18 |         26        2.12       51.30
         19 |        214       17.43       68.73
         20 |          9        0.73       69.46
         21 |         25        2.04       71.50
         22 |          9        0.73       72.23
         23 |         32        2.61       74.84
         24 |          6        0.49       75.33
         25 |         29        2.36       77.69
         26 |         15        1.22       78.91
         27 |         48        3.91       82.82
         28 |         20        1.63       84.45
         29 |         23        1.87       86.32
         30 |         40        3.26       89.58
         31 |         73        5.94       95.52
         32 |         27        2.20       97.72
         33 |          8        0.65       98.37
         34 |          6        0.49       98.86
         35 |          2        0.16       99.02
         36 |          2        0.16       99.19
         37 |          8        0.65       99.84
         38 |          2        0.16      100.00
------------+-----------------------------------
      Total |      1,228      100.00
.     drop DivisaoCNAE
. } 

. else {
.      di as error "Não foi possível gerar dummies para Divisão do CNAE."
. }

. 
. capture confirm variable NaturezaJuridica

. if _rc == 0 {
.     tabulate NaturezaJuridica, generate(NaturezaJuridica_)

NaturezaJur |
      idica |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |          1        0.08        0.08
          0 |          5        0.41        0.49
          1 |         13        1.06        1.55
          2 |         91        7.41        8.96
          3 |      1,068       86.97       95.93
          4 |         23        1.87       97.80
          5 |          2        0.16       97.96
          6 |          1        0.08       98.05
          7 |          6        0.49       98.53
          8 |         18        1.47      100.00
------------+-----------------------------------
      Total |      1,228      100.00
.     drop NaturezaJuridica
. } 

. else {
.      di as error "Não foi possível gerar dummies para NaturezaJuridica."
. }

. 
. 
. /*******************************************************************************
> ETAPA 6 - O CONJUNTO DE TESTE PERMANECE SEPARADO 
> *******************************************************************************/
. * O conjunto de teste ainda está salvo em "test_data.csv"
. * Ele será importado separadamente no final da análise.
. 
. /******************************************************************************
> Fornecer descrição básica da estrutura do conjunto de dados
> *******************************************************************************/
. describe

Contains data
 Observations:         1,228                  
    Variables:           131                  
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
LiqCorrente     float   %9.0g                 
LiqGeral        float   %9.0g                 
LiqCorAjust     float   %9.0g                 
SolvGeral       float   %9.0g                 
EndGeral        float   %9.0g                 
CompEndivid     float   %9.0g                 
IndepFin        float   %9.0g                 
ImobilPL        float   %9.0g                 
ImobRecNC       float   %9.0g                 
PtpCapTerce     float   %9.0g                 
GiroAtivo       float   %9.0g                 
MargOp          float   %9.0g                 
MargLiq         float   %9.0g                 
ROI             float   %9.0g                 
ROE             float   %9.0g                 
AC              double  %10.0g                
ANRP            double  %10.0g                
Investimentos   double  %10.0g                
Imobilizado     double  %10.0g                
Intangivel      double  %10.0g                
PC              double  %10.0g                
PNC             double  %10.0g                
PL              double  %10.0g                
RecBruta        double  %10.0g                
LucroBruto      double  %10.0g                
LucroLiquido    double  %10.0g                
QtePenalOutro~s int     %8.0g                 
vlrcontrato     float   %9.0g                 
IdadedeAnos     float   %9.0g                 
QtdeCNAEsSecu~s byte    %8.0g                 
AnodasDemonst~s int     %8.0g                 
cnpjs           byte    %8.0g                 
log_vlrcontrato float   %9.0g                 
u               float   %9.0g                 
obs_no          int     %8.0g                 
total_obs       int     %8.0g                 
cutoff          int     %8.0g                 
FoiPenalizado~J byte    %8.0g                 
train           byte    %8.0g                 
Porte_1         byte    %8.0g                 Porte== 0.0000
Porte_2         byte    %8.0g                 Porte== 1.0000
Porte_3         byte    %8.0g                 Porte== 2.0000
Porte_4         byte    %8.0g                 Porte== 3.0000
CNAE_1          byte    %8.0g                 CNAE== -1.0000
CNAE_2          byte    %8.0g                 CNAE== 3.0000
CNAE_3          byte    %8.0g                 CNAE== 7.0000
CNAE_4          byte    %8.0g                 CNAE== 10.0000
CNAE_5          byte    %8.0g                 CNAE== 11.0000
CNAE_6          byte    %8.0g                 CNAE== 13.0000
CNAE_7          byte    %8.0g                 CNAE== 15.0000
CNAE_8          byte    %8.0g                 CNAE== 16.0000
CNAE_9          byte    %8.0g                 CNAE== 18.0000
CNAE_10         byte    %8.0g                 CNAE== 28.0000
CNAE_11         byte    %8.0g                 CNAE== 30.0000
CNAE_12         byte    %8.0g                 CNAE== 32.0000
CNAE_13         byte    %8.0g                 CNAE== 33.0000
CNAE_14         byte    %8.0g                 CNAE== 42.0000
CNAE_15         byte    %8.0g                 CNAE== 43.0000
CNAE_16         byte    %8.0g                 CNAE== 44.0000
CNAE_17         byte    %8.0g                 CNAE== 47.0000
CNAE_18         byte    %8.0g                 CNAE== 57.0000
CNAE_19         byte    %8.0g                 CNAE== 62.0000
CNAE_20         byte    %8.0g                 CNAE== 63.0000
CNAE_21         byte    %8.0g                 CNAE== 64.0000
CNAE_22         byte    %8.0g                 CNAE== 65.0000
CNAE_23         byte    %8.0g                 CNAE== 66.0000
CNAE_24         byte    %8.0g                 CNAE== 70.0000
CNAE_25         byte    %8.0g                 CNAE== 71.0000
CNAE_26         byte    %8.0g                 CNAE== 73.0000
CNAE_27         byte    %8.0g                 CNAE== 77.0000
CNAE_28         byte    %8.0g                 CNAE== 78.0000
CNAE_29         byte    %8.0g                 CNAE== 79.0000
CNAE_30         byte    %8.0g                 CNAE== 84.0000
CNAE_31         byte    %8.0g                 CNAE== 85.0000
CNAE_32         byte    %8.0g                 CNAE== 86.0000
CNAE_33         byte    %8.0g                 CNAE== 87.0000
CNAE_34         byte    %8.0g                 CNAE== 90.0000
CNAE_35         byte    %8.0g                 CNAE== 91.0000
CNAE_36         byte    %8.0g                 CNAE== 92.0000
CNAE_37         byte    %8.0g                 CNAE== 93.0000
CNAE_38         byte    %8.0g                 CNAE== 97.0000
DivisaoCNAE_1   byte    %8.0g                 DivisaoCNAE== -1.0000
DivisaoCNAE_2   byte    %8.0g                 DivisaoCNAE== 0.0000
DivisaoCNAE_3   byte    %8.0g                 DivisaoCNAE== 1.0000
DivisaoCNAE_4   byte    %8.0g                 DivisaoCNAE== 2.0000
DivisaoCNAE_5   byte    %8.0g                 DivisaoCNAE== 3.0000
DivisaoCNAE_6   byte    %8.0g                 DivisaoCNAE== 4.0000
DivisaoCNAE_7   byte    %8.0g                 DivisaoCNAE== 5.0000
DivisaoCNAE_8   byte    %8.0g                 DivisaoCNAE== 6.0000
DivisaoCNAE_9   byte    %8.0g                 DivisaoCNAE== 7.0000
DivisaoCNAE_10  byte    %8.0g                 DivisaoCNAE== 8.0000
DivisaoCNAE_11  byte    %8.0g                 DivisaoCNAE== 9.0000
DivisaoCNAE_12  byte    %8.0g                 DivisaoCNAE== 10.0000
DivisaoCNAE_13  byte    %8.0g                 DivisaoCNAE== 11.0000
DivisaoCNAE_14  byte    %8.0g                 DivisaoCNAE== 12.0000
DivisaoCNAE_15  byte    %8.0g                 DivisaoCNAE== 13.0000
DivisaoCNAE_16  byte    %8.0g                 DivisaoCNAE== 14.0000
DivisaoCNAE_17  byte    %8.0g                 DivisaoCNAE== 15.0000
DivisaoCNAE_18  byte    %8.0g                 DivisaoCNAE== 16.0000
DivisaoCNAE_19  byte    %8.0g                 DivisaoCNAE== 17.0000
DivisaoCNAE_20  byte    %8.0g                 DivisaoCNAE== 18.0000
DivisaoCNAE_21  byte    %8.0g                 DivisaoCNAE== 19.0000
DivisaoCNAE_22  byte    %8.0g                 DivisaoCNAE== 20.0000
DivisaoCNAE_23  byte    %8.0g                 DivisaoCNAE== 21.0000
DivisaoCNAE_24  byte    %8.0g                 DivisaoCNAE== 22.0000
DivisaoCNAE_25  byte    %8.0g                 DivisaoCNAE== 23.0000
DivisaoCNAE_26  byte    %8.0g                 DivisaoCNAE== 24.0000
DivisaoCNAE_27  byte    %8.0g                 DivisaoCNAE== 25.0000
DivisaoCNAE_28  byte    %8.0g                 DivisaoCNAE== 26.0000
DivisaoCNAE_29  byte    %8.0g                 DivisaoCNAE== 27.0000
DivisaoCNAE_30  byte    %8.0g                 DivisaoCNAE== 28.0000
DivisaoCNAE_31  byte    %8.0g                 DivisaoCNAE== 29.0000
DivisaoCNAE_32  byte    %8.0g                 DivisaoCNAE== 30.0000
DivisaoCNAE_33  byte    %8.0g                 DivisaoCNAE== 31.0000
DivisaoCNAE_34  byte    %8.0g                 DivisaoCNAE== 32.0000
DivisaoCNAE_35  byte    %8.0g                 DivisaoCNAE== 33.0000
DivisaoCNAE_36  byte    %8.0g                 DivisaoCNAE== 34.0000
DivisaoCNAE_37  byte    %8.0g                 DivisaoCNAE== 35.0000
DivisaoCNAE_38  byte    %8.0g                 DivisaoCNAE== 36.0000
DivisaoCNAE_39  byte    %8.0g                 DivisaoCNAE== 37.0000
DivisaoCNAE_40  byte    %8.0g                 DivisaoCNAE== 38.0000
NaturezaJurid~1 byte    %8.0g                 NaturezaJuridica== -1.0000
NaturezaJurid~2 byte    %8.0g                 NaturezaJuridica== 0.0000
NaturezaJurid~3 byte    %8.0g                 NaturezaJuridica== 1.0000
NaturezaJurid~4 byte    %8.0g                 NaturezaJuridica== 2.0000
NaturezaJurid~5 byte    %8.0g                 NaturezaJuridica== 3.0000
NaturezaJurid~6 byte    %8.0g                 NaturezaJuridica== 4.0000
NaturezaJurid~7 byte    %8.0g                 NaturezaJuridica== 5.0000
NaturezaJurid~8 byte    %8.0g                 NaturezaJuridica== 6.0000
NaturezaJurid~9 byte    %8.0g                 NaturezaJuridica== 7.0000
NaturezaJuri~10 byte    %8.0g                 NaturezaJuridica== 8.0000
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. /*******************************************************************************
> ETAPA 6 - ANÁLISE LOGIT
> 
> A variável dependente é 'FoiPenalizadoSTJ', do tipo binária.
> Ela indica se o fornecedor foi penalizado pelo STJ (1) ou não (0).
> 
> As variáveis independentes serão divididas em variáveis contábeis e variáveis de controle.
> 
> *******************************************************************************/
. * 6.1 Listar todas as variáveis disponíveis
. ds
LiqCorrente   ImobRecNC     ANRP          LucroBruto    log_vlrcon~o  Porte_2       CNAE_6        CNAE_14       CNAE_22       CNAE_30       CNAE_38       DivisaoCN~_8  DivisaoCN~16  DivisaoCN~24  DivisaoCN~32  DivisaoCN~40  NaturezaJu~8
LiqGeral      PtpCapTerce   Investimen~s  LucroLiquido  u             Porte_3       CNAE_7        CNAE_15       CNAE_23       CNAE_31       DivisaoCN~_1  DivisaoCN~_9  DivisaoCN~17  DivisaoCN~25  DivisaoCN~33  NaturezaJu~1  NaturezaJu~9
LiqCorAjust   GiroAtivo     Imobilizado   QtePenalOu~s  obs_no        Porte_4       CNAE_8        CNAE_16       CNAE_24       CNAE_32       DivisaoCN~_2  DivisaoCN~10  DivisaoCN~18  DivisaoCN~26  DivisaoCN~34  NaturezaJu~2  NaturezaJ~10
SolvGeral     MargOp        Intangivel    vlrcontrato   total_obs     CNAE_1        CNAE_9        CNAE_17       CNAE_25       CNAE_33       DivisaoCN~_3  DivisaoCN~11  DivisaoCN~19  DivisaoCN~27  DivisaoCN~35  NaturezaJu~3
EndGeral      MargLiq       PC            IdadedeAnos   cutoff        CNAE_2        CNAE_10       CNAE_18       CNAE_26       CNAE_34       DivisaoCN~_4  DivisaoCN~12  DivisaoCN~20  DivisaoCN~28  DivisaoCN~36  NaturezaJu~4
CompEndivid   ROI           PNC           QtdeCNAEsS~s  FoiPenaliz~J  CNAE_3        CNAE_11       CNAE_19       CNAE_27       CNAE_35       DivisaoCN~_5  DivisaoCN~13  DivisaoCN~21  DivisaoCN~29  DivisaoCN~37  NaturezaJu~5
IndepFin      ROE           PL            AnodasDemo~s  train         CNAE_4        CNAE_12       CNAE_20       CNAE_28       CNAE_36       DivisaoCN~_6  DivisaoCN~14  DivisaoCN~22  DivisaoCN~30  DivisaoCN~38  NaturezaJu~6
ImobilPL      AC            RecBruta      cnpjs         Porte_1       CNAE_5        CNAE_13       CNAE_21       CNAE_29       CNAE_37       DivisaoCN~_7  DivisaoCN~15  DivisaoCN~23  DivisaoCN~31  DivisaoCN~39  NaturezaJu~7

.
. /*******************************************************************************
> 6.3 Regressão logística com seleção stepwise a 10% de significância no conjunto de treinamento
> *******************************************************************************/
. * Capturar todas as variáveis que começam com "Porte_"
. unab Porte_vars : Porte_*

. 
. * Capturar todas as variáveis que começam com "CNAE_"
. unab CNAE_vars : CNAE_*

. 
. * Capturar todas as variáveis que começam com "NaturezaJuridica_"
. unab Natureza_vars : NaturezaJuridica_*

. 
. * Definir variáveis contábeis e de controle corretamente
. local var_contabeis `Porte_vars' LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE

. 
. *local var_controle `CNAE_vars' `Natureza_vars' log_vlrcontrato qtdecnaess~s idadedeanos qtepenalou~s
. 
. local var_controle `CNAE_vars' `Natureza_vars' log_vlrcon~o  QtdeCNAEsS~s IdadedeAnos QtePenalOu~s

. 
. *Regressão logística com seleção stepwise a 10% 
. sw, pr(.10): logit FoiPenalizadoSTJ `var_contabeis' `var_controle' if train == 1
note: Porte_4 omitted because of estimability.
note: PtpCapTerce omitted because of estimability.
note: CNAE_2 omitted because of estimability.
note: CNAE_4 omitted because of estimability.
note: CNAE_6 omitted because of estimability.
note: CNAE_9 omitted because of estimability.
note: CNAE_10 omitted because of estimability.
note: CNAE_11 omitted because of estimability.
note: CNAE_14 omitted because of estimability.
note: CNAE_15 omitted because of estimability.
note: CNAE_20 omitted because of estimability.
note: CNAE_22 omitted because of estimability.
note: CNAE_24 omitted because of estimability.
note: CNAE_25 omitted because of estimability.
note: CNAE_28 omitted because of estimability.
note: CNAE_31 omitted because of estimability.
note: CNAE_34 omitted because of estimability.
note: CNAE_35 omitted because of estimability.
note: CNAE_36 omitted because of estimability.
note: CNAE_37 omitted because of estimability.
note: CNAE_38 omitted because of estimability.
note: o.NaturezaJuridica_1 omitted because of estimability.
note: NaturezaJuridica_2 omitted because of estimability.
note: NaturezaJuridica_3 omitted because of estimability.
note: NaturezaJuridica_7 omitted because of estimability.
note: NaturezaJuridica_8 omitted because of estimability.
note: NaturezaJuridica_9 omitted because of estimability.
note: NaturezaJuridica_10 omitted because of estimability.
note: 296 obs omitted because of estimability.

Wald test, begin with full model:
p = 0.9610 >= 0.1000, removing CNAE_26
p = 0.9486 >= 0.1000, removing SolvGeral
p = 0.8568 >= 0.1000, removing Porte_2
p = 0.8441 >= 0.1000, removing CompEndivid
p = 0.8126 >= 0.1000, removing ImobRecNC
p = 0.7856 >= 0.1000, removing ImobilPL
p = 0.7457 >= 0.1000, removing IdadedeAnos
p = 0.6347 >= 0.1000, removing MargLiq
p = 0.6250 >= 0.1000, removing CNAE_1
p = 0.6924 >= 0.1000, removing CNAE_21
p = 0.6168 >= 0.1000, removing CNAE_18
p = 0.5697 >= 0.1000, removing EndGeral
p = 0.5778 >= 0.1000, removing Porte_3
p = 0.4975 >= 0.1000, removing ROE
p = 0.3747 >= 0.1000, removing IndepFin
p = 0.2804 >= 0.1000, removing LiqGeral
p = 0.3171 >= 0.1000, removing MargOp
p = 0.3097 >= 0.1000, removing LiqCorAjust
p = 0.2768 >= 0.1000, removing CNAE_32
p = 0.1804 >= 0.1000, removing CNAE_19

Logistic regression                                     Number of obs =    746
                                                        LR chi2(23)   = 354.93
                                                        Prob > chi2   = 0.0000
Log likelihood = -339.16974                             Pseudo R2     = 0.3435

--------------------------------------------------------------------------------------
    FoiPenalizadoSTJ | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
---------------------+----------------------------------------------------------------
             Porte_1 |  -1.587886   .4051042    -3.92   0.000    -2.381875   -.7938963
QtdeCNAEsSecundarios |  -.0286349   .0071837    -3.99   0.000    -.0427148   -.0145551
QtePenalOutrosOrgaos |    .037124   .0085161     4.36   0.000     .0204328    .0538153
         LiqCorrente |  -.0107321   .0065056    -1.65   0.099    -.0234829    .0020187
             CNAE_13 |   1.227264   .5029411     2.44   0.015     .2415178    2.213011
             CNAE_17 |   1.905696   .7671692     2.48   0.013     .4020719     3.40932
  NaturezaJuridica_4 |  -8.015775   1.710821    -4.69   0.000    -11.36892   -4.662627
             CNAE_27 |   4.190843   1.132611     3.70   0.000     1.970967    6.410719
     log_vlrcontrato |   .1250357   .0151803     8.24   0.000     .0952827    .1547886
             CNAE_30 |    2.27821   .6184304     3.68   0.000     1.066109    3.490312
  NaturezaJuridica_5 |  -1.504229   .6721212    -2.24   0.025    -2.821562   -.1868956
  NaturezaJuridica_6 |  -2.511473   1.058705    -2.37   0.018    -4.586497   -.4364487
           GiroAtivo |   .1839244   .0985974     1.87   0.062    -.0093229    .3771718
             CNAE_29 |   1.734958   .7475282     2.32   0.020     .2698301    3.200087
             CNAE_33 |   3.808794    .691998     5.50   0.000     2.452503    5.165085
                 ROI |  -1.351468    .379066    -3.57   0.000    -2.094424   -.6085125
             CNAE_23 |   2.167006   .3474252     6.24   0.000     1.486065    2.847947
             CNAE_16 |   1.658232   .3677242     4.51   0.000     .9375054    2.378958
              CNAE_3 |   5.286973    1.03531     5.11   0.000     3.257802    7.316143
              CNAE_5 |   .6705782   .3888779     1.72   0.085    -.0916085    1.432765
              CNAE_7 |   1.768327   .5569916     3.17   0.001     .6766436     2.86001
              CNAE_8 |   2.347029   .5524446     4.25   0.000     1.264258    3.429801
             CNAE_12 |   1.534005   .3905676     3.93   0.000     .7685061    2.299503
               _cons |   .0975054   .6521689     0.15   0.881    -1.180722    1.375733
--------------------------------------------------------------------------------------

. 
. * Armazenar os resultados do modelo stepwise a 10%
. estimates store IRDC10

. 
. * Teste de bondade de ajuste de Hosmer-Lemeshow para o modelo stepwise a 10%
. estat gof if train == 1, group(10) table
note: obs collapsed on 10 quantiles of estimated probabilities.

Goodness-of-fit test after logistic model
Variable: FoiPenalizadoSTJ

  Table collapsed on quantiles of estimated probabilities
  +--------------------------------------------------------+
  | Group |   Prob | Obs_1 | Exp_1 | Obs_0 | Exp_0 | Total |
  |-------+--------+-------+-------+-------+-------+-------|
  |     1 | 0.0469 |    10 |   1.2 |    95 | 103.8 |   105 |
  |     2 | 0.1308 |    20 |   9.8 |    84 |  94.2 |   104 |
  |     3 | 0.1919 |    36 |  17.0 |    68 |  87.0 |   104 |
  |     4 | 0.2734 |    39 |  23.6 |    65 |  80.4 |   104 |
  |     5 | 0.4240 |    60 |  36.8 |    44 |  67.2 |   104 |
  |-------+--------+-------+-------+-------+-------+-------|
  |     6 | 0.5053 |    46 |  48.8 |    59 |  56.2 |   105 |
  |     7 | 0.6247 |    56 |  58.9 |    48 |  45.1 |   104 |
  |     8 | 0.7655 |    72 |  72.8 |    32 |  31.2 |   104 |
  |     9 | 0.8880 |    82 |  84.4 |    22 |  19.6 |   104 |
  |    10 | 0.9977 |   100 |  99.5 |     4 |   4.5 |   104 |
  +--------------------------------------------------------+

 Number of observations =  1,042
       Number of groups =     10
Hosmer–Lemeshow chi2(8) = 136.90
            Prob > chi2 = 0.0000

. 
. /*******************************************************************************
> 6.3.2 Tabela de classificação para o modelo stepwise a 10% na base de treinamento
> *******************************************************************************/
. estat class if train == 1

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |       313           109  |        422
     -     |       208           412  |        620
-----------+--------------------------+-----------
   Total   |       521           521  |       1042

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   60.08%
Specificity                     Pr( -|~D)   79.08%
Positive predictive value       Pr( D| +)   74.17%
Negative predictive value       Pr(~D| -)   66.45%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   20.92%
False - rate for true D         Pr( -| D)   39.92%
False + rate for classified +   Pr(~D| +)   25.83%
False - rate for classified -   Pr( D| -)   33.55%
--------------------------------------------------
Correctly classified                        69.58%
--------------------------------------------------

. 
. * 📌 Gerar predições na base de treinamento
. capture drop prob_pred_treino

. predict prob_pred_treino if train == 1, pr
(186 missing values generated)

. 
. * 📌 Classificação prevista
. capture drop predicted_class_treino

. gen predicted_class_treino = (prob_pred_treino >= 0.5) if train == 1
(186 missing values generated)

. 
. * 📌 Kappa na base de treinamento
. *ssc install kappaetc, replace
. kappaetc FoiPenalizadoSTJ predicted_class_treino if train == 1

Interrater agreement                             Number of subjects =    1042
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.6958    0.0143  48.79   0.000     0.6678     0.7238
Brennan and Prediger |  0.3916    0.0285  13.73   0.000     0.3356     0.4475
Cohen/Conger's Kappa |  0.3916    0.0280  13.98   0.000     0.3366     0.4465
    Scott/Fleiss' Pi |  0.3860    0.0287  13.45   0.000     0.3297     0.4423
           Gwet's AC |  0.3970    0.0286  13.86   0.000     0.3408     0.4532
Krippendorff's Alpha |  0.3863    0.0287  13.46   0.000     0.3300     0.4426
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de treinamento
. capture drop correct_classification_treino

. gen correct_classification_treino = (FoiPenalizadoSTJ == predicted_class_treino) if train == 1
(186 missing values generated)

. sum correct_classification_treino if train == 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~o |      1,042    .6957774    .4602983          0          1

. scalar prop_modelo_treino = r(mean)

. 
. * 📌 No Information Rate (NIR)
. *O NIR representa a acurácia de um modelo nulo (baseline), que classifica sempre a categoria mais frequente.
. tabulate FoiPenalizadoSTJ if train == 1, matcell(freq_treino)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        521       50.00       50.00
          1 |        521       50.00      100.00
------------+-----------------------------------
      Total |      1,042      100.00

. scalar total_treino = freq_treino[1,1] + freq_treino[2,1]

. scalar max_treino = max(freq_treino[1,1], freq_treino[2,1])

. scalar prop_nir_treino = max_treino / total_treino

. 
. * 📌 Comparação
. di "Acurácia na base de treinamento: " prop_modelo_treino
Acurácia na base de treinamento: .69577735

. di "NIR (treinamento): " prop_nir_treino
NIR (treinamento): .5

. 
. if (prop_modelo_treino > prop_nir_treino) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de treino."
✅ Modelo stepwise 10% supera o NIR na base de treino.
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de treino."
. }

. 
. * 📌 Teste de McNemar na base de treinamento
. * Criar a matriz de confusão da base de teste
. tabulate FoiPenalizadoSTJ predicted_class_treino if train == 1, matcell(mc_treino)

           | predicted_class_trein
FoiPenaliz |           o
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       412        109 |       521 
         1 |       208        313 |       521 
-----------+----------------------+----------
     Total |       620        422 |     1,042 

. 
. * Extrair os valores da matriz
. scalar tn_treino = mc_treino[1,1] // Verdadeiro Negativo

. scalar fn_treino = mc_treino[2,1] // Falso Negativo

. scalar fp_treino = mc_treino[1,2] // Falso Positivo

. scalar tp_treino = mc_treino[2,2] // Verdadeiro Positivo

. 
. * Mostrar os valores extraídos (opcional)
. di "TN: " tn_treino
TN: 412

. di "FN: " fn_treino
FN: 208

. di "FP: " fp_treino
FP: 109

. di "TP: " tp_treino
TP: 313

. 
. * Rodar o teste de McNemar com os valores numéricos
. mcci `=tn_treino' `=fn_treino' `=fp_treino' `=tp_treino'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       412         208  |        620
       Unexposed |       109         313  |        422
-----------------+------------------------+-----------
           Total |       521         521  |       1042

McNemar's chi2(1) =     30.92    Prob > chi2 = 0.0000
Exact McNemar significance probability       = 0.0000

Proportion with factor
        Cases       .5950096
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference  .0950096      .0610609   .1289583
        ratio       1.190019      1.119151   1.265375
        rel. diff.  .1900192      .1297386   .2502998

        odds ratio  1.908257      1.506347   2.428649   (exact)

. 
. /*******************************************************************************
> 6.3.3 Curva ROC para o modelo stepwise a 10% na base de TREINO
> *******************************************************************************/
. lroc if train == 1

Logistic model for FoiPenalizadoSTJ

Number of observations =     1042
Area under ROC curve   =   0.7851

. graph export "lroc_IRDC10_treino.png", replace
file lroc_IRDC10_treino.png saved as PNG format

. 
. /*******************************************************************************
> 6.3.4 Tabela de classificação para o modelo stepwise a 10% na base de TESTE
> *******************************************************************************/
. estat class if train == 0

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |        25            41  |         66
     -     |        31            89  |        120
-----------+--------------------------+-----------
   Total   |        56           130  |        186

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   44.64%
Specificity                     Pr( -|~D)   68.46%
Positive predictive value       Pr( D| +)   37.88%
Negative predictive value       Pr(~D| -)   74.17%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   31.54%
False - rate for true D         Pr( -| D)   55.36%
False + rate for classified +   Pr(~D| +)   62.12%
False - rate for classified -   Pr( D| -)   25.83%
--------------------------------------------------
Correctly classified                        61.29%
--------------------------------------------------

. 
. * 📌 Gerar predições na base de teste
. capture drop prob_pred_teste

. predict prob_pred_teste if train == 0, pr
(1,042 missing values generated)

. 
. * 📌 Classificação prevista
. capture drop predicted_class_teste

. gen predicted_class_teste = (prob_pred_teste >= 0.5) if train == 0
(1,042 missing values generated)

. 
. * 📌 Kappa na base de teste
. kappaetc FoiPenalizadoSTJ predicted_class_teste if train == 0

Interrater agreement                             Number of subjects =     186
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.6129    0.0358  17.11   0.000     0.5423     0.6836
Brennan and Prediger |  0.2258    0.0716   3.15   0.002     0.0845     0.3671
Cohen/Conger's Kappa |  0.1247    0.0744   1.68   0.095    -0.0220     0.2714
    Scott/Fleiss' Pi |  0.1218    0.0749   1.63   0.106    -0.0260     0.2697
           Gwet's AC |  0.3078    0.0754   4.08   0.000     0.1590     0.4565
Krippendorff's Alpha |  0.1242    0.0749   1.66   0.099    -0.0237     0.2721
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de teste
. capture drop correct_classification_teste

. gen correct_classification_teste = (FoiPenalizadoSTJ == predicted_class_teste) if train == 0
(1,042 missing values generated)

. sum correct_classification_teste if train == 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~e |        186    .6129032    .4884008          0          1

. scalar prop_modelo_teste = r(mean)

. 
. * 📌 No Information Rate (NIR)
. tabulate FoiPenalizadoSTJ if train == 0, matcell(freq_teste)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        130       69.89       69.89
          1 |         56       30.11      100.00
------------+-----------------------------------
      Total |        186      100.00

. scalar total_teste = freq_teste[1,1] + freq_teste[2,1]

. scalar max_teste = max(freq_teste[1,1], freq_teste[2,1])

. scalar prop_nir_teste = max_teste / total_teste

. 
. 
. * 📌 Comparação
. di "Acurácia na base de teste: " prop_modelo_teste
Acurácia na base de teste: .61290323

. di "NIR (teste): " prop_nir_teste
NIR (teste): .69892473

. 
. if (prop_modelo_teste > prop_nir_teste) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de teste."
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste."
⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste.
. }

. 
. * 📌 Teste de McNemar na base de teste
. * Criar a matriz de confusão da base de teste
. tabulate FoiPenalizadoSTJ predicted_class_teste if train == 0, matcell(mc_teste)

FoiPenaliz | predicted_class_teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |        89         41 |       130 
         1 |        31         25 |        56 
-----------+----------------------+----------
     Total |       120         66 |       186 

. 
. * Extrair os valores da matriz
. scalar tn_teste = mc_teste[1,1] // Verdadeiro Negativo

. scalar fn_teste = mc_teste[2,1] // Falso Negativo

. scalar fp_teste = mc_teste[1,2] // Falso Positivo

. scalar tp_teste = mc_teste[2,2] // Verdadeiro Positivo

. 
. * Mostrar os valores extraídos (opcional)
. di "TN: " tn_teste
TN: 89

. di "FN: " fn_teste
FN: 31

. di "FP: " fp_teste
FP: 41

. di "TP: " tp_teste
TP: 25

. 
. * Rodar o teste de McNemar com os valores numéricos
. mcci `=tn_teste' `=fn_teste' `=fp_teste' `=tp_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |        89          31  |        120
       Unexposed |        41          25  |         66
-----------------+------------------------+-----------
           Total |       130          56  |        186

McNemar's chi2(1) =      1.39    Prob > chi2 = 0.2386
Exact McNemar significance probability       = 0.2888

Proportion with factor
        Cases       .6451613
        Controls    .6989247     [95% conf. interval]
                   ---------     --------------------
        difference -.0537634     -.1482185   .0406916
        ratio       .9230769      .8079977   1.054546
        rel. diff. -.1785714     -.5009783   .1438354

        odds ratio  .7560976      .4584502   1.235457   (exact)

. 
. /*******************************************************************************
> 6.3.5 Curva ROC para o modelo stepwise a 10% na base de TESTE
> *******************************************************************************/
. lroc if train == 0

Logistic model for FoiPenalizadoSTJ

Number of observations =      186
Area under ROC curve   =   0.6416

. graph export "lroc_IRDC10_teste.png", replace
file lroc_IRDC10_teste.png saved as PNG format

. 
. /*******************************************************************************
> 6.3.6 – Ponto de Corte Ideal (Sensibilidade ≈ Especificidade)
> *******************************************************************************/
. 
. * Reexecutar rapidamente o modelo (sem sobrescrever)
. quietly logit FoiPenalizadoSTJ `var_contabeis' `var_controle' if train == 1

. 
. * Restaurar modelo salvo
. estimates restore IRDC10
(results IRDC10 are active now)

. 
. * 📌 BASE DE TREINAMENTO
. * ------------------------------------------------------------
. * Garantir que as variáveis temporárias não existam
. capture drop prob_pred_treino

. capture drop cutoff

. capture drop sens

. capture drop spec

. capture drop difference

. capture drop abs_diff

. capture drop ordem

. 
. * Gerar predições
. predict prob_pred_treino if train == 1, pr
(186 missing values generated)

. 
. * Gerar sensitividade e especificidade para diferentes cutoffs
. lsens if train == 1, genprob(cutoff) gensens(sens) genspec(spec) nograph

. 
. * Calcular diferença entre sensibilidade e especificidade
. gen difference = sens - spec
(188 missing values generated)

. gen abs_diff = abs(difference)
(188 missing values generated)

. 
. * Obter ponto ideal (menor diferença)
. gen ordem = _n

. gsort abs_diff

. 
. * Salvar valores do melhor ponto em scalars usando summarize
. summarize cutoff if abs_diff == abs_diff[1]

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
      cutoff |          1    .4243209           .   .4243209   .4243209

. scalar cutoff_ideal_treino = r(mean)

. 
. summarize sens if abs_diff == abs_diff[1]

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        sens |          1    .6833013           .   .6833013   .6833013

. scalar sens_ideal_treino = r(mean)

. scalar cutoff_step10 = cutoff_ideal_treino

. 
. 
. summarize spec if abs_diff == abs_diff[1]

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
        spec |          1    .6833013           .   .6833013   .6833013

. scalar spec_ideal_treino = r(mean)

. 
. * Mostrar o ponto ideal encontrado
. list cutoff sens spec abs_diff in 1, noobs clean

      cutoff       sens       spec   abs_diff  
    0.424321   0.683301   0.683301          0  

. 
. * Plotar gráfico com destaque no ponto de cruzamento
. lsens if train == 1, ///
>     yline(`=sens_ideal_treino') xline(`=cutoff_ideal_treino') ///
>     scheme(s1color) ///
>     ylab(0 0.2 `=sens_ideal_treino' 0.8 1) ///
>     xlab(0 0.2 `=cutoff_ideal_treino' 0.8 1)

. 
. graph export "cutoff_ideal_IRDC10_treino.png", replace
file cutoff_ideal_IRDC10_treino.png saved as PNG format

. 
. /*******************************************************************************
> 6.3.7 – Tabela de Classificação com Cutoff Ideal (Treinamento e Teste)
> *******************************************************************************/
. 
. * 📌 BASE DE TREINAMENTO
. * ------------------------------------------------------------
. 
. di "Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO: " cutoff_ideal_treino
Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO: .4243209

. 
. * Gerar classificação com o cutoff ideal
. capture drop predicted_class_treino

. gen predicted_class_treino = (prob_pred_treino >= cutoff_ideal_treino) if train == 1
(186 missing values generated)

. 
. * Matriz de classificação detalhada
. estat class if train == 1

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |       313           109  |        422
     -     |       208           412  |        620
-----------+--------------------------+-----------
   Total   |       521           521  |       1042

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   60.08%
Specificity                     Pr( -|~D)   79.08%
Positive predictive value       Pr( D| +)   74.17%
Negative predictive value       Pr(~D| -)   66.45%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   20.92%
False - rate for true D         Pr( -| D)   39.92%
False + rate for classified +   Pr(~D| +)   25.83%
False - rate for classified -   Pr( D| -)   33.55%
--------------------------------------------------
Correctly classified                        69.58%
--------------------------------------------------

. 
. * Kappa
. kappaetc FoiPenalizadoSTJ predicted_class_treino if train == 1

Interrater agreement                             Number of subjects =    1042
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.6833    0.0144  47.39   0.000     0.6550     0.7116
Brennan and Prediger |  0.3666    0.0288  12.71   0.000     0.3100     0.4232
Cohen/Conger's Kappa |  0.3666    0.0288  12.71   0.000     0.3100     0.4232
    Scott/Fleiss' Pi |  0.3666    0.0288  12.71   0.000     0.3100     0.4232
           Gwet's AC |  0.3666    0.0288  12.71   0.000     0.3100     0.4232
Krippendorff's Alpha |  0.3669    0.0288  12.72   0.000     0.3103     0.4235
------------------------------------------------------------------------------

. 
. * Acurácia
. capture drop correct_classification_treino

. gen correct_classification_treino = (FoiPenalizadoSTJ == predicted_class_treino) if train == 1
(186 missing values generated)

. sum correct_classification_treino if train == 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~o |      1,042    .6833013    .4654122          0          1

. scalar prop_modelo_treino = r(mean)

. 
. * No Information Rate
. tabulate FoiPenalizadoSTJ if train == 1, matcell(freq_treino)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        521       50.00       50.00
          1 |        521       50.00      100.00
------------+-----------------------------------
      Total |      1,042      100.00

. scalar total_treino = freq_treino[1,1] + freq_treino[2,1]

. scalar max_treino = max(freq_treino[1,1], freq_treino[2,1])

. scalar prop_nir_treino = max_treino / total_treino

. 
. di "Acurácia (treino): " prop_modelo_treino
Acurácia (treino): .68330134

. di "NIR (treino): " prop_nir_treino
NIR (treino): .5

. 
. if (prop_modelo_treino > prop_nir_treino) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de treino (cutoff ideal)."
✅ Modelo stepwise 10% supera o NIR na base de treino (cutoff ideal).
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de treino (cutoff ideal)."
. }

. 
. * Teste de McNemar
. tabulate FoiPenalizadoSTJ predicted_class_treino if train == 1, matcell(mc_treino)

           | predicted_class_trein
FoiPenaliz |           o
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       356        165 |       521 
         1 |       165        356 |       521 
-----------+----------------------+----------
     Total |       521        521 |     1,042 

. scalar tn_treino = mc_treino[1,1]

. scalar fn_treino = mc_treino[2,1]

. scalar fp_treino = mc_treino[1,2]

. scalar tp_treino = mc_treino[2,2]

. mcci `=tn_treino' `=fn_treino' `=fp_treino' `=tp_treino'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       356         165  |        521
       Unexposed |       165         356  |        521
-----------------+------------------------+-----------
           Total |       521         521  |       1042

McNemar's chi2(1) =      0.00    Prob > chi2 = 1.0000
Exact McNemar significance probability       = 1.0000

Proportion with factor
        Cases             .5
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference         0     -.0351291   .0351291
        ratio              1       .933944   1.070728
        rel. diff.         0     -.0683388   .0683388

        odds ratio         1      .8009881   1.248458   (exact)

. 
. 
. * 📌 BASE DE TESTE
. * ------------------------------------------------------------
. 
. di "Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO (aplicado na base de TESTE): " cutoff_ideal_treino
Tabela de classificação utilizando o cutoff ideal da base de TREINAMENTO (aplicado na base de TESTE): .4243209

. 
. * Gerar classificação com o mesmo cutoff da base de teste
. capture drop predicted_class_teste

. gen predicted_class_teste = (prob_pred_teste >= cutoff_ideal_treino) if train == 0
(1,042 missing values generated)

. 
. * Matriz de classificação detalhada
. estat class if train == 0

Logistic model for FoiPenalizadoSTJ

              -------- True --------
Classified |         D            ~D  |      Total
-----------+--------------------------+-----------
     +     |        25            41  |         66
     -     |        31            89  |        120
-----------+--------------------------+-----------
   Total   |        56           130  |        186

Classified + if predicted Pr(D) >= .5
True D defined as FoiPenalizadoSTJ != 0
--------------------------------------------------
Sensitivity                     Pr( +| D)   44.64%
Specificity                     Pr( -|~D)   68.46%
Positive predictive value       Pr( D| +)   37.88%
Negative predictive value       Pr(~D| -)   74.17%
--------------------------------------------------
False + rate for true ~D        Pr( +|~D)   31.54%
False - rate for true D         Pr( -| D)   55.36%
False + rate for classified +   Pr(~D| +)   62.12%
False - rate for classified -   Pr( D| -)   25.83%
--------------------------------------------------
Correctly classified                        61.29%
--------------------------------------------------

. 
. * Kappa
. kappaetc FoiPenalizadoSTJ predicted_class_teste if train == 0

Interrater agreement                             Number of subjects =     186
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.6129    0.0358  17.11   0.000     0.5423     0.6836
Brennan and Prediger |  0.2258    0.0716   3.15   0.002     0.0845     0.3671
Cohen/Conger's Kappa |  0.1651    0.0720   2.29   0.023     0.0230     0.3072
    Scott/Fleiss' Pi |  0.1545    0.0743   2.08   0.039     0.0080     0.3011
           Gwet's AC |  0.2860    0.0751   3.81   0.000     0.1379     0.4341
Krippendorff's Alpha |  0.1568    0.0743   2.11   0.036     0.0103     0.3033
------------------------------------------------------------------------------

. 
. * Acurácia
. capture drop correct_classification_teste

. gen correct_classification_teste = (FoiPenalizadoSTJ == predicted_class_teste) if train == 0
(1,042 missing values generated)

. sum correct_classification_teste if train == 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_cl~e |        186    .6129032    .4884008          0          1

. scalar prop_modelo_teste = r(mean)

. 
. * No Information Rate
. tabulate FoiPenalizadoSTJ if train == 0, matcell(freq_teste)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        130       69.89       69.89
          1 |         56       30.11      100.00
------------+-----------------------------------
      Total |        186      100.00

. scalar total_teste = freq_teste[1,1] + freq_teste[2,1]

. scalar max_teste = max(freq_teste[1,1], freq_teste[2,1])

. scalar prop_nir_teste = max_teste / total_teste

. 
. di "Acurácia (teste): " prop_modelo_teste
Acurácia (teste): .61290323

. di "NIR (teste): " prop_nir_teste
NIR (teste): .69892473

. 
. if (prop_modelo_teste > prop_nir_teste) {
.     di "✅ Modelo stepwise 10% supera o NIR na base de teste (cutoff ideal do treino)."
. }

. else {
.     di "⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste (cutoff ideal do treino)."
⚠️ Modelo stepwise 10% NÃO supera o NIR na base de teste (cutoff ideal do treino).
. }

. 
. * Teste de McNemar
. tabulate FoiPenalizadoSTJ predicted_class_teste if train == 0, matcell(mc_teste)

FoiPenaliz | predicted_class_teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |        84         46 |       130 
         1 |        26         30 |        56 
-----------+----------------------+----------
     Total |       110         76 |       186 

. scalar tn_teste = mc_teste[1,1]

. scalar fn_teste = mc_teste[2,1]

. scalar fp_teste = mc_teste[1,2]

. scalar tp_teste = mc_teste[2,2]

. mcci `=tn_teste' `=fn_teste' `=fp_teste' `=tp_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |        84          26  |        110
       Unexposed |        46          30  |         76
-----------------+------------------------+-----------
           Total |       130          56  |        186

McNemar's chi2(1) =      5.56    Prob > chi2 = 0.0184
Exact McNemar significance probability       = 0.0245

Proportion with factor
        Cases       .5913978
        Controls    .6989247     [95% conf. interval]
                   ---------     --------------------
        difference -.1075269     -.2009709  -.0140828
        ratio       .8461538      .7362922   .9724078
        rel. diff. -.3571429     -.7031134  -.0111723

        odds ratio  .5652174      .3354038   .9337548   (exact)

. 
. /*******************************************************************************
> 6.4 Teste de Razão de Verossimilhança entre os Modelos Aninhados(LR Test)
> *******************************************************************************/
. 
. di "📊 Teste de Razão de Verossimilhança: IRDCcompleto vs IRDC05 (stepwise 5%)"
📊 Teste de Razão de Verossimilhança: IRDCcompleto vs IRDC05 (stepwise 5%)

. lrtest IRDCcompleto IRDC05

Likelihood-ratio test
Assumption: IRDC05 nested within IRDCcompleto

LR chi2(22) =  19.12
Prob > chi2 = 0.6377

. 
. di "📊 Teste de Razão de Verossimilhança: IRDCcompleto vs IRDC10 (stepwise 10%)"
📊 Teste de Razão de Verossimilhança: IRDCcompleto vs IRDC10 (stepwise 10%)

. lrtest IRDCcompleto IRDC10

Likelihood-ratio test
Assumption: IRDC10 nested within IRDCcompleto

LR chi2(20) =  10.25
Prob > chi2 = 0.9635

. 
. di "📊 Teste de Razão de Verossimilhança: IRDC05 (stepwise 5%) vs IRDC10 (stepwise 10%)"
📊 Teste de Razão de Verossimilhança: IRDC05 (stepwise 5%) vs IRDC10 (stepwise 10%)

. lrtest IRDC05 IRDC10

Likelihood-ratio test
Assumption: IRDC05 nested within IRDC10

 LR chi2(2) =   8.88
Prob > chi2 = 0.0118

. 
. /*******************************************************************************
> 6.5 Regressão logística com seleção via LASSO (penalização L1) no conjunto de treinamento
> 
>  O LASSO (Least Absolute Shrinkage and Selection Operator) realiza seleção automática
> de variáveis e reduz o risco de overfitting (sobreajuste), especialmente útil em 
> modelos com muitas variáveis e potencial multicolinearidade.
> 
> *******************************************************************************/
. 
. * Capturar todas as variáveis que começam com "Porte_"
. unab Porte_vars : Porte_*

. 
. * Capturar todas as variáveis que começam com "CNAE_"
. unab CNAE_vars : CNAE_*

. 
. * Capturar todas as variáveis que começam com "DivisaoCNAE_"
. unab DivisaoCNAE_vars : DivisaoCNAE_*

. 
. * Capturar todas as variáveis que começam com "NaturezaJuridica_"
. unab Natureza_vars : NaturezaJuridica_*

. 
. * Definir variáveis contábeis e de controle corretamente
. local var_contabeis `Porte_vars' LiqCorrente LiqGeral LiqCorAjust SolvGeral EndGeral CompEndivid IndepFin ImobilPL ImobRecNC PtpCapTerce GiroAtivo MargOp MargLiq ROI ROE

. 
. local var_controle `CNAE_vars' `Natureza_vars' log_vlrcon~o  QtdeCNAEsS~s IdadedeAnos QtePenalOu~s

. 
. *local var_controle `DivisaoCNAE_vars' `Natureza_vars' log_vlrcon~o  QtdeCNAEsS~s IdadedeAnos QtePenalOu~s
. 
. * Consolidar todas as variáveis em uma macro
. local todas_vars `var_contabeis' `var_controle'

. 
. *Ajustar modelo LASSO na base de treinamento
. lasso logit FoiPenalizadoSTJ `todas_vars' if train == 1, selection(cv)
note: NaturezaJuridica_1 omitted because it is constant.
note: PtpCapTerce omitted because of collinearity with another variable.
note: NaturezaJuridica_7 omitted because it is constant in C.V. subsamples.
note: NaturezaJuridica_8 omitted because it is constant in C.V. subsamples.
10-fold cross-validation with 100 lambdas ...
Grid value 1:     lambda = .1449131   no. of nonzero coef. =  0
Folds: 1...5....10   CVF = 1.388243
Grid value 2:     lambda = .1320395   no. of nonzero coef. =  1
Folds: 1...5....10   CVF = 1.376445
Grid value 3:     lambda = .1203094   no. of nonzero coef. =  2
Folds: 1...5....10   CVF = 1.359286
Grid value 4:     lambda = .1096215   no. of nonzero coef. =  2
Folds: 1...5....10   CVF = 1.341855
Grid value 5:     lambda =  .099883   no. of nonzero coef. =  3
Folds: 1...5....10   CVF = 1.325928
Grid value 6:     lambda = .0910097   no. of nonzero coef. =  5
Folds: 1...5....10   CVF = 1.300407
Grid value 7:     lambda = .0829246   no. of nonzero coef. =  5
Folds: 1...5....10   CVF = 1.272607
Grid value 8:     lambda = .0755578   no. of nonzero coef. =  5
Folds: 1...5....10   CVF =  1.24846
Grid value 9:     lambda = .0688455   no. of nonzero coef. =  7
Folds: 1...5....10   CVF = 1.226901
Grid value 10:    lambda = .0627294   no. of nonzero coef. =  9
Folds: 1...5....10   CVF = 1.201928
Grid value 11:    lambda = .0571567   no. of nonzero coef. = 11
Folds: 1...5....10   CVF = 1.174379
Grid value 12:    lambda = .0520791   no. of nonzero coef. = 17
Folds: 1...5....10   CVF =  1.14483
Grid value 13:    lambda = .0474525   no. of nonzero coef. = 21
Folds: 1...5....10   CVF = 1.113183
Grid value 14:    lambda =  .043237   no. of nonzero coef. = 25
Folds: 1...5....10   CVF =  1.08126
Grid value 15:    lambda = .0393959   no. of nonzero coef. = 26
Folds: 1...5....10   CVF = 1.048848
Grid value 16:    lambda = .0358961   no. of nonzero coef. = 29
Folds: 1...5....10   CVF = 1.018825
Grid value 17:    lambda = .0327072   no. of nonzero coef. = 30
Folds: 1...5....10   CVF = .9908101
Grid value 18:    lambda = .0298016   no. of nonzero coef. = 32
Folds: 1...5....10   CVF = .9655959
Grid value 19:    lambda = .0271541   no. of nonzero coef. = 33
Folds: 1...5....10   CVF = .9425946
Grid value 20:    lambda = .0247418   no. of nonzero coef. = 36
Folds: 1...5....10   CVF = .9211049
Grid value 21:    lambda = .0225438   no. of nonzero coef. = 40
Folds: 1...5....10   CVF = .9012807
Grid value 22:    lambda = .0205411   no. of nonzero coef. = 40
Folds: 1...5....10   CVF = .8823094
Grid value 23:    lambda = .0187163   no. of nonzero coef. = 40
Folds: 1...5....10   CVF = .8650938
Grid value 24:    lambda = .0170536   no. of nonzero coef. = 41
Folds: 1...5....10   CVF = .8496829
Grid value 25:    lambda = .0155386   no. of nonzero coef. = 41
Folds: 1...5....10   CVF = .8353524
Grid value 26:    lambda = .0141582   no. of nonzero coef. = 42
Folds: 1...5....10   CVF = .8229118
Grid value 27:    lambda = .0129004   no. of nonzero coef. = 42
Folds: 1...5....10   CVF = .8120423
Grid value 28:    lambda = .0117544   no. of nonzero coef. = 43
Folds: 1...5....10   CVF = .8023949
Grid value 29:    lambda = .0107101   no. of nonzero coef. = 45
Folds: 1...5....10   CVF = .7938168
Grid value 30:    lambda = .0097587   no. of nonzero coef. = 46
Folds: 1...5....10   CVF = .7863908
Grid value 31:    lambda = .0088917   no. of nonzero coef. = 46
Folds: 1...5....10   CVF = .7799265
Grid value 32:    lambda = .0081018   no. of nonzero coef. = 47
Folds: 1...5....10   CVF = .7743286
Grid value 33:    lambda = .0073821   no. of nonzero coef. = 47
Folds: 1...5....10   CVF = .7694924
Grid value 34:    lambda = .0067263   no. of nonzero coef. = 48
Folds: 1...5....10   CVF = .7652257
Grid value 35:    lambda = .0061287   no. of nonzero coef. = 50
Folds: 1...5....10   CVF = .7615729
Grid value 36:    lambda = .0055843   no. of nonzero coef. = 50
Folds: 1...5....10   CVF = .7585355
Grid value 37:    lambda = .0050882   no. of nonzero coef. = 50
Folds: 1...5....10   CVF = .7560185
Grid value 38:    lambda = .0046362   no. of nonzero coef. = 50
Folds: 1...5....10   CVF = .7539692
Grid value 39:    lambda = .0042243   no. of nonzero coef. = 50
Folds: 1...5....10   CVF = .7522993
Grid value 40:    lambda =  .003849   no. of nonzero coef. = 50
Folds: 1...5....10   CVF = .7510323
Grid value 41:    lambda = .0035071   no. of nonzero coef. = 50
Folds: 1...5....10   CVF = .7501424
Grid value 42:    lambda = .0031955   no. of nonzero coef. = 51
Folds: 1...5....10   CVF =  .749556
Grid value 43:    lambda = .0029116   no. of nonzero coef. = 53
Folds: 1...5....10   CVF = .7493399
Grid value 44:    lambda =  .002653   no. of nonzero coef. = 54
Folds: 1...5....10   CVF = .7494932
Grid value 45:    lambda = .0024173   no. of nonzero coef. = 54
Folds: 1...5....10   CVF =  .749879
Grid value 46:    lambda = .0022026   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .7504851
Grid value 47:    lambda = .0020069   no. of nonzero coef. = 55
Folds: 1...5....10   CVF = .7513196
Grid value 48:    lambda = .0018286   no. of nonzero coef. = 54
Folds: 1...5....10   CVF = .7522946
... cross-validation complete ... minimum found

Lasso logit model                           No. of obs        =      1,042
                                            No. of covariates =         67
Selection: Cross-validation                 No. of CV folds   =         10

--------------------------------------------------------------------------
         |                                No. of      Out-of-
         |                               nonzero       sample      CV mean
      ID |     Description      lambda     coef.   dev. ratio     deviance
---------+----------------------------------------------------------------
       1 |    first lambda    .1449131         0      -0.0014     1.388243
      42 |   lambda before    .0031955        51       0.4593      .749556
    * 43 | selected lambda    .0029116        53       0.4595     .7493399
      44 |    lambda after     .002653        54       0.4594     .7494932
      48 |     last lambda    .0018286        54       0.4573     .7522946
--------------------------------------------------------------------------
* lambda selected by cross-validation.

. 
. * Salvar modelo
. estimates store IRDC_LASSO

. 
. 
. /*******************************************************************************
> 6.5.1 – Exportar Coeficientes Selecionados do Modelo LASSO (via log + conversão via Python)
> *******************************************************************************/
. 
. * Garantir que qualquer log anterior esteja fechado
. capture log close lassolog

. 
. * Abrir log no diretório atual (o mesmo de execução)
. log using "coef_lasso.txt", name(lassolog) text replace
(file C:\Users\morenos\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata\coef_lasso.txt not found)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  lassolog
       log:  C:\Users\morenos\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata\coef_lasso.txt
  log type:  text
 opened on:   2 Jul 2025, 14:57:52

. 
. * Exibir os coeficientes selecionados
. lassocoef, display(coef, postselection)

---------------------------------
                     | IRDC_LASSO
---------------------+-----------
             Porte_1 |  -1.854645
             Porte_3 |  -.1541271
         LiqCorrente |  -.0073069
         LiqCorAjust |  -.4290441
            EndGeral |  -.0174614
         CompEndivid |   .3374612
           GiroAtivo |   .1263599
              MargOp |  -.4120885
             MargLiq |   .1448167
                 ROI |  -1.312306
              CNAE_1 |  -1.808329
              CNAE_2 |  -17.63517
              CNAE_3 |   3.595176
              CNAE_4 |   17.59008
              CNAE_5 |  -1.119567
              CNAE_6 |   22.76723
              CNAE_8 |   .6207224
              CNAE_9 |   17.79765
             CNAE_10 |   18.09382
             CNAE_11 |   18.33671
             CNAE_12 |  -.3216565
             CNAE_13 |  -.5195116
             CNAE_14 |   18.19308
             CNAE_15 |     18.759
             CNAE_17 |   .2491956
             CNAE_18 |   1.489354
             CNAE_19 |  -.9004717
             CNAE_20 |  -19.01807
             CNAE_21 |  -1.576781
             CNAE_22 |  -19.32131
             CNAE_23 |   .4052867
             CNAE_24 |   16.71454
             CNAE_25 |   19.29332
             CNAE_26 |  -2.063839
             CNAE_27 |   2.389952
             CNAE_28 |   17.58952
             CNAE_30 |    .582235
             CNAE_31 |  -19.26437
             CNAE_32 |  -1.239854
             CNAE_33 |   2.319094
             CNAE_34 |  -18.96237
             CNAE_35 |  -2.034572
             CNAE_36 |   -19.3341
             CNAE_37 |  -18.64993
             CNAE_38 |   19.33774
  NaturezaJuridica_4 |  -5.259002
  NaturezaJuridica_5 |   1.369758
  NaturezaJuridica_9 |   2.496604
 NaturezaJuridica_10 |  -17.10024
     log_vlrcontrato |   .1281925
QtdeCNAEsSecundarios |  -.0252709
         IdadedeAnos |    .005814
QtePenalOutrosOrgaos |   .0376983
               _cons |  -1.012997
---------------------------------
Legend:
  b - base level
  e - empty cell
  o - omitted

. 
. * Fechar o log
. log close lassolog
      name:  lassolog
       log:  C:\Users\morenos\OneDrive - STJ- Superior Tribunal de Justiça\UnB\Mestrado em Governança e Inovação em Políticas Públicas\Projeto\Dados\Diretorio Stata\coef_lasso.txt
  log type:  text
 closed on:   2 Jul 2025, 14:57:52
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

. 
. display "✅ coef_lasso.txt exportado com sucesso."
✅ coef_lasso.txt exportado com sucesso.

. 
. 
. /*******************************************************************************
> 6.5.2 Tabela de Classificação, Acurácia, NIR e Teste de McNemar para o 
> Modelo LASSO na base de treino
> *******************************************************************************/
. 
. * 📌 Gerar predições de probabilidade na base de treinamento
. capture drop prob_pred_lasso

. predict prob_pred_lasso if train == 1, xb
(option penalized assumed; linear prediction with penalized coefficients)

. 
. * 📌 Classificação prevista com cutoff 0.5
. capture drop pred_lasso

. gen pred_lasso = (prob_pred_lasso >= 0.5) if train == 1
(186 missing values generated)

. 
. * 📌 Kappa
. kappaetc FoiPenalizadoSTJ pred_lasso if train == 1

Interrater agreement                             Number of subjects =    1042
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.8417    0.0113  74.38   0.000     0.8194     0.8639
Brennan and Prediger |  0.6833    0.0226  30.19   0.000     0.6389     0.7277
Cohen/Conger's Kappa |  0.6833    0.0223  30.67   0.000     0.6396     0.7270
    Scott/Fleiss' Pi |  0.6809    0.0228  29.87   0.000     0.6361     0.7256
           Gwet's AC |  0.6857    0.0226  30.37   0.000     0.6414     0.7300
Krippendorff's Alpha |  0.6810    0.0228  29.88   0.000     0.6363     0.7257
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de treinamento
. capture drop correct_lasso

. gen correct_lasso = (FoiPenalizadoSTJ == pred_lasso) if train == 1
(186 missing values generated)

. sum correct_lasso if train == 1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_la~o |      1,042    .8416507    .3652435          0          1

. scalar acuracia = r(mean)

. 
. * 📌 No Information Rate (NIR)
. * O NIR representa a acurácia de um modelo nulo (baseline), que classifica sempre a categoria mais frequente
. tabulate FoiPenalizadoSTJ if train == 1, matcell(freq_lasso)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        521       50.00       50.00
          1 |        521       50.00      100.00
------------+-----------------------------------
      Total |      1,042      100.00

. scalar total_lasso = freq_lasso[1,1] + freq_lasso[2,1]

. scalar max_lasso = max(freq_lasso[1,1], freq_lasso[2,1])

. scalar prop_nir_lasso = max_lasso / total_lasso

. 
. * 📌 Comparação
. di "Acurácia LASSO na base de treinamento: " acuracia
Acurácia LASSO na base de treinamento: .84165067

. di "NIR (treinamento): " prop_nir_lasso
NIR (treinamento): .5

. 
. if (acuracia > prop_nir_lasso) {
.     di "✅ Modelo LASSO supera o NIR na base de treino."
✅ Modelo LASSO supera o NIR na base de treino.
. }

. else {
.     di "⚠️ Modelo LASSO NÃO supera o NIR na base de treino."
. }

. 
. * 📌 Teste de McNemar na base de treinamento
. tabulate FoiPenalizadoSTJ pred_lasso if train == 1, matcell(mc_lasso)

FoiPenaliz |      pred_lasso
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       484         37 |       521 
         1 |       128        393 |       521 
-----------+----------------------+----------
     Total |       612        430 |     1,042 

. 
. scalar tn_lasso = mc_lasso[1,1] // Verdadeiro Negativo

. scalar fn_lasso = mc_lasso[2,1] // Falso Negativo

. scalar fp_lasso = mc_lasso[1,2] // Falso Positivo

. scalar tp_lasso = mc_lasso[2,2] // Verdadeiro Positivo

. 
. * Mostrar os valores extraídos (opcional)
. di "TN: " tn_lasso
TN: 484

. di "FN: " fn_lasso
FN: 128

. di "FP: " fp_lasso
FP: 37

. di "TP: " tp_lasso
TP: 393

. 
. * Rodar o teste de McNemar com os valores numéricos
. mcci `=tn_lasso' `=fn_lasso' `=fp_lasso' `=tp_lasso'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       484         128  |        612
       Unexposed |        37         393  |        430
-----------------+------------------------+-----------
           Total |       521         521  |       1042

McNemar's chi2(1) =     50.19    Prob > chi2 = 0.0000
Exact McNemar significance probability       = 0.0000

Proportion with factor
        Cases       .5873321
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference  .0873321         .0628   .1118641
        ratio       1.174664      1.123441   1.228222
        rel. diff.  .1746641      .1307638   .2185644

        odds ratio  3.459459      2.383052   5.132328   (exact)

. 
. /*******************************************************************************
> 6.5.3 Curva ROC para o modelo LASSO na base de TREINO
> *******************************************************************************/
. capture drop prob_pred_lasso_treino

. predict prob_pred_lasso_treino if train == 1, xb
(option penalized assumed; linear prediction with penalized coefficients)

. roctab FoiPenalizadoSTJ prob_pred_lasso_treino if train == 1, graph

. graph export "ROC_LASSO_treino.png", replace
(file ROC_LASSO_treino.png not found)
file ROC_LASSO_treino.png saved as PNG format

. 
. /*******************************************************************************
> 6.5.4 Avaliação do modelo LASSO na base de TESTE
> *******************************************************************************/
. 
. * 📌 Gerar predições de probabilidade na base de teste
. capture drop prob_pred_lasso_teste

. predict prob_pred_lasso_teste if train == 0, xb
(option penalized assumed; linear prediction with penalized coefficients)

. 
. * 📌 Classificação prevista com cutoff 0.5
. capture drop pred_lasso_teste

. gen pred_lasso_teste = (prob_pred_lasso_teste >= 0.5) if train == 0
(1,042 missing values generated)

. 
. * 📌 Kappa na base de teste
. kappaetc FoiPenalizadoSTJ pred_lasso_teste if train == 0

Interrater agreement                             Number of subjects =     186
                                                Ratings per subject =       2
                                        Number of rating categories =       2
------------------------------------------------------------------------------
                     |   Coef.  Std. Err.    t    P>|t|   [95% Conf. Interval]
---------------------+--------------------------------------------------------
   Percent Agreement |  0.7527    0.0317  23.73   0.000     0.6901     0.8153
Brennan and Prediger |  0.5054    0.0634   7.97   0.000     0.3802     0.6305
Cohen/Conger's Kappa |  0.3673    0.0751   4.89   0.000     0.2191     0.5156
    Scott/Fleiss' Pi |  0.3627    0.0766   4.73   0.000     0.2115     0.5139
           Gwet's AC |  0.5958    0.0601   9.91   0.000     0.4773     0.7144
Krippendorff's Alpha |  0.3644    0.0766   4.76   0.000     0.2132     0.5156
------------------------------------------------------------------------------

. 
. * 📌 Acurácia na base de teste
. capture drop correct_lasso_teste

. gen correct_lasso_teste = (FoiPenalizadoSTJ == pred_lasso_teste) if train == 0
(1,042 missing values generated)

. sum correct_lasso_teste if train == 0

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
correct_la~e |        186    .7526882     .432614          0          1

. scalar acuracia_teste = r(mean)

. 
. * 📌 No Information Rate (NIR) - TESTE
. tabulate FoiPenalizadoSTJ if train == 0, matcell(freq_teste)

FoiPenaliza |
      doSTJ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        130       69.89       69.89
          1 |         56       30.11      100.00
------------+-----------------------------------
      Total |        186      100.00

. scalar total_teste = freq_teste[1,1] + freq_teste[2,1]

. scalar max_teste = max(freq_teste[1,1], freq_teste[2,1])

. scalar nir_teste = max_teste / total_teste

. 
. di "Acurácia LASSO (teste): " acuracia_teste
Acurácia LASSO (teste): .75268817

. di "NIR (teste): " nir_teste
NIR (teste): .69892473

. 
. if (acuracia_teste > nir_teste) {
.     di "✅ Modelo LASSO supera o NIR na base de teste."
✅ Modelo LASSO supera o NIR na base de teste.
. }

. else {
.     di "⚠️ Modelo LASSO NÃO supera o NIR na base de teste."
. }

. 
. * 📌 Teste de McNemar - TESTE
. tabulate FoiPenalizadoSTJ pred_lasso_teste if train == 0, matcell(mc_lasso_teste)

FoiPenaliz |   pred_lasso_teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       114         16 |       130 
         1 |        30         26 |        56 
-----------+----------------------+----------
     Total |       144         42 |       186 

. 
. scalar tn_teste = mc_lasso_teste[1,1]

. scalar fn_teste = mc_lasso_teste[2,1]

. scalar fp_teste = mc_lasso_teste[1,2]

. scalar tp_teste = mc_lasso_teste[2,2]

. 
. di "TN: " tn_teste
TN: 114

. di "FN: " fn_teste
FN: 30

. di "FP: " fp_teste
FP: 16

. di "TP: " tp_teste
TP: 26

. 
. mcci `=tn_teste' `=fn_teste' `=fp_teste' `=tp_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       114          30  |        144
       Unexposed |        16          26  |         42
-----------------+------------------------+-----------
           Total |       130          56  |        186

McNemar's chi2(1) =      4.26    Prob > chi2 = 0.0390
Exact McNemar significance probability       = 0.0541

Proportion with factor
        Cases       .7741935
        Controls    .6989247     [95% conf. interval]
                   ---------     --------------------
        difference  .0752688     -.0007526   .1512902
        ratio       1.107692      1.005135   1.220714
        rel. diff.       .25      .0444253   .4555747

        odds ratio     1.875      .9900892   3.682885   (exact)

. 
. /*******************************************************************************
> 6.5.5 Curva ROC para o modelo LASSO na base de TESTE
> *******************************************************************************/
. roctab FoiPenalizadoSTJ prob_pred_lasso_teste if train == 0, graph

. graph export "ROC_LASSO_teste.png", replace
(file ROC_LASSO_teste.png not found)
file ROC_LASSO_teste.png saved as PNG format

. 
. /*******************************************************************************
> 6.5.6 – Classificação com Cutoff Médio (modelo LASSO)
> *******************************************************************************/
. 
. * 📌 Definir o cutoff médio com base nos modelos completos, stepwise 5% e stepwise 10%
. scalar cutoff_medio = (cutoff_completo + cutoff_step05 + cutoff_step10) / 3

. di "📌 Cutoff médio dos modelos: " cutoff_medio
📌 Cutoff médio dos modelos: .45154175

. 
. * ========================================================
. * BASE DE TREINAMENTO
. * ========================================================
. 
. * 📌 Gerar classificação com cutoff médio
. capture drop predicted_class_lasso_treino

. gen predicted_class_lasso_treino = (prob_pred_lasso_treino >= cutoff_medio) if train == 1
(186 missing values generated)

. 
. * 📌 Matriz de classificação com tabulação
. tabulate FoiPenalizadoSTJ predicted_class_lasso_treino if train == 1, matcell(mc_lasso_treino)

           | predicted_class_lasso
FoiPenaliz |        _treino
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       483         38 |       521 
         1 |       128        393 |       521 
-----------+----------------------+----------
     Total |       611        431 |     1,042 

. 
. * 📌 Extrair valores
. scalar tn_lasso_medio = mc_lasso_treino[1,1]

. scalar fn_lasso_medio = mc_lasso_treino[2,1]

. scalar fp_lasso_medio = mc_lasso_treino[1,2]

. scalar tp_lasso_medio = mc_lasso_treino[2,2]

. 
. * 📌 Teste de McNemar
. mcci `=tn_lasso_medio' `=fn_lasso_medio' `=fp_lasso_medio' `=tp_lasso_medio'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       483         128  |        611
       Unexposed |        38         393  |        431
-----------------+------------------------+-----------
           Total |       521         521  |       1042

McNemar's chi2(1) =     48.80    Prob > chi2 = 0.0000
Exact McNemar significance probability       = 0.0000

Proportion with factor
        Cases       .5863724
        Controls          .5     [95% conf. interval]
                   ---------     --------------------
        difference  .0863724      .0617524   .1109923
        ratio       1.172745      1.121413   1.226426
        rel. diff.  .1727447      .1286604    .216829

        odds ratio  3.368421      2.328943   4.974634   (exact)

. 
. * ========================================================
. * BASE DE TESTE
. * ========================================================
. 
. * 📌 Gerar classificação com cutoff médio
. capture drop predicted_class_lasso_teste

. gen predicted_class_lasso_teste = (prob_pred_lasso_teste >= cutoff_medio) if train == 0
(1,042 missing values generated)

. 
. * 📌 Matriz de classificação com tabulação
. tabulate FoiPenalizadoSTJ predicted_class_lasso_teste if train == 0, matcell(mc_lasso_teste)

           | predicted_class_lasso
FoiPenaliz |        _teste
    adoSTJ |         0          1 |     Total
-----------+----------------------+----------
         0 |       114         16 |       130 
         1 |        29         27 |        56 
-----------+----------------------+----------
     Total |       143         43 |       186 

. 
. * 📌 Extrair valores
. scalar tn_lasso_medio_teste = mc_lasso_teste[1,1]

. scalar fn_lasso_medio_teste = mc_lasso_teste[2,1]

. scalar fp_lasso_medio_teste = mc_lasso_teste[1,2]

. scalar tp_lasso_medio_teste = mc_lasso_teste[2,2]

. 
. * 📌 Teste de McNemar
. mcci `=tn_lasso_medio_teste' `=fn_lasso_medio_teste' `=fp_lasso_medio_teste' `=tp_lasso_medio_teste'

                 |        Controls        |
Cases            |   Exposed   Unexposed  |      Total
-----------------+------------------------+-----------
         Exposed |       114          29  |        143
       Unexposed |        16          27  |         43
-----------------+------------------------+-----------
           Total |       130          56  |        186

McNemar's chi2(1) =      3.76    Prob > chi2 = 0.0526
Exact McNemar significance probability       = 0.0725

Proportion with factor
        Cases       .7688172
        Controls    .6989247     [95% conf. interval]
                   ---------     --------------------
        difference  .0698925     -.0054539   .1452389
        ratio            1.1      .9988803   1.211356
        rel. diff.  .2321429      .0264086   .4378771

        odds ratio    1.8125      .9523662   3.572808   (exact)

. 
. /*******************************************************************************
> FIM DO SCRIPT
> *******************************************************************************/
. 
. log off
no log file open
r(606);

end of do-file

r(606);

. exit, clear
